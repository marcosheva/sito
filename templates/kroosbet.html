<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Kroosbet - Scommesse Sportive</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
  </style>
</head>
<body>
  <div id="app">
    <!-- Menu Hamburger per Mobile -->
    <div class="md:hidden fixed top-0 left-0 right-0 z-50 bg-gray-800 p-2 flex justify-between items-center border-b border-gray-700">
      <button id="mobile-menu-left" class="text-white p-2 hover:bg-gray-700 rounded">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
        </svg>
      </button>
      <span class="text-white font-bold">Kroosbet</span>
      <button id="mobile-menu-right" class="text-white p-2 hover:bg-gray-700 rounded">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
        </svg>
      </button>
    </div>
    
    <!-- Overlay per mobile -->
    <div id="mobile-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-30 hidden"></div>
    
    <div class="flex h-screen bg-gray-900 overflow-hidden pt-12 md:pt-0">
      <!-- Sidebar Sinistra -->
      <aside id="sidebar-left" class="fixed md:relative inset-y-0 left-0 z-40 w-80 md:w-72 bg-gray-800 text-white h-full md:h-auto p-3 flex flex-col space-y-3 border-r border-gray-700 overflow-y-auto transform -translate-x-full md:translate-x-0 transition-transform duration-300 ease-in-out">
        <!-- Bottone chiudi per mobile -->
        <button id="close-sidebar-left" class="md:hidden absolute top-2 right-2 text-white hover:bg-gray-700 rounded p-1">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
        <div class="font-bold text-sm bg-gray-700 px-3 py-2 rounded">MENU SPORT</div>
        <div class="flex flex-col space-y-2">
          <div class="flex items-center bg-black rounded px-2 py-1">
            <svg class="w-4 h-4 text-gray-400 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-4.35-4.35M17 11A6 6 0 1 1 5 11a6 6 0 0 1 12 0z"/>
            </svg>
            <input type="text" placeholder="Cerca..." class="bg-black text-white text-xs focus:outline-none w-full" />
          </div>
        </div>
        <div class="bg-gray-700 rounded px-2 py-1 mt-2">
          <div class="text-xs font-bold mb-1">SPORT</div>
          <div class="flex flex-col space-y-1">
            <div class="sport-item" data-sport="calcio">
              <div id="calcio-toggle" class="flex items-center justify-between px-1 py-1 hover:bg-gray-600 rounded cursor-pointer">
                <div class="flex items-center space-x-2">
                  <span class="text-lg">‚öΩ</span>
                  <span class="text-xs font-bold">CALCIO</span>
                </div>
                <div class="flex items-center space-x-1">
                  <span class="sport-indicator hidden text-yellow-400">‚úì</span>
                  <svg id="calcio-arrow" class="w-3 h-3 text-gray-400 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                  </svg>
                </div>
              </div>
              <div id="calcio-submenu" class="hidden ml-4 mt-1 space-y-1">
                <div class="text-xs text-gray-400 px-2 py-1">Caricamento campionati...</div>
              </div>
            </div>
            <div class="flex items-center justify-between px-1 py-1 hover:bg-gray-600 rounded cursor-pointer sport-item" data-sport="tennis" data-icon="üéæ" data-nome="Tennis">
              <div class="flex items-center space-x-2">
                <span class="text-lg">üéæ</span>
                <span class="text-xs">Tennis</span>
              </div>
              <span class="sport-indicator hidden text-yellow-400">‚úì</span>
            </div>
            <div class="flex items-center justify-between px-1 py-1 hover:bg-gray-600 rounded cursor-pointer sport-item" data-sport="basket" data-icon="üèÄ" data-nome="Basket">
              <div class="flex items-center space-x-2">
                <span class="text-lg">üèÄ</span>
                <span class="text-xs">Basket</span>
              </div>
              <span class="sport-indicator hidden text-yellow-400">‚úì</span>
            </div>
            <div class="flex items-center justify-between px-1 py-1 hover:bg-gray-600 rounded cursor-pointer sport-item" data-sport="hockey" data-icon="üèí" data-nome="Hockey">
              <div class="flex items-center space-x-2">
                <span class="text-lg">üèí</span>
                <span class="text-xs">Hockey</span>
              </div>
              <span class="sport-indicator hidden text-yellow-400">‚úì</span>
            </div>
            <div class="flex items-center justify-between px-1 py-1 hover:bg-gray-600 rounded cursor-pointer sport-item" data-sport="rugby" data-icon="üèâ" data-nome="Rugby">
              <div class="flex items-center space-x-2">
                <span class="text-lg">üèâ</span>
                <span class="text-xs">Rugby</span>
              </div>
              <span class="sport-indicator hidden text-yellow-400">‚úì</span>
            </div>
            <div class="flex items-center justify-between px-1 py-1 hover:bg-gray-600 rounded cursor-pointer sport-item" data-sport="american football" data-icon="üèà" data-nome="American Football">
              <div class="flex items-center space-x-2">
                <span class="text-lg">üèà</span>
                <span class="text-xs">American Football</span>
              </div>
              <span class="sport-indicator hidden text-yellow-400">‚úì</span>
            </div>
            <div class="flex items-center justify-between px-1 py-1 hover:bg-gray-600 rounded cursor-pointer sport-item" data-sport="volleyball" data-icon="üèê" data-nome="Volleyball">
              <div class="flex items-center space-x-2">
                <span class="text-lg">üèê</span>
                <span class="text-xs">Volleyball</span>
              </div>
              <span class="sport-indicator hidden text-yellow-400">‚úì</span>
            </div>
            <div class="flex items-center justify-between px-1 py-1 hover:bg-gray-600 rounded cursor-pointer sport-item" data-sport="water polo" data-icon="üèì" data-nome="Water Polo">
              <div class="flex items-center space-x-2">
                <span class="text-lg">üèì</span>
                <span class="text-xs">Water Polo</span>
              </div>
              <span class="sport-indicator hidden text-yellow-400">‚úì</span>
            </div>
            <div class="flex items-center justify-between px-1 py-1 hover:bg-gray-600 rounded cursor-pointer sport-item" data-sport="golf" data-icon="üèåÔ∏è" data-nome="Golf">
              <div class="flex items-center space-x-2">
                <span class="text-lg">üèåÔ∏è</span>
                <span class="text-xs">Golf</span>
              </div>
              <span class="sport-indicator hidden text-yellow-400">‚úì</span>
            </div>
            <div class="flex items-center justify-between px-1 py-1 hover:bg-gray-600 rounded cursor-pointer sport-item" data-sport="pingpong" data-icon="üéæ" data-nome="Pingpong">
              <div class="flex items-center space-x-2">
                <span class="text-lg">üéæ</span>
                <span class="text-xs">Pingpong</span>
              </div>
              <span class="sport-indicator hidden text-yellow-400">‚úì</span>
            </div>
            <div class="flex items-center justify-between px-1 py-1 hover:bg-gray-600 rounded cursor-pointer sport-item" data-sport="futsal" data-icon="‚öΩ" data-nome="Futsal">
              <div class="flex items-center space-x-2">
                <span class="text-lg">‚öΩ</span>
                <span class="text-xs">Futsal</span>
              </div>
              <span class="sport-indicator hidden text-yellow-400">‚úì</span>
            </div>
            <div class="flex items-center justify-between px-1 py-1 hover:bg-gray-600 rounded cursor-pointer sport-item" data-sport="pallamano" data-icon="üéæ" data-nome="Pallamano">
              <div class="flex items-center space-x-2">
                <span class="text-lg">üéæ</span>
                <span class="text-xs">Pallamano</span>
              </div>
              <span class="sport-indicator hidden text-yellow-400">‚úì</span>
            </div>
            <div class="flex items-center justify-between px-1 py-1 hover:bg-gray-600 rounded cursor-pointer sport-item" data-sport="freccette" data-icon="üéæ" data-nome="Freccette">
              <div class="flex items-center space-x-2">
                <span class="text-lg">üéæ</span>
                <span class="text-xs">Freccette</span>
              </div>
              <span class="sport-indicator hidden text-yellow-400">‚úì</span>
            </div>
            <div class="flex items-center justify-between px-1 py-1 hover:bg-gray-600 rounded cursor-pointer sport-item" data-sport="boxing" data-icon="ü•ä" data-nome="Boxing">
              <div class="flex items-center space-x-2">
                <span class="text-lg">ü•ä</span>
                <span class="text-xs">Boxing</span>
              </div>
              <span class="sport-indicator hidden text-yellow-400">‚úì</span>
            </div>
            <div class="flex items-center justify-between px-1 py-1 hover:bg-gray-600 rounded cursor-pointer sport-item" data-sport="e-sport" data-icon="üéÆ" data-nome="E-Sport">
              <div class="flex items-center space-x-2">
                <span class="text-lg">üéÆ</span>
                <span class="text-xs">E-Sport</span>
              </div>
              <span class="sport-indicator hidden text-yellow-400">‚úì</span>
            </div>
            <div class="flex items-center justify-between px-1 py-1 hover:bg-gray-600 rounded cursor-pointer sport-item" data-sport="badminton" data-icon="üè∏" data-nome="Badminton">
              <div class="flex items-center space-x-2">
                <span class="text-lg">üè∏</span>
                <span class="text-xs">Badminton</span>
              </div>
              <span class="sport-indicator hidden text-yellow-400">‚úì</span>
            </div>
            <div class="flex items-center justify-between px-1 py-1 hover:bg-gray-600 rounded cursor-pointer sport-item" data-sport="cricket" data-icon="üèè" data-nome="Cricket">
              <div class="flex items-center space-x-2">
                <span class="text-lg">üèè</span>
                <span class="text-xs">Cricket</span>
              </div>
              <span class="sport-indicator hidden text-yellow-400">‚úì</span>
            </div>
            <div class="flex items-center justify-between px-1 py-1 hover:bg-gray-600 rounded cursor-pointer sport-item" data-sport="squash" data-icon="üéæ" data-nome="Squash">
              <div class="flex items-center space-x-2">
                <span class="text-lg">üéæ</span>
                <span class="text-xs">Squash</span>
              </div>
              <span class="sport-indicator hidden text-yellow-400">‚úì</span>
            </div>
          </div>
        </div>
      </aside>
      
      <!-- Contenuto Centrale -->
      <div class="flex-1 flex flex-col overflow-hidden">
        <header class="bg-gray-800 text-white px-6 py-4 border-b border-gray-700">
          <div class="flex items-center justify-between">
            <div>
              <h1 class="text-2xl font-bold">Kroosbet</h1>
              <p class="text-xs text-gray-400 mt-1">Credito: <span class="font-bold text-green-400" id="credito-display">{{ "%.2f"|format(credito) }} ‚Ç¨</span></p>
            </div>
            <div class="flex items-center space-x-4">
              <a href="/schedine" class="text-sm hover:text-yellow-400">Le Mie Schedine</a>
              <a href="/" class="text-sm hover:text-yellow-400">Home</a>
              <a href="/logout" class="text-sm hover:text-yellow-400">Logout</a>
            </div>
          </div>
        </header>
        
        <div class="flex-1 overflow-y-auto p-4">
          <div class="w-full bg-gray-800 rounded shadow border-2 border-yellow-500">
            <div class="bg-gray-700 text-white text-center font-bold py-2 border-b border-gray-600 text-lg" id="sport-title">CALCIO</div>
            
            <!-- Tab Mercati Principali -->
            <div class="flex space-x-2 bg-gray-700 px-2 py-2 border-b border-gray-600 overflow-x-auto">
              <button id="mercato-Principali" class="mercato-tab-btn px-3 py-1 rounded text-xs font-bold bg-yellow-500 text-black hover:bg-yellow-600 mercato-tab whitespace-nowrap" data-mercato="Principali">Principali</button>
              <button id="mercato-1X2" class="mercato-tab-btn px-3 py-1 rounded text-xs font-bold bg-gray-600 text-white hover:bg-gray-500 mercato-tab whitespace-nowrap" data-mercato="1X2">1X2</button>
              <button id="mercato-Doppia Chance" class="mercato-tab-btn px-3 py-1 rounded text-xs font-bold bg-gray-600 text-white hover:bg-gray-500 mercato-tab whitespace-nowrap" data-mercato="Doppia Chance">Doppia Chance</button>
              <button id="mercato-Over/Under" class="mercato-tab-btn px-3 py-1 rounded text-xs font-bold bg-gray-600 text-white hover:bg-gray-500 mercato-tab whitespace-nowrap" data-mercato="Over/Under">Over/Under</button>
              <button id="mercato-Gol Totali" class="mercato-tab-btn px-3 py-1 rounded text-xs font-bold bg-gray-600 text-white hover:bg-gray-500 mercato-tab whitespace-nowrap" data-mercato="Gol Totali">Gol Totali</button>
              <button id="mercato-Handicap" class="mercato-tab-btn px-3 py-1 rounded text-xs font-bold bg-gray-600 text-white hover:bg-gray-500 mercato-tab whitespace-nowrap" data-mercato="Handicap">Handicap</button>
              <button id="mercato-Ris. Esatto" class="mercato-tab-btn px-3 py-1 rounded text-xs font-bold bg-gray-600 text-white hover:bg-gray-500 mercato-tab whitespace-nowrap" data-mercato="Ris. Esatto">Ris. Esatto</button>
              <button id="mercato-Corner" class="mercato-tab-btn px-3 py-1 rounded text-xs font-bold bg-gray-600 text-white hover:bg-gray-500 mercato-tab whitespace-nowrap" data-mercato="Corner">Corner</button>
              <button id="mercato-Cartellini" class="mercato-tab-btn px-3 py-1 rounded text-xs font-bold bg-gray-600 text-white hover:bg-gray-500 mercato-tab whitespace-nowrap" data-mercato="Cartellini">Cartellini</button>
              <button id="mercato-Primo Gol" class="mercato-tab-btn px-3 py-1 rounded text-xs font-bold bg-gray-600 text-white hover:bg-gray-500 mercato-tab whitespace-nowrap" data-mercato="Primo Gol">Primo Gol</button>
              <button id="mercato-1T" class="mercato-tab-btn px-3 py-1 rounded text-xs font-bold bg-gray-600 text-white hover:bg-gray-500 mercato-tab whitespace-nowrap" data-mercato="1T">1T</button>
              <button id="mercato-2T" class="mercato-tab-btn px-3 py-1 rounded text-xs font-bold bg-gray-600 text-white hover:bg-gray-500 mercato-tab whitespace-nowrap" data-mercato="2T">2T</button>
              <button id="mercato-DNB" class="mercato-tab-btn px-3 py-1 rounded text-xs font-bold bg-gray-600 text-white hover:bg-gray-500 mercato-tab whitespace-nowrap" data-mercato="DNB">DNB</button>
            </div>
            
            <div class="overflow-x-auto">
              <table class="min-w-full text-xs text-white">
                <thead class="bg-gray-700 text-gray-200">
                  <tr id="table-header">
                    <th class="px-2 py-1 border-b border-gray-600 text-center">Id</th>
                    <th class="px-2 py-1 border-b border-gray-600 text-center">Data</th>
                    <th class="px-2 py-1 border-b border-gray-600 text-center">Evento</th>
                    <th class="px-1 py-1 border-b border-gray-600">1</th>
                    <th class="px-1 py-1 border-b border-gray-600">X</th>
                    <th class="px-1 py-1 border-b border-gray-600">2</th>
                  </tr>
                </thead>
                <tbody id="matches-body">
                  <tr>
                    <td colspan="6" class="text-center py-4 text-gray-400">Caricamento dati...</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
        
        <footer class="w-full bg-gray-900 border-t-4 border-yellow-500 py-6 px-8 text-white text-xs">
          <div class="flex flex-col md:flex-row justify-between items-center">
            <div class="flex flex-col items-start space-y-2">
              <div class="flex items-center space-x-2">
                <span class="text-3xl font-bold">K</span>
                <span class="text-2xl font-bold">roosbet</span>
              </div>
              <span>¬© 2025 kroosbet</span>
            </div>
            <div class="mt-4 md:mt-0">
              <span>Per informazioni: <a href="mailto:infalcode@protonmail.com" class="text-blue-400 hover:underline">infalcode@protonmail.com</a></span>
            </div>
          </div>
        </footer>
      </div>
      
      <!-- Sidebar Destra - Schedina -->
      <aside id="sidebar-right" class="fixed md:relative inset-y-0 right-0 z-40 w-80 md:w-80 bg-gray-800 text-white h-full md:h-auto p-3 flex flex-col space-y-3 border-l border-gray-700 transform translate-x-full md:translate-x-0 transition-transform duration-300 ease-in-out">
        <!-- Bottone chiudi per mobile -->
        <button id="close-sidebar-right" class="md:hidden absolute top-2 right-2 text-white hover:bg-gray-700 rounded p-1">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
        <div class="font-bold text-sm bg-gray-700 px-3 py-2 rounded">SCHEDINA</div>
        <div id="schedina-content" class="flex-1 overflow-y-auto">
          <div class="text-xs text-gray-400">Nessuna selezione</div>
        </div>
        <div class="mt-2 flex flex-col space-y-1 bg-gray-700 rounded p-2">
          <label class="text-xs mb-1">Importo Tot. (‚Ç¨)</label>
          <input id="importo-input" type="number" min="1" step="1" class="w-full rounded px-2 py-1 text-black text-xs focus:outline-none" placeholder="0.00" />
          <div class="flex justify-between text-xs mt-1">
            <span>Vincita Pot.</span>
            <span class="font-bold text-yellow-400" id="vincita-pot">0.00 ‚Ç¨</span>
          </div>
        </div>
        <div class="flex space-x-2 mt-3">
          <button onclick="clearSchedina()" class="flex-1 bg-red-500 hover:bg-red-600 text-white py-1 rounded text-xs">CANCELLA</button>
          <button onclick="giocaSchedina()" class="flex-1 bg-green-600 hover:bg-green-700 text-white font-bold py-1 rounded text-xs">GIOCA</button>
        </div>
      </aside>
    </div>
  </div>

  <!-- Modal Mercati -->
  <div id="modal-mercati" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
    <div class="bg-gray-800 rounded-lg shadow-xl max-w-6xl w-full mx-4 max-h-[90vh] flex flex-col">
      <div class="sticky top-0 bg-gray-800 border-b border-gray-700 px-6 py-4 flex justify-between items-center z-10">
        <h2 class="text-xl font-bold text-yellow-400" id="modal-titolo">Tutti i Mercati</h2>
        <div class="flex items-center space-x-2">
          <button onclick="refreshMercati()" class="px-3 py-1 bg-gray-700 hover:bg-gray-600 text-white text-sm rounded">üîÑ</button>
          <button onclick="chiudiMercati()" class="text-gray-400 hover:text-white text-2xl">&times;</button>
        </div>
      </div>
      
      <!-- Tab Categorie -->
      <div class="sticky top-[73px] bg-gray-700 border-b border-gray-600 px-4 py-2 overflow-x-auto z-10">
        <div class="flex space-x-2" id="tab-categorie">
          <!-- Tab dinamiche -->
        </div>
      </div>
      
      <div class="flex-1 overflow-y-auto p-6" id="modal-contenuto">
        <!-- Contenuto dinamico -->
      </div>
    </div>
  </div>

  <script>
    let selections = [];
    let matchesData = [];
    let sportSelezionato = 'calcio';
    let mercatoSelezionato = 'Principali';
    let campionatoSelezionato = null;
    let nationsLeagues = {};
    let nazioneSelezionata = null; // Traccia quale nazione √® selezionata
    let expandedNations = new Set(); // Traccia quali nazioni sono espanse
    
    // Non caricare subito, aspetta DOMContentLoaded
    const sportInfo = {
      'calcio': { icon: '‚öΩ', nome: 'CALCIO' },
      'tennis': { icon: 'üéæ', nome: 'Tennis' },
      'basket': { icon: 'üèÄ', nome: 'Basket' },
      'football': { icon: '‚öΩ', nome: 'Football' },
      'baseball': { icon: '', nome: 'Baseball' },
      'hockey': { icon: 'üèí', nome: 'Hockey' },
      'rugby': { icon: 'üèâ', nome: 'Rugby' },
      'american football': { icon: 'üèà', nome: 'American Football' },
      'volleyball': { icon: 'üèê', nome: 'Volleyball' },
      'water polo': { icon: 'üèì', nome: 'Water Polo' },
      'golf': { icon: 'üèåÔ∏è', nome: 'Golf' },
      'pingpong': { icon: 'üéæ', nome: 'Pingpong' },
      'pallamano': { icon: 'üéæ', nome: 'Pallamano' },
      'freccette': { icon: 'üéæ', nome: 'Freccette' },
      'futsal': { icon: 'üéæ', nome: 'Futsal' },
      'boxing': { icon: 'ü•ä', nome: 'Boxing' },
      'e-sport': { icon: 'üéÆ', nome: 'E-Sport' },
      'badminton': { icon: 'üè∏', nome: 'Badminton' },
      'cricket': { icon: 'üèè', nome: 'Cricket' },
      'squash': { icon: 'üéæ', nome: 'Squash' },
    };

    // Mapping sport UI -> MongoDB
    function getSportForMongo(sport) {
      const mapping = {
        'water polo': 'pallanuoto',
        'waterpolo': 'pallanuoto',
        'american football': 'football',
        'e-sport': 'E-Sport',
        'badminton': 'Badminton',
        'cricket': 'Cricket',
        'squash': 'Squash'
      };
      return mapping[sport] || sport;
    }

    // Toggle menu calcio
    function toggleCalcioMenu() {
      const submenu = document.getElementById('calcio-submenu');
      const arrow = document.getElementById('calcio-arrow');
      const isHidden = submenu.classList.contains('hidden');
      
      if (isHidden) {
        submenu.classList.remove('hidden');
        arrow.style.transform = 'rotate(180deg)';
        if (Object.keys(nationsLeagues).length === 0) {
          loadLeagues();
        }
      } else {
        submenu.classList.add('hidden');
        arrow.style.transform = 'rotate(0deg)';
      }
    }

    // Carica campionati disponibili
    async function loadLeagues() {
      if (sportSelezionato !== 'calcio') {
        console.log('loadLeagues: sport non √® calcio, esco');
        return;
      }
      
      const submenu = document.getElementById('calcio-submenu');
      if (!submenu) {
        console.error('loadLeagues: submenu non trovato');
        return;
      }
      
      // Mostra il submenu se √® nascosto
      submenu.classList.remove('hidden');
      submenu.innerHTML = '<div class="text-xs text-gray-400 px-2 py-1">Caricamento campionati...</div>';
      
      try {
        console.log('loadLeagues: chiamata API con sport=', sportSelezionato);
        // Usa URL assoluto per evitare problemi su Render
        const sportForMongo = getSportForMongo(sportSelezionato);
        const apiUrl = `${window.location.origin}/api/leagues?sport=${sportForMongo}`;
        console.log('loadLeagues: URL completo', apiUrl);
        const response = await fetch(apiUrl);
        
        if (!response.ok) {
          const errorText = await response.text();
          console.error('loadLeagues: errore HTTP', response.status, errorText);
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const contentType = response.headers.get('content-type');
        if (!contentType || !contentType.includes('application/json')) {
          const text = await response.text();
          console.error('loadLeagues: risposta non JSON', text.substring(0, 200));
          throw new Error('Risposta non √® JSON');
        }
        
        const data = await response.json();
        console.log('loadLeagues: risposta API', data);
        console.log('loadLeagues: data.debug esiste?', !!data.debug);
        console.log('loadLeagues: data.debug =', data.debug);
        console.log('loadLeagues: chiavi di data =', Object.keys(data));
        if (data.debug) {
          console.log('loadLeagues: chiavi di data.debug =', Object.keys(data.debug));
        }
        
        // Mostra info di debug se disponibili
        if (data.debug) {
          console.log('=== DEBUG API ===');
          console.log('DEBUG API completo:', JSON.stringify(data.debug, null, 2));
          console.log('Nazioni trovate:', data.debug.nations_list);
          console.log('Campionati in Altri:', data.debug.altri_count);
          console.log('Campionati in Italia:', data.debug.italia_count);
          if (data.debug.sample_parsing) {
            console.log('=== TEST PARSING ===');
            data.debug.sample_parsing.forEach(test => {
              console.log(`${test.league}: prima parola="${test.first_word}", in mappatura=${test.in_mapping}, nazione="${test.mapped_nation}"`);
            });
          }
          if (data.debug.mapping_keys_sample) {
            console.log('Chiavi mappatura (prime 10):', data.debug.mapping_keys_sample);
          }
          if (data.debug.test_result) {
            console.log('=== TEST RISULTATI ===');
            Object.keys(data.debug.test_result).forEach(league => {
              const test = data.debug.test_result[league];
              console.log(`${league}: prima parola="${test.first_word}", in mappatura=${test.in_mapping}, nazione="${test.mapped_nation}"`);
            });
          }
          if (data.debug.test_results) {
            console.log('=== TEST RISULTATI FINALI ===');
            Object.keys(data.debug.test_results).forEach(league => {
              const test = data.debug.test_results[league];
              console.log(`${league}:`);
              console.log(`  Prima parola: "${test.first_word}", in mappatura: ${test.in_mapping}`);
              console.log(`  Nazione attesa: "${test.expected_nation}", League name atteso: "${test.expected_league_name}"`);
              console.log(`  Nazione trovata: "${test.found_nation}", Trovato nel risultato: ${test.found_in_result}`);
              if (test.expected_nation !== test.found_nation) {
                console.warn(`  ‚ö†Ô∏è PROBLEMA: Nazione attesa "${test.expected_nation}" ma trovata "${test.found_nation}"`);
              }
            });
          }
          console.log('===================');
        } else {
          console.warn('‚ö†Ô∏è DEBUG INFO NON DISPONIBILE nella risposta API');
        }
        
        if (data.success && data.nations) {
          nationsLeagues = data.nations;
          console.log('loadLeagues: campionati caricati', Object.keys(nationsLeagues).length, 'nazioni');
          console.log('Nazioni disponibili:', Object.keys(nationsLeagues));
          renderLeaguesMenu();
        } else {
          console.error('loadLeagues: risposta API non valida', data);
          submenu.innerHTML = '<div class="text-xs text-red-400 px-2 py-1">Errore caricamento campionati</div>';
        }
      } catch (error) {
        console.error('Errore caricamento campionati:', error);
        submenu.innerHTML = `<div class="text-xs text-red-400 px-2 py-1">Errore: ${error.message}</div>`;
      }
    }

    // Mappatura bandiere SVG per nazioni
    const nationFlags = {
      "Italia": "https://1276648311.rsc.cdn77.org/alphacode/assets/images/flagssvg/it.svg",
      "Inghilterra": "https://1276648311.rsc.cdn77.org/alphacode/assets/images/flagssvg/eng.svg",
      "Spagna": "https://1276648311.rsc.cdn77.org/alphacode/assets/images/flagssvg/es.svg",
      "Francia": "https://1276648311.rsc.cdn77.org/alphacode/assets/images/flagssvg/fr.svg",
      "Germania": "https://1276648311.rsc.cdn77.org/alphacode/assets/images/flagssvg/de.svg",
      "Olanda": "https://1276648311.rsc.cdn77.org/alphacode/assets/images/flagssvg/nl.svg",
      "Paesi Bassi": "https://1276648311.rsc.cdn77.org/alphacode/assets/images/flagssvg/nl.svg",
      "Portogallo": "https://1276648311.rsc.cdn77.org/alphacode/assets/images/flagssvg/pt.svg",
      "Belgio": "https://1276648311.rsc.cdn77.org/alphacode/assets/images/flagssvg/be.svg",
      "Turchia": "https://1276648311.rsc.cdn77.org/alphacode/assets/images/flagssvg/tr.svg",
      "Grecia": "https://1276648311.rsc.cdn77.org/alphacode/assets/images/flagssvg/gr.svg",
      "Russia": "https://1276648311.rsc.cdn77.org/alphacode/assets/images/flagssvg/ru.svg",
      "Polonia": "https://1276648311.rsc.cdn77.org/alphacode/assets/images/flagssvg/pl.svg",
      "Repubblica Ceca": "https://1276648311.rsc.cdn77.org/alphacode/assets/images/flagssvg/cz.svg",
      "Svizzera": "https://1276648311.rsc.cdn77.org/alphacode/assets/images/flagssvg/ch.svg",
      "Austria": "https://1276648311.rsc.cdn77.org/alphacode/assets/images/flagssvg/at.svg",
      "Scozia": "https://1276648311.rsc.cdn77.org/alphacode/assets/images/flagssvg/gb-sct.svg",
      "Danimarca": "https://1276648311.rsc.cdn77.org/alphacode/assets/images/flagssvg/dk.svg",
      "Svezia": "https://1276648311.rsc.cdn77.org/alphacode/assets/images/flagssvg/se.svg",
      "Norvegia": "https://1276648311.rsc.cdn77.org/alphacode/assets/images/flagssvg/no.svg",
      "Brasile": "https://1276648311.rsc.cdn77.org/alphacode/assets/images/flagssvg/br.svg",
      "Argentina": "https://1276648311.rsc.cdn77.org/alphacode/assets/images/flagssvg/ar.svg",
      "Messico": "https://1276648311.rsc.cdn77.org/alphacode/assets/images/flagssvg/mx.svg",
      "Stati Uniti": "https://1276648311.rsc.cdn77.org/alphacode/assets/images/flagssvg/us.svg",
      "Giappone": "https://1276648311.rsc.cdn77.org/alphacode/assets/images/flagssvg/jp.svg",
      "Cina": "https://1276648311.rsc.cdn77.org/alphacode/assets/images/flagssvg/cn.svg",
      "Corea del Sud": "https://1276648311.rsc.cdn77.org/alphacode/assets/images/flagssvg/kr.svg",
      "Australia": "https://1276648311.rsc.cdn77.org/alphacode/assets/images/flagssvg/au.svg",
      "Bosnia ed Erzegovina": "https://1276648311.rsc.cdn77.org/alphacode/assets/images/flagssvg/ba.svg",
      "Bosnia & Herzegovina": "https://1276648311.rsc.cdn77.org/alphacode/assets/images/flagssvg/ba.svg",
      "Bulgaria": "https://1276648311.rsc.cdn77.org/alphacode/assets/images/flagssvg/bg.svg",
      "Ecuador": "https://1276648311.rsc.cdn77.org/alphacode/assets/images/flagssvg/ec.svg",
      "Israele": "https://1276648311.rsc.cdn77.org/alphacode/assets/images/flagssvg/il.svg",
      "Paraguay": "https://1276648311.rsc.cdn77.org/alphacode/assets/images/flagssvg/py.svg",
      "Slovenia": "https://1276648311.rsc.cdn77.org/alphacode/assets/images/flagssvg/si.svg",
      "Colombia": "https://1276648311.rsc.cdn77.org/alphacode/assets/images/flagssvg/co.svg",
      "Chile": "https://1276648311.rsc.cdn77.org/alphacode/assets/images/flagssvg/cl.svg",
      "Peru": "https://1276648311.rsc.cdn77.org/alphacode/assets/images/flagssvg/pe.svg",
      "Uruguay": "https://1276648311.rsc.cdn77.org/alphacode/assets/images/flagssvg/uy.svg",
      "Bolivia": "https://1276648311.rsc.cdn77.org/alphacode/assets/images/flagssvg/bo.svg",
      "Romania": "https://1276648311.rsc.cdn77.org/alphacode/assets/images/flagssvg/ro.svg",
      "Slovakia": "https://1276648311.rsc.cdn77.org/alphacode/assets/images/flagssvg/sk.svg",
      "Cyprus": "https://1276648311.rsc.cdn77.org/alphacode/assets/images/flagssvg/cy.svg",
      "Qatar": "https://1276648311.rsc.cdn77.org/alphacode/assets/images/flagssvg/qa.svg",
      "Saudi": "https://1276648311.rsc.cdn77.org/alphacode/assets/images/flagssvg/sa.svg",
      "Jordan": "https://1276648311.rsc.cdn77.org/alphacode/assets/images/flagssvg/jo.svg",
      "Singapore": "https://1276648311.rsc.cdn77.org/alphacode/assets/images/flagssvg/sg.svg",
      "Ghana": "https://1276648311.rsc.cdn77.org/alphacode/assets/images/flagssvg/gh.svg",
      "Nigeria": "https://1276648311.rsc.cdn77.org/alphacode/assets/images/flagssvg/ng.svg",
      "Honduras": "https://1276648311.rsc.cdn77.org/alphacode/assets/images/flagssvg/hn.svg",
      "Namibia": "https://1276648311.rsc.cdn77.org/alphacode/assets/images/flagssvg/na.svg",
      "Liberia": "https://1276648311.rsc.cdn77.org/alphacode/assets/images/flagssvg/lr.svg",
      "Mauritania": "https://1276648311.rsc.cdn77.org/alphacode/assets/images/flagssvg/mr.svg",
      "Sierra": "https://1276648311.rsc.cdn77.org/alphacode/assets/images/flagssvg/sl.svg",
      "Ivory": "https://1276648311.rsc.cdn77.org/alphacode/assets/images/flagssvg/ci.svg",
      "Northern": "https://1276648311.rsc.cdn77.org/alphacode/assets/images/flagssvg/gb-nir.svg",
      "South": "https://1276648311.rsc.cdn77.org/alphacode/assets/images/flagssvg/za.svg",
      "Zanzibar": "https://1276648311.rsc.cdn77.org/alphacode/assets/images/flagssvg/tz.svg",
      "Portugal": "https://1276648311.rsc.cdn77.org/alphacode/assets/images/flagssvg/pt.svg",
      "Sweden": "https://1276648311.rsc.cdn77.org/alphacode/assets/images/flagssvg/se.svg",
      "Norway": "https://1276648311.rsc.cdn77.org/alphacode/assets/images/flagssvg/no.svg",
      "Switzerland": "https://1276648311.rsc.cdn77.org/alphacode/assets/images/flagssvg/ch.svg",
      "Czechia": "https://1276648311.rsc.cdn77.org/alphacode/assets/images/flagssvg/cz.svg",
      "Scotland": "https://1276648311.rsc.cdn77.org/alphacode/assets/images/flagssvg/gb-sct.svg",
      "Belgium": "https://1276648311.rsc.cdn77.org/alphacode/assets/images/flagssvg/be.svg",
      "Mexico": "https://1276648311.rsc.cdn77.org/alphacode/assets/images/flagssvg/mx.svg",
      "Japan": "https://1276648311.rsc.cdn77.org/alphacode/assets/images/flagssvg/jp.svg",
      "USA": "https://1276648311.rsc.cdn77.org/alphacode/assets/images/flagssvg/us.svg",
      "T√ºrkiye": "https://1276648311.rsc.cdn77.org/alphacode/assets/images/flagssvg/tr.svg",
      "Europe": "üèÜ",
      "UEFA": "üèÜ",
      "Sud America": "üåé",
      "Copa": "üèÜ",
      "Africa": "üåç",
      "Asia": "üåè",
      "Baller League UK": "üè¥Û†ÅßÛ†Å¢Û†Å•Û†ÅÆÛ†ÅßÛ†Åø",
      "Brazil Kings Cup": "üáßüá∑",
      "Esoccer Battle": "üéÆ",
      "Esoccer Battle Volta": "üéÆ",
      "Altri": "üåç"
    };

    // Renderizza menu campionati con struttura gerarchica: Nazioni -> Campionati
    function renderLeaguesMenu() {
      const submenu = document.getElementById('calcio-submenu');
      if (!submenu) {
        console.error('renderLeaguesMenu: submenu non trovato');
        return;
      }
      
      // Assicurati che il submenu sia visibile
      submenu.classList.remove('hidden');
      
      let html = '';
      
      // Aggiungi opzione "Tutti i campionati"
      html += `
        <div class="league-item-all px-2 py-1 hover:bg-gray-600 rounded cursor-pointer text-xs ${campionatoSelezionato === null ? 'bg-yellow-500 bg-opacity-20 text-yellow-400' : 'text-gray-300'}">
          üìã Tutti i campionati
        </div>
      `;
      
      // Ordina nazioni: prima Italia, poi altre in ordine alfabetico
      const sortedNations = Object.keys(nationsLeagues || {}).sort((a, b) => {
        if (a === "Italia") return -1;
        if (b === "Italia") return 1;
        return a.localeCompare(b);
      });
      console.log('renderLeaguesMenu: nazioni trovate', sortedNations.length);
      
      if (sortedNations.length === 0) {
        html += '<div class="text-xs text-gray-400 px-2 py-1 mt-1">Nessun campionato disponibile</div>';
      } else {
        sortedNations.forEach(nation => {
          const leagues = nationsLeagues[nation] || [];
          const safeNation = (nation || '').replace(/'/g, "\\'").replace(/"/g, '&quot;');
          const nationId = `nation-${safeNation.replace(/[^a-zA-Z0-9]/g, '-')}`;
          // Cerca la bandiera, con fallback per varianti del nome
          let flag = nationFlags[nation];
          if (!flag) {
            // Prova varianti comuni
            const variants = {
              "Netherlands": "Paesi Bassi",
              "Olanda": "Paesi Bassi",
              "England": "Inghilterra",
              "Italy": "Italia",
              "Spain": "Spagna",
              "France": "Francia",
              "Germany": "Germania"
            };
            const variant = variants[nation];
            if (variant) {
              flag = nationFlags[variant];
            }
          }
          // Se ancora non trovata, usa bandiera generica o emoji
          if (!flag) {
            flag = "üè≥Ô∏è";
          }
          console.log(`renderLeaguesMenu: nazione ${nation}, ${leagues.length} campionati`);
          
          // Verifica se questa nazione ha un campionato selezionato
          const hasSelectedLeague = leagues.some(l => l.full_name === campionatoSelezionato);
          const isNationSelected = nazioneSelezionata === nation || hasSelectedLeague;
          const isExpanded = expandedNations.has(nationId) || hasSelectedLeague;
          
          // Se ha un campionato selezionato, assicurati che sia espansa
          if (hasSelectedLeague) {
            expandedNations.add(nationId);
          }
          
          // Determina se la bandiera √® un URL (immagine) o un emoji
          const isImage = flag.startsWith('http');
          const flagHtml = isImage 
            ? `<img src="${flag}" alt="${nation}" class="w-5 h-4 object-contain" />`
            : `<span class="text-lg">${flag}</span>`;
          
          // Header nazione con bandiera prima del nome (stile capitanbet)
          html += `
            <div class="mt-0.5">
              <div class="nation-header flex items-center px-2 py-1.5 hover:bg-gray-700 cursor-pointer border-b border-gray-700 ${isNationSelected ? 'bg-orange-600' : 'bg-gray-800'}" 
                   data-nation-id="${nationId}"
                   data-nation="${safeNation}">
                <div class="flex items-center space-x-2 flex-1">
                  ${flagHtml}
                  <span class="text-sm font-medium ${isNationSelected ? 'text-white' : 'text-gray-300'}">${nation}</span>
                </div>
                <svg class="nation-arrow w-4 h-4 text-gray-400 transition-transform ${isExpanded ? 'rotate-180' : ''}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                </svg>
              </div>
              <div id="${nationId}" class="nation-leagues ${isExpanded ? '' : 'hidden'} bg-gray-900">
          `;
          
          // Campionati sotto la nazione
          leagues.forEach((league, idx) => {
            const isSelected = campionatoSelezionato === league.full_name;
            html += `
              <div class="league-item px-6 py-1.5 hover:bg-gray-700 cursor-pointer text-sm border-b border-gray-800 ${isSelected ? 'bg-orange-500 bg-opacity-30 text-white' : 'text-gray-300'}" 
                   data-nation="${safeNation}" 
                   data-index="${idx}">
                ${(league.name || league.full_name || 'N/A').replace(/</g, '&lt;').replace(/>/g, '&gt;')}
              </div>
            `;
          });
          
          html += `</div></div>`;
        });
      }
      
      submenu.innerHTML = html;
      console.log('renderLeaguesMenu: menu renderizzato');
      
      // Aggiungi event listener a "Tutti i campionati"
      const allItem = submenu.querySelector('.league-item-all');
      if (allItem) {
        allItem.addEventListener('click', function() {
          selezionaCampionato(null);
        });
      }
      
      // Aggiungi event listener agli header nazione
      submenu.querySelectorAll('.nation-header').forEach(header => {
        header.addEventListener('click', function() {
          const nationId = this.getAttribute('data-nation-id');
          const nation = this.getAttribute('data-nation');
          nazioneSelezionata = nation;
          toggleNation(nationId);
        });
      });
      
      // Aggiungi event listener ai campionati
      submenu.querySelectorAll('.league-item').forEach(item => {
        item.addEventListener('click', function(e) {
          e.stopPropagation(); // Evita che il click si propaghi al header nazione
          const nation = this.getAttribute('data-nation');
          const index = parseInt(this.getAttribute('data-index'));
          selezionaCampionatoByIndex(nation, index);
        });
      });
    }
    
    // Toggle espansione/collasso nazione
    function toggleNation(nationId) {
      const nationDiv = document.getElementById(nationId);
      const nationHeader = document.querySelector(`[data-nation-id="${nationId}"]`);
      const arrow = nationHeader?.querySelector('.nation-arrow');
      
      if (nationDiv && nationHeader && arrow) {
        const isHidden = nationDiv.classList.contains('hidden');
        if (isHidden) {
          nationDiv.classList.remove('hidden');
          arrow.classList.add('rotate-180');
          expandedNations.add(nationId);
        } else {
          nationDiv.classList.add('hidden');
          arrow.classList.remove('rotate-180');
          expandedNations.delete(nationId);
        }
      }
    }

    // Seleziona campionato
    function selezionaCampionato(league) {
      campionatoSelezionato = league;
      
      // Trova la nazione del campionato selezionato
      if (league) {
        for (const [nation, leagues] of Object.entries(nationsLeagues)) {
          if (leagues.some(l => l.full_name === league)) {
            nazioneSelezionata = nation;
            break;
          }
        }
      } else {
        nazioneSelezionata = null;
      }
      
      renderLeaguesMenu();
      loadMatches();
    }

    // Seleziona campionato per indice (evita problemi con caratteri speciali)
    function selezionaCampionatoByIndex(nation, index) {
      if (nationsLeagues[nation] && nationsLeagues[nation][index]) {
        const league = nationsLeagues[nation][index].full_name;
        selezionaCampionato(league);
      }
    }

    // Seleziona sport
    function selezionaSport(sport, icon, nome) {
      sportSelezionato = sport;
      campionatoSelezionato = null; // Reset filtro campionato
      
      // Per gli altri sport (non calcio), imposta mercato a 1X2
      if (sport !== 'calcio') {
        mercatoSelezionato = '1X2';
        // Aggiorna UI tab
        document.querySelectorAll('.mercato-tab-btn').forEach(tab => {
          tab.classList.remove('bg-yellow-500', 'text-black');
          tab.classList.add('bg-gray-600', 'text-white');
        });
        const tab1X2 = document.getElementById('mercato-1X2');
        if (tab1X2) {
          tab1X2.classList.remove('bg-gray-600', 'text-white');
          tab1X2.classList.add('bg-yellow-500', 'text-black');
        }
      } else {
        // Per calcio, imposta a Principali se non gi√† impostato
        if (mercatoSelezionato !== 'Principali') {
          mercatoSelezionato = 'Principali';
          // Aggiorna UI tab
          document.querySelectorAll('.mercato-tab-btn').forEach(tab => {
            tab.classList.remove('bg-yellow-500', 'text-black');
            tab.classList.add('bg-gray-600', 'text-white');
          });
          const tabPrincipali = document.getElementById('mercato-Principali');
          if (tabPrincipali) {
            tabPrincipali.classList.remove('bg-gray-600', 'text-white');
            tabPrincipali.classList.add('bg-yellow-500', 'text-black');
          }
        }
      }
      
      // Aggiorna UI sidebar
      document.querySelectorAll('.sport-item').forEach(item => {
        item.classList.remove('bg-yellow-500', 'bg-opacity-20');
        // Per calcio, cerca dentro calcio-toggle
        if (item.getAttribute('data-sport') === 'calcio') {
          const calcioToggle = item.querySelector('#calcio-toggle');
          if (calcioToggle) {
            const indicator = calcioToggle.querySelector('.sport-indicator');
            if (indicator) indicator.classList.add('hidden');
          }
        } else {
        const indicator = item.querySelector('.sport-indicator');
        if (indicator) indicator.classList.add('hidden');
        }
      });
      const selectedItem = document.querySelector(`[data-sport="${sport}"]`);
      if (selectedItem) {
        selectedItem.classList.add('bg-yellow-500', 'bg-opacity-20');
        // Per calcio, cerca dentro calcio-toggle
        if (sport === 'calcio') {
          const calcioToggle = selectedItem.querySelector('#calcio-toggle');
          if (calcioToggle) {
            const indicator = calcioToggle.querySelector('.sport-indicator');
            if (indicator) indicator.classList.remove('hidden');
          }
        } else {
        const indicator = selectedItem.querySelector('.sport-indicator');
        if (indicator) indicator.classList.remove('hidden');
        }
      }
      
      // Aggiorna titolo
      document.getElementById('sport-title').textContent = nome;
      
      // Carica campionati se √® calcio
      if (sport === 'calcio') {
        loadLeagues();
      }
      
      // Ricarica i dati
      loadMatches();
    }

    // Seleziona mercato
    function selezionaMercato(mercato) {
      mercatoSelezionato = mercato;
      
      // Aggiorna UI tab
      document.querySelectorAll('.mercato-tab-btn').forEach(tab => {
        tab.classList.remove('bg-yellow-500', 'text-black');
        tab.classList.add('bg-gray-600', 'text-white');
      });
      const selectedTab = document.getElementById(`mercato-${mercato}`);
      if (selectedTab) {
        selectedTab.classList.remove('bg-gray-600', 'text-white');
        selectedTab.classList.add('bg-yellow-500', 'text-black');
      }
      
      // Rerenderizza le partite con il nuovo mercato
      if (matchesData.length > 0) {
        renderMatches();
      }
    }
    
    // Calcola colonne per mercato
    // Helper per estrarre quota Doppia Chance
    function getDoubleChanceQuota(quote, col, homeName, awayName) {
      if (!quote) return null;
      
      // Cerca in main.sp.double_chance
      const doubleChance = quote.main?.sp?.double_chance || quote.double_chance || {};
      
      // Se doubleChance √® direttamente un array
      if (Array.isArray(doubleChance)) {
        for (const odd of doubleChance) {
          const name = (odd.name || '').toLowerCase();
          const homeLower = (homeName || '').toLowerCase();
          const awayLower = (awayName || '').toLowerCase();
          
          // Mappa le combinazioni
          if (col === '1X') {
            if (name.includes('draw')) {
              if (homeLower && name.includes(homeLower) && (!awayLower || !name.includes(awayLower))) {
                return odd.odds;
              }
              if (name.includes('home') && !name.includes('away')) {
                return odd.odds;
              }
            }
            if (homeLower && name.includes(homeLower) && name.includes('or') && name.includes('draw') && 
                (!awayLower || !name.includes(awayLower))) {
              return odd.odds;
            }
          } else if (col === 'X2') {
            if (name.includes('draw')) {
              if (awayLower && name.includes(awayLower) && (!homeLower || !name.includes(homeLower))) {
                return odd.odds;
              }
              if (name.includes('away') && !name.includes('home')) {
                return odd.odds;
              }
            }
            if (awayLower && name.includes(awayLower) && name.includes('or') && name.includes('draw') && 
                (!homeLower || !name.includes(homeLower))) {
              return odd.odds;
            }
          } else if (col === '12') {
            if (!name.includes('draw')) {
              if (homeLower && awayLower && name.includes(homeLower) && name.includes(awayLower)) {
                return odd.odds;
              }
              if (name.includes('home') && name.includes('away')) {
                return odd.odds;
              }
            }
          }
        }
      }
      
      // Se doubleChance ha una propriet√† odds che √® un array
      if (Array.isArray(doubleChance.odds)) {
        for (const odd of doubleChance.odds) {
          const name = (odd.name || '').toLowerCase();
          const homeLower = (homeName || '').toLowerCase();
          const awayLower = (awayName || '').toLowerCase();
          
          // Mappa le combinazioni
          if (col === '1X') {
            // Home or Draw - cerca "home or draw" o "nome_squadra_casa or draw"
            // Pattern: "Fiorentina or Draw" (NON "Draw or Juventus")
            if (name.includes('draw')) {
              // Se contiene "draw", deve contenere il nome della squadra di casa E NON quello ospite
              if (homeLower && name.includes(homeLower) && (!awayLower || !name.includes(awayLower))) {
                return odd.odds;
              }
              // Oppure pattern generico "home or draw" o "draw or home" (senza "away")
              if (name.includes('home') && !name.includes('away')) {
                return odd.odds;
              }
            }
            // Pattern "nome_squadra_casa or draw" (senza "draw" all'inizio e senza nome squadra ospite)
            if (homeLower && name.includes(homeLower) && name.includes('or') && name.includes('draw') && 
                (!awayLower || !name.includes(awayLower))) {
              return odd.odds;
            }
          } else if (col === 'X2') {
            // Draw or Away - cerca "draw or away" o "draw or nome_squadra_ospite"
            // Pattern: "Draw or Juventus" (NON "Fiorentina or Draw")
            if (name.includes('draw')) {
              // Se contiene "draw", deve contenere il nome della squadra ospite E NON quello di casa
              if (awayLower && name.includes(awayLower) && (!homeLower || !name.includes(homeLower))) {
                return odd.odds;
              }
              // Oppure pattern generico "draw or away" o "away or draw" (senza "home")
              if (name.includes('away') && !name.includes('home')) {
                return odd.odds;
              }
            }
            // Pattern "draw or nome_squadra_ospite" (senza nome squadra di casa)
            if (awayLower && name.includes(awayLower) && name.includes('or') && name.includes('draw') && 
                (!homeLower || !name.includes(homeLower))) {
              return odd.odds;
            }
          } else if (col === '12') {
            // Home or Away - cerca "home or away" o "nome_squadra1 or nome_squadra2" (senza draw)
            // Pattern: "Fiorentina or Juventus" o "Home or Away"
            if (!name.includes('draw')) {
              // Deve contenere entrambi i nomi delle squadre
              if (homeLower && awayLower && name.includes(homeLower) && name.includes(awayLower)) {
                return odd.odds;
              }
              // Oppure pattern generico "home or away" o "away or home"
              if (name.includes('home') && name.includes('away')) {
                return odd.odds;
              }
            }
          }
        }
      }
      
      // Fallback: cerca direttamente per nome
      if (doubleChance[col]) {
        return doubleChance[col];
      }
      
      return null;
    }

    // Helper per formattare quota con 2 decimali
    function formattaQuota(quota) {
      if (quota === '-' || quota === null || quota === undefined) {
        return '-';
      }
      const num = parseFloat(quota);
      if (isNaN(num)) {
        return quota; // Restituisci il valore originale se non √® un numero
      }
      return num.toFixed(2);
    }

    // Helper per estrarre quota 1X2 dal JSON (per basket e altri sport)
    function get1X2Quota(quote, col, sport) {
      if (!quote) return null;
      
      // Per l'hockey, cerca in 3_way con name "Money Line" e header "1", "2" o "Tie" (per X)
      if (sport === 'hockey' || sport === 'ice_hockey') {
        const threeWay = quote.main?.sp?.['3_way'] || quote['3_way'] || {};
        
        // Se threeWay √® direttamente un array
        if (Array.isArray(threeWay)) {
          for (const odd of threeWay) {
            const name = (odd.name || '').toLowerCase().trim();
            const header = (odd.header || '').trim();
            if (name === 'money line') {
              if (col === '1' && header === '1') {
                return odd.odds;
              } else if (col === '2' && header === '2') {
                return odd.odds;
              } else if (col === 'X' && header.toLowerCase() === 'tie') {
                return odd.odds;
              }
            }
          }
        }
        
        // Se threeWay ha una propriet√† odds che √® un array
        if (Array.isArray(threeWay.odds)) {
          for (const odd of threeWay.odds) {
            const name = (odd.name || '').toLowerCase().trim();
            const header = (odd.header || '').trim();
            if (name === 'money line') {
              if (col === '1' && header === '1') {
                return odd.odds;
              } else if (col === '2' && header === '2') {
                return odd.odds;
              } else if (col === 'X' && header.toLowerCase() === 'tie') {
                return odd.odds;
              }
            }
          }
        }
        
        return null;
      }
      
      // Per il volley, cerca in game_lines con name "Winner" e header "1" o "2"
      if (sport === 'volleyball' || sport === 'volley') {
        const gameLines = quote.main?.sp?.game_lines || quote.game_lines || {};
        
        // Se gameLines √® direttamente un array
        if (Array.isArray(gameLines)) {
          for (const odd of gameLines) {
            const name = (odd.name || '').toLowerCase().trim();
            const header = (odd.header || '').trim();
            if (name === 'winner' && 
                ((col === '1' && header === '1') || (col === '2' && header === '2'))) {
              return odd.odds;
            }
          }
        }
        
        // Se gameLines ha una propriet√† odds che √® un array
        if (Array.isArray(gameLines.odds)) {
          for (const odd of gameLines.odds) {
            const name = (odd.name || '').toLowerCase().trim();
            const header = (odd.header || '').trim();
            if (name === 'winner' && 
                ((col === '1' && header === '1') || (col === '2' && header === '2'))) {
              return odd.odds;
            }
          }
        }
        
        return null;
      }
      
      // Per il waterpolo, cerca in game_lines con name "To Win" e header "1" o "2"
      if (sport === 'water polo' || sport === 'waterpolo') {
        const gameLines = quote.main?.sp?.game_lines || quote.game_lines || {};
        
        // Se gameLines √® direttamente un array
        if (Array.isArray(gameLines)) {
          for (const odd of gameLines) {
            const name = (odd.name || '').toLowerCase().trim();
            const header = (odd.header || '').trim();
            if (name === 'to win' && 
                ((col === '1' && header === '1') || (col === '2' && header === '2'))) {
              return odd.odds;
            }
          }
        }
        
        // Se gameLines ha una propriet√† odds che √® un array
        if (Array.isArray(gameLines.odds)) {
          for (const odd of gameLines.odds) {
            const name = (odd.name || '').toLowerCase().trim();
            const header = (odd.header || '').trim();
            if (name === 'to win' && 
                ((col === '1' && header === '1') || (col === '2' && header === '2'))) {
              return odd.odds;
            }
          }
        }
        
        return null;
      }
      
      // Per la pallamano, cerca in game_lines con name "To Win" e header "1" o "2"
      if (sport === 'pallamano') {
        const gameLines = quote.main?.sp?.game_lines || quote.game_lines || {};
        
        // Se gameLines √® direttamente un array
        if (Array.isArray(gameLines)) {
          for (const odd of gameLines) {
            const name = (odd.name || '').toLowerCase().trim();
            const header = (odd.header || '').trim();
            if (name === 'to win' && 
                ((col === '1' && header === '1') || (col === '2' && header === '2'))) {
              return odd.odds;
            }
          }
        }
        
        // Se gameLines ha una propriet√† odds che √® un array
        if (Array.isArray(gameLines.odds)) {
          for (const odd of gameLines.odds) {
            const name = (odd.name || '').toLowerCase().trim();
            const header = (odd.header || '').trim();
            if (name === 'to win' && 
                ((col === '1' && header === '1') || (col === '2' && header === '2'))) {
              return odd.odds;
            }
          }
        }
        
        return null;
      }
      
      // Per il football (american football), cerca in game_lines con name "Money Line" e header "1" o "2"
      if (sport === 'football' || sport === 'american football') {
        const gameLines = quote.main?.sp?.game_lines || quote.game_lines || {};
        
        // Se gameLines √® direttamente un array
        if (Array.isArray(gameLines)) {
          for (const odd of gameLines) {
            const name = (odd.name || '').toLowerCase().trim();
            const header = (odd.header || '').trim();
            if (name === 'money line' && 
                ((col === '1' && header === '1') || (col === '2' && header === '2'))) {
              return odd.odds;
            }
          }
        }
        
        // Se gameLines ha una propriet√† odds che √® un array
        if (Array.isArray(gameLines.odds)) {
          for (const odd of gameLines.odds) {
            const name = (odd.name || '').toLowerCase().trim();
            const header = (odd.header || '').trim();
            if (name === 'money line' && 
                ((col === '1' && header === '1') || (col === '2' && header === '2'))) {
              return odd.odds;
            }
          }
        }
        
        return null;
      }
      
      // Per il rugby, cerca in game_betting_3_way con name "Result" e header "1", "Tie" (per X), o "2"
      if (sport === 'rugby') {
        const gameBetting3Way = quote.main?.sp?.game_betting_3_way || quote.game_betting_3_way || {};
        
        // Se gameBetting3Way √® direttamente un array
        if (Array.isArray(gameBetting3Way)) {
          for (const odd of gameBetting3Way) {
            const name = (odd.name || '').toLowerCase().trim();
            const header = (odd.header || '').trim();
            if (name === 'result') {
              if (col === '1' && header === '1') {
                return odd.odds;
              } else if (col === 'X' && header.toLowerCase() === 'tie') {
                return odd.odds;
              } else if (col === '2' && header === '2') {
                return odd.odds;
              }
            }
          }
        }
        
        // Se gameBetting3Way ha una propriet√† odds che √® un array
        if (Array.isArray(gameBetting3Way.odds)) {
          for (const odd of gameBetting3Way.odds) {
            const name = (odd.name || '').toLowerCase().trim();
            const header = (odd.header || '').trim();
            if (name === 'result') {
              if (col === '1' && header === '1') {
                return odd.odds;
              } else if (col === 'X' && header.toLowerCase() === 'tie') {
                return odd.odds;
              } else if (col === '2' && header === '2') {
                return odd.odds;
              }
            }
          }
        }
        
        return null;
      }
      
      // Per il boxing, cerca in to_win_fight con name "1" o "2"
      if (sport === 'boxing') {
        const toWinFight = quote.main?.sp?.to_win_fight || quote.to_win_fight || {};
        
        // Se toWinFight √® direttamente un array
        if (Array.isArray(toWinFight)) {
          for (const odd of toWinFight) {
            const name = (odd.name || '').trim();
            if ((col === '1' && name === '1') || (col === '2' && name === '2')) {
              return odd.odds;
            }
          }
        }
        
        // Se toWinFight ha una propriet√† odds che √® un array
        if (Array.isArray(toWinFight.odds)) {
          for (const odd of toWinFight.odds) {
            const name = (odd.name || '').trim();
            if ((col === '1' && name === '1') || (col === '2' && name === '2')) {
              return odd.odds;
            }
          }
        }
        
        return null;
      }
      
      // Per il futsal, cerca in money_line con name "Result" e header "1", "Tie" (per X), o "2"
      if (sport === 'futsal') {
        const moneyLine = quote.main?.sp?.money_line || quote.money_line || {};
        
        // Se moneyLine √® direttamente un array
        if (Array.isArray(moneyLine)) {
          for (const odd of moneyLine) {
            const name = (odd.name || '').toLowerCase().trim();
            const header = (odd.header || '').trim();
            if (name === 'result') {
              if (col === '1' && header === '1') {
                return odd.odds;
              } else if (col === 'X' && header.toLowerCase() === 'tie') {
                return odd.odds;
              } else if (col === '2' && header === '2') {
                return odd.odds;
              }
            }
          }
        }
        
        // Se moneyLine ha una propriet√† odds che √® un array
        if (Array.isArray(moneyLine.odds)) {
          for (const odd of moneyLine.odds) {
            const name = (odd.name || '').toLowerCase().trim();
            const header = (odd.header || '').trim();
            if (name === 'result') {
              if (col === '1' && header === '1') {
                return odd.odds;
              } else if (col === 'X' && header.toLowerCase() === 'tie') {
                return odd.odds;
              } else if (col === '2' && header === '2') {
                return odd.odds;
              }
            }
          }
        }
        
        return null;
      }
      
      // Per l'e-sport, cerca in match_lines con name "To Win" e header "1" o "2"
      if (sport === 'e-sport' || sport === 'esport') {
        const matchLines = quote.main?.sp?.match_lines || quote.match_lines || {};
        
        // Se matchLines √® direttamente un array
        if (Array.isArray(matchLines)) {
          for (const odd of matchLines) {
            const name = (odd.name || '').toLowerCase().trim();
            const header = (odd.header || '').trim();
            if (name === 'to win' && 
                ((col === '1' && header === '1') || (col === '2' && header === '2'))) {
              return odd.odds;
            }
          }
        }
        
        // Se matchLines ha una propriet√† odds che √® un array
        if (Array.isArray(matchLines.odds)) {
          for (const odd of matchLines.odds) {
            const name = (odd.name || '').toLowerCase().trim();
            const header = (odd.header || '').trim();
            if (name === 'to win' && 
                ((col === '1' && header === '1') || (col === '2' && header === '2'))) {
              return odd.odds;
            }
          }
        }
        
        return null;
      }
      
      // Per il badminton, cerca in match_lines con name "To Win" e header "1" o "2"
      if (sport === 'badminton') {
        const matchLines = quote.main?.sp?.match_lines || quote.match_lines || {};
        
        // Se matchLines √® direttamente un array
        if (Array.isArray(matchLines)) {
          for (const odd of matchLines) {
            const name = (odd.name || '').toLowerCase().trim();
            const header = (odd.header || '').trim();
            if (name === 'to win' && 
                ((col === '1' && header === '1') || (col === '2' && header === '2'))) {
              return odd.odds;
            }
          }
        }
        
        // Se matchLines ha una propriet√† odds che √® un array
        if (Array.isArray(matchLines.odds)) {
          for (const odd of matchLines.odds) {
            const name = (odd.name || '').toLowerCase().trim();
            const header = (odd.header || '').trim();
            if (name === 'to win' && 
                ((col === '1' && header === '1') || (col === '2' && header === '2'))) {
              return odd.odds;
            }
          }
        }
        
        return null;
      }
      
      // Per il cricket, cerca in to_win_the_match con name "1" o "2"
      if (sport === 'cricket') {
        const toWinTheMatch = quote.main?.sp?.to_win_the_match || quote.to_win_the_match || {};
        
        // Se toWinTheMatch √® direttamente un array
        if (Array.isArray(toWinTheMatch)) {
          for (const odd of toWinTheMatch) {
            const name = (odd.name || '').trim();
            if ((col === '1' && name === '1') || (col === '2' && name === '2')) {
              return odd.odds;
            }
          }
        }
        
        // Se toWinTheMatch ha una propriet√† odds che √® un array
        if (Array.isArray(toWinTheMatch.odds)) {
          for (const odd of toWinTheMatch.odds) {
            const name = (odd.name || '').trim();
            if ((col === '1' && name === '1') || (col === '2' && name === '2')) {
              return odd.odds;
            }
          }
        }
        
        return null;
      }
      
      // Per lo squash, cerca in schedule.sp.main con name "1" o "2"
      if (sport === 'squash') {
        const scheduleMain = quote.schedule?.sp?.main || quote.main || {};
        
        // Se scheduleMain √® direttamente un array
        if (Array.isArray(scheduleMain)) {
          for (const odd of scheduleMain) {
            const name = (odd.name || '').trim();
            if ((col === '1' && name === '1') || (col === '2' && name === '2')) {
              return odd.odds;
            }
          }
        }
        
        // Fallback: cerca in quote.main.sp.main se esiste
        const mainSp = quote.main?.sp?.main;
        if (Array.isArray(mainSp)) {
          for (const odd of mainSp) {
            const name = (odd.name || '').trim();
            if ((col === '1' && name === '1') || (col === '2' && name === '2')) {
              return odd.odds;
            }
          }
        }
        
        return null;
      }
      
      // Per il ping pong, cerca in match_lines con name "To Win" e header "1" o "2"
      if (sport === 'pingpong' || sport === 'ping_pong') {
        const matchLines = quote.main?.sp?.match_lines || quote.match_lines || {};
        
        // Se matchLines √® direttamente un array
        if (Array.isArray(matchLines)) {
          for (const odd of matchLines) {
            const name = (odd.name || '').toLowerCase().trim();
            const header = (odd.header || '').trim();
            if (name === 'to win' && 
                ((col === '1' && header === '1') || (col === '2' && header === '2'))) {
              return odd.odds;
            }
          }
        }
        
        // Se matchLines ha una propriet√† odds che √® un array
        if (Array.isArray(matchLines.odds)) {
          for (const odd of matchLines.odds) {
            const name = (odd.name || '').toLowerCase().trim();
            const header = (odd.header || '').trim();
            if (name === 'to win' && 
                ((col === '1' && header === '1') || (col === '2' && header === '2'))) {
              return odd.odds;
            }
          }
        }
        
        return null;
      }
      
      // Per il basket, cerca in game_lines con name "Money Line" e header "1" o "2"
      if (sport === 'basket') {
        // Per la X, restituisci sempre 10
        if (col === 'X') {
          return '10';
        }
        
        const gameLines = quote.main?.sp?.game_lines || quote.game_lines || {};
        
        // Se gameLines √® direttamente un array
        if (Array.isArray(gameLines)) {
          for (const odd of gameLines) {
            const name = (odd.name || '').toLowerCase().trim();
            const header = (odd.header || '').trim();
            if (name === 'money line' && 
                ((col === '1' && header === '1') || (col === '2' && header === '2'))) {
              return odd.odds;
            }
          }
        }
        
        // Se gameLines ha una propriet√† odds che √® un array
        if (Array.isArray(gameLines.odds)) {
          for (const odd of gameLines.odds) {
            const name = (odd.name || '').toLowerCase().trim();
            const header = (odd.header || '').trim();
            if (name === 'money line' && 
                ((col === '1' && header === '1') || (col === '2' && header === '2'))) {
              return odd.odds;
            }
          }
        }
        
        // Fallback: cerca anche in game_lines_3_way
        const gameLines3Way = quote.main?.sp?.game_lines_3_way || quote.game_lines_3_way || {};
        
        if (Array.isArray(gameLines3Way)) {
          for (const odd of gameLines3Way) {
            const name = (odd.name || odd.header || '').toLowerCase().trim();
            if ((col === '1' && (name === '1' || name === 'home' || name === 'casa')) ||
                (col === '2' && (name === '2' || name === 'away' || name === 'trasferta' || name === 'ospiti'))) {
              return odd.odds;
            }
          }
        }
        
        if (Array.isArray(gameLines3Way.odds)) {
          for (const odd of gameLines3Way.odds) {
            const name = (odd.name || odd.header || '').toLowerCase().trim();
            if ((col === '1' && (name === '1' || name === 'home' || name === 'casa')) ||
                (col === '2' && (name === '2' || name === 'away' || name === 'trasferta' || name === 'ospiti'))) {
              return odd.odds;
            }
          }
        }
        
        return null;
      }
      
      // Per gli altri sport, cerca in game_lines_3_way
      const gameLines3Way = quote.main?.sp?.game_lines_3_way || quote.game_lines_3_way || {};
      
      // Se gameLines3Way √® direttamente un array
      if (Array.isArray(gameLines3Way)) {
        for (const odd of gameLines3Way) {
          const name = (odd.name || odd.header || '').toLowerCase().trim();
          if ((col === '1' && (name === '1' || name === 'home' || name === 'casa')) ||
              (col === '2' && (name === '2' || name === 'away' || name === 'trasferta' || name === 'ospiti')) ||
              (col === 'X' && (name === 'x' || name === 'draw' || name === 'pareggio'))) {
            return odd.odds;
          }
        }
      }
      
      // Se gameLines3Way ha una propriet√† odds che √® un array
      if (Array.isArray(gameLines3Way.odds)) {
        for (const odd of gameLines3Way.odds) {
          const name = (odd.name || odd.header || '').toLowerCase().trim();
          if ((col === '1' && (name === '1' || name === 'home' || name === 'casa')) ||
              (col === '2' && (name === '2' || name === 'away' || name === 'trasferta' || name === 'ospiti')) ||
              (col === 'X' && (name === 'x' || name === 'draw' || name === 'pareggio'))) {
            return odd.odds;
          }
        }
      }
      
      // Cerca in main.sp.full_time_result
      const fullTimeResult = quote.main?.sp?.full_time_result || quote.full_time_result || {};
      
      // Se fullTimeResult √® direttamente un array
      if (Array.isArray(fullTimeResult)) {
        for (const odd of fullTimeResult) {
          const name = (odd.name || odd.header || '').toLowerCase().trim();
          if ((col === '1' && (name === '1' || name === 'home' || name === 'casa')) ||
              (col === '2' && (name === '2' || name === 'away' || name === 'trasferta' || name === 'ospiti')) ||
              (col === 'X' && (name === 'x' || name === 'draw' || name === 'pareggio'))) {
            return odd.odds;
          }
        }
      }
      
      // Se fullTimeResult ha una propriet√† odds che √® un array
      if (Array.isArray(fullTimeResult.odds)) {
        for (const odd of fullTimeResult.odds) {
          const name = (odd.name || odd.header || '').toLowerCase().trim();
          if ((col === '1' && (name === '1' || name === 'home' || name === 'casa')) ||
              (col === '2' && (name === '2' || name === 'away' || name === 'trasferta' || name === 'ospiti')) ||
              (col === 'X' && (name === 'x' || name === 'draw' || name === 'pareggio'))) {
            return odd.odds;
          }
        }
      }
      
      // Cerca anche in match_winner o to_win_match
      const matchWinner = quote.main?.sp?.match_winner || quote.match_winner || quote.to_win_match || {};
      
      if (Array.isArray(matchWinner)) {
        for (const odd of matchWinner) {
          const name = (odd.name || odd.header || '').toLowerCase().trim();
          if ((col === '1' && (name === '1' || name === 'home' || name === 'casa')) ||
              (col === '2' && (name === '2' || name === 'away' || name === 'trasferta' || name === 'ospiti'))) {
            return odd.odds;
          }
        }
      }
      
      if (Array.isArray(matchWinner.odds)) {
        for (const odd of matchWinner.odds) {
          const name = (odd.name || odd.header || '').toLowerCase().trim();
          if ((col === '1' && (name === '1' || name === 'home' || name === 'casa')) ||
              (col === '2' && (name === '2' || name === 'away' || name === 'trasferta' || name === 'ospiti'))) {
            return odd.odds;
          }
        }
      }
      
      return null;
    }

    // Helper per estrarre quota Over/Under
    function getOverUnderQuota(quote, col) {
      if (!quote) return null;
      
      // Estrai il valore (es. "2.5" da "Over 2.5" o "Under 2.5")
      const match = col.match(/(Over|Under)\s*(\d+\.?\d*)/i);
      if (!match) return null;
      
      const type = match[1].toLowerCase(); // "over" o "under"
      const value = match[2]; // "2.5", "1.5", etc.
      
      // Prima cerca in goals_over_under (solitamente per 2.5)
      const goalsOU = quote.main?.sp?.goals_over_under || quote.goals_over_under || {};
      
      // Se goalsOU √® direttamente un array
      if (Array.isArray(goalsOU)) {
        const item = goalsOU.find(o => {
          const oName = String(o.name || '').trim();
          const oHeader = (o.header || '').toLowerCase().trim();
          return oName === value && oHeader === type;
        });
        if (item && item.odds) return item.odds;
      }
      
      // Se goalsOU ha una propriet√† odds che √® un array
      if (Array.isArray(goalsOU.odds)) {
        const item = goalsOU.odds.find(o => {
          const oName = String(o.name || '').trim();
          const oHeader = (o.header || '').toLowerCase().trim();
          return oName === value && oHeader === type;
        });
        if (item && item.odds) return item.odds;
      }
      
      // Poi cerca in alternative_total_goals (per tutti i valori inclusi 2.5 se non trovato sopra)
      const altGoals = quote.main?.sp?.alternative_total_goals || quote.alternative_total_goals || {};
      
      // Se altGoals √® direttamente un array
      if (Array.isArray(altGoals)) {
        const item = altGoals.find(o => {
          const oName = String(o.name || '').trim();
          const oHeader = (o.header || '').toLowerCase().trim();
          return oName === value && oHeader === type;
        });
        if (item && item.odds) return item.odds;
      }
      
      // Se altGoals ha una propriet√† odds che √® un array
      if (Array.isArray(altGoals.odds)) {
        const item = altGoals.odds.find(o => {
          const oName = String(o.name || '').trim();
          const oHeader = (o.header || '').toLowerCase().trim();
          return oName === value && oHeader === type;
        });
        if (item && item.odds) return item.odds;
      }
      
      // Fallback: cerca in match_goals
      const matchGoals = quote.match_goals || {};
      if (matchGoals[col]) {
        return matchGoals[col];
      }
      
      return null;
    }

    function getColonnePerMercato(mercato) {
      // Per il basket, mostra 1X2 (1, X, 2) da game_lines_3_way
      if (sportSelezionato === 'basket') {
        if (mercato === 'Principali' || mercato === '1X2') {
          return ['1', 'X', '2'];
        }
      }
      
      // Per il tennis, mostra solo Money Line (1 e 2, senza X)
      if (sportSelezionato === 'tennis') {
        if (mercato === 'Principali' || mercato === '1X2') {
          return ['1', '2'];
        }
      }
      
      // Per l'e-sport, mostra solo To Win (1 e 2, senza X)
      if (sportSelezionato === 'e-sport' || sportSelezionato === 'esport') {
        if (mercato === 'Principali' || mercato === '1X2') {
          return ['1', '2'];
        }
      }
      
      // Per il boxing, mostra solo To Win Fight (1 e 2, senza X)
      if (sportSelezionato === 'boxing') {
        if (mercato === 'Principali' || mercato === '1X2') {
          return ['1', '2'];
        }
      }
      
      // Per il badminton, mostra solo To Win (1 e 2, senza X)
      if (sportSelezionato === 'badminton') {
        if (mercato === 'Principali' || mercato === '1X2') {
          return ['1', '2'];
        }
      }
      
      // Per il cricket, mostra solo To Win the Match (1 e 2, senza X)
      if (sportSelezionato === 'cricket') {
        if (mercato === 'Principali' || mercato === '1X2') {
          return ['1', '2'];
        }
      }
      
      // Per lo squash, mostra solo 1 e 2 (senza X)
      if (sportSelezionato === 'squash') {
        if (mercato === 'Principali' || mercato === '1X2') {
          return ['1', '2'];
        }
      }
      
      // Per il ping pong, mostra solo Money Line (1 e 2, senza X)
      if (sportSelezionato === 'pingpong' || sportSelezionato === 'ping_pong') {
        if (mercato === 'Principali' || mercato === '1X2') {
          return ['1', '2'];
        }
      }
      
      // Per il volley, mostra solo Winner (1 e 2, senza X)
      if (sportSelezionato === 'volleyball' || sportSelezionato === 'volley') {
        if (mercato === 'Principali' || mercato === '1X2') {
          return ['1', '2'];
        }
      }
      
      // Per il waterpolo, mostra solo 1 e 2 (senza X)
      if (sportSelezionato === 'water polo' || sportSelezionato === 'waterpolo') {
        if (mercato === 'Principali' || mercato === '1X2') {
          return ['1', '2'];
        }
      }
      
      // Per la pallamano, mostra solo 1 e 2 (senza X)
      if (sportSelezionato === 'pallamano') {
        if (mercato === 'Principali' || mercato === '1X2') {
          return ['1', '2'];
        }
      }
      
      // Per il futsal, mostra solo 1X2 (come gli altri sport non-calcio)
      if (sportSelezionato === 'futsal') {
        if (mercato === 'Principali' || mercato === '1X2') {
          return ['1', 'X', '2'];
        }
      }
      
      // Per gli altri sport (non calcio), mostra solo 1X2
      if (sportSelezionato !== 'calcio' && mercato === 'Principali') {
        return ['1', 'X', '2'];
      }
      
      switch(mercato) {
        case 'Principali':
          // Solo per calcio: 1X2 (3) + DC (3) + GG/NG (2) + Over/Under 1.5 e 2.5 (4) = 12 colonne
          return [
            // 1X2
            { type: '1X2', label: '1' },
            { type: '1X2', label: 'X' },
            { type: '1X2', label: '2' },
            // Doppia Chance
            { type: 'Doppia Chance', label: '1X' },
            { type: 'Doppia Chance', label: '12' },
            { type: 'Doppia Chance', label: 'X2' },
            // Gol Totali
            { type: 'Gol Totali', label: 'GG' },
            { type: 'Gol Totali', label: 'NG' },
            // Over/Under
            { type: 'Over/Under', label: 'Over 1.5' },
            { type: 'Over/Under', label: 'Under 1.5' },
            { type: 'Over/Under', label: 'Over 2.5' },
            { type: 'Over/Under', label: 'Under 2.5' }
          ];
        case '1X2':
          // Per il basket, restituisce gi√† ['1', 'X', '2'] sopra
          if (sportSelezionato === 'basket') {
            return ['1', 'X', '2'];
          }
          // Per il tennis, solo Money Line (1 e 2, senza X)
          if (sportSelezionato === 'tennis') {
            return ['1', '2'];
          }
          // Per il ping pong, solo Money Line (1 e 2, senza X)
          if (sportSelezionato === 'pingpong' || sportSelezionato === 'ping_pong') {
            return ['1', '2'];
          }
          return ['1', 'X', '2'];
        case 'Doppia Chance':
          return ['1X', '12', 'X2'];
        case 'Over/Under':
          return ['Over 2.5', 'Under 2.5'];
        case 'Gol Totali':
          return ['GG', 'NG'];
        case 'Handicap':
          return ['H1', 'HX', 'H2'];
        case 'Ris. Esatto':
          return ['0-0', '1-0', '0-1'];
        case 'Corner':
          return ['Over', 'Under'];
        case 'Cartellini':
          return ['Over', 'Under'];
        case 'Primo Gol':
          return ['Casa', 'Ospiti', 'Nessuno'];
        case '1T':
          return ['1', 'X', '2'];
        case '2T':
          return ['1', 'X', '2'];
        case 'DNB':
          return ['1', '2'];
        default:
          return ['1', 'X', '2'];
      }
    }

    // Carica i dati delle partite
    async function loadMatches() {
      try {
        const matchesBody = document.getElementById('matches-body');
        if (!matchesBody) {
          console.error('Elemento matches-body non trovato');
          return;
        }
        
        const colonne = getColonnePerMercato(mercatoSelezionato);
        const numCols = 4 + (Array.isArray(colonne) && colonne[0]?.type ? colonne.length : colonne.length);
        matchesBody.innerHTML = `<tr><td colspan="${numCols}" class="text-center py-4 text-gray-400">Caricamento dati...</td></tr>`;
        
        // Usa URL assoluto per evitare problemi su Render
        // Ridotto limite a 200 per performance
        const sportForMongo = getSportForMongo(sportSelezionato);
        const url = campionatoSelezionato 
          ? `${window.location.origin}/api/events?sport=${sportForMongo}&limit=200&league=${encodeURIComponent(campionatoSelezionato)}`
          : `${window.location.origin}/api/events?sport=${sportForMongo}&limit=200`;
        
        console.log('loadMatches: URL completo', url);
        const response = await fetch(url);
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        
        if (data.success && data.results) {
          matchesData = data.results;
          renderMatches();
        } else {
          const colonne = getColonnePerMercato(mercatoSelezionato);
          const numCols = 4 + (Array.isArray(colonne) && colonne[0]?.type ? colonne.length : colonne.length);
          matchesBody.innerHTML = `<tr><td colspan="${numCols}" class="text-center py-4 text-red-400">Nessun dato disponibile</td></tr>`;
        }
      } catch (error) {
        console.error('Errore caricamento dati:', error);
        const matchesBody = document.getElementById('matches-body');
        if (matchesBody) {
          const colonne = getColonnePerMercato(mercatoSelezionato);
          const numCols = 4 + (Array.isArray(colonne) && colonne[0]?.type ? colonne.length : colonne.length);
          matchesBody.innerHTML = `<tr><td colspan="${numCols}" class="text-center py-4 text-red-400">Errore nel caricamento dei dati: ${error.message}</td></tr>`;
        }
      }
    }

    // Renderizza le partite
    function renderMatches() {
      try {
        const tbody = document.getElementById('matches-body');
        const thead = document.getElementById('table-header');
        
        if (!tbody || !thead) {
          console.error('Elementi tabella non trovati');
          return;
        }
        
        if (matchesData.length === 0) {
          const colonne = getColonnePerMercato(mercatoSelezionato);
          const numCols = 4 + (Array.isArray(colonne) && colonne[0]?.type ? colonne.length : colonne.length);
          tbody.innerHTML = `<tr><td colspan="${numCols}" class="text-center py-4 text-gray-400">Nessuna partita disponibile</td></tr>`;
          return;
        }

        // Aggiorna header in base al mercato
        let colonne = getColonnePerMercato(mercatoSelezionato);
        const isPrincipali = Array.isArray(colonne) && colonne[0]?.type;
        
        // Aggiorna header tabella
        let headerHtml = `
          <th class="px-2 py-1 border-b border-gray-600 text-center">Id</th>
          <th class="px-2 py-1 border-b border-gray-600 text-center">Data</th>
          <th class="px-2 py-1 border-b border-gray-600 text-center">Evento</th>
        `;
        
        // Se colonne √® un array di oggetti (Principali), usa label, altrimenti usa direttamente la stringa
        if (isPrincipali) {
          colonne.forEach(col => {
            headerHtml += `<th class="px-1 py-1 border-b border-gray-600">${col.label}</th>`;
          });
        } else {
        colonne.forEach(col => {
          headerHtml += `<th class="px-1 py-1 border-b border-gray-600">${col}</th>`;
        });
        }
        headerHtml += `<th class="px-2 py-1 border-b border-gray-600 text-center">Mercati</th>`;
        thead.innerHTML = `<tr>${headerHtml}</tr>`;

        let html = '';
        const grouped = {};
        
        // Raggruppa per data e poi per campionato
        matchesData.forEach(ev => {
          const date = new Date(ev.start_time_date || ev.start_time);
          const dateStr = date.toLocaleDateString('it-IT');
          const league = ev.league || 'Altri Campionati';
          
          if (!grouped[dateStr]) {
            grouped[dateStr] = {};
          }
          if (!grouped[dateStr][league]) {
            grouped[dateStr][league] = [];
          }
          grouped[dateStr][league].push(ev);
        });

        Object.keys(grouped).sort().forEach(date => {
          const numCols = 4 + colonne.length;
          html += `<tr><td colspan="${numCols}" class="bg-gray-900 text-yellow-400 font-bold px-2 py-1 border-b border-gray-700">${date}</td></tr>`;
          
          // Per ogni data, mostra i campionati
          Object.keys(grouped[date]).sort().forEach(league => {
            html += `<tr><td colspan="${numCols}" class="bg-gray-800 text-blue-400 font-semibold px-4 py-1 border-b border-gray-600 text-xs">üèÜ ${league}</td></tr>`;
            
            grouped[date][league].forEach(ev => {
              const time = new Date(ev.start_time_date || ev.start_time).toLocaleTimeString('it-IT', { hour: '2-digit', minute: '2-digit' });
              const quote_1x2 = ev.quote_1x2 || {};
              const matchId = ev.match_id || ev._id;
              const teams = `${ev.home_name || ''} - ${ev.away_name || ''}`;
              
              html += `<tr class="bg-gray-800 hover:bg-gray-700">
                <td class="px-2 py-1 border-b border-gray-700 text-center">${matchId}</td>
                <td class="px-2 py-1 border-b border-gray-700 text-center">${time}</td>
                <td class="px-2 py-1 border-b border-gray-700 text-center">${teams}</td>`;
              
              // Aggiungi colonne in base al mercato
              colonne.forEach(col => {
                let quota = '-';
                const quote = ev.quote || {};
                const colLabel = isPrincipali ? col.label : col;
                const colType = isPrincipali ? col.type : mercatoSelezionato;
                
                // Per il basket, estrai le quote 1X2 da game_lines con Money Line
                if (sportSelezionato === 'basket') {
                  quota = get1X2Quota(quote, colLabel || col, 'basket') || quote_1x2[colLabel || col] || '-';
                } else if (sportSelezionato === 'tennis') {
                  // Per il tennis, estrai le quote Money Line (solo 1 e 2, senza X)
                  quota = get1X2Quota(quote, colLabel || col, 'tennis') || quote_1x2[colLabel || col] || '-';
                } else if (sportSelezionato === 'hockey' || sportSelezionato === 'ice_hockey') {
                  // Per l'hockey, estrai le quote 1X2 da 3_way
                  quota = get1X2Quota(quote, colLabel || col, 'hockey') || quote_1x2[colLabel || col] || '-';
                } else if (sportSelezionato === 'volleyball' || sportSelezionato === 'volley') {
                  // Per il volley, estrai le quote da game_line con Winner (solo 1 e 2, senza X)
                  quota = get1X2Quota(quote, colLabel || col, 'volleyball') || quote_1x2[colLabel || col] || '-';
                } else if (sportSelezionato === 'water polo' || sportSelezionato === 'waterpolo') {
                  // Per il waterpolo, estrai le quote da game_lines con To Win (solo 1 e 2, senza X)
                  quota = get1X2Quota(quote, colLabel || col, 'waterpolo') || quote_1x2[colLabel || col] || '-';
                } else if (sportSelezionato === 'pallamano') {
                  // Per la pallamano, estrai le quote da game_lines con To Win (solo 1 e 2, senza X)
                  quota = get1X2Quota(quote, colLabel || col, 'pallamano') || quote_1x2[colLabel || col] || '-';
                } else if (sportSelezionato === 'football' || sportSelezionato === 'american football') {
                  // Per il football (american football), estrai le quote da game_lines con Money Line (solo 1 e 2, senza X)
                  quota = get1X2Quota(quote, colLabel || col, 'football') || quote_1x2[colLabel || col] || '-';
                } else if (sportSelezionato === 'rugby') {
                  // Per il rugby, estrai le quote 1X2 da game_betting_3_way con Result
                  quota = get1X2Quota(quote, colLabel || col, 'rugby') || quote_1x2[colLabel || col] || '-';
                } else if (sportSelezionato === 'e-sport' || sportSelezionato === 'esport') {
                  // Per l'e-sport, estrai le quote da match_lines con To Win (solo 1 e 2, senza X)
                  quota = get1X2Quota(quote, colLabel || col, 'e-sport') || quote_1x2[colLabel || col] || '-';
                } else if (sportSelezionato === 'boxing') {
                  // Per il boxing, estrai le quote da to_win_fight (solo 1 e 2, senza X)
                  quota = get1X2Quota(quote, colLabel || col, 'boxing') || quote_1x2[colLabel || col] || '-';
                } else if (sportSelezionato === 'badminton') {
                  // Per il badminton, estrai le quote da match_lines con To Win (solo 1 e 2, senza X)
                  quota = get1X2Quota(quote, colLabel || col, 'badminton') || quote_1x2[colLabel || col] || '-';
                } else if (sportSelezionato === 'cricket') {
                  // Per il cricket, estrai le quote da to_win_the_match (solo 1 e 2, senza X)
                  quota = get1X2Quota(quote, colLabel || col, 'cricket') || quote_1x2[colLabel || col] || '-';
                } else if (sportSelezionato === 'squash') {
                  // Per lo squash, estrai le quote da schedule.sp.main (solo 1 e 2, senza X)
                  // schedule potrebbe essere a livello root dell'evento, non dentro quote
                  let squashQuote = get1X2Quota(quote, colLabel || col, 'squash');
                  if (!squashQuote && ev.schedule?.sp?.main) {
                    const scheduleMain = ev.schedule.sp.main;
                    if (Array.isArray(scheduleMain)) {
                      for (const odd of scheduleMain) {
                        const name = (odd.name || '').trim();
                        if ((colLabel || col) === '1' && name === '1') {
                          squashQuote = odd.odds;
                          break;
                        } else if ((colLabel || col) === '2' && name === '2') {
                          squashQuote = odd.odds;
                          break;
                        }
                      }
                    }
                  }
                  quota = squashQuote || quote_1x2[colLabel || col] || '-';
                } else if (sportSelezionato === 'futsal') {
                  // Per il futsal, estrai le quote 1X2 da money_line con Result
                  quota = get1X2Quota(quote, colLabel || col, 'futsal') || quote_1x2[colLabel || col] || '-';
                } else if (sportSelezionato === 'pingpong' || sportSelezionato === 'ping_pong') {
                  // Per il ping pong, estrai le quote da match_lines con To Win (solo 1 e 2, senza X)
                  quota = get1X2Quota(quote, colLabel || col, 'pingpong') || quote_1x2[colLabel || col] || '-';
                } else if (isPrincipali) {
                  // Gestione Principali: usa colType per determinare il mercato
                  if (colType === '1X2') {
                    quota = quote_1x2[colLabel] || '-';
                  } else if (colType === 'Doppia Chance') {
                    const homeName = ev.home_name || '';
                    const awayName = ev.away_name || '';
                    quota = getDoubleChanceQuota(quote, colLabel, homeName, awayName) || '-';
                  } else if (colType === 'Over/Under') {
                    quota = getOverUnderQuota(quote, colLabel) || '-';
                  } else if (colType === 'Gol Totali') {
                    const btts = quote['both_teams_to_score'] || {};
                    if (Array.isArray(btts)) {
                      const item = btts.find(o => (o.name || o.header) === colLabel || (colLabel === 'GG' && (o.name === 'Yes' || o.name === 'S√¨')) || (colLabel === 'NG' && (o.name === 'No' || o.name === 'No')));
                      quota = item?.odds || '-';
                    } else {
                      quota = btts[colLabel === 'GG' ? 'Yes' : 'No'] || '-';
                    }
                  }
                } else if (mercatoSelezionato === '1X2') {
                  quota = quote_1x2[col] || '-';
                } else if (mercatoSelezionato === 'Doppia Chance') {
                  // Usa la funzione helper per estrarre la quota Doppia Chance
                  const homeName = ev.home_name || '';
                  const awayName = ev.away_name || '';
                  quota = getDoubleChanceQuota(quote, col, homeName, awayName) || '-';
                  // Debug temporaneo
                  if (quota === '-' && quote) {
                    console.log('DC non trovata:', { col, homeName, awayName, quote: JSON.stringify(quote).substring(0, 200) });
                  }
                } else if (mercatoSelezionato === 'Over/Under') {
                  // Usa la funzione helper per estrarre la quota Over/Under
                  quota = getOverUnderQuota(quote, col) || '-';
                  // Debug temporaneo
                  if (quota === '-' && quote) {
                    console.log('OU non trovata:', { col, quote: JSON.stringify(quote).substring(0, 200) });
                  }
                } else if (mercatoSelezionato === 'Gol Totali') {
                  const btts = quote['both_teams_to_score'] || {};
                  if (Array.isArray(btts)) {
                    const item = btts.find(o => (o.name || o.header) === col || (col === 'GG' && (o.name === 'Yes' || o.name === 'S√¨')) || (col === 'NG' && (o.name === 'No' || o.name === 'No')));
                    quota = item?.odds || '-';
                  } else {
                    quota = btts[col === 'GG' ? 'Yes' : 'No'] || '-';
                  }
                } else if (mercatoSelezionato === 'Handicap') {
                  const handicap = quote['asian_lines'] || quote['handicap'] || {};
                  if (Array.isArray(handicap)) {
                    const item = handicap.find(o => o.name === col || o.header === col);
                    quota = item?.odds || '-';
                  } else {
                    quota = handicap[col] || '-';
                  }
                } else if (mercatoSelezionato === 'Ris. Esatto') {
                  const exact = quote['correct_score'] || {};
                  if (Array.isArray(exact)) {
                    const item = exact.find(o => o.name === col || o.header === col);
                    quota = item?.odds || '-';
                  } else {
                    quota = exact[col] || '-';
                  }
                } else if (mercatoSelezionato === 'Corner') {
                  const corners = quote['corners'] || {};
                  if (Array.isArray(corners)) {
                    const item = corners.find(o => o.name === col || o.header === col);
                    quota = item?.odds || '-';
                  } else {
                    quota = corners[col] || '-';
                  }
                } else if (mercatoSelezionato === 'Cartellini') {
                  const cards = quote['cards'] || {};
                  if (Array.isArray(cards)) {
                    const item = cards.find(o => o.name === col || o.header === col);
                    quota = item?.odds || '-';
                  } else {
                    quota = cards[col] || '-';
                  }
                } else if (mercatoSelezionato === 'Primo Gol') {
                  const firstGoal = quote['first_goal'] || {};
                  if (Array.isArray(firstGoal)) {
                    const item = firstGoal.find(o => o.name === col || o.header === col);
                    quota = item?.odds || '-';
                  } else {
                    quota = firstGoal[col] || '-';
                  }
                } else if (mercatoSelezionato === '1T') {
                  const ht = quote['half_time'] || {};
                  if (Array.isArray(ht)) {
                    const item = ht.find(o => o.name === col || o.header === col);
                    quota = item?.odds || '-';
                  } else {
                    quota = ht[col] || quote_1x2[col] || '-';
                  }
                } else if (mercatoSelezionato === '2T') {
                  const sh = quote['second_half'] || {};
                  if (Array.isArray(sh)) {
                    const item = sh.find(o => o.name === col || o.header === col);
                    quota = item?.odds || '-';
                  } else {
                    quota = sh[col] || quote_1x2[col] || '-';
                  }
                } else if (mercatoSelezionato === 'DNB') {
                  const dnb = quote['draw_no_bet'] || {};
                  if (Array.isArray(dnb)) {
                    const item = dnb.find(o => o.name === col || o.header === col);
                    quota = item?.odds || '-';
                  } else {
                    quota = dnb[col] || quote_1x2[col] || '-';
                  }
                }
                
                const quotaNum = parseFloat(quota);
                const categoria = isPrincipali ? colType : mercatoSelezionato;
                const segno = isPrincipali ? colLabel : col;
                const isSelected = selections.some(s => s.id == matchId && s.categoria === categoria && s.segno === segno);
                const quotaFormattata = quotaNum > 1 ? formattaQuota(quota) : '-';
                
                html += `
                  <td class="px-1 py-1 border-b border-gray-700">
                    <button class="quote-btn w-full border border-gray-600 rounded px-0.5 py-0.5 text-xs ${isSelected ? 'bg-yellow-500 text-black' : 'bg-gray-900 text-white hover:bg-yellow-500 hover:text-black'} ${quotaNum <= 1 ? 'opacity-60 cursor-not-allowed' : 'cursor-pointer'}"
                            data-match-id="${matchId}"
                            data-categoria="${categoria}"
                            data-segno="${segno}"
                            data-quota="${quota}"
                            data-evento="${(teams || '').replace(/"/g, '&quot;').replace(/'/g, '&#39;')}"
                            ${quotaNum <= 1 ? 'disabled' : ''}>
                      ${quotaFormattata}
                    </button>
                  </td>`;
              });
              
              // Pulsante mercati dopo le quote
              html += `
                <td class="px-2 py-1 border-b border-gray-700 text-center">
                  <button class="mercati-btn px-2 py-1 bg-blue-600 hover:bg-blue-700 text-white text-xs rounded"
                          data-match-id="${matchId}">
                    üìä
                  </button>
                </td>
              `;
              
              html += `</tr>`;
            });
          });
        });

        tbody.innerHTML = html;
        
        // Aggiungi event listener ai pulsanti quote
        tbody.querySelectorAll('.quote-btn').forEach(btn => {
          if (!btn.disabled) {
            btn.addEventListener('click', function() {
              const matchId = this.getAttribute('data-match-id');
              const categoria = this.getAttribute('data-categoria');
              const segno = this.getAttribute('data-segno');
              const quota = this.getAttribute('data-quota');
              const evento = this.getAttribute('data-evento');
              selectQuote(matchId, categoria, segno, quota, evento);
            });
          }
        });
        
        // Aggiungi event listener ai pulsanti mercati
        tbody.querySelectorAll('.mercati-btn').forEach(btn => {
          btn.addEventListener('click', function() {
            const matchId = this.getAttribute('data-match-id');
            apriMercati(matchId);
          });
        });
      } catch (error) {
        console.error('Errore renderMatches:', error);
        const tbody = document.getElementById('matches-body');
        if (tbody) {
          tbody.innerHTML = '<tr><td colspan="6" class="text-center py-4 text-red-400">Errore nel rendering delle partite</td></tr>';
        }
      }
    }

    // Seleziona una quota
    function selectQuote(id, categoria, segno, quota, evento) {
      if (parseFloat(quota) <= 1 || quota === '-') return;
      
      const key = `${id}-${categoria}-${segno}`;
      const existing = selections.findIndex(s => s.key === key);
      
      if (existing !== -1) {
        selections.splice(existing, 1);
      } else {
        // Rimuovi altre selezioni per la stessa partita e mercato
        selections = selections.filter(s => !(s.id === id && s.categoria === categoria));
        selections.push({ id, categoria, segno, quota, evento, key });
      }
      
      updateSchedina();
      renderMatches(); // Rerenderizza per aggiornare lo stato visivo
    }

    // Aggiorna la schedina
    function updateSchedina() {
      const content = document.getElementById('schedina-content');
      const importoInput = document.getElementById('importo-input');
      
      if (selections.length === 0) {
        content.innerHTML = '<div class="text-xs text-gray-400">Nessuna selezione</div>';
        document.getElementById('vincita-pot').textContent = '0.00 ‚Ç¨';
        return;
      }

      let html = '<div class="flex flex-col space-y-1">';
      let totaleQuota = 1;
      
      selections.forEach(sel => {
        totaleQuota *= parseFloat(sel.quota);
        html += `
          <div class="flex items-center justify-between bg-gray-900 rounded px-2 py-1 mb-1">
            <div>
              <div class="font-bold text-yellow-400 text-xs">${sel.id} - ${sel.evento}</div>
              <div class="text-xs">${sel.categoria}: <span class="font-bold">${sel.segno}</span> @ <span class="font-bold">${formattaQuota(sel.quota)}</span></div>
            </div>
            <button class="remove-selection-btn ml-2 text-red-400 hover:text-red-600 font-bold" data-key="${sel.key}">&times;</button>
          </div>
        `;
      });
      
      html += `<div class="mt-2 text-xs">Totale quota: <span class="font-bold">${totaleQuota.toFixed(2)}</span></div>`;
      html += '</div>';
      
      content.innerHTML = html;
      
      // Aggiungi event listener ai pulsanti rimuovi
      content.querySelectorAll('.remove-selection-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          const key = this.getAttribute('data-key');
          removeSelection(key);
        });
      });
      
      updateVincita();
    }

    // Rimuovi selezione
    function removeSelection(key) {
      selections = selections.filter(s => s.key !== key);
      updateSchedina();
    }

    // Aggiorna vincita potenziale
    function updateVincita() {
      const importo = parseFloat(document.getElementById('importo-input').value) || 0;
      if (selections.length === 0 || importo <= 0) {
        document.getElementById('vincita-pot').textContent = '0.00 ‚Ç¨';
        return;
      }
      
      const totaleQuota = selections.reduce((acc, s) => acc * parseFloat(s.quota), 1);
      const vincita = (importo * totaleQuota).toFixed(2);
      document.getElementById('vincita-pot').textContent = vincita + ' ‚Ç¨';
    }

    // Pulisci schedina
    function clearSchedina() {
      selections = [];
      document.getElementById('importo-input').value = '';
      updateSchedina();
    }

    // Ottieni credito corrente
    async function getCredito() {
      try {
        const res = await fetch('/api/credito');
        const data = await res.json();
        return data.credito || 0;
      } catch (err) {
        console.error('Errore recupero credito:', err);
        return 0;
      }
    }

    // Gioca schedina
    async function giocaSchedina() {
      if (selections.length === 0) {
        alert('Nessuna selezione nella schedina!');
        return;
      }
      
      const importo = parseFloat(document.getElementById('importo-input').value);
      if (isNaN(importo) || importo <= 0) {
        alert('Inserisci un importo valido!');
        return;
      }
      
      // Verifica credito disponibile
      const credito = await getCredito();
      if (credito < importo) {
        alert(`Credito insufficiente! Credito disponibile: ${credito.toFixed(2)} ‚Ç¨`);
        return;
      }
      
      const totaleQuota = selections.reduce((acc, s) => acc * parseFloat(s.quota), 1);
      const vincita = importo * totaleQuota;
      
      try {
        const res = await fetch('/api/salva-schedina', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            scommesse: selections,
            importo: importo,
            vincita: vincita,
            data: new Date().toISOString()
          })
        });
        
        const result = await res.json();
        if (res.ok) {
          alert('Schedina giocata con successo! Credito rimanente: ' + result.credito_rimanente.toFixed(2) + ' ‚Ç¨');
          // Aggiorna il credito visualizzato
          if (result.credito_rimanente !== undefined) {
            document.getElementById('credito-display').textContent = result.credito_rimanente.toFixed(2) + ' ‚Ç¨';
          }
          clearSchedina();
        } else {
          alert(result.error || 'Errore durante il salvataggio!');
        }
      } catch (err) {
        alert('Errore di rete: ' + err.message);
      }
    }

    // Event listener per l'importo
    document.getElementById('importo-input').addEventListener('input', updateVincita);

    let categoriaSelezionata = 'Principali';
    let eventoCorrente = null;

    // Mappa categorie database -> categorie UI
    const mappaCategorie = {
      'full_time_result': 'Principali',
      'match_goals': 'O/U',
      'both_teams_to_score': 'Gol Totali',
      'asian_lines': 'Handicap',
      'correct_score': 'Ris. Esatto',
      'corners': 'Corner',
      'cards': 'Cartellini',
      'first_goal': 'Primo Gol',
      'half_time': '1T',
      'second_half': '2T',
      'double_chance': 'Doppia Chance',
      'draw_no_bet': 'DNB',
      'handicap': 'Handicap',
      'over_under': 'O/U',
      'match_goals_range': 'Gol Totali'
    };

    // Apri modal mercati
    function apriMercati(matchId) {
      const modal = document.getElementById('modal-mercati');
      const titolo = document.getElementById('modal-titolo');
      const tabContainer = document.getElementById('tab-categorie');
      
      // Trova l'evento nei dati caricati
      const evento = matchesData.find(m => (m.match_id || m._id) == matchId || String(m.match_id || m._id) === String(matchId) || String(m.match_id || m._id) === String(matchId));
      if (!evento) {
        alert('Evento non trovato');
        return;
      }
      
      eventoCorrente = evento;
      categoriaSelezionata = 'Principali';
      
      const teams = `${evento.home_name || ''} - ${evento.away_name || ''}`;
      titolo.textContent = teams;
      
      // Crea tab categorie
      const quote = evento.quote || {};
      const categorieDisponibili = ['Principali'];
      
      // Aggiungi categorie disponibili
      Object.keys(quote).forEach(cat => {
        const catUI = mappaCategorie[cat] || cat;
        if (!categorieDisponibili.includes(catUI) && quote[cat] && quote[cat].length > 0) {
          categorieDisponibili.push(catUI);
        }
      });
      
      // Aggiungi categorie standard
      ['O/U', 'Gol Totali', 'Handicap', 'Ris. Esatto', 'Corner', 'Cartellini', 'Primo Gol', '1T', '2T', 'Doppia Chance', 'DNB'].forEach(cat => {
        if (!categorieDisponibili.includes(cat)) {
          categorieDisponibili.push(cat);
        }
      });
      
      let tabHtml = '';
      categorieDisponibili.forEach(cat => {
        const isActive = cat === categoriaSelezionata;
        tabHtml += `
          <button class="categoria-tab px-3 py-1 rounded text-xs font-bold whitespace-nowrap ${isActive ? 'bg-yellow-500 text-black' : 'bg-gray-600 text-white hover:bg-gray-500'}"
                  data-categoria="${cat}">
            ${cat}
          </button>
        `;
      });
      tabContainer.innerHTML = tabHtml;
      
      // Aggiungi event listener alle tab categorie
      tabContainer.querySelectorAll('.categoria-tab').forEach(btn => {
        btn.addEventListener('click', function() {
          const categoria = this.getAttribute('data-categoria');
          selezionaCategoria(categoria);
        });
      });
      
      // Renderizza contenuto
      renderizzaMercati();
      modal.classList.remove('hidden');
    }

    // Seleziona categoria
    function selezionaCategoria(categoria) {
      categoriaSelezionata = categoria;
      
      // Aggiorna tab
      document.querySelectorAll('#tab-categorie button').forEach(btn => {
        if (btn.textContent.trim() === categoria) {
          btn.classList.remove('bg-gray-600', 'text-white');
          btn.classList.add('bg-yellow-500', 'text-black');
        } else {
          btn.classList.remove('bg-yellow-500', 'text-black');
          btn.classList.add('bg-gray-600', 'text-white');
        }
      });
      
      renderizzaMercati();
    }

    // Renderizza mercati in base alla categoria
    function renderizzaMercati() {
      if (!eventoCorrente) return;
      
      const contenuto = document.getElementById('modal-contenuto');
      const quote_1x2 = eventoCorrente.quote_1x2 || {};
      const quote = eventoCorrente.quote || {};
      const matchId = eventoCorrente.match_id || eventoCorrente._id;
      const teams = `${eventoCorrente.home_name || ''} - ${eventoCorrente.away_name || ''}`;
      
      let html = '';
      
      if (categoriaSelezionata === 'Principali') {
        // 1X2
        html += '<div class="mb-6">';
        html += '<h3 class="text-lg font-bold text-yellow-400 mb-3">1X2</h3>';
        html += '<div class="grid grid-cols-3 gap-3">';
        ['1', 'X', '2'].forEach(segno => {
          const quota = quote_1x2[segno] || '-';
          const quotaNum = parseFloat(quota);
          const isSelected = selections.some(s => s.id == matchId && s.categoria === '1X2' && s.segno === segno);
          html += `
            <button class="modal-quote-btn px-4 py-3 rounded text-sm font-bold ${isSelected ? 'bg-yellow-500 text-black' : 'bg-gray-700 text-white hover:bg-yellow-500 hover:text-black'} ${quotaNum <= 1 ? 'opacity-60 cursor-not-allowed' : 'cursor-pointer'}"
                    data-match-id="${matchId}"
                    data-categoria="1X2"
                    data-segno="${segno}"
                    data-quota="${quota}"
                    data-evento="${(teams || '').replace(/"/g, '&quot;').replace(/'/g, '&#39;')}"
                    ${quotaNum <= 1 ? 'disabled' : ''}>
              <div class="text-xs mb-1">${segno === '1' ? 'Casa' : segno === 'X' ? 'Pareggio' : 'Ospiti'}</div>
              <div class="text-lg">${quotaNum > 1 ? formattaQuota(quota) : '-'}</div>
            </button>
          `;
        });
        html += '</div></div>';
        
        // Doppia Chance
        html += '<div class="mb-6">';
        html += '<h3 class="text-lg font-bold text-yellow-400 mb-3">Doppia Chance</h3>';
        html += '<div class="grid grid-cols-3 gap-3">';
        ['1X', '12', 'X2'].forEach(segno => {
          const quota = quote_1x2[segno] || '-';
          const quotaNum = parseFloat(quota);
          const isSelected = selections.some(s => s.id == matchId && s.categoria === 'Doppia Chance' && s.segno === segno);
          html += `
            <button class="modal-quote-btn px-4 py-3 rounded text-sm font-bold ${isSelected ? 'bg-yellow-500 text-black' : 'bg-gray-700 text-white hover:bg-yellow-500 hover:text-black'} ${quotaNum <= 1 ? 'opacity-60 cursor-not-allowed' : 'cursor-pointer'}"
                    data-match-id="${matchId}"
                    data-categoria="Doppia Chance"
                    data-segno="${segno}"
                    data-quota="${quota}"
                    data-evento="${(teams || '').replace(/"/g, '&quot;').replace(/'/g, '&#39;')}"
                    ${quotaNum <= 1 ? 'disabled' : ''}>
              <div class="text-xs mb-1">${segno}</div>
              <div class="text-lg">${quotaNum > 1 ? formattaQuota(quota) : '-'}</div>
            </button>
          `;
        });
        html += '</div></div>';
      } else if (categoriaSelezionata === 'O/U' || categoriaSelezionata === 'Over/Under') {
        // Over/Under
        const overUnder = quote['match_goals'] || {};
        if (overUnder && Array.isArray(overUnder)) {
          html += '<div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3">';
          overUnder.forEach(item => {
            const nome = item.name || item.header || '-';
            const quota = item.odds || '-';
            const quotaNum = parseFloat(quota);
            const isSelected = selections.some(s => s.id == matchId && s.categoria === 'O/U' && s.segno === nome);
            html += `
              <button class="modal-quote-btn px-4 py-3 rounded text-sm font-bold ${isSelected ? 'bg-yellow-500 text-black' : 'bg-gray-700 text-white hover:bg-yellow-500 hover:text-black'} ${quotaNum <= 1 ? 'opacity-60 cursor-not-allowed' : 'cursor-pointer'}"
                      data-match-id="${matchId}"
                      data-categoria="O/U"
                      data-segno="${(nome || '').replace(/"/g, '&quot;').replace(/'/g, '&#39;')}"
                      data-quota="${quota}"
                      data-evento="${(teams || '').replace(/"/g, '&quot;').replace(/'/g, '&#39;')}"
                      ${quotaNum <= 1 ? 'disabled' : ''}>
                <div class="text-xs mb-1">${nome}</div>
                <div class="text-lg">${quotaNum > 1 ? formattaQuota(quota) : '-'}</div>
              </button>
            `;
          });
          html += '</div>';
        } else {
          // Fallback per struttura diversa
          Object.keys(overUnder).forEach(key => {
            const quota = overUnder[key];
            const quotaNum = parseFloat(quota);
            const isSelected = selections.some(s => s.id == matchId && s.categoria === 'O/U' && s.segno === key);
            html += `
              <button class="modal-quote-btn px-4 py-3 rounded text-sm font-bold ${isSelected ? 'bg-yellow-500 text-black' : 'bg-gray-700 text-white hover:bg-yellow-500 hover:text-black'} ${quotaNum <= 1 ? 'opacity-60 cursor-not-allowed' : 'cursor-pointer'}"
                      data-match-id="${matchId}"
                      data-categoria="O/U"
                      data-segno="${(key || '').replace(/"/g, '&quot;').replace(/'/g, '&#39;')}"
                      data-quota="${quota}"
                      data-evento="${(teams || '').replace(/"/g, '&quot;').replace(/'/g, '&#39;')}"
                      ${quotaNum <= 1 ? 'disabled' : ''}>
                <div class="text-xs mb-1">${key}</div>
                <div class="text-lg">${quotaNum > 1 ? formattaQuota(quota) : '-'}</div>
              </button>
            `;
          });
        }
      } else {
        // Mostra tutti i mercati della categoria selezionata
        const categoriaKey = Object.keys(mappaCategorie).find(k => mappaCategorie[k] === categoriaSelezionata) || categoriaSelezionata.toLowerCase();
        const mercati = quote[categoriaKey] || [];
        
        if (Array.isArray(mercati) && mercati.length > 0) {
          html += '<div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3">';
          mercati.forEach(item => {
            const nome = item.name || item.header || '-';
            const quota = item.odds || '-';
            const handicap = item.handicap ? ` (${item.handicap})` : '';
            const quotaNum = parseFloat(quota);
            const isSelected = selections.some(s => s.id == matchId && s.categoria === categoriaSelezionata && s.segno === nome);
            html += `
              <button class="modal-quote-btn px-4 py-3 rounded text-sm font-bold ${isSelected ? 'bg-yellow-500 text-black' : 'bg-gray-700 text-white hover:bg-yellow-500 hover:text-black'} ${quotaNum <= 1 ? 'opacity-60 cursor-not-allowed' : 'cursor-pointer'}"
                      data-match-id="${matchId}"
                      data-categoria="${(categoriaSelezionata || '').replace(/"/g, '&quot;').replace(/'/g, '&#39;')}"
                      data-segno="${(nome || '').replace(/"/g, '&quot;').replace(/'/g, '&#39;')}"
                      data-quota="${quota}"
                      data-evento="${(teams || '').replace(/"/g, '&quot;').replace(/'/g, '&#39;')}"
                      ${quotaNum <= 1 ? 'disabled' : ''}>
                <div class="text-xs mb-1">${nome}${handicap}</div>
                <div class="text-lg">${quotaNum > 1 ? formattaQuota(quota) : '-'}</div>
              </button>
            `;
          });
          html += '</div>';
        } else {
          html += '<p class="text-gray-400">Nessun mercato disponibile per questa categoria</p>';
        }
      }
      
      contenuto.innerHTML = html || '<p class="text-gray-400">Nessun mercato disponibile</p>';
      
      // Aggiungi event listener ai pulsanti quote nel modal
      contenuto.querySelectorAll('.modal-quote-btn').forEach(btn => {
        if (!btn.disabled) {
          btn.addEventListener('click', function() {
            const matchId = this.getAttribute('data-match-id');
            const categoria = this.getAttribute('data-categoria');
            const segno = this.getAttribute('data-segno');
            const quota = this.getAttribute('data-quota');
            const evento = this.getAttribute('data-evento');
            selectQuoteFromModal(matchId, categoria, segno, quota, evento);
          });
        }
      });
    }

    // Refresh mercati
    function refreshMercati() {
      if (eventoCorrente) {
        const matchId = eventoCorrente.match_id || eventoCorrente._id;
        apriMercati(matchId);
      }
    }

    // Chiudi modal mercati
    function chiudiMercati() {
      document.getElementById('modal-mercati').classList.add('hidden');
    }

    // Seleziona quota dal modal
    function selectQuoteFromModal(id, categoria, segno, quota, evento) {
      selectQuote(id, categoria, segno, quota, evento);
      // Aggiorna il modal per mostrare la selezione
      apriMercati(id);
    }

    // Chiudi modal cliccando fuori
    document.getElementById('modal-mercati').addEventListener('click', (e) => {
      if (e.target.id === 'modal-mercati') {
        chiudiMercati();
      }
    });

    // Gestione menu mobile
    function toggleSidebar(sidebarId, overlayId) {
      const sidebar = document.getElementById(sidebarId);
      const overlay = document.getElementById(overlayId);
      
      if (!sidebar || !overlay) return;
      
      if (sidebar.classList.contains('-translate-x-full') || sidebar.classList.contains('translate-x-full')) {
        // Apri sidebar
        sidebar.classList.remove('-translate-x-full', 'translate-x-full');
        overlay.classList.remove('hidden');
        document.body.style.overflow = 'hidden';
      } else {
        // Chiudi sidebar
        if (sidebarId === 'sidebar-left') {
          sidebar.classList.add('-translate-x-full');
        } else {
          sidebar.classList.add('translate-x-full');
        }
        overlay.classList.add('hidden');
        document.body.style.overflow = '';
      }
    }
    
    function closeSidebar(sidebarId, overlayId) {
      const sidebar = document.getElementById(sidebarId);
      const overlay = document.getElementById(overlayId);
      
      if (!sidebar || !overlay) return;
      
      if (sidebarId === 'sidebar-left') {
        sidebar.classList.add('-translate-x-full');
      } else {
        sidebar.classList.add('translate-x-full');
      }
      overlay.classList.add('hidden');
      document.body.style.overflow = '';
    }

    // Inizializza sport selezionato e UI
    window.addEventListener('DOMContentLoaded', () => {
      // Event listeners per menu mobile
      const mobileMenuLeft = document.getElementById('mobile-menu-left');
      const mobileMenuRight = document.getElementById('mobile-menu-right');
      const closeSidebarLeft = document.getElementById('close-sidebar-left');
      const closeSidebarRight = document.getElementById('close-sidebar-right');
      const overlay = document.getElementById('mobile-overlay');
      
      if (mobileMenuLeft) {
        mobileMenuLeft.addEventListener('click', () => toggleSidebar('sidebar-left', 'mobile-overlay'));
      }
      
      if (mobileMenuRight) {
        mobileMenuRight.addEventListener('click', () => toggleSidebar('sidebar-right', 'mobile-overlay'));
      }
      
      if (closeSidebarLeft) {
        closeSidebarLeft.addEventListener('click', () => closeSidebar('sidebar-left', 'mobile-overlay'));
      }
      
      if (closeSidebarRight) {
        closeSidebarRight.addEventListener('click', () => closeSidebar('sidebar-right', 'mobile-overlay'));
      }
      
      if (overlay) {
        overlay.addEventListener('click', () => {
          closeSidebar('sidebar-left', 'mobile-overlay');
          closeSidebar('sidebar-right', 'mobile-overlay');
        });
      }
      
      try {
        // Imposta UI per calcio
        const calcioItem = document.querySelector('[data-sport="calcio"]');
        if (calcioItem) {
          calcioItem.classList.add('bg-yellow-500', 'bg-opacity-20');
          // Cerca l'indicatore dentro calcio-toggle
          const calcioToggle = document.getElementById('calcio-toggle');
          if (calcioToggle) {
            const indicator = calcioToggle.querySelector('.sport-indicator');
            if (indicator) {
              indicator.classList.remove('hidden');
            }
          }
        }
        
        const sportTitle = document.getElementById('sport-title');
        if (sportTitle) {
          sportTitle.textContent = 'CALCIO';
        }
        
        // Apri automaticamente il submenu calcio e mostra la freccia
        const submenu = document.getElementById('calcio-submenu');
        const arrow = document.getElementById('calcio-arrow');
        if (submenu && arrow) {
          submenu.classList.remove('hidden');
          arrow.style.transform = 'rotate(180deg)';
        }
        
        // Aggiungi event listener per toggle menu calcio e selezione sport
        const calcioToggle = document.getElementById('calcio-toggle');
        if (calcioToggle) {
          calcioToggle.addEventListener('click', function(e) {
            // Se si clicca sulla freccia, solo toggle menu
            if (e.target.closest('#calcio-arrow') || e.target.closest('.sport-indicator')) {
              toggleCalcioMenu();
            } else {
              // Altrimenti seleziona calcio
              selezionaSport('calcio', '‚öΩ', 'CALCIO');
              toggleCalcioMenu(); // Apri anche il menu
            }
          });
        }
        
        // Aggiungi event listener agli sport
        document.querySelectorAll('.sport-item[data-sport]').forEach(item => {
          if (item.id !== 'calcio-toggle' && !item.closest('#calcio-submenu')) {
            item.addEventListener('click', function() {
              const sport = this.getAttribute('data-sport');
              const icon = this.getAttribute('data-icon');
              const nome = this.getAttribute('data-nome');
              if (sport && icon && nome) {
                selezionaSport(sport, icon, nome);
              }
            });
          }
        });
        
        // Aggiungi event listener ai tab mercati
        document.querySelectorAll('.mercato-tab-btn').forEach(btn => {
          btn.addEventListener('click', function() {
            const mercato = this.getAttribute('data-mercato');
            if (mercato) {
              selezionaMercato(mercato);
            }
          });
        });
        
        // Imposta mercato 1X2
        selezionaMercato('1X2');
        
        // Carica solo i campionati all'apertura (le partite verranno caricate solo quando si clicca su "Tutti i campionati")
        console.log('DOMContentLoaded: inizializzazione');
        loadLeagues().then(() => {
          console.log('DOMContentLoaded: campionati caricati');
        }).catch(error => {
          console.error('DOMContentLoaded: errore caricamento campionati', error);
        });
      } catch (error) {
        console.error('Errore inizializzazione:', error);
        const matchesBody = document.getElementById('matches-body');
        if (matchesBody) {
          matchesBody.innerHTML = '<tr><td colspan="6" class="text-center py-4 text-red-400">Errore di inizializzazione. Controlla la console.</td></tr>';
        }
      }
    });
  </script>
</body>
</html>
