<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Betbet - Scommesse Sportive</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
  </style>
</head>
<body>
  <div id="app">
    <!-- Menu Hamburger per Mobile -->
    <div class="md:hidden fixed top-0 left-0 right-0 z-50 bg-gray-800 p-2 flex justify-between items-center border-b border-gray-700">
      <button id="mobile-menu-left" class="text-white p-2 hover:bg-gray-700 rounded">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
        </svg>
      </button>
      <span class="text-white font-bold">Betbet</span>
      <button id="mobile-menu-right" class="text-white p-2 hover:bg-gray-700 rounded">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
        </svg>
      </button>
    </div>
    
    <!-- Overlay per mobile -->
    <div id="mobile-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-30 hidden"></div>
    
    <div class="flex h-screen bg-gray-900 overflow-hidden pt-12 md:pt-0">
      <!-- Sidebar Sinistra -->
      <aside id="sidebar-left" class="fixed md:relative inset-y-0 left-0 z-40 w-80 md:w-72 bg-gray-800 text-white h-full md:h-auto p-3 flex flex-col space-y-3 border-r border-gray-700 overflow-y-auto transform -translate-x-full md:translate-x-0 transition-transform duration-300 ease-in-out">
        <!-- Bottone chiudi per mobile -->
        <button id="close-sidebar-left" class="md:hidden absolute top-2 right-2 text-white hover:bg-gray-700 rounded p-1">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
        <div class="font-bold text-sm bg-gray-700 px-3 py-2 rounded">MENU SPORT</div>
        <div class="flex flex-col space-y-2">
          <div class="flex items-center bg-black rounded px-2 py-1">
            <svg class="w-4 h-4 text-gray-400 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-4.35-4.35M17 11A6 6 0 1 1 5 11a6 6 0 0 1 12 0z"/>
            </svg>
            <input type="text" placeholder="Cerca..." class="bg-black text-white text-xs focus:outline-none w-full" />
          </div>
        </div>
        <div class="bg-gray-700 rounded px-2 py-1 mt-2">
          <div class="text-xs font-bold mb-1">SPORT</div>
          <div class="flex flex-col space-y-1">
            <div class="sport-item" data-sport="calcio">
              <div id="calcio-toggle" class="flex items-center justify-between px-1 py-1 hover:bg-gray-600 rounded cursor-pointer">
                <div class="flex items-center space-x-2">
                  <span class="text-lg">‚öΩ</span>
                  <span class="text-xs font-bold">CALCIO</span>
                </div>
                <div class="flex items-center space-x-1">
                  <span class="sport-indicator hidden text-yellow-400">‚úì</span>
                  <svg id="calcio-arrow" class="w-3 h-3 text-gray-400 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                  </svg>
                </div>
              </div>
              <div id="calcio-submenu" class="hidden ml-4 mt-1 space-y-1">
                <div class="text-xs text-gray-400 px-2 py-1">Caricamento campionati...</div>
              </div>
            </div>
            <div class="sport-item" data-sport="tennis">
              <div id="tennis-toggle" class="flex items-center justify-between px-1 py-1 hover:bg-gray-600 rounded cursor-pointer">
                <div class="flex items-center space-x-2">
                  <span class="text-lg">üéæ</span>
                  <span class="text-xs font-bold">Tennis</span>
                </div>
                <div class="flex items-center space-x-1">
                  <span class="sport-indicator hidden text-yellow-400">‚úì</span>
                  <svg id="tennis-arrow" class="w-3 h-3 text-gray-400 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                  </svg>
                </div>
              </div>
              <div id="tennis-submenu" class="hidden ml-4 mt-1 space-y-1">
                <div class="text-xs text-gray-400 px-2 py-1">Caricamento campionati...</div>
              </div>
            </div>
            <div class="sport-item" data-sport="basket">
              <div id="basket-toggle" class="flex items-center justify-between px-1 py-1 hover:bg-gray-600 rounded cursor-pointer">
                <div class="flex items-center space-x-2">
                  <span class="text-lg">üèÄ</span>
                  <span class="text-xs font-bold">Basket</span>
                </div>
                <div class="flex items-center space-x-1">
                  <span class="sport-indicator hidden text-yellow-400">‚úì</span>
                  <svg id="basket-arrow" class="w-3 h-3 text-gray-400 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                  </svg>
                </div>
              </div>
              <div id="basket-submenu" class="hidden ml-4 mt-1 space-y-1">
                <div class="text-xs text-gray-400 px-2 py-1">Caricamento campionati...</div>
              </div>
            </div>
            <div class="sport-item" data-sport="hockey">
              <div id="hockey-toggle" class="flex items-center justify-between px-1 py-1 hover:bg-gray-600 rounded cursor-pointer">
                <div class="flex items-center space-x-2">
                  <span class="text-lg">üèí</span>
                  <span class="text-xs font-bold">Hockey</span>
                </div>
                <div class="flex items-center space-x-1">
                  <span class="sport-indicator hidden text-yellow-400">‚úì</span>
                  <svg id="hockey-arrow" class="w-3 h-3 text-gray-400 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                  </svg>
                </div>
              </div>
              <div id="hockey-submenu" class="hidden ml-4 mt-1 space-y-1">
                <div class="text-xs text-gray-400 px-2 py-1">Caricamento campionati...</div>
              </div>
            </div>
            <div class="sport-item" data-sport="rugby">
              <div id="rugby-toggle" class="flex items-center justify-between px-1 py-1 hover:bg-gray-600 rounded cursor-pointer">
                <div class="flex items-center space-x-2">
                  <span class="text-lg">üèâ</span>
                  <span class="text-xs font-bold">Rugby</span>
                </div>
                <div class="flex items-center space-x-1">
                  <span class="sport-indicator hidden text-yellow-400">‚úì</span>
                  <svg id="rugby-arrow" class="w-3 h-3 text-gray-400 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                  </svg>
                </div>
              </div>
              <div id="rugby-submenu" class="hidden ml-4 mt-1 space-y-1">
                <div class="text-xs text-gray-400 px-2 py-1">Caricamento campionati...</div>
              </div>
            </div>
            <div class="sport-item" data-sport="american football">
              <div id="american-football-toggle" class="flex items-center justify-between px-1 py-1 hover:bg-gray-600 rounded cursor-pointer">
                <div class="flex items-center space-x-2">
                  <span class="text-lg">üèà</span>
                  <span class="text-xs font-bold">American Football</span>
                </div>
                <div class="flex items-center space-x-1">
                  <span class="sport-indicator hidden text-yellow-400">‚úì</span>
                  <svg id="american-football-arrow" class="w-3 h-3 text-gray-400 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                  </svg>
                </div>
              </div>
              <div id="american-football-submenu" class="hidden ml-4 mt-1 space-y-1">
                <div class="text-xs text-gray-400 px-2 py-1">Caricamento campionati...</div>
              </div>
            </div>
            <div class="sport-item" data-sport="volleyball">
              <div id="volleyball-toggle" class="flex items-center justify-between px-1 py-1 hover:bg-gray-600 rounded cursor-pointer">
                <div class="flex items-center space-x-2">
                  <span class="text-lg">üèê</span>
                  <span class="text-xs font-bold">Volleyball</span>
                </div>
                <div class="flex items-center space-x-1">
                  <span class="sport-indicator hidden text-yellow-400">‚úì</span>
                  <svg id="volleyball-arrow" class="w-3 h-3 text-gray-400 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                  </svg>
                </div>
              </div>
              <div id="volleyball-submenu" class="hidden ml-4 mt-1 space-y-1">
                <div class="text-xs text-gray-400 px-2 py-1">Caricamento campionati...</div>
              </div>
            </div>
            <div class="sport-item" data-sport="water polo">
              <div id="water-polo-toggle" class="flex items-center justify-between px-1 py-1 hover:bg-gray-600 rounded cursor-pointer">
                <div class="flex items-center space-x-2">
                  <span class="text-lg">üèì</span>
                  <span class="text-xs font-bold">Water Polo</span>
                </div>
                <div class="flex items-center space-x-1">
                  <span class="sport-indicator hidden text-yellow-400">‚úì</span>
                  <svg id="water-polo-arrow" class="w-3 h-3 text-gray-400 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                  </svg>
                </div>
              </div>
              <div id="water-polo-submenu" class="hidden ml-4 mt-1 space-y-1">
                <div class="text-xs text-gray-400 px-2 py-1">Caricamento campionati...</div>
              </div>
            </div>
            <div class="sport-item" data-sport="pingpong">
              <div id="pingpong-toggle" class="flex items-center justify-between px-1 py-1 hover:bg-gray-600 rounded cursor-pointer">
                <div class="flex items-center space-x-2">
                  <span class="text-lg">üéæ</span>
                  <span class="text-xs font-bold">Pingpong</span>
                </div>
                <div class="flex items-center space-x-1">
                  <span class="sport-indicator hidden text-yellow-400">‚úì</span>
                  <svg id="pingpong-arrow" class="w-3 h-3 text-gray-400 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                  </svg>
                </div>
              </div>
              <div id="pingpong-submenu" class="hidden ml-4 mt-1 space-y-1">
                <div class="text-xs text-gray-400 px-2 py-1">Caricamento campionati...</div>
              </div>
            </div>
            <div class="sport-item" data-sport="futsal">
              <div id="futsal-toggle" class="flex items-center justify-between px-1 py-1 hover:bg-gray-600 rounded cursor-pointer">
                <div class="flex items-center space-x-2">
                  <span class="text-lg">‚öΩ</span>
                  <span class="text-xs font-bold">Futsal</span>
                </div>
                <div class="flex items-center space-x-1">
                  <span class="sport-indicator hidden text-yellow-400">‚úì</span>
                  <svg id="futsal-arrow" class="w-3 h-3 text-gray-400 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                  </svg>
                </div>
              </div>
              <div id="futsal-submenu" class="hidden ml-4 mt-1 space-y-1">
                <div class="text-xs text-gray-400 px-2 py-1">Caricamento campionati...</div>
              </div>
            </div>
            <div class="sport-item" data-sport="pallamano">
              <div id="pallamano-toggle" class="flex items-center justify-between px-1 py-1 hover:bg-gray-600 rounded cursor-pointer">
                <div class="flex items-center space-x-2">
                  <span class="text-lg">üéæ</span>
                  <span class="text-xs font-bold">Pallamano</span>
                </div>
                <div class="flex items-center space-x-1">
                  <span class="sport-indicator hidden text-yellow-400">‚úì</span>
                  <svg id="pallamano-arrow" class="w-3 h-3 text-gray-400 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                  </svg>
                </div>
              </div>
              <div id="pallamano-submenu" class="hidden ml-4 mt-1 space-y-1">
                <div class="text-xs text-gray-400 px-2 py-1">Caricamento campionati...</div>
              </div>
            </div>
            <div class="sport-item" data-sport="freccette">
              <div id="freccette-toggle" class="flex items-center justify-between px-1 py-1 hover:bg-gray-600 rounded cursor-pointer">
                <div class="flex items-center space-x-2">
                  <span class="text-lg">üéæ</span>
                  <span class="text-xs font-bold">Freccette</span>
                </div>
                <div class="flex items-center space-x-1">
                  <span class="sport-indicator hidden text-yellow-400">‚úì</span>
                  <svg id="freccette-arrow" class="w-3 h-3 text-gray-400 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                  </svg>
                </div>
              </div>
              <div id="freccette-submenu" class="hidden ml-4 mt-1 space-y-1">
                <div class="text-xs text-gray-400 px-2 py-1">Caricamento campionati...</div>
              </div>
            </div>
            <div class="sport-item" data-sport="boxing">
              <div id="boxing-toggle" class="flex items-center justify-between px-1 py-1 hover:bg-gray-600 rounded cursor-pointer">
                <div class="flex items-center space-x-2">
                  <span class="text-lg">ü•ä</span>
                  <span class="text-xs font-bold">Boxing</span>
                </div>
                <div class="flex items-center space-x-1">
                  <span class="sport-indicator hidden text-yellow-400">‚úì</span>
                  <svg id="boxing-arrow" class="w-3 h-3 text-gray-400 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                  </svg>
                </div>
              </div>
              <div id="boxing-submenu" class="hidden ml-4 mt-1 space-y-1">
                <div class="text-xs text-gray-400 px-2 py-1">Caricamento campionati...</div>
              </div>
            </div>
            <div class="sport-item" data-sport="e-sport">
              <div id="e-sport-toggle" class="flex items-center justify-between px-1 py-1 hover:bg-gray-600 rounded cursor-pointer">
                <div class="flex items-center space-x-2">
                  <span class="text-lg">üéÆ</span>
                  <span class="text-xs font-bold">E-Sport</span>
                </div>
                <div class="flex items-center space-x-1">
                  <span class="sport-indicator hidden text-yellow-400">‚úì</span>
                  <svg id="e-sport-arrow" class="w-3 h-3 text-gray-400 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                  </svg>
                </div>
              </div>
              <div id="e-sport-submenu" class="hidden ml-4 mt-1 space-y-1">
                <div class="text-xs text-gray-400 px-2 py-1">Caricamento campionati...</div>
              </div>
            </div>
            <div class="sport-item" data-sport="badminton">
              <div id="badminton-toggle" class="flex items-center justify-between px-1 py-1 hover:bg-gray-600 rounded cursor-pointer">
                <div class="flex items-center space-x-2">
                  <span class="text-lg">üè∏</span>
                  <span class="text-xs font-bold">Badminton</span>
                </div>
                <div class="flex items-center space-x-1">
                  <span class="sport-indicator hidden text-yellow-400">‚úì</span>
                  <svg id="badminton-arrow" class="w-3 h-3 text-gray-400 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                  </svg>
                </div>
              </div>
              <div id="badminton-submenu" class="hidden ml-4 mt-1 space-y-1">
                <div class="text-xs text-gray-400 px-2 py-1">Caricamento campionati...</div>
              </div>
            </div>
            <div class="sport-item" data-sport="cricket">
              <div id="cricket-toggle" class="flex items-center justify-between px-1 py-1 hover:bg-gray-600 rounded cursor-pointer">
                <div class="flex items-center space-x-2">
                  <span class="text-lg">üèè</span>
                  <span class="text-xs font-bold">Cricket</span>
                </div>
                <div class="flex items-center space-x-1">
                  <span class="sport-indicator hidden text-yellow-400">‚úì</span>
                  <svg id="cricket-arrow" class="w-3 h-3 text-gray-400 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                  </svg>
                </div>
              </div>
              <div id="cricket-submenu" class="hidden ml-4 mt-1 space-y-1">
                <div class="text-xs text-gray-400 px-2 py-1">Caricamento campionati...</div>
              </div>
            </div>
            <div class="sport-item" data-sport="squash">
              <div id="squash-toggle" class="flex items-center justify-between px-1 py-1 hover:bg-gray-600 rounded cursor-pointer">
                <div class="flex items-center space-x-2">
                  <span class="text-lg">üéæ</span>
                  <span class="text-xs font-bold">Squash</span>
                </div>
                <div class="flex items-center space-x-1">
                  <span class="sport-indicator hidden text-yellow-400">‚úì</span>
                  <svg id="squash-arrow" class="w-3 h-3 text-gray-400 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                  </svg>
                </div>
              </div>
              <div id="squash-submenu" class="hidden ml-4 mt-1 space-y-1">
                <div class="text-xs text-gray-400 px-2 py-1">Caricamento campionati...</div>
              </div>
            </div>
            <div class="flex items-center justify-between px-1 py-1 hover:bg-gray-600 rounded cursor-pointer sport-item" data-sport="horse racing" data-icon="üê¥" data-nome="Horse Racing">
              <div class="flex items-center space-x-2">
                <span class="text-lg">üê¥</span>
                <span class="text-xs font-bold">Horse Racing</span>
              </div>
              <span class="sport-indicator hidden text-yellow-400">‚úì</span>
            </div>
          </div>
        </div>
      </aside>
      
      <!-- Contenuto Centrale -->
      <div class="flex-1 flex flex-col overflow-hidden">
        <header class="bg-gray-800 text-white px-6 py-4 border-b border-gray-700">
          <div class="flex flex-col md:flex-row items-start md:items-center justify-between gap-4">
            <div>
              <h1 class="text-2xl font-bold">Betbet</h1>
              <p class="text-xs text-gray-400 mt-1">Credito: <span class="font-bold text-green-400" id="credito-display">{{ "%.2f"|format(credito) }} ‚Ç¨</span></p>
            </div>
            <div class="flex flex-col md:flex-row items-start md:items-center gap-3 w-full md:w-auto">
              <!-- Barra di ricerca -->
              <div class="relative w-full md:w-64">
                <input type="text" 
                       id="search-input" 
                       placeholder="Cerca ID o nome..." 
                       class="w-full px-4 py-2 bg-gray-700 text-white rounded-lg border border-gray-600 focus:outline-none focus:border-yellow-500 text-sm"
                       autocomplete="off">
                <button id="search-btn" class="absolute right-2 top-1/2 transform -translate-y-1/2 bg-yellow-500 hover:bg-yellow-600 text-black px-3 py-1 rounded text-xs font-bold">
                  üîç
                </button>
                <div id="search-results" class="hidden absolute top-full left-0 right-0 mt-1 bg-gray-800 border border-gray-600 rounded-lg shadow-lg max-h-60 overflow-y-auto z-50"></div>
              </div>
              <div class="flex items-center space-x-4">
                <a href="/schedine" class="text-sm hover:text-yellow-400">Le Mie Schedine</a>
                <a href="/" class="text-sm hover:text-yellow-400">Home</a>
                <a href="/logout" class="text-sm hover:text-yellow-400">Logout</a>
              </div>
            </div>
          </div>
        </header>
        
        <div class="flex-1 overflow-y-auto p-4">
          <!-- Per Horse Racing: layout con sidebar a destra -->
          <div id="horse-racing-layout" class="hidden flex flex-col md:flex-row gap-4 h-full">
            <!-- Contenuto centrale con le corse -->
            <div class="flex-1 bg-gray-800 rounded shadow border-2 border-yellow-500 overflow-y-auto order-2 md:order-1">
              <div class="bg-gray-700 text-white text-center font-bold py-2 border-b border-gray-600 text-lg" id="campo-selezionato-title">Seleziona un campo</div>
              <div id="corse-container" class="p-2 md:p-4"></div>
            </div>
            <!-- Sidebar a destra con i campi (su mobile va sopra) -->
            <div class="w-full md:w-64 bg-gray-800 rounded shadow border-2 border-gray-600 overflow-y-auto max-h-48 md:max-h-none order-1 md:order-2">
              <div class="bg-gray-700 text-white text-center font-bold py-2 border-b border-gray-600 text-sm">üèá Campi</div>
              <div id="campi-list" class="p-2 flex flex-row md:flex-col overflow-x-auto md:overflow-x-visible gap-1 md:gap-0"></div>
            </div>
          </div>
          
          <!-- Per Goalscorer: layout con sidebar a sinistra (partite) e contenuto centrale (marcatori) -->
          <div id="goalscorer-layout" class="hidden flex flex-col md:flex-row gap-4 h-full">
            <!-- Sidebar a sinistra con le partite (su mobile va sopra) -->
            <div class="w-full md:w-64 bg-gray-800 rounded shadow border-2 border-gray-600 overflow-y-auto max-h-48 md:max-h-none order-1 md:order-1">
              <div class="bg-gray-700 text-white text-center font-bold py-2 border-b border-gray-600 text-sm">‚öΩ Partite</div>
              <div id="partite-list" class="p-2 flex flex-row md:flex-col overflow-x-auto md:overflow-x-visible gap-1 md:gap-0"></div>
            </div>
            <!-- Contenuto centrale con i marcatori -->
            <div class="flex-1 bg-gray-800 rounded shadow border-2 border-yellow-500 overflow-y-auto order-2 md:order-2">
              <div class="bg-gray-700 text-white text-center font-bold py-2 border-b border-gray-600 text-lg" id="partita-selezionata-title">Seleziona una partita</div>
              <div id="marcatori-container" class="p-2 md:p-4"></div>
            </div>
          </div>
          
          <!-- Layout normale per gli altri sport -->
          <div id="normal-layout" class="w-full bg-gray-800 rounded shadow border-2 border-yellow-500">
            <div class="bg-gray-700 text-white text-center font-bold py-2 border-b border-gray-600 text-lg" id="sport-title">CALCIO</div>
            
            <!-- Griglia Tab Mercati (solo per Calcio) -->
            <div id="mercati-tabs-container" class="bg-gray-700 px-2 py-2 border-b border-gray-600 overflow-x-auto hidden">
              <div class="grid grid-cols-8 gap-1 min-w-max">
                <!-- Riga 1 -->
                <button id="mercato-Principali" class="mercato-tab-btn px-2 py-1 rounded text-xs font-bold bg-yellow-500 text-black hover:bg-yellow-600 mercato-tab whitespace-nowrap" data-mercato="Principali">Principali</button>
                <button id="mercato-1X2" class="mercato-tab-btn px-2 py-1 rounded text-xs font-bold bg-gray-600 text-white hover:bg-gray-500 mercato-tab whitespace-nowrap" data-mercato="1X2">1X2</button>
                <button id="mercato-Doppia Chance" class="mercato-tab-btn px-2 py-1 rounded text-xs font-bold bg-gray-600 text-white hover:bg-gray-500 mercato-tab whitespace-nowrap" data-mercato="Doppia Chance">Doppia Chance</button>
                <button id="mercato-Over/Under" class="mercato-tab-btn px-2 py-1 rounded text-xs font-bold bg-gray-600 text-white hover:bg-gray-500 mercato-tab whitespace-nowrap" data-mercato="Over/Under">O/U</button>
                <button id="mercato-O/U 1T" class="mercato-tab-btn px-2 py-1 rounded text-xs font-bold bg-gray-600 text-white hover:bg-gray-500 mercato-tab whitespace-nowrap" data-mercato="O/U 1T">O/U 1T</button>
                <button id="mercato-O/U 2T" class="mercato-tab-btn px-2 py-1 rounded text-xs font-bold bg-gray-600 text-white hover:bg-gray-500 mercato-tab whitespace-nowrap" data-mercato="O/U 2T">O/U 2T</button>
                <button id="mercato-O/U C/O" class="mercato-tab-btn px-2 py-1 rounded text-xs font-bold bg-gray-600 text-white hover:bg-gray-500 mercato-tab whitespace-nowrap" data-mercato="O/U C/O">O/U C/O</button>
                <button id="mercato-O/U 1T C/O" class="mercato-tab-btn px-2 py-1 rounded text-xs font-bold bg-gray-600 text-white hover:bg-gray-500 mercato-tab whitespace-nowrap" data-mercato="O/U 1T C/O">O/U 1T C/O</button>
                
                <!-- Pulsante per aprire/chiudere le tab -->
                <button id="toggle-mercati-btn" class="px-2 py-1 rounded text-xs font-bold bg-gray-600 text-white hover:bg-gray-500 whitespace-nowrap col-span-8 flex items-center justify-center gap-1" title="Mostra/Nascondi tutti i mercati">
                  <span id="toggle-mercati-text">‚ñº Mostra tutti</span>
                </button>
                
                <!-- Goalscorer sempre visibile dopo il pulsante -->
                <button id="mercato-Goalscorer" class="mercato-tab-btn px-2 py-1 rounded text-xs font-bold bg-gray-600 text-white hover:bg-gray-500 mercato-tab whitespace-nowrap col-span-8" data-mercato="Goalscorer">Goalscorer</button>
                
                <!-- Righe 2-11 (nascoste di default) -->
                <div id="mercati-righe-extra" class="hidden col-span-8 grid grid-cols-8 gap-1">
                  <!-- Riga 2 -->
                  <button id="mercato-1T" class="mercato-tab-btn px-2 py-1 rounded text-xs font-bold bg-gray-600 text-white hover:bg-gray-500 mercato-tab whitespace-nowrap" data-mercato="1T">1T</button>
                <button id="mercato-2T" class="mercato-tab-btn px-2 py-1 rounded text-xs font-bold bg-gray-600 text-white hover:bg-gray-500 mercato-tab whitespace-nowrap" data-mercato="2T">2T</button>
                <button id="mercato-1X2 5 min" class="mercato-tab-btn px-2 py-1 rounded text-xs font-bold bg-gray-600 text-white hover:bg-gray-500 mercato-tab whitespace-nowrap" data-mercato="1X2 5 min">1X2 5 min.</button>
                <button id="mercato-1X2 10 min" class="mercato-tab-btn px-2 py-1 rounded text-xs font-bold bg-gray-600 text-white hover:bg-gray-500 mercato-tab whitespace-nowrap" data-mercato="1X2 10 min">1X2 10 min.</button>
                <button id="mercato-1X2 15 min" class="mercato-tab-btn px-2 py-1 rounded text-xs font-bold bg-gray-600 text-white hover:bg-gray-500 mercato-tab whitespace-nowrap" data-mercato="1X2 15 min">1X2 15 min.</button>
                <button id="mercato-1X2 25 min" class="mercato-tab-btn px-2 py-1 rounded text-xs font-bold bg-gray-600 text-white hover:bg-gray-500 mercato-tab whitespace-nowrap" data-mercato="1X2 25 min">1X2 25 min.</button>
                <button id="mercato-1X2 30 min" class="mercato-tab-btn px-2 py-1 rounded text-xs font-bold bg-gray-600 text-white hover:bg-gray-500 mercato-tab whitespace-nowrap" data-mercato="1X2 30 min">1X2 30 min.</button>
                <button id="mercato-DC 1T" class="mercato-tab-btn px-2 py-1 rounded text-xs font-bold bg-gray-600 text-white hover:bg-gray-500 mercato-tab whitespace-nowrap" data-mercato="DC 1T">DC 1T</button>
                
                  <!-- Riga 3 -->
                  <button id="mercato-DC 2T" class="mercato-tab-btn px-2 py-1 rounded text-xs font-bold bg-gray-600 text-white hover:bg-gray-500 mercato-tab whitespace-nowrap" data-mercato="DC 2T">DC 2T</button>
                <button id="mercato-Parz./Fin." class="mercato-tab-btn px-2 py-1 rounded text-xs font-bold bg-gray-600 text-white hover:bg-gray-500 mercato-tab whitespace-nowrap" data-mercato="Parz./Fin.">Parz./Fin.</button>
                <button id="mercato-Gol Esatti" class="mercato-tab-btn px-2 py-1 rounded text-xs font-bold bg-gray-600 text-white hover:bg-gray-500 mercato-tab whitespace-nowrap" data-mercato="Gol Esatti">Gol Esatti</button>
                <button id="mercato-GolTot 1T" class="mercato-tab-btn px-2 py-1 rounded text-xs font-bold bg-gray-600 text-white hover:bg-gray-500 mercato-tab whitespace-nowrap" data-mercato="GolTot 1T">GolTot 1T</button>
                <button id="mercato-GolTot 2T" class="mercato-tab-btn px-2 py-1 rounded text-xs font-bold bg-gray-600 text-white hover:bg-gray-500 mercato-tab whitespace-nowrap" data-mercato="GolTot 2T">GolTot 2T</button>
                <button id="mercato-GolTot Casa" class="mercato-tab-btn px-2 py-1 rounded text-xs font-bold bg-gray-600 text-white hover:bg-gray-500 mercato-tab whitespace-nowrap" data-mercato="GolTot Casa">GolTot Casa</button>
                <button id="mercato-GolTot Ospite" class="mercato-tab-btn px-2 py-1 rounded text-xs font-bold bg-gray-600 text-white hover:bg-gray-500 mercato-tab whitespace-nowrap" data-mercato="GolTot Ospite">GolTot Ospite</button>
                <button id="mercato-Goal (0 - 15)" class="mercato-tab-btn px-2 py-1 rounded text-xs font-bold bg-gray-600 text-white hover:bg-gray-500 mercato-tab whitespace-nowrap" data-mercato="Goal (0 - 15)">Goal (0 - 15)</button>
                
                  <!-- Riga 4 -->
                  <button id="mercato-Goal (0 - 30)" class="mercato-tab-btn px-2 py-1 rounded text-xs font-bold bg-gray-600 text-white hover:bg-gray-500 mercato-tab whitespace-nowrap" data-mercato="Goal (0 - 30)">Goal (0 - 30)</button>
                <button id="mercato-GG/NG 1T" class="mercato-tab-btn px-2 py-1 rounded text-xs font-bold bg-gray-600 text-white hover:bg-gray-500 mercato-tab whitespace-nowrap" data-mercato="GG/NG 1T">GG/NG 1T</button>
                <button id="mercato-GG/NG 2T" class="mercato-tab-btn px-2 py-1 rounded text-xs font-bold bg-gray-600 text-white hover:bg-gray-500 mercato-tab whitespace-nowrap" data-mercato="GG/NG 2T">GG/NG 2T</button>
                <button id="mercato-GG Special" class="mercato-tab-btn px-2 py-1 rounded text-xs font-bold bg-gray-600 text-white hover:bg-gray-500 mercato-tab whitespace-nowrap" data-mercato="GG Special">GG Special</button>
                <button id="mercato-Handicap" class="mercato-tab-btn px-2 py-1 rounded text-xs font-bold bg-gray-600 text-white hover:bg-gray-500 mercato-tab whitespace-nowrap" data-mercato="Handicap">Handicap</button>
                <button id="mercato-Handicap 1T" class="mercato-tab-btn px-2 py-1 rounded text-xs font-bold bg-gray-600 text-white hover:bg-gray-500 mercato-tab whitespace-nowrap" data-mercato="Handicap 1T">Handicap 1T</button>
                <button id="mercato-Handicap 2T" class="mercato-tab-btn px-2 py-1 rounded text-xs font-bold bg-gray-600 text-white hover:bg-gray-500 mercato-tab whitespace-nowrap" data-mercato="Handicap 2T">Handicap 2T</button>
                <button id="mercato-Pari/Dispari" class="mercato-tab-btn px-2 py-1 rounded text-xs font-bold bg-gray-600 text-white hover:bg-gray-500 mercato-tab whitespace-nowrap" data-mercato="Pari/Dispari">Pari/Dispari</button>
                
                  <!-- Riga 5 -->
                  <button id="mercato-Pari/Dis. 1T" class="mercato-tab-btn px-2 py-1 rounded text-xs font-bold bg-gray-600 text-white hover:bg-gray-500 mercato-tab whitespace-nowrap" data-mercato="Pari/Dis. 1T">Pari/Dis. 1T</button>
                <button id="mercato-Pari/Dis. 2T" class="mercato-tab-btn px-2 py-1 rounded text-xs font-bold bg-gray-600 text-white hover:bg-gray-500 mercato-tab whitespace-nowrap" data-mercato="Pari/Dis. 2T">Pari/Dis. 2T</button>
                <button id="mercato-P./D. Squadre" class="mercato-tab-btn px-2 py-1 rounded text-xs font-bold bg-gray-600 text-white hover:bg-gray-500 mercato-tab whitespace-nowrap" data-mercato="P./D. Squadre">P./D. Squadre</button>
                <button id="mercato-Ris. Esatto" class="mercato-tab-btn px-2 py-1 rounded text-xs font-bold bg-gray-600 text-white hover:bg-gray-500 mercato-tab whitespace-nowrap" data-mercato="Ris. Esatto">Ris. Esatto</button>
                <button id="mercato-Ris. Es. 1T" class="mercato-tab-btn px-2 py-1 rounded text-xs font-bold bg-gray-600 text-white hover:bg-gray-500 mercato-tab whitespace-nowrap" data-mercato="Ris. Es. 1T">Ris. Es. 1T</button>
                <button id="mercato-Ris. Es. 2T" class="mercato-tab-btn px-2 py-1 rounded text-xs font-bold bg-gray-600 text-white hover:bg-gray-500 mercato-tab whitespace-nowrap" data-mercato="Ris. Es. 2T">Ris. Es. 2T</button>
                <button id="mercato-Ris. Es. P/F" class="mercato-tab-btn px-2 py-1 rounded text-xs font-bold bg-gray-600 text-white hover:bg-gray-500 mercato-tab whitespace-nowrap" data-mercato="Ris. Es. P/F">Ris. Es. P/F</button>
                <button id="mercato-DNB" class="mercato-tab-btn px-2 py-1 rounded text-xs font-bold bg-gray-600 text-white hover:bg-gray-500 mercato-tab whitespace-nowrap" data-mercato="DNB">DNB</button>
                
                  <!-- Riga 6 -->
                  <button id="mercato-DNB 1T" class="mercato-tab-btn px-2 py-1 rounded text-xs font-bold bg-gray-600 text-white hover:bg-gray-500 mercato-tab whitespace-nowrap" data-mercato="DNB 1T">DNB 1T</button>
                <button id="mercato-DNB 2T" class="mercato-tab-btn px-2 py-1 rounded text-xs font-bold bg-gray-600 text-white hover:bg-gray-500 mercato-tab whitespace-nowrap" data-mercato="DNB 2T">DNB 2T</button>
                <button id="mercato-HNB" class="mercato-tab-btn px-2 py-1 rounded text-xs font-bold bg-gray-600 text-white hover:bg-gray-500 mercato-tab whitespace-nowrap" data-mercato="HNB">HNB</button>
                <button id="mercato-ANB" class="mercato-tab-btn px-2 py-1 rounded text-xs font-bold bg-gray-600 text-white hover:bg-gray-500 mercato-tab whitespace-nowrap" data-mercato="ANB">ANB</button>
                <button id="mercato-Gol No Bet" class="mercato-tab-btn px-2 py-1 rounded text-xs font-bold bg-gray-600 text-white hover:bg-gray-500 mercato-tab whitespace-nowrap" data-mercato="Gol No Bet">Gol No Bet</button>
                <button id="mercato-Tempo+Gol" class="mercato-tab-btn px-2 py-1 rounded text-xs font-bold bg-gray-600 text-white hover:bg-gray-500 mercato-tab whitespace-nowrap" data-mercato="Tempo+Gol">Tempo+Gol</button>
                <button id="mercato-T+G (C/O)" class="mercato-tab-btn px-2 py-1 rounded text-xs font-bold bg-gray-600 text-white hover:bg-gray-500 mercato-tab whitespace-nowrap" data-mercato="T+G (C/O)">T+G (C/O)</button>
                <button id="mercato-Combo" class="mercato-tab-btn px-2 py-1 rounded text-xs font-bold bg-gray-600 text-white hover:bg-gray-500 mercato-tab whitespace-nowrap" data-mercato="Combo">Combo</button>
                
                  <!-- Riga 7 -->
                  <button id="mercato-Combo 1T" class="mercato-tab-btn px-2 py-1 rounded text-xs font-bold bg-gray-600 text-white hover:bg-gray-500 mercato-tab whitespace-nowrap" data-mercato="Combo 1T">Combo 1T</button>
                <button id="mercato-Combo 2T" class="mercato-tab-btn px-2 py-1 rounded text-xs font-bold bg-gray-600 text-white hover:bg-gray-500 mercato-tab whitespace-nowrap" data-mercato="Combo 2T">Combo 2T</button>
                <button id="mercato-Combo DC" class="mercato-tab-btn px-2 py-1 rounded text-xs font-bold bg-gray-600 text-white hover:bg-gray-500 mercato-tab whitespace-nowrap" data-mercato="Combo DC">Combo DC</button>
                <button id="mercato-Combo DC 1T" class="mercato-tab-btn px-2 py-1 rounded text-xs font-bold bg-gray-600 text-white hover:bg-gray-500 mercato-tab whitespace-nowrap" data-mercato="Combo DC 1T">Combo DC 1T</button>
                <button id="mercato-Combo DC 2T" class="mercato-tab-btn px-2 py-1 rounded text-xs font-bold bg-gray-600 text-white hover:bg-gray-500 mercato-tab whitespace-nowrap" data-mercato="Combo DC 2T">Combo DC 2T</button>
                <button id="mercato-C. DC Multi" class="mercato-tab-btn px-2 py-1 rounded text-xs font-bold bg-gray-600 text-white hover:bg-gray-500 mercato-tab whitespace-nowrap" data-mercato="C. DC Multi">C. DC Multi</button>
                <button id="mercato-Combo 3" class="mercato-tab-btn px-2 py-1 rounded text-xs font-bold bg-gray-600 text-white hover:bg-gray-500 mercato-tab whitespace-nowrap" data-mercato="Combo 3">Combo 3</button>
                <button id="mercato-Combo3 HT/FT" class="mercato-tab-btn px-2 py-1 rounded text-xs font-bold bg-gray-600 text-white hover:bg-gray-500 mercato-tab whitespace-nowrap" data-mercato="Combo3 HT/FT">Combo3 HT/FT</button>
                
                  <!-- Riga 8 -->
                  <button id="mercato-Combo+Multi" class="mercato-tab-btn px-2 py-1 rounded text-xs font-bold bg-gray-600 text-white hover:bg-gray-500 mercato-tab whitespace-nowrap" data-mercato="Combo+Multi">Combo+Multi</button>
                <button id="mercato-Combo C/O" class="mercato-tab-btn px-2 py-1 rounded text-xs font-bold bg-gray-600 text-white hover:bg-gray-500 mercato-tab whitespace-nowrap" data-mercato="Combo C/O">Combo C/O</button>
                <button id="mercato-Chance 3 Mix" class="mercato-tab-btn px-2 py-1 rounded text-xs font-bold bg-gray-600 text-white hover:bg-gray-500 mercato-tab whitespace-nowrap" data-mercato="Chance 3 Mix">Chance 3 Mix</button>
                <button id="mercato-Chance Mix" class="mercato-tab-btn px-2 py-1 rounded text-xs font-bold bg-gray-600 text-white hover:bg-gray-500 mercato-tab whitespace-nowrap" data-mercato="Chance Mix">Chance Mix</button>
                <button id="mercato-HT Ch. Mix" class="mercato-tab-btn px-2 py-1 rounded text-xs font-bold bg-gray-600 text-white hover:bg-gray-500 mercato-tab whitespace-nowrap" data-mercato="HT Ch. Mix">HT Ch. Mix</button>
                <button id="mercato-Ris. Esatto Mix" class="mercato-tab-btn px-2 py-1 rounded text-xs font-bold bg-gray-600 text-white hover:bg-gray-500 mercato-tab whitespace-nowrap" data-mercato="Ris. Esatto Mix">Ris. Esatto Mix</button>
                <button id="mercato-Segna 1T 2T" class="mercato-tab-btn px-2 py-1 rounded text-xs font-bold bg-gray-600 text-white hover:bg-gray-500 mercato-tab whitespace-nowrap" data-mercato="Segna 1T 2T">Segna 1T 2T</button>
                <button id="mercato-Vince a 0" class="mercato-tab-btn px-2 py-1 rounded text-xs font-bold bg-gray-600 text-white hover:bg-gray-500 mercato-tab whitespace-nowrap" data-mercato="Vince a 0">Vince a 0</button>
                
                  <!-- Riga 9 -->
                  <button id="mercato-Vince 1T e 2T" class="mercato-tab-btn px-2 py-1 rounded text-xs font-bold bg-gray-600 text-white hover:bg-gray-500 mercato-tab whitespace-nowrap" data-mercato="Vince 1T e 2T">Vince 1T e 2T</button>
                <button id="mercato-Vince 1T o 2T" class="mercato-tab-btn px-2 py-1 rounded text-xs font-bold bg-gray-600 text-white hover:bg-gray-500 mercato-tab whitespace-nowrap" data-mercato="Vince 1T o 2T">Vince 1T o 2T</button>
                <button id="mercato-Vincono Rib." class="mercato-tab-btn px-2 py-1 rounded text-xs font-bold bg-gray-600 text-white hover:bg-gray-500 mercato-tab whitespace-nowrap" data-mercato="Vincono Rib.">Vincono Rib.</button>
                <button id="mercato-Cart. Allen." class="mercato-tab-btn px-2 py-1 rounded text-xs font-bold bg-gray-600 text-white hover:bg-gray-500 mercato-tab whitespace-nowrap" data-mercato="Cart. Allen.">Cart. Allen.</button>
                <button id="mercato-Primo Gol" class="mercato-tab-btn px-2 py-1 rounded text-xs font-bold bg-gray-600 text-white hover:bg-gray-500 mercato-tab whitespace-nowrap" data-mercato="Primo Gol">Primo Gol</button>
                <button id="mercato-Primo Gol Min" class="mercato-tab-btn px-2 py-1 rounded text-xs font-bold bg-gray-600 text-white hover:bg-gray-500 mercato-tab whitespace-nowrap" data-mercato="Primo Gol Min">Primo Gol Min</button>
                <button id="mercato-Primo Gol Min." class="mercato-tab-btn px-2 py-1 rounded text-xs font-bold bg-gray-600 text-white hover:bg-gray-500 mercato-tab whitespace-nowrap" data-mercato="Primo Gol Min.">Primo Gol Min.</button>
                <button id="mercato-1X2+Primo Go" class="mercato-tab-btn px-2 py-1 rounded text-xs font-bold bg-gray-600 text-white hover:bg-gray-500 mercato-tab whitespace-nowrap" data-mercato="1X2+Primo Go">1X2+Primo Go</button>
                
                  <!-- Riga 10 -->
                  <button id="mercato-DNB Primo Go" class="mercato-tab-btn px-2 py-1 rounded text-xs font-bold bg-gray-600 text-white hover:bg-gray-500 mercato-tab whitespace-nowrap" data-mercato="DNB Primo Go">DNB Primo Go</button>
                <button id="mercato-Ultimo Gol" class="mercato-tab-btn px-2 py-1 rounded text-xs font-bold bg-gray-600 text-white hover:bg-gray-500 mercato-tab whitespace-nowrap" data-mercato="Ultimo Gol">Ultimo Gol</button>
                <button id="mercato-Multi Gol" class="mercato-tab-btn px-2 py-1 rounded text-xs font-bold bg-gray-600 text-white hover:bg-gray-500 mercato-tab whitespace-nowrap" data-mercato="Multi Gol">Multi Gol</button>
                <button id="mercato-Multi Gol 1T" class="mercato-tab-btn px-2 py-1 rounded text-xs font-bold bg-gray-600 text-white hover:bg-gray-500 mercato-tab whitespace-nowrap" data-mercato="Multi Gol 1T">Multi Gol 1T</button>
                <button id="mercato-Multi Gol 2T" class="mercato-tab-btn px-2 py-1 rounded text-xs font-bold bg-gray-600 text-white hover:bg-gray-500 mercato-tab whitespace-nowrap" data-mercato="Multi Gol 2T">Multi Gol 2T</button>
                <button id="mercato-Multi Gol C/O" class="mercato-tab-btn px-2 py-1 rounded text-xs font-bold bg-gray-600 text-white hover:bg-gray-500 mercato-tab whitespace-nowrap" data-mercato="Multi Gol C/O">Multi Gol C/O</button>
                <button id="mercato-Multigoal 1T/2" class="mercato-tab-btn px-2 py-1 rounded text-xs font-bold bg-gray-600 text-white hover:bg-gray-500 mercato-tab whitespace-nowrap" data-mercato="Multigoal 1T/2">Multigoal 1T/2</button>
                <button id="mercato-Multigol Comb" class="mercato-tab-btn px-2 py-1 rounded text-xs font-bold bg-gray-600 text-white hover:bg-gray-500 mercato-tab whitespace-nowrap" data-mercato="Multigol Comb">Multigol Comb</button>
                
                  <!-- Riga 11 -->
                  <button id="mercato-Rigori" class="mercato-tab-btn px-2 py-1 rounded text-xs font-bold bg-gray-600 text-white hover:bg-gray-500 mercato-tab whitespace-nowrap" data-mercato="Rigori">Rigori</button>
                  <button id="mercato-Speciali Gol" class="mercato-tab-btn px-2 py-1 rounded text-xs font-bold bg-gray-600 text-white hover:bg-gray-500 mercato-tab whitespace-nowrap" data-mercato="Speciali Gol">Speciali Gol</button>
                  <button id="mercato-Metodo 1¬∞ gol" class="mercato-tab-btn px-2 py-1 rounded text-xs font-bold bg-gray-600 text-white hover:bg-gray-500 mercato-tab whitespace-nowrap" data-mercato="Metodo 1¬∞ gol">Metodo 1¬∞ gol</button>
                  <button id="mercato-Tempo 1¬∞sub" class="mercato-tab-btn px-2 py-1 rounded text-xs font-bold bg-gray-600 text-white hover:bg-gray-500 mercato-tab whitespace-nowrap" data-mercato="Tempo 1¬∞sub">Tempo 1¬∞sub</button>
                  <button id="mercato-Team 1¬∞ sub" class="mercato-tab-btn px-2 py-1 rounded text-xs font-bold bg-gray-600 text-white hover:bg-gray-500 mercato-tab whitespace-nowrap" data-mercato="Team 1¬∞ sub">Team 1¬∞ sub</button>
                  <button id="mercato-VAR Si/No" class="mercato-tab-btn px-2 py-1 rounded text-xs font-bold bg-gray-600 text-white hover:bg-gray-500 mercato-tab whitespace-nowrap" data-mercato="VAR Si/No">VAR Si/No</button>
                  <button id="mercato-Corner" class="mercato-tab-btn px-2 py-1 rounded text-xs font-bold bg-gray-600 text-white hover:bg-gray-500 mercato-tab whitespace-nowrap" data-mercato="Corner">Corner</button>
                </div>
              </div>
            </div>
            
            <!-- Tabelle Mercati per Categoria (solo Calcio) -->
            <div id="mercati-categorie-container" class="hidden mb-4">
              <div class="bg-gray-800 rounded-lg p-4">
                <h3 class="text-yellow-400 font-bold text-sm mb-3">Mercati per Categoria</h3>
                <div id="mercati-categorie" class="space-y-4"></div>
              </div>
            </div>
            
            <div class="overflow-x-auto">
              <table class="min-w-full text-xs text-white">
                <thead class="bg-gray-700 text-gray-200">
                  <tr id="table-header">
                    <th class="px-2 py-1 border-b border-gray-600 text-center">Id</th>
                    <th class="px-2 py-1 border-b border-gray-600 text-center">Data</th>
                    <th class="px-2 py-1 border-b border-gray-600 text-center">Evento</th>
                    <th class="px-1 py-1 border-b border-gray-600">1</th>
                    <th class="px-1 py-1 border-b border-gray-600">X</th>
                    <th class="px-1 py-1 border-b border-gray-600">2</th>
                  </tr>
                </thead>
                <tbody id="matches-body">
                  <tr>
                    <td colspan="6" class="text-center py-20">
                      <div class="flex flex-col items-center justify-center">
                        <svg class="w-32 h-32 mb-4 text-yellow-500 animate-spin" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                          <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        <div class="text-yellow-500 text-xl font-bold">BETBET</div>
                        <div class="text-gray-400 text-sm mt-2">Caricamento in corso...</div>
                      </div>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
        
        <footer class="w-full bg-gray-900 border-t-4 border-yellow-500 py-6 px-8 text-white text-xs">
          <div class="flex flex-col md:flex-row justify-between items-center">
            <div class="flex flex-col items-start space-y-2">
              <div class="flex items-center space-x-2">
                <span class="text-3xl font-bold">B</span>
                <span class="text-2xl font-bold">etbet</span>
              </div>
              <span>¬© 2025 betbet</span>
            </div>
            <div class="mt-4 md:mt-0">
              <span>Per informazioni: <a href="mailto:infalcode@protonmail.com" class="text-blue-400 hover:underline">infalcode@protonmail.com</a></span>
            </div>
          </div>
        </footer>
      </div>
      
      <!-- Sidebar Destra - Schedina -->
      <aside id="sidebar-right" class="fixed md:relative inset-y-0 right-0 z-40 w-80 md:w-80 bg-gray-800 text-white h-full md:h-auto p-3 flex flex-col space-y-3 border-l border-gray-700 transform translate-x-full md:translate-x-0 transition-transform duration-300 ease-in-out">
        <!-- Bottone chiudi per mobile -->
        <button id="close-sidebar-right" class="md:hidden absolute top-2 right-2 text-white hover:bg-gray-700 rounded p-1">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
        <div class="font-bold text-sm bg-gray-700 px-3 py-2 rounded">SCHEDINA</div>
        <div id="schedina-content" class="flex-1 overflow-y-auto">
          <div class="text-xs text-gray-400">Nessuna selezione</div>
        </div>
        <div class="mt-2 flex flex-col space-y-1 bg-gray-700 rounded p-2">
          <label class="text-xs mb-1">Importo Tot. (‚Ç¨)</label>
          <input id="importo-input" type="number" min="1" step="1" class="w-full rounded px-2 py-1 text-black text-xs focus:outline-none" placeholder="0.00" />
          <div class="flex justify-between text-xs mt-1">
            <span>Vincita Pot.</span>
            <span class="font-bold text-yellow-400" id="vincita-pot">0.00 ‚Ç¨</span>
          </div>
        </div>
        <div class="flex space-x-2 mt-3">
          <button onclick="clearSchedina()" class="flex-1 bg-red-500 hover:bg-red-600 text-white py-1 rounded text-xs">CANCELLA</button>
          <button onclick="giocaSchedina()" class="flex-1 bg-green-600 hover:bg-green-700 text-white font-bold py-1 rounded text-xs">GIOCA</button>
        </div>
      </aside>
    </div>
  </div>

  <!-- Modal Mercati -->
  <div id="modal-mercati" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
    <div class="bg-gray-800 rounded-lg shadow-xl max-w-6xl w-full mx-4 max-h-[90vh] flex flex-col">
      <div class="sticky top-0 bg-gray-800 border-b border-gray-700 px-6 py-4 flex justify-between items-center z-10">
        <h2 class="text-xl font-bold text-yellow-400" id="modal-titolo">Tutti i Mercati</h2>
        <div class="flex items-center space-x-2">
          <button onclick="refreshMercati()" class="px-3 py-1 bg-gray-700 hover:bg-gray-600 text-white text-sm rounded">üîÑ</button>
          <button onclick="chiudiMercati()" class="text-gray-400 hover:text-white text-2xl">&times;</button>
        </div>
      </div>
      
      <!-- Tab Categorie -->
      <div class="sticky top-[73px] bg-gray-700 border-b border-gray-600 px-4 py-2 overflow-x-auto z-10">
        <div class="flex space-x-2" id="tab-categorie">
          <!-- Tab dinamiche -->
        </div>
      </div>
      
      <div class="flex-1 overflow-y-auto p-6" id="modal-contenuto">
        <!-- Contenuto dinamico -->
      </div>
    </div>
  </div>

  <script>
    let selections = [];
    let matchesData = [];
    let sportSelezionato = 'calcio';
    let mercatoSelezionato = 'Principali';
    let campionatoSelezionato = null;
    let nationsLeagues = {};
    
    // Mappatura nazioni inglese -> italiano (per convertire nazioni dagli eventi)
    const nationMapping = {
      "Italy": "Italia",
      "Brazil": "Brasile",
      "Argentina": "Argentina",
      "Australia": "Australia",
      "Austria": "Austria",
      "Bulgaria": "Bulgaria",
      "China": "Cina",
      "Denmark": "Danimarca",
      "Ecuador": "Ecuador",
      "England": "Inghilterra",
      "France": "Francia",
      "Germany": "Germania",
      "Greece": "Grecia",
      "Israel": "Israele",
      "Netherlands": "Paesi Bassi",
      "Paraguay": "Paraguay",
      "Poland": "Polonia",
      "Slovenia": "Slovenia",
      "Spain": "Spagna"
    };
    
    // Funzione per convertire nazione inglese in italiano
    function convertNationToItalian(nation) {
      if (!nation) return null;
      return nationMapping[nation] || nation;
    }
    let nazioneSelezionata = null; // Traccia quale nazione √® selezionata
    let expandedNations = new Set(); // Traccia quali nazioni sono espanse
    
    // Non caricare subito, aspetta DOMContentLoaded
    const sportInfo = {
      'calcio': { icon: '‚öΩ', nome: 'CALCIO' },
      'tennis': { icon: 'üéæ', nome: 'Tennis' },
      'basket': { icon: 'üèÄ', nome: 'Basket' },
      'football': { icon: '‚öΩ', nome: 'Football' },
      'baseball': { icon: '', nome: 'Baseball' },
      'hockey': { icon: 'üèí', nome: 'Hockey' },
      'rugby': { icon: 'üèâ', nome: 'Rugby' },
      'american football': { icon: 'üèà', nome: 'American Football' },
      'volleyball': { icon: 'üèê', nome: 'Volleyball' },
      'water polo': { icon: 'üèì', nome: 'Water Polo' },
      'pingpong': { icon: 'üéæ', nome: 'Pingpong' },
      'pallamano': { icon: 'üèê', nome: 'Pallamano' },
      'freccette': { icon: 'ÔøΩ', nome: 'Freccette' },
      'futsal': { icon: 'ü•Ö', nome: 'Futsal' },
      'boxing': { icon: 'ü•ä', nome: 'Boxing' },
      'e-sport': { icon: 'üéÆ', nome: 'E-Sport' },
      'badminton': { icon: 'üè∏', nome: 'Badminton' },
      'cricket': { icon: 'üèè', nome: 'Cricket' },
      'squash': { icon: 'üéæ', nome: 'Squash' },
      'horse racing': { icon: 'üê¥', nome: 'Horse Racing' },
    };

    // Mapping sport UI -> MongoDB
    function getSportForMongo(sport) {
      const mapping = {
        'water polo': 'pallanuoto',
        'waterpolo': 'pallanuoto',
        'american football': 'football',
        'e-sport': 'E-Sport',
        'badminton': 'Badminton',
        'cricket': 'Cricket',
        'squash': 'Squash',
        'horse racing': 'Horse Racing'
      };
      return mapping[sport] || sport;
    }

    // Toggle menu calcio
    // Funzione generica per toggle menu sport
    function toggleSportMenu(sport) {
      // Mappa sport -> ID submenu e arrow
      const sportMap = {
        'calcio': { submenu: 'calcio-submenu', arrow: 'calcio-arrow' },
        'tennis': { submenu: 'tennis-submenu', arrow: 'tennis-arrow' },
        'basket': { submenu: 'basket-submenu', arrow: 'basket-arrow' },
        'hockey': { submenu: 'hockey-submenu', arrow: 'hockey-arrow' },
        'rugby': { submenu: 'rugby-submenu', arrow: 'rugby-arrow' },
        'american football': { submenu: 'american-football-submenu', arrow: 'american-football-arrow' },
        'volleyball': { submenu: 'volleyball-submenu', arrow: 'volleyball-arrow' },
        'water polo': { submenu: 'water-polo-submenu', arrow: 'water-polo-arrow' },
        'pingpong': { submenu: 'pingpong-submenu', arrow: 'pingpong-arrow' },
        'futsal': { submenu: 'futsal-submenu', arrow: 'futsal-arrow' },
        'pallamano': { submenu: 'pallamano-submenu', arrow: 'pallamano-arrow' },
        'freccette': { submenu: 'freccette-submenu', arrow: 'freccette-arrow' },
        'boxing': { submenu: 'boxing-submenu', arrow: 'boxing-arrow' },
        'e-sport': { submenu: 'e-sport-submenu', arrow: 'e-sport-arrow' },
        'badminton': { submenu: 'badminton-submenu', arrow: 'badminton-arrow' },
        'cricket': { submenu: 'cricket-submenu', arrow: 'cricket-arrow' },
        'squash': { submenu: 'squash-submenu', arrow: 'squash-arrow' },
      };
      
      const sportInfo = sportMap[sport];
      if (!sportInfo) {
        console.error('toggleSportMenu: sport non mappato:', sport);
        return;
      }
      
      const submenu = document.getElementById(sportInfo.submenu);
      const arrow = document.getElementById(sportInfo.arrow);
      
      if (!submenu || !arrow) {
        console.error('toggleSportMenu: submenu o arrow non trovato per sport:', sport);
        return;
      }
      
      const isHidden = submenu.classList.contains('hidden');
      
      if (isHidden) {
        submenu.classList.remove('hidden');
        arrow.style.transform = 'rotate(180deg)';
        // Carica campionati se non gi√† caricati o se lo sport √® cambiato
        if (Object.keys(nationsLeagues).length === 0 || sportSelezionato === sport) {
          loadLeagues();
        }
      } else {
        submenu.classList.add('hidden');
        arrow.style.transform = 'rotate(0deg)';
      }
    }
    
    // Alias per retrocompatibilit√†
    function toggleCalcioMenu() {
      toggleSportMenu('calcio');
    }

    // Carica campionati disponibili
    async function loadLeagues() {
      // Mappa sport -> ID submenu
      const sportSubmenuMap = {
        'calcio': 'calcio-submenu',
        'tennis': 'tennis-submenu',
        'basket': 'basket-submenu',
        'hockey': 'hockey-submenu',
        'rugby': 'rugby-submenu',
        'american football': 'american-football-submenu',
        'volleyball': 'volleyball-submenu',
        'water polo': 'water-polo-submenu',
        'pingpong': 'pingpong-submenu',
        'futsal': 'futsal-submenu',
        'pallamano': 'pallamano-submenu',
        'freccette': 'freccette-submenu',
        'boxing': 'boxing-submenu',
        'e-sport': 'e-sport-submenu',
        'badminton': 'badminton-submenu',
        'cricket': 'cricket-submenu',
        'squash': 'squash-submenu',
      };
      
      const submenuId = sportSubmenuMap[sportSelezionato];
      if (!submenuId) {
        console.error('loadLeagues: sport non mappato:', sportSelezionato);
        return;
      }
      
      const submenu = document.getElementById(submenuId);
      if (!submenu) {
        console.error('loadLeagues: submenu non trovato per sport:', sportSelezionato, 'ID:', submenuId);
        return;
      }
      
      // Mostra il submenu se √® nascosto
      submenu.classList.remove('hidden');
      submenu.innerHTML = '<div class="text-xs text-gray-400 px-2 py-1">Caricamento campionati...</div>';
      
      try {
        // Usa URL assoluto per evitare problemi su Render
        const sportForMongo = getSportForMongo(sportSelezionato);
        const apiUrl = `${window.location.origin}/api/leagues-betbet?sport=${sportForMongo}`;
        const response = await fetch(apiUrl);
        
        if (!response.ok) {
          const errorText = await response.text();
          console.error('loadLeagues: errore HTTP', response.status, errorText);
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const contentType = response.headers.get('content-type');
        if (!contentType || !contentType.includes('application/json')) {
          const text = await response.text();
          console.error('loadLeagues: risposta non JSON', text.substring(0, 200));
          throw new Error('Risposta non √® JSON');
        }
        
        const data = await response.json();
        
        if (data.success && data.nations) {
          nationsLeagues = data.nations;
          renderLeaguesMenu();
          
          // Per horse racing, i "campi" sono i campionati - seleziona automaticamente il primo campo disponibile
          if (sportSelezionato === 'horse racing' || sportSelezionato === 'horseracing') {
            // Trova il primo campionato disponibile (qualsiasi nazione)
            const firstNation = Object.keys(nationsLeagues).sort()[0];
            if (firstNation && nationsLeagues[firstNation] && nationsLeagues[firstNation].length > 0) {
              const primoCampo = nationsLeagues[firstNation][0];
              campoSelezionato = primoCampo.full_name;
              // Carica i dati per mostrare i campi
              loadMatches();
            }
          }
          // Non selezionare automaticamente campionati - l'utente deve selezionare manualmente
        } else {
          console.error('loadLeagues: risposta API non valida', data);
          submenu.innerHTML = '<div class="text-xs text-red-400 px-2 py-1">Errore caricamento campionati</div>';
        }
      } catch (error) {
        console.error('Errore caricamento campionati:', error);
        submenu.innerHTML = `<div class="text-xs text-red-400 px-2 py-1">Errore: ${error.message}</div>`;
      }
    }

    // Mappatura bandiere SVG per nazioni
    const nationFlags = {
      "Italia": "https://1276648311.rsc.cdn77.org/alphacode/assets/images/flagssvg/it.svg",
      "Inghilterra": "https://1276648311.rsc.cdn77.org/alphacode/assets/images/flagssvg/eng.svg",
      "Spagna": "https://1276648311.rsc.cdn77.org/alphacode/assets/images/flagssvg/es.svg",
      "Francia": "https://1276648311.rsc.cdn77.org/alphacode/assets/images/flagssvg/fr.svg",
      "Germania": "https://1276648311.rsc.cdn77.org/alphacode/assets/images/flagssvg/de.svg",
      "Olanda": "https://1276648311.rsc.cdn77.org/alphacode/assets/images/flagssvg/nl.svg",
      "Paesi Bassi": "https://1276648311.rsc.cdn77.org/alphacode/assets/images/flagssvg/nl.svg",
      "Portogallo": "https://1276648311.rsc.cdn77.org/alphacode/assets/images/flagssvg/pt.svg",
      "Belgio": "https://1276648311.rsc.cdn77.org/alphacode/assets/images/flagssvg/be.svg",
      "Turchia": "https://1276648311.rsc.cdn77.org/alphacode/assets/images/flagssvg/tr.svg",
      "Grecia": "https://1276648311.rsc.cdn77.org/alphacode/assets/images/flagssvg/gr.svg",
      "Russia": "https://1276648311.rsc.cdn77.org/alphacode/assets/images/flagssvg/ru.svg",
      "Polonia": "https://1276648311.rsc.cdn77.org/alphacode/assets/images/flagssvg/pl.svg",
      "Repubblica Ceca": "https://1276648311.rsc.cdn77.org/alphacode/assets/images/flagssvg/cz.svg",
      "Svizzera": "https://1276648311.rsc.cdn77.org/alphacode/assets/images/flagssvg/ch.svg",
      "Austria": "https://1276648311.rsc.cdn77.org/alphacode/assets/images/flagssvg/at.svg",
      "Scozia": "https://1276648311.rsc.cdn77.org/alphacode/assets/images/flagssvg/gb-sct.svg",
      "Danimarca": "https://1276648311.rsc.cdn77.org/alphacode/assets/images/flagssvg/dk.svg",
      "Svezia": "https://1276648311.rsc.cdn77.org/alphacode/assets/images/flagssvg/se.svg",
      "Norvegia": "https://1276648311.rsc.cdn77.org/alphacode/assets/images/flagssvg/no.svg",
      "Brasile": "https://1276648311.rsc.cdn77.org/alphacode/assets/images/flagssvg/br.svg",
      "Argentina": "https://1276648311.rsc.cdn77.org/alphacode/assets/images/flagssvg/ar.svg",
      "Messico": "https://1276648311.rsc.cdn77.org/alphacode/assets/images/flagssvg/mx.svg",
      "Stati Uniti": "https://1276648311.rsc.cdn77.org/alphacode/assets/images/flagssvg/us.svg",
      "Giappone": "https://1276648311.rsc.cdn77.org/alphacode/assets/images/flagssvg/jp.svg",
      "Cina": "https://1276648311.rsc.cdn77.org/alphacode/assets/images/flagssvg/cn.svg",
      "Corea del Sud": "https://1276648311.rsc.cdn77.org/alphacode/assets/images/flagssvg/kr.svg",
      "Australia": "https://1276648311.rsc.cdn77.org/alphacode/assets/images/flagssvg/au.svg",
      "Bosnia ed Erzegovina": "https://1276648311.rsc.cdn77.org/alphacode/assets/images/flagssvg/ba.svg",
      "Bosnia & Herzegovina": "https://1276648311.rsc.cdn77.org/alphacode/assets/images/flagssvg/ba.svg",
      "Bulgaria": "https://1276648311.rsc.cdn77.org/alphacode/assets/images/flagssvg/bg.svg",
      "Ecuador": "https://1276648311.rsc.cdn77.org/alphacode/assets/images/flagssvg/ec.svg",
      "Israele": "https://1276648311.rsc.cdn77.org/alphacode/assets/images/flagssvg/il.svg",
      "Paraguay": "https://1276648311.rsc.cdn77.org/alphacode/assets/images/flagssvg/py.svg",
      "Slovenia": "https://1276648311.rsc.cdn77.org/alphacode/assets/images/flagssvg/si.svg",
      "Colombia": "https://1276648311.rsc.cdn77.org/alphacode/assets/images/flagssvg/co.svg",
      "Chile": "https://1276648311.rsc.cdn77.org/alphacode/assets/images/flagssvg/cl.svg",
      "Peru": "https://1276648311.rsc.cdn77.org/alphacode/assets/images/flagssvg/pe.svg",
      "Uruguay": "https://1276648311.rsc.cdn77.org/alphacode/assets/images/flagssvg/uy.svg",
      "Bolivia": "https://1276648311.rsc.cdn77.org/alphacode/assets/images/flagssvg/bo.svg",
      "Romania": "https://1276648311.rsc.cdn77.org/alphacode/assets/images/flagssvg/ro.svg",
      "Slovakia": "https://1276648311.rsc.cdn77.org/alphacode/assets/images/flagssvg/sk.svg",
      "Cyprus": "https://1276648311.rsc.cdn77.org/alphacode/assets/images/flagssvg/cy.svg",
      "Qatar": "https://1276648311.rsc.cdn77.org/alphacode/assets/images/flagssvg/qa.svg",
      "Saudi": "https://1276648311.rsc.cdn77.org/alphacode/assets/images/flagssvg/sa.svg",
      "Jordan": "https://1276648311.rsc.cdn77.org/alphacode/assets/images/flagssvg/jo.svg",
      "Singapore": "https://1276648311.rsc.cdn77.org/alphacode/assets/images/flagssvg/sg.svg",
      "Ghana": "https://1276648311.rsc.cdn77.org/alphacode/assets/images/flagssvg/gh.svg",
      "Nigeria": "https://1276648311.rsc.cdn77.org/alphacode/assets/images/flagssvg/ng.svg",
      "Honduras": "https://1276648311.rsc.cdn77.org/alphacode/assets/images/flagssvg/hn.svg",
      "Namibia": "https://1276648311.rsc.cdn77.org/alphacode/assets/images/flagssvg/na.svg",
      "Liberia": "https://1276648311.rsc.cdn77.org/alphacode/assets/images/flagssvg/lr.svg",
      "Mauritania": "https://1276648311.rsc.cdn77.org/alphacode/assets/images/flagssvg/mr.svg",
      "Sierra": "https://1276648311.rsc.cdn77.org/alphacode/assets/images/flagssvg/sl.svg",
      "Ivory": "https://1276648311.rsc.cdn77.org/alphacode/assets/images/flagssvg/ci.svg",
      "Northern": "https://1276648311.rsc.cdn77.org/alphacode/assets/images/flagssvg/gb-nir.svg",
      "South": "https://1276648311.rsc.cdn77.org/alphacode/assets/images/flagssvg/za.svg",
      "Zanzibar": "https://1276648311.rsc.cdn77.org/alphacode/assets/images/flagssvg/tz.svg",
      "Portugal": "https://1276648311.rsc.cdn77.org/alphacode/assets/images/flagssvg/pt.svg",
      "Sweden": "https://1276648311.rsc.cdn77.org/alphacode/assets/images/flagssvg/se.svg",
      "Norway": "https://1276648311.rsc.cdn77.org/alphacode/assets/images/flagssvg/no.svg",
      "Switzerland": "https://1276648311.rsc.cdn77.org/alphacode/assets/images/flagssvg/ch.svg",
      "Czechia": "https://1276648311.rsc.cdn77.org/alphacode/assets/images/flagssvg/cz.svg",
      "Scotland": "https://1276648311.rsc.cdn77.org/alphacode/assets/images/flagssvg/gb-sct.svg",
      "Belgium": "https://1276648311.rsc.cdn77.org/alphacode/assets/images/flagssvg/be.svg",
      "Mexico": "https://1276648311.rsc.cdn77.org/alphacode/assets/images/flagssvg/mx.svg",
      "Japan": "https://1276648311.rsc.cdn77.org/alphacode/assets/images/flagssvg/jp.svg",
      "USA": "https://1276648311.rsc.cdn77.org/alphacode/assets/images/flagssvg/us.svg",
      "T√ºrkiye": "https://1276648311.rsc.cdn77.org/alphacode/assets/images/flagssvg/tr.svg",
      "Europe": "üèÜ",
      "UEFA": "üèÜ",
      "Sud America": "üåé",
      "Copa": "üèÜ",
      "Africa": "üåç",
      "Asia": "üåè",
      "Baller League UK": "üè¥Û†ÅßÛ†Å¢Û†Å•Û†ÅÆÛ†ÅßÛ†Åø",
      "Brazil Kings Cup": "üáßüá∑",
      "Esoccer Battle": "üéÆ",
      "Esoccer Battle Volta": "üéÆ",
      "Altri": "üåç"
    };

    // Renderizza menu campionati con struttura gerarchica: Nazioni -> Campionati
    function renderLeaguesMenu() {
      // Mappa sport -> ID submenu
      const sportSubmenuMap = {
        'calcio': 'calcio-submenu',
        'tennis': 'tennis-submenu',
        'basket': 'basket-submenu',
        'hockey': 'hockey-submenu',
        'rugby': 'rugby-submenu',
        'american football': 'american-football-submenu',
        'volleyball': 'volleyball-submenu',
        'water polo': 'water-polo-submenu',
        'pingpong': 'pingpong-submenu',
        'futsal': 'futsal-submenu',
        'pallamano': 'pallamano-submenu',
        'freccette': 'freccette-submenu',
        'boxing': 'boxing-submenu',
        'e-sport': 'e-sport-submenu',
        'badminton': 'badminton-submenu',
        'cricket': 'cricket-submenu',
        'squash': 'squash-submenu',
      };
      
      const submenuId = sportSubmenuMap[sportSelezionato];
      if (!submenuId) {
        console.error('renderLeaguesMenu: sport non mappato:', sportSelezionato);
        return;
      }
      
      const submenu = document.getElementById(submenuId);
      if (!submenu) {
        console.error('renderLeaguesMenu: submenu non trovato per sport:', sportSelezionato, 'ID:', submenuId);
        return;
      }
      
      // Assicurati che il submenu sia visibile
      submenu.classList.remove('hidden');
      
      let html = '';
      
      // Aggiungi opzione "Tutti i campionati"
      html += `
        <div class="league-item-all px-2 py-1 hover:bg-gray-600 rounded cursor-pointer text-xs ${campionatoSelezionato === null ? 'bg-yellow-500 bg-opacity-20 text-yellow-400' : 'text-gray-300'}">
          üìã Tutti i campionati
        </div>
      `;
      
      // Ordina nazioni: prima Italia, poi altre in ordine alfabetico
      const sortedNations = Object.keys(nationsLeagues || {}).sort((a, b) => {
        if (a === "Italia") return -1;
        if (b === "Italia") return 1;
        return a.localeCompare(b);
      });
      
      if (sortedNations.length === 0) {
        html += '<div class="text-xs text-gray-400 px-2 py-1 mt-1">Nessun campionato disponibile</div>';
      } else {
        sortedNations.forEach(nation => {
          const leagues = nationsLeagues[nation] || [];
          const safeNation = (nation || '').replace(/'/g, "\\'").replace(/"/g, '&quot;');
          const nationId = `nation-${safeNation.replace(/[^a-zA-Z0-9]/g, '-')}`;
          // Cerca la bandiera, con fallback per varianti del nome
          let flag = nationFlags[nation];
          if (!flag) {
            // Prova varianti comuni
            const variants = {
              "Netherlands": "Paesi Bassi",
              "Olanda": "Paesi Bassi",
              "England": "Inghilterra",
              "Italy": "Italia",
              "Spain": "Spagna",
              "France": "Francia",
              "Germany": "Germania"
            };
            const variant = variants[nation];
            if (variant) {
              flag = nationFlags[variant];
            }
          }
          // Se ancora non trovata, usa bandiera generica o emoji
          if (!flag) {
            flag = "üè≥Ô∏è";
          }
          
          // Verifica se questa nazione ha un campionato selezionato
          const hasSelectedLeague = leagues.some(l => l.full_name === campionatoSelezionato);
          const isNationSelected = nazioneSelezionata === nation || hasSelectedLeague;
          const isExpanded = expandedNations.has(nationId) || hasSelectedLeague;
          
          // Se ha un campionato selezionato, assicurati che sia espansa
          if (hasSelectedLeague) {
            expandedNations.add(nationId);
          }
          
          // Determina se la bandiera √® un URL (immagine) o un emoji
          const isImage = flag.startsWith('http');
          const flagHtml = isImage 
            ? `<img src="${flag}" alt="${nation}" class="w-5 h-4 object-contain" />`
            : `<span class="text-lg">${flag}</span>`;
          
          // Header nazione con bandiera prima del nome (stile capitanbet)
          html += `
            <div class="mt-0.5">
              <div class="nation-header flex items-center px-2 py-1.5 hover:bg-gray-700 cursor-pointer border-b border-gray-700 ${isNationSelected ? 'bg-orange-600' : 'bg-gray-800'}" 
                   data-nation-id="${nationId}"
                   data-nation="${safeNation}">
                <div class="flex items-center space-x-2 flex-1">
                  ${flagHtml}
                  <span class="text-sm font-medium ${isNationSelected ? 'text-white' : 'text-gray-300'}">${nation}</span>
                </div>
                <svg class="nation-arrow w-4 h-4 text-gray-400 transition-transform ${isExpanded ? 'rotate-180' : ''}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                </svg>
              </div>
              <div id="${nationId}" class="nation-leagues ${isExpanded ? '' : 'hidden'} bg-gray-900">
          `;
          
          // Campionati sotto la nazione
          leagues.forEach((league, idx) => {
            const isSelected = campionatoSelezionato === league.full_name;
            html += `
              <div class="league-item px-6 py-1.5 hover:bg-gray-700 cursor-pointer text-sm border-b border-gray-800 ${isSelected ? 'bg-orange-500 bg-opacity-30 text-white' : 'text-gray-300'}" 
                   data-nation="${safeNation}" 
                   data-index="${idx}">
                ${(league.name || league.full_name || 'N/A').replace(/</g, '&lt;').replace(/>/g, '&gt;')}
              </div>
            `;
          });
          
          html += `</div></div>`;
        });
      }
      
      submenu.innerHTML = html;
      
      // Aggiungi event listener a "Tutti i campionati"
      const allItem = submenu.querySelector('.league-item-all');
      if (allItem) {
        allItem.addEventListener('click', function() {
          selezionaCampionato(null);
        });
      }
      
      // Aggiungi event listener agli header nazione
      submenu.querySelectorAll('.nation-header').forEach(header => {
        header.addEventListener('click', function() {
          const nationId = this.getAttribute('data-nation-id');
          const nation = this.getAttribute('data-nation');
          nazioneSelezionata = nation;
          toggleNation(nationId);
        });
      });
      
      // Aggiungi event listener ai campionati
      submenu.querySelectorAll('.league-item').forEach(item => {
        item.addEventListener('click', function(e) {
          e.stopPropagation(); // Evita che il click si propaghi al header nazione
          const nation = this.getAttribute('data-nation');
          const index = parseInt(this.getAttribute('data-index'));
          selezionaCampionatoByIndex(nation, index);
        });
      });
    }
    
    // Toggle espansione/collasso nazione
    function toggleNation(nationId) {
      const nationDiv = document.getElementById(nationId);
      const nationHeader = document.querySelector(`[data-nation-id="${nationId}"]`);
      const arrow = nationHeader?.querySelector('.nation-arrow');
      
      if (nationDiv && nationHeader && arrow) {
        const isHidden = nationDiv.classList.contains('hidden');
        if (isHidden) {
          nationDiv.classList.remove('hidden');
          arrow.classList.add('rotate-180');
          expandedNations.add(nationId);
        } else {
          nationDiv.classList.add('hidden');
          arrow.classList.remove('rotate-180');
          expandedNations.delete(nationId);
        }
      }
    }

    // Seleziona campionato
    async function selezionaCampionato(league, nation = null) {
      // Se nationsLeagues non √® ancora caricato, caricarlo prima
      if (Object.keys(nationsLeagues).length === 0 && (sportSelezionato === 'calcio' || sportSelezionato === 'horse racing' || sportSelezionato === 'horseracing')) {
        await loadLeagues();
      }
      
      campionatoSelezionato = league;
      
      // Per horse racing, imposta anche campoSelezionato (i campionati sono i campi)
      if (sportSelezionato === 'horse racing' || sportSelezionato === 'horseracing') {
        campoSelezionato = league;
      }
      
      // Se la nazione √® fornita, usala direttamente (evita ambiguit√† con campionati omonimi)
      if (nation) {
        nazioneSelezionata = nation;
      } else if (league) {
        // Altrimenti, trova la nazione del campionato selezionato
        // ATTENZIONE: se ci sono pi√π campionati con lo stesso nome, potrebbe trovare quello sbagliato
        for (const [nationKey, leagues] of Object.entries(nationsLeagues)) {
          if (leagues.some(l => l.full_name === league)) {
            nazioneSelezionata = nationKey;
            break;
          }
        }
      } else {
        nazioneSelezionata = null;
      }
      
      renderLeaguesMenu();
      loadMatches();
    }

    // Seleziona campionato per indice (evita problemi con caratteri speciali)
    function selezionaCampionatoByIndex(nation, index) {
      if (nationsLeagues[nation] && nationsLeagues[nation][index]) {
        const league = nationsLeagues[nation][index].full_name;
        // Passa la nazione direttamente per evitare ambiguit√†
        selezionaCampionato(league, nation);
      }
    }

    // Variabile per campo selezionato (Horse Racing)
    let campoSelezionato = null;
    
    // Variabile per partita selezionata (Goalscorer)
    let partitaSelezionata = null;
    
    // Seleziona sport
    function selezionaSport(sport, icon, nome) {
      sportSelezionato = sport;
      campionatoSelezionato = null; // Reset filtro campionato
      campoSelezionato = null; // Reset campo selezionato
      partitaSelezionata = null; // Reset partita selezionata
      
      // Mostra/nascondi layout in base allo sport
      const horseRacingLayout = document.getElementById('horse-racing-layout');
      const goalscorerLayout = document.getElementById('goalscorer-layout');
      const normalLayout = document.getElementById('normal-layout');
      
      if (sport === 'horse racing' || sport === 'horseracing') {
        // Per horse racing, usa il layout normale con campi a destra
        if (horseRacingLayout) horseRacingLayout.classList.remove('hidden');
        if (goalscorerLayout) goalscorerLayout.classList.add('hidden');
        if (normalLayout) normalLayout.classList.add('hidden');
      } else if (mercatoSelezionato === 'Goalscorer' && sport === 'calcio') {
        if (horseRacingLayout) horseRacingLayout.classList.add('hidden');
        if (goalscorerLayout) goalscorerLayout.classList.remove('hidden');
        if (normalLayout) normalLayout.classList.add('hidden');
      } else {
        if (horseRacingLayout) horseRacingLayout.classList.add('hidden');
        if (goalscorerLayout) goalscorerLayout.classList.add('hidden');
        if (normalLayout) normalLayout.classList.remove('hidden');
      }
      
      // Mostra/nascondi tab mercati in base allo sport
      const mercatiTabsContainer = document.getElementById('mercati-tabs-container');
      if (mercatiTabsContainer) {
        if (sport === 'calcio') {
          mercatiTabsContainer.classList.remove('hidden');
        } else {
          mercatiTabsContainer.classList.add('hidden');
        }
      }
      
      // Per gli altri sport (non calcio), imposta mercato a 1X2
      if (sport !== 'calcio') {
        mercatoSelezionato = '1X2';
        // Aggiorna UI tab (se visibili)
        document.querySelectorAll('.mercato-tab-btn').forEach(tab => {
          tab.classList.remove('bg-yellow-500', 'text-black');
          tab.classList.add('bg-gray-600', 'text-white');
        });
        const tab1X2 = document.getElementById('mercato-1X2');
        if (tab1X2) {
          tab1X2.classList.remove('bg-gray-600', 'text-white');
          tab1X2.classList.add('bg-yellow-500', 'text-black');
        }
      } else {
        // Per calcio, imposta a Principali se non gi√† impostato
        if (mercatoSelezionato !== 'Principali') {
          mercatoSelezionato = 'Principali';
          // Aggiorna UI tab
          document.querySelectorAll('.mercato-tab-btn').forEach(tab => {
            tab.classList.remove('bg-yellow-500', 'text-black');
            tab.classList.add('bg-gray-600', 'text-white');
          });
          const tabPrincipali = document.getElementById('mercato-Principali');
          if (tabPrincipali) {
            tabPrincipali.classList.remove('bg-gray-600', 'text-white');
            tabPrincipali.classList.add('bg-yellow-500', 'text-black');
          }
        }
      }
      
      // Aggiorna UI sidebar
      document.querySelectorAll('.sport-item').forEach(item => {
        item.classList.remove('bg-yellow-500', 'bg-opacity-20');
        // Per calcio, cerca dentro calcio-toggle
        if (item.getAttribute('data-sport') === 'calcio') {
          const calcioToggle = item.querySelector('#calcio-toggle');
          if (calcioToggle) {
            const indicator = calcioToggle.querySelector('.sport-indicator');
            if (indicator) indicator.classList.add('hidden');
          }
        } else {
        const indicator = item.querySelector('.sport-indicator');
        if (indicator) indicator.classList.add('hidden');
        }
      });
      const selectedItem = document.querySelector(`[data-sport="${sport}"]`);
      if (selectedItem) {
        selectedItem.classList.add('bg-yellow-500', 'bg-opacity-20');
        // Per calcio, cerca dentro calcio-toggle
        if (sport === 'calcio') {
          const calcioToggle = selectedItem.querySelector('#calcio-toggle');
          if (calcioToggle) {
            const indicator = calcioToggle.querySelector('.sport-indicator');
            if (indicator) indicator.classList.remove('hidden');
          }
        } else {
        const indicator = selectedItem.querySelector('.sport-indicator');
        if (indicator) indicator.classList.remove('hidden');
        }
      }
      
      // Aggiorna titolo
      document.getElementById('sport-title').textContent = nome;
      
      // Mostra/nascondi contenitore mercati per categoria
      const mercatiContainer = document.getElementById('mercati-categorie-container');
      if (mercatiContainer) {
        if (sport === 'calcio') {
          // Verr√† mostrato quando vengono caricati i dati
        } else {
          mercatiContainer.classList.add('hidden');
        }
      }
      
      // Carica campionati per tutti gli sport (non solo calcio)
      loadLeagues();
      
      // Ricarica i dati
      loadMatches().then(() => {
      }).catch(error => {
        console.error('Errore caricamento dati per sport:', sport, error);
      });
    }

    // Seleziona mercato
    function selezionaMercato(mercato) {
      mercatoSelezionato = mercato;
      
      // Aggiorna UI tab
      document.querySelectorAll('.mercato-tab-btn').forEach(tab => {
        tab.classList.remove('bg-yellow-500', 'text-black');
        tab.classList.add('bg-gray-600', 'text-white');
      });
      const selectedTab = document.getElementById(`mercato-${mercato}`);
      if (selectedTab) {
        selectedTab.classList.remove('bg-gray-600', 'text-white');
        selectedTab.classList.add('bg-yellow-500', 'text-black');
      }
      
      // Mostra/nascondi layout in base al mercato
      const horseRacingLayout = document.getElementById('horse-racing-layout');
      const goalscorerLayout = document.getElementById('goalscorer-layout');
      const normalLayout = document.getElementById('normal-layout');
      
      if (mercato === 'Goalscorer' && sportSelezionato === 'calcio') {
        if (horseRacingLayout) horseRacingLayout.classList.add('hidden');
        if (goalscorerLayout) goalscorerLayout.classList.remove('hidden');
        if (normalLayout) normalLayout.classList.add('hidden');
        // Chiama sempre le funzioni per inizializzare la sidebar e il contenuto
        renderSquadreGoalscorer();
        renderMarcatoriGoalscorer();
      } else {
        if (horseRacingLayout) horseRacingLayout.classList.add('hidden');
        if (goalscorerLayout) goalscorerLayout.classList.add('hidden');
        if (normalLayout) normalLayout.classList.remove('hidden');
        // Rerenderizza le partite con il nuovo mercato
        if (matchesData.length > 0) {
          renderMatches();
        }
      }
    }
    
    // Calcola colonne per mercato
    // Helper per estrarre quota Doppia Chance
    function getDoubleChanceQuota(quote, col, homeName, awayName, isFirstHalf = false, isSecondHalf = false) {
      if (!quote) return null;
      
      let doubleChance = {};
      
      // Per DC 1T, cerca in half_time_double_chance
      if (isFirstHalf) {
        doubleChance = quote.half_time_double_chance || 
                      quote.half?.sp?.half_time_double_chance ||
                      quote.main?.sp?.half_time_double_chance ||
                      quote.others?.find(o => o.sp?.half_time_double_chance)?.sp?.half_time_double_chance ||
                      {};
      } 
      // Per DC 2T, cerca in 2nd_half_double_chance
      else if (isSecondHalf) {
        doubleChance = quote['2nd_half_double_chance'] || 
                      quote.half?.sp?.['2nd_half_double_chance'] ||
                      quote.goals?.sp?.['2nd_half_double_chance'] ||
                      quote.others?.find(o => o.sp?.['2nd_half_double_chance'])?.sp?.['2nd_half_double_chance'] ||
                      {};
      }
      // Per DC normale, cerca in main.sp.double_chance o direttamente in quote.double_chance
      else {
        doubleChance = quote.double_chance || 
                      quote.main?.sp?.double_chance || 
                      quote.goals?.sp?.double_chance ||
                      quote.others?.find(o => o.sp?.double_chance)?.sp?.double_chance ||
                      {};
      }
      
      // Se doubleChance √® direttamente un array
      if (Array.isArray(doubleChance)) {
        for (const odd of doubleChance) {
          const name = (odd.name || '').toLowerCase();
          const header = (odd.header || '').toUpperCase();
          const homeLower = (homeName || '').toLowerCase();
          const awayLower = (awayName || '').toLowerCase();
          
          // Se header corrisponde direttamente (formato calculated: "1X", "X2", "12")
          if (header === col.toUpperCase()) {
            return odd.odds;
          }
          
          // Mappa le combinazioni per nome
          if (col === '1X') {
            if (name.includes('draw')) {
              if (homeLower && name.includes(homeLower) && (!awayLower || !name.includes(awayLower))) {
                return odd.odds;
              }
              if (name.includes('home') && !name.includes('away')) {
                return odd.odds;
              }
            }
            if (homeLower && name.includes(homeLower) && name.includes('or') && name.includes('draw') && 
                (!awayLower || !name.includes(awayLower))) {
              return odd.odds;
            }
          } else if (col === 'X2') {
            if (name.includes('draw')) {
              if (awayLower && name.includes(awayLower) && (!homeLower || !name.includes(homeLower))) {
                return odd.odds;
              }
              if (name.includes('away') && !name.includes('home')) {
                return odd.odds;
              }
            }
            if (awayLower && name.includes(awayLower) && name.includes('or') && name.includes('draw') && 
                (!homeLower || !name.includes(homeLower))) {
              return odd.odds;
            }
          } else if (col === '12') {
            if (!name.includes('draw')) {
              if (homeLower && awayLower && name.includes(homeLower) && name.includes(awayLower)) {
                return odd.odds;
              }
              if (name.includes('home') && name.includes('away')) {
                return odd.odds;
              }
            }
          }
        }
      }
      
      // Se doubleChance ha una propriet√† odds che √® un array
      if (Array.isArray(doubleChance.odds)) {
        for (const odd of doubleChance.odds) {
          const name = (odd.name || '').toLowerCase();
          const header = (odd.header || '').toUpperCase();
          const homeLower = (homeName || '').toLowerCase();
          const awayLower = (awayName || '').toLowerCase();
          
          // Se header corrisponde direttamente (formato calculated: "1X", "X2", "12")
          if (header === col.toUpperCase()) {
            return odd.odds;
          }
          
          // Mappa le combinazioni per nome
          if (col === '1X') {
            // Home or Draw - cerca "home or draw" o "nome_squadra_casa or draw"
            // Pattern: "Fiorentina or Draw" (NON "Draw or Juventus")
            if (name.includes('draw')) {
              // Se contiene "draw", deve contenere il nome della squadra di casa E NON quello ospite
              if (homeLower && name.includes(homeLower) && (!awayLower || !name.includes(awayLower))) {
                return odd.odds;
              }
              // Oppure pattern generico "home or draw" o "draw or home" (senza "away")
              if (name.includes('home') && !name.includes('away')) {
                return odd.odds;
              }
            }
            // Pattern "nome_squadra_casa or draw" (senza "draw" all'inizio e senza nome squadra ospite)
            if (homeLower && name.includes(homeLower) && name.includes('or') && name.includes('draw') && 
                (!awayLower || !name.includes(awayLower))) {
              return odd.odds;
            }
          } else if (col === 'X2') {
            // Draw or Away - cerca "draw or away" o "draw or nome_squadra_ospite"
            // Pattern: "Draw or Juventus" (NON "Fiorentina or Draw")
            if (name.includes('draw')) {
              // Se contiene "draw", deve contenere il nome della squadra ospite E NON quello di casa
              if (awayLower && name.includes(awayLower) && (!homeLower || !name.includes(homeLower))) {
                return odd.odds;
              }
              // Oppure pattern generico "draw or away" o "away or draw" (senza "home")
              if (name.includes('away') && !name.includes('home')) {
                return odd.odds;
              }
            }
            // Pattern "draw or nome_squadra_ospite" (senza nome squadra di casa)
            if (awayLower && name.includes(awayLower) && name.includes('or') && name.includes('draw') && 
                (!homeLower || !name.includes(homeLower))) {
              return odd.odds;
            }
          } else if (col === '12') {
            // Home or Away - cerca "home or away" o "nome_squadra1 or nome_squadra2" (senza draw)
            // Pattern: "Fiorentina or Juventus" o "Home or Away"
            if (!name.includes('draw')) {
              // Deve contenere entrambi i nomi delle squadre
              if (homeLower && awayLower && name.includes(homeLower) && name.includes(awayLower)) {
                return odd.odds;
              }
              // Oppure pattern generico "home or away" o "away or home"
              if (name.includes('home') && name.includes('away')) {
                return odd.odds;
              }
            }
          }
        }
      }
      
      // Fallback: cerca direttamente per nome
      if (doubleChance[col]) {
        return doubleChance[col];
      }
      
      return null;
    }

    // Helper per formattare quota con 2 decimali
    function formattaQuota(quota) {
      if (quota === '-' || quota === null || quota === undefined) {
        return '-';
      }
      const num = parseFloat(quota);
      if (isNaN(num)) {
        return quota; // Restituisci il valore originale se non √® un numero
      }
      return num.toFixed(2);
    }

    // Helper per estrarre quota 1X2 dal JSON (per basket e altri sport)
    function get1X2Quota(quote, col, sport) {
      if (!quote) return null;
      
      // Per l'hockey, cerca in 3_way con name "Money Line" e header "1", "2" o "Tie" (per X)
      if (sport === 'hockey' || sport === 'ice_hockey') {
        const threeWay = quote.main?.sp?.['3_way'] || quote['3_way'] || {};
        
        // Se threeWay √® direttamente un array
        if (Array.isArray(threeWay)) {
          for (const odd of threeWay) {
            const name = (odd.name || '').toLowerCase().trim();
            const header = (odd.header || '').trim();
            if (name === 'money line') {
              if (col === '1' && header === '1') {
                return odd.odds;
              } else if (col === '2' && header === '2') {
                return odd.odds;
              } else if (col === 'X' && header.toLowerCase() === 'tie') {
                return odd.odds;
              }
            }
          }
        }
        
        // Se threeWay ha una propriet√† odds che √® un array
        if (Array.isArray(threeWay.odds)) {
          for (const odd of threeWay.odds) {
            const name = (odd.name || '').toLowerCase().trim();
            const header = (odd.header || '').trim();
            if (name === 'money line') {
              if (col === '1' && header === '1') {
                return odd.odds;
              } else if (col === '2' && header === '2') {
                return odd.odds;
              } else if (col === 'X' && header.toLowerCase() === 'tie') {
                return odd.odds;
              }
            }
          }
        }
        
        return null;
      }
      
      // Per il volley, cerca in game_lines con name "Winner" e header "1" o "2"
      if (sport === 'volleyball' || sport === 'volley') {
        const gameLines = quote.main?.sp?.game_lines || quote.game_lines || {};
        
        // Se gameLines √® direttamente un array
        if (Array.isArray(gameLines)) {
          for (const odd of gameLines) {
            const name = (odd.name || '').toLowerCase().trim();
            const header = (odd.header || '').trim();
            if (name === 'winner' && 
                ((col === '1' && header === '1') || (col === '2' && header === '2'))) {
              return odd.odds;
            }
          }
        }
        
        // Se gameLines ha una propriet√† odds che √® un array
        if (Array.isArray(gameLines.odds)) {
          for (const odd of gameLines.odds) {
            const name = (odd.name || '').toLowerCase().trim();
            const header = (odd.header || '').trim();
            if (name === 'winner' && 
                ((col === '1' && header === '1') || (col === '2' && header === '2'))) {
              return odd.odds;
            }
          }
        }
        
        return null;
      }
      
      // Per il waterpolo, cerca in game_lines con name "To Win" e header "1" o "2"
      if (sport === 'water polo' || sport === 'waterpolo') {
        const gameLines = quote.main?.sp?.game_lines || quote.game_lines || {};
        
        // Se gameLines √® direttamente un array
        if (Array.isArray(gameLines)) {
          for (const odd of gameLines) {
            const name = (odd.name || '').toLowerCase().trim();
            const header = (odd.header || '').trim();
            if (name === 'to win' && 
                ((col === '1' && header === '1') || (col === '2' && header === '2'))) {
              return odd.odds;
            }
          }
        }
        
        // Se gameLines ha una propriet√† odds che √® un array
        if (Array.isArray(gameLines.odds)) {
          for (const odd of gameLines.odds) {
            const name = (odd.name || '').toLowerCase().trim();
            const header = (odd.header || '').trim();
            if (name === 'to win' && 
                ((col === '1' && header === '1') || (col === '2' && header === '2'))) {
              return odd.odds;
            }
          }
        }
        
        return null;
      }
      
      // Per la pallamano, cerca in game_lines con name "To Win" e header "1" o "2"
      if (sport === 'pallamano') {
        const gameLines = quote.main?.sp?.game_lines || quote.game_lines || {};
        
        // Se gameLines √® direttamente un array
        if (Array.isArray(gameLines)) {
          for (const odd of gameLines) {
            const name = (odd.name || '').toLowerCase().trim();
            const header = (odd.header || '').trim();
            if (name === 'to win' && 
                ((col === '1' && header === '1') || (col === '2' && header === '2'))) {
              return odd.odds;
            }
          }
        }
        
        // Se gameLines ha una propriet√† odds che √® un array
        if (Array.isArray(gameLines.odds)) {
          for (const odd of gameLines.odds) {
            const name = (odd.name || '').toLowerCase().trim();
            const header = (odd.header || '').trim();
            if (name === 'to win' && 
                ((col === '1' && header === '1') || (col === '2' && header === '2'))) {
              return odd.odds;
            }
          }
        }
        
        return null;
      }
      
      // Per il football (american football), cerca in game_lines con name "Money Line" e header "1" o "2"
      if (sport === 'football' || sport === 'american football') {
        const gameLines = quote.main?.sp?.game_lines || quote.game_lines || {};
        
        // Se gameLines √® direttamente un array
        if (Array.isArray(gameLines)) {
          for (const odd of gameLines) {
            const name = (odd.name || '').toLowerCase().trim();
            const header = (odd.header || '').trim();
            if (name === 'money line' && 
                ((col === '1' && header === '1') || (col === '2' && header === '2'))) {
              return odd.odds;
            }
          }
        }
        
        // Se gameLines ha una propriet√† odds che √® un array
        if (Array.isArray(gameLines.odds)) {
          for (const odd of gameLines.odds) {
            const name = (odd.name || '').toLowerCase().trim();
            const header = (odd.header || '').trim();
            if (name === 'money line' && 
                ((col === '1' && header === '1') || (col === '2' && header === '2'))) {
              return odd.odds;
            }
          }
        }
        
        return null;
      }
      
      // Per il rugby, cerca in game_betting_3_way con name "Result" e header "1", "Tie" (per X), o "2"
      if (sport === 'rugby') {
        const gameBetting3Way = quote.main?.sp?.game_betting_3_way || quote.game_betting_3_way || {};
        
        // Se gameBetting3Way √® direttamente un array
        if (Array.isArray(gameBetting3Way)) {
          for (const odd of gameBetting3Way) {
            const name = (odd.name || '').toLowerCase().trim();
            const header = (odd.header || '').trim();
            if (name === 'result') {
              if (col === '1' && header === '1') {
                return odd.odds;
              } else if (col === 'X' && header.toLowerCase() === 'tie') {
                return odd.odds;
              } else if (col === '2' && header === '2') {
                return odd.odds;
              }
            }
          }
        }
        
        // Se gameBetting3Way ha una propriet√† odds che √® un array
        if (Array.isArray(gameBetting3Way.odds)) {
          for (const odd of gameBetting3Way.odds) {
            const name = (odd.name || '').toLowerCase().trim();
            const header = (odd.header || '').trim();
            if (name === 'result') {
              if (col === '1' && header === '1') {
                return odd.odds;
              } else if (col === 'X' && header.toLowerCase() === 'tie') {
                return odd.odds;
              } else if (col === '2' && header === '2') {
                return odd.odds;
              }
            }
          }
        }
        
        return null;
      }
      
      // Per il boxing, cerca in to_win_fight con name "1" o "2"
      if (sport === 'boxing') {
        const toWinFight = quote.main?.sp?.to_win_fight || quote.to_win_fight || {};
        
        // Se toWinFight √® direttamente un array
        if (Array.isArray(toWinFight)) {
          for (const odd of toWinFight) {
            const name = (odd.name || '').trim();
            if ((col === '1' && name === '1') || (col === '2' && name === '2')) {
              return odd.odds;
            }
          }
        }
        
        // Se toWinFight ha una propriet√† odds che √® un array
        if (Array.isArray(toWinFight.odds)) {
          for (const odd of toWinFight.odds) {
            const name = (odd.name || '').trim();
            if ((col === '1' && name === '1') || (col === '2' && name === '2')) {
              return odd.odds;
            }
          }
        }
        
        return null;
      }
      
      // Per il futsal, cerca in money_line con name "Result" e header "1", "Tie" (per X), o "2"
      if (sport === 'futsal') {
        const moneyLine = quote.main?.sp?.money_line || quote.money_line || {};
        
        // Se moneyLine √® direttamente un array
        if (Array.isArray(moneyLine)) {
          for (const odd of moneyLine) {
            const name = (odd.name || '').toLowerCase().trim();
            const header = (odd.header || '').trim();
            if (name === 'result') {
              if (col === '1' && header === '1') {
                return odd.odds;
              } else if (col === 'X' && header.toLowerCase() === 'tie') {
                return odd.odds;
              } else if (col === '2' && header === '2') {
                return odd.odds;
              }
            }
          }
        }
        
        // Se moneyLine ha una propriet√† odds che √® un array
        if (Array.isArray(moneyLine.odds)) {
          for (const odd of moneyLine.odds) {
            const name = (odd.name || '').toLowerCase().trim();
            const header = (odd.header || '').trim();
            if (name === 'result') {
              if (col === '1' && header === '1') {
                return odd.odds;
              } else if (col === 'X' && header.toLowerCase() === 'tie') {
                return odd.odds;
              } else if (col === '2' && header === '2') {
                return odd.odds;
              }
            }
          }
        }
        
        return null;
      }
      
      // Per l'e-sport, cerca in match_lines con name "To Win" e header "1" o "2"
      if (sport === 'e-sport' || sport === 'esport') {
        const matchLines = quote.main?.sp?.match_lines || quote.match_lines || {};
        
        // Se matchLines √® direttamente un array
        if (Array.isArray(matchLines)) {
          for (const odd of matchLines) {
            const name = (odd.name || '').toLowerCase().trim();
            const header = (odd.header || '').trim();
            if (name === 'to win' && 
                ((col === '1' && header === '1') || (col === '2' && header === '2'))) {
              return odd.odds;
            }
          }
        }
        
        // Se matchLines ha una propriet√† odds che √® un array
        if (Array.isArray(matchLines.odds)) {
          for (const odd of matchLines.odds) {
            const name = (odd.name || '').toLowerCase().trim();
            const header = (odd.header || '').trim();
            if (name === 'to win' && 
                ((col === '1' && header === '1') || (col === '2' && header === '2'))) {
              return odd.odds;
            }
          }
        }
        
        return null;
      }
      
      // Per il badminton, cerca in match_lines con name "To Win" e header "1" o "2"
      if (sport === 'badminton') {
        const matchLines = quote.main?.sp?.match_lines || quote.match_lines || {};
        
        // Se matchLines √® direttamente un array
        if (Array.isArray(matchLines)) {
          for (const odd of matchLines) {
            const name = (odd.name || '').toLowerCase().trim();
            const header = (odd.header || '').trim();
            if (name === 'to win' && 
                ((col === '1' && header === '1') || (col === '2' && header === '2'))) {
              return odd.odds;
            }
          }
        }
        
        // Se matchLines ha una propriet√† odds che √® un array
        if (Array.isArray(matchLines.odds)) {
          for (const odd of matchLines.odds) {
            const name = (odd.name || '').toLowerCase().trim();
            const header = (odd.header || '').trim();
            if (name === 'to win' && 
                ((col === '1' && header === '1') || (col === '2' && header === '2'))) {
              return odd.odds;
            }
          }
        }
        
        return null;
      }
      
      // Per il cricket, cerca in to_win_the_match con name "1" o "2"
      if (sport === 'cricket') {
        const toWinTheMatch = quote.main?.sp?.to_win_the_match || quote.to_win_the_match || {};
        
        // Se toWinTheMatch √® direttamente un array
        if (Array.isArray(toWinTheMatch)) {
          for (const odd of toWinTheMatch) {
            const name = (odd.name || '').trim();
            if ((col === '1' && name === '1') || (col === '2' && name === '2')) {
              return odd.odds;
            }
          }
        }
        
        // Se toWinTheMatch ha una propriet√† odds che √® un array
        if (Array.isArray(toWinTheMatch.odds)) {
          for (const odd of toWinTheMatch.odds) {
            const name = (odd.name || '').trim();
            if ((col === '1' && name === '1') || (col === '2' && name === '2')) {
              return odd.odds;
            }
          }
        }
        
        return null;
      }
      
      // Per lo squash, cerca in schedule.sp.main con name "1" o "2"
      if (sport === 'squash') {
        const scheduleMain = quote.schedule?.sp?.main || quote.main || {};
        
        // Se scheduleMain √® direttamente un array
        if (Array.isArray(scheduleMain)) {
          for (const odd of scheduleMain) {
            const name = (odd.name || '').trim();
            if ((col === '1' && name === '1') || (col === '2' && name === '2')) {
              return odd.odds;
            }
          }
        }
        
        // Fallback: cerca in quote.main.sp.main se esiste
        const mainSp = quote.main?.sp?.main;
        if (Array.isArray(mainSp)) {
          for (const odd of mainSp) {
            const name = (odd.name || '').trim();
            if ((col === '1' && name === '1') || (col === '2' && name === '2')) {
              return odd.odds;
            }
          }
        }
        
        return null;
      }
      
      // Per Horse Racing, cerca in win_each_way per nome del cavallo
      if (sport === 'horse racing' || sport === 'horseracing') {
        const winEachWay = quote.win_each_way || [];
        
        if (Array.isArray(winEachWay)) {
          for (const cavallo of winEachWay) {
            const nomeCavallo = (cavallo.name || '').trim();
            // col √® il nome del cavallo
            if (nomeCavallo === col.trim()) {
              return cavallo.odds;
            }
          }
        }
        
        return null;
      }
      
      // Per il ping pong, cerca in match_lines con name "To Win" e header "1" o "2"
      if (sport === 'pingpong' || sport === 'ping_pong') {
        const matchLines = quote.main?.sp?.match_lines || quote.match_lines || {};
        
        // Se matchLines √® direttamente un array
        if (Array.isArray(matchLines)) {
          for (const odd of matchLines) {
            const name = (odd.name || '').toLowerCase().trim();
            const header = (odd.header || '').trim();
            if (name === 'to win' && 
                ((col === '1' && header === '1') || (col === '2' && header === '2'))) {
              return odd.odds;
            }
          }
        }
        
        // Se matchLines ha una propriet√† odds che √® un array
        if (Array.isArray(matchLines.odds)) {
          for (const odd of matchLines.odds) {
            const name = (odd.name || '').toLowerCase().trim();
            const header = (odd.header || '').trim();
            if (name === 'to win' && 
                ((col === '1' && header === '1') || (col === '2' && header === '2'))) {
              return odd.odds;
            }
          }
        }
        
        return null;
      }
      
      // Per il basket, cerca in game_lines con name "Money Line" e header "1" o "2"
      if (sport === 'basket') {
        // Per la X, restituisci sempre 10
        if (col === 'X') {
          return '10';
        }
        
        const gameLines = quote.main?.sp?.game_lines || quote.game_lines || {};
        
        // Se gameLines √® direttamente un array
        if (Array.isArray(gameLines)) {
          for (const odd of gameLines) {
            const name = (odd.name || '').toLowerCase().trim();
            const header = (odd.header || '').trim();
            if (name === 'money line' && 
                ((col === '1' && header === '1') || (col === '2' && header === '2'))) {
              return odd.odds;
            }
          }
        }
        
        // Se gameLines ha una propriet√† odds che √® un array
        if (Array.isArray(gameLines.odds)) {
          for (const odd of gameLines.odds) {
            const name = (odd.name || '').toLowerCase().trim();
            const header = (odd.header || '').trim();
            if (name === 'money line' && 
                ((col === '1' && header === '1') || (col === '2' && header === '2'))) {
              return odd.odds;
            }
          }
        }
        
        // Fallback: cerca anche in game_lines_3_way
        const gameLines3Way = quote.main?.sp?.game_lines_3_way || quote.game_lines_3_way || {};
        
        if (Array.isArray(gameLines3Way)) {
          for (const odd of gameLines3Way) {
            const name = (odd.name || odd.header || '').toLowerCase().trim();
            if ((col === '1' && (name === '1' || name === 'home' || name === 'casa')) ||
                (col === '2' && (name === '2' || name === 'away' || name === 'trasferta' || name === 'ospiti'))) {
              return odd.odds;
            }
          }
        }
        
        if (Array.isArray(gameLines3Way.odds)) {
          for (const odd of gameLines3Way.odds) {
            const name = (odd.name || odd.header || '').toLowerCase().trim();
            if ((col === '1' && (name === '1' || name === 'home' || name === 'casa')) ||
                (col === '2' && (name === '2' || name === 'away' || name === 'trasferta' || name === 'ospiti'))) {
              return odd.odds;
            }
          }
        }
        
        return null;
      }
      
      // Per gli altri sport, cerca in game_lines_3_way
      const gameLines3Way = quote.main?.sp?.game_lines_3_way || quote.game_lines_3_way || {};
      
      // Se gameLines3Way √® direttamente un array
      if (Array.isArray(gameLines3Way)) {
        for (const odd of gameLines3Way) {
          const name = (odd.name || odd.header || '').toLowerCase().trim();
          if ((col === '1' && (name === '1' || name === 'home' || name === 'casa')) ||
              (col === '2' && (name === '2' || name === 'away' || name === 'trasferta' || name === 'ospiti')) ||
              (col === 'X' && (name === 'x' || name === 'draw' || name === 'pareggio'))) {
            return odd.odds;
          }
        }
      }
      
      // Se gameLines3Way ha una propriet√† odds che √® un array
      if (Array.isArray(gameLines3Way.odds)) {
        for (const odd of gameLines3Way.odds) {
          const name = (odd.name || odd.header || '').toLowerCase().trim();
          if ((col === '1' && (name === '1' || name === 'home' || name === 'casa')) ||
              (col === '2' && (name === '2' || name === 'away' || name === 'trasferta' || name === 'ospiti')) ||
              (col === 'X' && (name === 'x' || name === 'draw' || name === 'pareggio'))) {
            return odd.odds;
          }
        }
      }
      
      // Cerca in main.sp.full_time_result
      const fullTimeResult = quote.main?.sp?.full_time_result || quote.full_time_result || {};
      
      // Se fullTimeResult √® direttamente un array
      if (Array.isArray(fullTimeResult)) {
        for (const odd of fullTimeResult) {
          const name = (odd.name || odd.header || '').toLowerCase().trim();
          if ((col === '1' && (name === '1' || name === 'home' || name === 'casa')) ||
              (col === '2' && (name === '2' || name === 'away' || name === 'trasferta' || name === 'ospiti')) ||
              (col === 'X' && (name === 'x' || name === 'draw' || name === 'pareggio'))) {
            return odd.odds;
          }
        }
      }
      
      // Se fullTimeResult ha una propriet√† odds che √® un array
      if (Array.isArray(fullTimeResult.odds)) {
        for (const odd of fullTimeResult.odds) {
          const name = (odd.name || odd.header || '').toLowerCase().trim();
          if ((col === '1' && (name === '1' || name === 'home' || name === 'casa')) ||
              (col === '2' && (name === '2' || name === 'away' || name === 'trasferta' || name === 'ospiti')) ||
              (col === 'X' && (name === 'x' || name === 'draw' || name === 'pareggio'))) {
            return odd.odds;
          }
        }
      }
      
      // Cerca anche in match_winner o to_win_match
      const matchWinner = quote.main?.sp?.match_winner || quote.match_winner || quote.to_win_match || {};
      
      if (Array.isArray(matchWinner)) {
        for (const odd of matchWinner) {
          const name = (odd.name || odd.header || '').toLowerCase().trim();
          if ((col === '1' && (name === '1' || name === 'home' || name === 'casa')) ||
              (col === '2' && (name === '2' || name === 'away' || name === 'trasferta' || name === 'ospiti'))) {
            return odd.odds;
          }
        }
      }
      
      if (Array.isArray(matchWinner.odds)) {
        for (const odd of matchWinner.odds) {
          const name = (odd.name || odd.header || '').toLowerCase().trim();
          if ((col === '1' && (name === '1' || name === 'home' || name === 'casa')) ||
              (col === '2' && (name === '2' || name === 'away' || name === 'trasferta' || name === 'ospiti'))) {
            return odd.odds;
          }
        }
      }
      
      return null;
    }

    // Helper per estrarre quota Over/Under
    // Funzione per estrarre quote O/U Casa/Ospite
    function getTeamOverUnderQuota(quote, col, isFirstHalf = false) {
      if (!quote) return null;
      
      // Estrai squadra (Casa o Ospite) e tipo (Over/Under) e valore
      const match = col.match(/(Casa|Ospite)\s+(Over|Under)\s+(\d+\.?\d*)/i);
      if (!match) return null;
      
      const team = match[1].toLowerCase(); // "casa" o "ospite"
      const type = match[2].toLowerCase(); // "over" o "under"
      const value = match[3]; // "0.5", "1.5", etc.
      
      const isHome = team === 'casa';
      const isAway = team === 'ospite';
      
      // üîπ Cerca PRIMA direttamente in team_total_goals (se presente)
      if (!isFirstHalf && quote.team_total_goals && Array.isArray(quote.team_total_goals)) {
        const item = quote.team_total_goals.find(o => {
          const oName = String(o.name || '').trim();
          const oHeader = String(o.header || '').trim();
          const oHandicap = String(o.handicap || '').trim();
          
          // Verifica che sia per la squadra corretta (1 = casa, 2 = ospite)
          const teamMatch = (isHome && (oName === '1' || oHeader === '1')) || 
                           (isAway && (oName === '2' || oHeader === '2'));
          
          // Verifica che l'handicap corrisponda (es. "Over 0.5", "Under 1.5")
          const handicapMatch = oHandicap && (
            (type === 'over' && oHandicap.toLowerCase().startsWith('over') && oHandicap.includes(value)) ||
            (type === 'under' && oHandicap.toLowerCase().startsWith('under') && oHandicap.includes(value))
          );
          
          return teamMatch && handicapMatch;
        });
        if (item && item.odds) return item.odds;
      }
      
      // üîπ Cerca anche in 1st_half_team_total_goals per il primo tempo
      if (isFirstHalf) {
        // Cerca in quote['1st_half_team_total_goals']
        if (quote['1st_half_team_total_goals'] && Array.isArray(quote['1st_half_team_total_goals'])) {
          const item = quote['1st_half_team_total_goals'].find(o => {
            const oName = String(o.name || '').trim();
            const oHeader = String(o.header || '').trim();
            const oHandicap = String(o.handicap || '').trim();
            
            const teamMatch = (isHome && (oName === '1' || oHeader === '1')) || 
                             (isAway && (oName === '2' || oHeader === '2'));
            
            const handicapMatch = oHandicap && (
              (type === 'over' && oHandicap.toLowerCase().startsWith('over') && oHandicap.includes(value)) ||
              (type === 'under' && oHandicap.toLowerCase().startsWith('under') && oHandicap.includes(value))
            );
            
            return teamMatch && handicapMatch;
          });
          if (item && item.odds) return item.odds;
        }
        
        // Cerca anche in goals.sp.1st_half_team_total_goals
        const goals1stHalfTeam = quote.goals?.sp?.['1st_half_team_total_goals'] || {};
        if (Array.isArray(goals1stHalfTeam)) {
          const item = goals1stHalfTeam.find(o => {
            const oName = String(o.name || '').trim();
            const oHeader = String(o.header || '').trim();
            const oHandicap = String(o.handicap || '').trim();
            
            const teamMatch = (isHome && (oName === '1' || oHeader === '1')) || 
                             (isAway && (oName === '2' || oHeader === '2'));
            
            const handicapMatch = oHandicap && (
              (type === 'over' && oHandicap.toLowerCase().startsWith('over') && oHandicap.includes(value)) ||
              (type === 'under' && oHandicap.toLowerCase().startsWith('under') && oHandicap.includes(value))
            );
            
            return teamMatch && handicapMatch;
          });
          if (item && item.odds) return item.odds;
        } else if (goals1stHalfTeam.odds && Array.isArray(goals1stHalfTeam.odds)) {
          const item = goals1stHalfTeam.odds.find(o => {
            const oName = String(o.name || '').trim();
            const oHeader = String(o.header || '').trim();
            const oHandicap = String(o.handicap || '').trim();
            
            const teamMatch = (isHome && (oName === '1' || oHeader === '1')) || 
                             (isAway && (oName === '2' || oHeader === '2'));
            
            const handicapMatch = oHandicap && (
              (type === 'over' && oHandicap.toLowerCase().startsWith('over') && oHandicap.includes(value)) ||
              (type === 'under' && oHandicap.toLowerCase().startsWith('under') && oHandicap.includes(value))
            );
            
            return teamMatch && handicapMatch;
          });
          if (item && item.odds) return item.odds;
        }
        
        // Cerca anche in half.sp.1st_half_team_total_goals
        const half1stHalfTeam = quote.half?.sp?.['1st_half_team_total_goals'] || {};
        if (Array.isArray(half1stHalfTeam)) {
          const item = half1stHalfTeam.find(o => {
            const oName = String(o.name || '').trim();
            const oHeader = String(o.header || '').trim();
            const oHandicap = String(o.handicap || '').trim();
            
            const teamMatch = (isHome && (oName === '1' || oHeader === '1')) || 
                             (isAway && (oName === '2' || oHeader === '2'));
            
            const handicapMatch = oHandicap && (
              (type === 'over' && oHandicap.toLowerCase().startsWith('over') && oHandicap.includes(value)) ||
              (type === 'under' && oHandicap.toLowerCase().startsWith('under') && oHandicap.includes(value))
            );
            
            return teamMatch && handicapMatch;
          });
          if (item && item.odds) return item.odds;
        } else if (half1stHalfTeam.odds && Array.isArray(half1stHalfTeam.odds)) {
          const item = half1stHalfTeam.odds.find(o => {
            const oName = String(o.name || '').trim();
            const oHeader = String(o.header || '').trim();
            const oHandicap = String(o.handicap || '').trim();
            
            const teamMatch = (isHome && (oName === '1' || oHeader === '1')) || 
                             (isAway && (oName === '2' || oHeader === '2'));
            
            const handicapMatch = oHandicap && (
              (type === 'over' && oHandicap.toLowerCase().startsWith('over') && oHandicap.includes(value)) ||
              (type === 'under' && oHandicap.toLowerCase().startsWith('under') && oHandicap.includes(value))
            );
            
            return teamMatch && handicapMatch;
          });
          if (item && item.odds) return item.odds;
        }
        
        // Cerca anche in chiavi specifiche per home/away team 1st half
        const specificKeys = isHome 
          ? ['1st_half_home_team_total_goals', 'home_team_1st_half_goals', '1st_half_home_team_goals', 
             'home_team_1st_half_goals_over_under', '1st_half_home_team_goals_over_under']
          : ['1st_half_away_team_total_goals', 'away_team_1st_half_goals', '1st_half_away_team_goals',
             'away_team_1st_half_goals_over_under', '1st_half_away_team_goals_over_under'];
        
        for (const key of specificKeys) {
          // Cerca direttamente in quote[key]
          if (quote[key] && Array.isArray(quote[key])) {
            const item = quote[key].find(o => {
              const oName = String(o.name || '').trim();
              const oHeader = String(o.header || '').toLowerCase().trim();
              return (oName === value || oName.replace(',', '.') === value) && oHeader === type;
            });
            if (item && item.odds) return item.odds;
          }
          
          // Cerca in goals.sp[key]
          const goalsData = quote.goals?.sp?.[key] || {};
          if (Array.isArray(goalsData)) {
            const item = goalsData.find(o => {
              const oName = String(o.name || '').trim();
              const oHeader = String(o.header || '').toLowerCase().trim();
              return (oName === value || oName.replace(',', '.') === value) && oHeader === type;
            });
            if (item && item.odds) return item.odds;
          } else if (goalsData.odds && Array.isArray(goalsData.odds)) {
            const item = goalsData.odds.find(o => {
              const oName = String(o.name || '').trim();
              const oHeader = String(o.header || '').toLowerCase().trim();
              return (oName === value || oName.replace(',', '.') === value) && oHeader === type;
            });
            if (item && item.odds) return item.odds;
          }
          
          // Cerca in half.sp[key]
          const halfData = quote.half?.sp?.[key] || {};
          if (Array.isArray(halfData)) {
            const item = halfData.find(o => {
              const oName = String(o.name || '').trim();
              const oHeader = String(o.header || '').toLowerCase().trim();
              return (oName === value || oName.replace(',', '.') === value) && oHeader === type;
            });
            if (item && item.odds) return item.odds;
          } else if (halfData.odds && Array.isArray(halfData.odds)) {
            const item = halfData.odds.find(o => {
              const oName = String(o.name || '').trim();
              const oHeader = String(o.header || '').toLowerCase().trim();
              return (oName === value || oName.replace(',', '.') === value) && oHeader === type;
            });
            if (item && item.odds) return item.odds;
          }
        }
      }
      
      // üîπ Cerca PRIMA nelle chiavi mappate dal calculated (priorit√†)
      if (!isFirstHalf) {
        // Per match completo - cerca in home_team_goals_over_under / away_team_goals_over_under (dal calculated)
        const calculatedKey = isHome ? 'home_team_goals_over_under' : 'away_team_goals_over_under';
        if (quote[calculatedKey] && Array.isArray(quote[calculatedKey])) {
          const item = quote[calculatedKey].find(o => {
            const oName = String(o.name || '').trim();
            const oHeader = String(o.header || '').toLowerCase().trim();
            return (oName === value || oName.replace(',', '.') === value) && oHeader === type;
          });
          if (item && item.odds) return item.odds;
        }
      } else {
        // Per primo tempo - cerca in 1st_half_home_team_goals_over_under / 1st_half_away_team_goals_over_under (dal calculated)
        const calculatedKey = isHome ? '1st_half_home_team_goals_over_under' : '1st_half_away_team_goals_over_under';
        if (quote[calculatedKey] && Array.isArray(quote[calculatedKey])) {
          const item = quote[calculatedKey].find(o => {
            const oName = String(o.name || '').trim();
            const oHeader = String(o.header || '').toLowerCase().trim();
            return (oName === value || oName.replace(',', '.') === value) && oHeader === type;
          });
          if (item && item.odds) return item.odds;
        }
      }
      
      // Lista di possibili chiavi da cercare
      const possibleKeys = [];
      
      if (!isFirstHalf) {
        // Per match completo
        if (isHome) {
          possibleKeys.push('home_team_total_goals', 'home_team_goals', 'home_team_over_under', 'home_team_goals_over_under',
                           'team_total_goals', 'home_team_goal_line', 'home_team_alternative_goal_line');
        } else {
          possibleKeys.push('away_team_total_goals', 'away_team_goals', 'away_team_over_under', 'away_team_goals_over_under',
                           'team_total_goals', 'away_team_goal_line', 'away_team_alternative_goal_line');
        }
      } else {
        // Per primo tempo
        if (isHome) {
          possibleKeys.push('1st_half_home_team_total_goals', 'home_team_1st_half_goals', '1st_half_home_team_goals', 
                           'home_team_1st_half_goals_over_under', '1st_half_home_team_goals_over_under',
                           '1st_half_team_total_goals', 'home_team_1st_half_goal_line');
        } else {
          possibleKeys.push('1st_half_away_team_total_goals', 'away_team_1st_half_goals', '1st_half_away_team_goals',
                           'away_team_1st_half_goals_over_under', '1st_half_away_team_goals_over_under',
                           '1st_half_team_total_goals', 'away_team_1st_half_goal_line');
        }
      }
      
      // Cerca direttamente nel quote object
      for (const key of possibleKeys) {
        if (quote[key] && Array.isArray(quote[key])) {
          const item = quote[key].find(o => {
            const oName = String(o.name || '').trim();
            const oHeader = String(o.header || '').trim();
            const oHandicap = String(o.handicap || '').trim();
            
            // Per team_total_goals, la struttura √®: name/header = "1" o "2" (squadra), handicap = "Over 0.5", "Under 0.5", ecc.
            if (key === 'team_total_goals' || key === '1st_half_team_total_goals') {
              // Verifica che sia per la squadra corretta (1 = casa, 2 = ospite)
              const teamMatch = (isHome && (oName === '1' || oHeader === '1')) || 
                               (isAway && (oName === '2' || oHeader === '2'));
              
              // Verifica che l'handicap corrisponda (es. "Over 0.5", "Under 1.5")
              const handicapMatch = oHandicap && (
                (type === 'over' && oHandicap.toLowerCase().startsWith('over') && oHandicap.includes(value)) ||
                (type === 'under' && oHandicap.toLowerCase().startsWith('under') && oHandicap.includes(value))
              );
              
              return teamMatch && handicapMatch;
            }
            
            // Per altre chiavi, usa la logica normale
            return (oName === value || oName.replace(',', '.') === value) && oHeader === type;
          });
          if (item && item.odds) return item.odds;
        }
      }
      
      // Cerca in goals.sp
      for (const key of possibleKeys) {
        const goalsData = quote.goals?.sp?.[key] || {};
        if (Array.isArray(goalsData)) {
          const item = goalsData.find(o => {
            const oName = String(o.name || '').trim();
            const oHeader = String(o.header || '').trim();
            const oHandicap = String(o.handicap || '').trim();
            
            // Per team_total_goals, usa la struttura speciale
            if (key === 'team_total_goals' || key === '1st_half_team_total_goals') {
              const teamMatch = (isHome && (oName === '1' || oHeader === '1')) || 
                               (isAway && (oName === '2' || oHeader === '2'));
              const handicapMatch = oHandicap && (
                (type === 'over' && oHandicap.toLowerCase().startsWith('over') && oHandicap.includes(value)) ||
                (type === 'under' && oHandicap.toLowerCase().startsWith('under') && oHandicap.includes(value))
              );
              return teamMatch && handicapMatch;
            }
            
            return (oName === value || oName.replace(',', '.') === value) && oHeader === type;
          });
          if (item && item.odds) return item.odds;
        } else if (goalsData.odds && Array.isArray(goalsData.odds)) {
          const item = goalsData.odds.find(o => {
            const oName = String(o.name || '').trim();
            const oHeader = String(o.header || '').trim();
            const oHandicap = String(o.handicap || '').trim();
            
            if (key === 'team_total_goals' || key === '1st_half_team_total_goals') {
              const teamMatch = (isHome && (oName === '1' || oHeader === '1')) || 
                               (isAway && (oName === '2' || oHeader === '2'));
              const handicapMatch = oHandicap && (
                (type === 'over' && oHandicap.toLowerCase().startsWith('over') && oHandicap.includes(value)) ||
                (type === 'under' && oHandicap.toLowerCase().startsWith('under') && oHandicap.includes(value))
              );
              return teamMatch && handicapMatch;
            }
            
            return (oName === value || oName.replace(',', '.') === value) && oHeader === type;
          });
          if (item && item.odds) return item.odds;
        }
      }
      
      // Cerca in main.sp
      for (const key of possibleKeys) {
        const mainData = quote.main?.sp?.[key] || {};
        if (Array.isArray(mainData)) {
          const item = mainData.find(o => {
            const oName = String(o.name || '').trim();
            const oHeader = String(o.header || '').trim();
            const oHandicap = String(o.handicap || '').trim();
            
            if (key === 'team_total_goals' || key === '1st_half_team_total_goals') {
              const teamMatch = (isHome && (oName === '1' || oHeader === '1')) || 
                               (isAway && (oName === '2' || oHeader === '2'));
              const handicapMatch = oHandicap && (
                (type === 'over' && oHandicap.toLowerCase().startsWith('over') && oHandicap.includes(value)) ||
                (type === 'under' && oHandicap.toLowerCase().startsWith('under') && oHandicap.includes(value))
              );
              return teamMatch && handicapMatch;
            }
            
            return (oName === value || oName.replace(',', '.') === value) && oHeader === type;
          });
          if (item && item.odds) return item.odds;
        } else if (mainData.odds && Array.isArray(mainData.odds)) {
          const item = mainData.odds.find(o => {
            const oName = String(o.name || '').trim();
            const oHeader = String(o.header || '').trim();
            const oHandicap = String(o.handicap || '').trim();
            
            if (key === 'team_total_goals' || key === '1st_half_team_total_goals') {
              const teamMatch = (isHome && (oName === '1' || oHeader === '1')) || 
                               (isAway && (oName === '2' || oHeader === '2'));
              const handicapMatch = oHandicap && (
                (type === 'over' && oHandicap.toLowerCase().startsWith('over') && oHandicap.includes(value)) ||
                (type === 'under' && oHandicap.toLowerCase().startsWith('under') && oHandicap.includes(value))
              );
              return teamMatch && handicapMatch;
            }
            
            return (oName === value || oName.replace(',', '.') === value) && oHeader === type;
          });
          if (item && item.odds) return item.odds;
        }
      }
      
      // Cerca in others[x].sp - Itera su tutti gli others e cerca in tutte le chiavi possibili
      if (quote.others && Array.isArray(quote.others)) {
        for (const other of quote.others) {
          if (other.sp) {
            for (const key of possibleKeys) {
              if (other.sp[key]) {
                const teamData = other.sp[key];
                if (Array.isArray(teamData)) {
                  const item = teamData.find(o => {
                    const oName = String(o.name || '').trim();
                    const oHeader = String(o.header || '').trim();
                    const oHandicap = String(o.handicap || '').trim();
                    
                    if (key === 'team_total_goals' || key === '1st_half_team_total_goals') {
                      const teamMatch = (isHome && (oName === '1' || oHeader === '1')) || 
                                       (isAway && (oName === '2' || oHeader === '2'));
                      const handicapMatch = oHandicap && (
                        (type === 'over' && oHandicap.toLowerCase().startsWith('over') && oHandicap.includes(value)) ||
                        (type === 'under' && oHandicap.toLowerCase().startsWith('under') && oHandicap.includes(value))
                      );
                      return teamMatch && handicapMatch;
                    }
                    
                    return (oName === value || oName.replace(',', '.') === value) && oHeader === type;
                  });
                  if (item && item.odds) return item.odds;
                } else if (teamData.odds && Array.isArray(teamData.odds)) {
                  const item = teamData.odds.find(o => {
                    const oName = String(o.name || '').trim();
                    const oHeader = String(o.header || '').trim();
                    const oHandicap = String(o.handicap || '').trim();
                    
                    if (key === 'team_total_goals' || key === '1st_half_team_total_goals') {
                      const teamMatch = (isHome && (oName === '1' || oHeader === '1')) || 
                                       (isAway && (oName === '2' || oHeader === '2'));
                      const handicapMatch = oHandicap && (
                        (type === 'over' && oHandicap.toLowerCase().startsWith('over') && oHandicap.includes(value)) ||
                        (type === 'under' && oHandicap.toLowerCase().startsWith('under') && oHandicap.includes(value))
                      );
                      return teamMatch && handicapMatch;
                    }
                    
                    return (oName === value || oName.replace(',', '.') === value) && oHeader === type;
                  });
                  if (item && item.odds) return item.odds;
                }
              }
            }
            
            // üîπ Cerca PRIMA in others[x].sp per chiavi specifiche del primo tempo
            if (isFirstHalf) {
              // Cerca in others[x].sp.1st_half_team_total_goals
              if (other.sp['1st_half_team_total_goals'] && Array.isArray(other.sp['1st_half_team_total_goals'])) {
                const item = other.sp['1st_half_team_total_goals'].find(o => {
                  const oName = String(o.name || '').trim();
                  const oHeader = String(o.header || '').trim();
                  const oHandicap = String(o.handicap || '').trim();
                  
                  const teamMatch = (isHome && (oName === '1' || oHeader === '1')) || 
                                   (isAway && (oName === '2' || oHeader === '2'));
                  
                  const handicapMatch = oHandicap && (
                    (type === 'over' && oHandicap.toLowerCase().startsWith('over') && oHandicap.includes(value)) ||
                    (type === 'under' && oHandicap.toLowerCase().startsWith('under') && oHandicap.includes(value))
                  );
                  
                  return teamMatch && handicapMatch;
                });
                if (item && item.odds) return item.odds;
              }
              
              // Cerca anche in chiavi specifiche per home/away team 1st half in others[x].sp
              const specificKeysOthers = isHome 
                ? ['1st_half_home_team_total_goals', 'home_team_1st_half_goals', '1st_half_home_team_goals', 
                   'home_team_1st_half_goals_over_under', '1st_half_home_team_goals_over_under']
                : ['1st_half_away_team_total_goals', 'away_team_1st_half_goals', '1st_half_away_team_goals',
                   'away_team_1st_half_goals_over_under', '1st_half_away_team_goals_over_under'];
              
              for (const key of specificKeysOthers) {
                if (other.sp[key]) {
                  const teamData = other.sp[key];
                  if (Array.isArray(teamData)) {
                    const item = teamData.find(o => {
                      const oName = String(o.name || '').trim();
                      const oHeader = String(o.header || '').toLowerCase().trim();
                      return (oName === value || oName.replace(',', '.') === value) && oHeader === type;
                    });
                    if (item && item.odds) return item.odds;
                  } else if (teamData && teamData.odds && Array.isArray(teamData.odds)) {
                    const item = teamData.odds.find(o => {
                      const oName = String(o.name || '').trim();
                      const oHeader = String(o.header || '').toLowerCase().trim();
                      return (oName === value || oName.replace(',', '.') === value) && oHeader === type;
                    });
                    if (item && item.odds) return item.odds;
                  }
                }
              }
            }
            
            // Cerca anche in tutte le chiavi che contengono "home" o "away" e "goals"
            for (const spKey in other.sp) {
              if (typeof spKey === 'string') {
                const keyLower = spKey.toLowerCase();
                const isTeamKey = (isHome && (keyLower.includes('home') || keyLower.includes('casa'))) ||
                                 (isAway && (keyLower.includes('away') || keyLower.includes('ospite')));
                const hasGoals = keyLower.includes('goal');
                const hasOverUnder = keyLower.includes('over') || keyLower.includes('under') || keyLower.includes('total');
                const hasFirstHalf = keyLower.includes('1st_half') || keyLower.includes('first_half') || keyLower.includes('1st') || keyLower.includes('half');
                
                // Per il primo tempo, cerca chiavi che contengono "1st_half" o "first_half"
                // Per il match completo, cerca chiavi che NON contengono "1st_half" o "2nd_half"
                const isFirstHalfKey = hasFirstHalf && !keyLower.includes('2nd_half') && !keyLower.includes('second_half');
                const isFullMatchKey = !hasFirstHalf && !keyLower.includes('2nd_half') && !keyLower.includes('second_half');
                
                const timeMatch = isFirstHalf ? isFirstHalfKey : isFullMatchKey;
                
                if (isTeamKey && hasGoals && (hasOverUnder || !isFirstHalf) && timeMatch) {
                  const teamData = other.sp[spKey];
                  
                  // Se √® team_total_goals o 1st_half_team_total_goals, usa la struttura speciale
                  if (spKey === 'team_total_goals' || spKey === '1st_half_team_total_goals') {
                    if (Array.isArray(teamData)) {
                      const item = teamData.find(o => {
                        const oName = String(o.name || '').trim();
                        const oHeader = String(o.header || '').trim();
                        const oHandicap = String(o.handicap || '').trim();
                        
                        const teamMatch = (isHome && (oName === '1' || oHeader === '1')) || 
                                         (isAway && (oName === '2' || oHeader === '2'));
                        const handicapMatch = oHandicap && (
                          (type === 'over' && oHandicap.toLowerCase().startsWith('over') && oHandicap.includes(value)) ||
                          (type === 'under' && oHandicap.toLowerCase().startsWith('under') && oHandicap.includes(value))
                        );
                        return teamMatch && handicapMatch;
                      });
                      if (item && item.odds) return item.odds;
                    } else if (teamData && teamData.odds && Array.isArray(teamData.odds)) {
                      const item = teamData.odds.find(o => {
                        const oName = String(o.name || '').trim();
                        const oHeader = String(o.header || '').trim();
                        const oHandicap = String(o.handicap || '').trim();
                        
                        const teamMatch = (isHome && (oName === '1' || oHeader === '1')) || 
                                         (isAway && (oName === '2' || oHeader === '2'));
                        const handicapMatch = oHandicap && (
                          (type === 'over' && oHandicap.toLowerCase().startsWith('over') && oHandicap.includes(value)) ||
                          (type === 'under' && oHandicap.toLowerCase().startsWith('under') && oHandicap.includes(value))
                        );
                        return teamMatch && handicapMatch;
                      });
                      if (item && item.odds) return item.odds;
                    }
                  } else {
                    // Per altre chiavi, usa la logica normale
                    if (Array.isArray(teamData)) {
                      const item = teamData.find(o => {
                        const oName = String(o.name || '').trim();
                        const oHeader = (o.header || '').toLowerCase().trim();
                        return (oName === value || oName.replace(',', '.') === value) && oHeader === type;
                      });
                      if (item && item.odds) return item.odds;
                    } else if (teamData && teamData.odds && Array.isArray(teamData.odds)) {
                      const item = teamData.odds.find(o => {
                        const oName = String(o.name || '').trim();
                        const oHeader = (o.header || '').toLowerCase().trim();
                        return (oName === value || oName.replace(',', '.') === value) && oHeader === type;
                      });
                      if (item && item.odds) return item.odds;
                    }
                  }
                }
              }
            }
          }
        }
      }
      
      return null;
    }
    
    function getOverUnderQuota(quote, col, isFirstHalf = false, isSecondHalf = false) {
      if (!quote) return null;
      
      // Estrai il valore (es. "2.5" da "Over 2.5" o "Under 2.5")
      const match = col.match(/(Over|Under)\s*(\d+\.?\d*)/i);
      if (!match) return null;
      
      const type = match[1].toLowerCase(); // "over" o "under"
      const value = match[2]; // "2.5", "1.5", etc.
      
      // Per O/U 2T, cerca prima in 2nd_half_goals_over_under (percorso MongoDB diretto da bet365.py)
      if (isSecondHalf) {
        // Prima cerca in quote.2nd_half_goals_over_under (percorso MongoDB diretto)
        if (quote['2nd_half_goals_over_under'] && Array.isArray(quote['2nd_half_goals_over_under'])) {
          const item = quote['2nd_half_goals_over_under'].find(o => {
            const oName = String(o.name || '').trim();
            const oHeader = (o.header || '').toLowerCase().trim();
            return oName === value && oHeader === type;
          });
          if (item && item.odds) return item.odds;
        }
        
        // Cerca anche in quote.2nd_half_goals (percorso MongoDB diretto)
        if (quote['2nd_half_goals'] && Array.isArray(quote['2nd_half_goals'])) {
          const item = quote['2nd_half_goals'].find(o => {
            const oName = String(o.name || '').trim();
            const oHeader = (o.header || '').toLowerCase().trim();
            return oName === value && oHeader === type;
          });
          if (item && item.odds) return item.odds;
        }
        
        // Cerca anche in quote.2nd_half_goals_range (percorso MongoDB)
        if (quote['2nd_half_goals_range'] && Array.isArray(quote['2nd_half_goals_range'])) {
          const item = quote['2nd_half_goals_range'].find(o => {
            const oName = String(o.name || '').trim();
            const oHeader = (o.header || '').toLowerCase().trim();
            return oName === value && oHeader === type;
          });
          if (item && item.odds) return item.odds;
        }
        
        // Cerca anche in others[x].sp.2nd_half_goals (percorso finale come in soccer.py)
        if (quote.others && Array.isArray(quote.others)) {
          for (const other of quote.others) {
            // Cerca in 2nd_half_goals (percorso finale)
            if (other.sp && other.sp['2nd_half_goals']) {
              const secondHalfGoals = other.sp['2nd_half_goals'];
              if (Array.isArray(secondHalfGoals)) {
                const item = secondHalfGoals.find(o => {
                  const oName = String(o.name || '').trim();
                  const oHeader = (o.header || '').toLowerCase().trim();
                  return oName === value && oHeader === type;
                });
                if (item && item.odds) return item.odds;
              }
            }
          }
        }
        
        // Cerca anche in goals.sp.2nd_half_goals
        const goalsSecondHalf = quote.goals?.sp?.['2nd_half_goals'] || {};
        if (Array.isArray(goalsSecondHalf)) {
          const item = goalsSecondHalf.find(o => {
            const oName = String(o.name || '').trim();
            const oHeader = (o.header || '').toLowerCase().trim();
            return oName === value && oHeader === type;
          });
          if (item && item.odds) return item.odds;
        }
      }
      
      // Per O/U 1T, cerca prima in 1st_half_goals_over_under (percorso MongoDB diretto da bet365.py)
      if (isFirstHalf) {
        // Prima cerca in quote.1st_half_goals_over_under (percorso MongoDB diretto)
        if (quote['1st_half_goals_over_under'] && Array.isArray(quote['1st_half_goals_over_under'])) {
          const item = quote['1st_half_goals_over_under'].find(o => {
            const oName = String(o.name || '').trim();
            const oHeader = (o.header || '').toLowerCase().trim();
            return oName === value && oHeader === type;
          });
          if (item && item.odds) return item.odds;
        }
        
        // Cerca anche in quote.first_half_goals (percorso MongoDB diretto)
        if (quote['first_half_goals'] && Array.isArray(quote['first_half_goals'])) {
          const item = quote['first_half_goals'].find(o => {
            const oName = String(o.name || '').trim();
            const oHeader = (o.header || '').toLowerCase().trim();
            return oName === value && oHeader === type;
          });
          if (item && item.odds) return item.odds;
        }
        
        // Cerca anche in quote.1st_half_goals (variante)
        if (quote['1st_half_goals'] && Array.isArray(quote['1st_half_goals'])) {
          const item = quote['1st_half_goals'].find(o => {
            const oName = String(o.name || '').trim();
            const oHeader = (o.header || '').toLowerCase().trim();
            return oName === value && oHeader === type;
          });
          if (item && item.odds) return item.odds;
        }
        
        // Cerca anche in quote.1st_half_goals_range (percorso MongoDB)
        if (quote['1st_half_goals_range'] && Array.isArray(quote['1st_half_goals_range'])) {
          const item = quote['1st_half_goals_range'].find(o => {
            const oName = String(o.name || '').trim();
            const oHeader = (o.header || '').toLowerCase().trim();
            return oName === value && oHeader === type;
          });
          if (item && item.odds) return item.odds;
        }
        
        // Cerca anche in others[x].sp.first_half_goals (percorso finale come in soccer.py)
        if (quote.others && Array.isArray(quote.others)) {
          for (const other of quote.others) {
            // Cerca in first_half_goals (percorso finale)
            if (other.sp && other.sp['first_half_goals']) {
              const firstHalfGoals = other.sp['first_half_goals'];
              if (Array.isArray(firstHalfGoals)) {
                const item = firstHalfGoals.find(o => {
                  const oName = String(o.name || '').trim();
                  const oHeader = (o.header || '').toLowerCase().trim();
                  return oName === value && oHeader === type;
                });
                if (item && item.odds) return item.odds;
              }
            }
            
            // Cerca anche in 1st_half_goals (variante)
            if (other.sp && other.sp['1st_half_goals']) {
              const firstHalfGoals = other.sp['1st_half_goals'];
              if (Array.isArray(firstHalfGoals)) {
                const item = firstHalfGoals.find(o => {
                  const oName = String(o.name || '').trim();
                  const oHeader = (o.header || '').toLowerCase().trim();
                  return oName === value && oHeader === type;
                });
                if (item && item.odds) return item.odds;
              }
            }
            
            // Cerca anche in alternative_1st_half_goal_line
            if (other.sp && other.sp['alternative_1st_half_goal_line']) {
              const alt1stHalf = other.sp['alternative_1st_half_goal_line'];
              if (alt1stHalf.odds && Array.isArray(alt1stHalf.odds)) {
                const item = alt1stHalf.odds.find(o => {
                  const oName = String(o.name || '').trim();
                  const oHeader = (o.header || '').toLowerCase().trim();
                  // Cerca solo per 0.5, 1.5, 2.5, 3.5 (gestisce anche formati con virgola)
                  const normalizedName = oName.replace(',', '.');
                  return normalizedName === value && oHeader === type;
                });
                if (item && item.odds) return item.odds;
              }
            }
          }
        }
        
        // Cerca anche in goals.sp.first_half_goals
        const goalsFirstHalf = quote.goals?.sp?.first_half_goals || {};
        if (Array.isArray(goalsFirstHalf)) {
          const item = goalsFirstHalf.find(o => {
            const oName = String(o.name || '').trim();
            const oHeader = (o.header || '').toLowerCase().trim();
            return oName === value && oHeader === type;
          });
          if (item && item.odds) return item.odds;
        }
        
        // Cerca anche in goals.sp.alternative_1st_half_goal_line
        const alt1stHalfGoals = quote.goals?.sp?.alternative_1st_half_goal_line || {};
        if (alt1stHalfGoals.odds && Array.isArray(alt1stHalfGoals.odds)) {
          const item = alt1stHalfGoals.odds.find(o => {
            const oName = String(o.name || '').trim();
            const oHeader = (o.header || '').toLowerCase().trim();
            // Cerca solo per 0.5, 1.5, 2.5, 3.5 (gestisce anche formati con virgola)
            const normalizedName = oName.replace(',', '.');
            return normalizedName === value && oHeader === type;
          });
          if (item && item.odds) return item.odds;
        }
      }
      
      // Prima cerca in quote.goals_over_under (percorso MongoDB diretto)
      if (quote.goals_over_under && Array.isArray(quote.goals_over_under)) {
        const item = quote.goals_over_under.find(o => {
          const oName = String(o.name || '').trim();
          const oHeader = (o.header || '').toLowerCase().trim();
          return oName === value && oHeader === type;
        });
        if (item && item.odds) return item.odds;
      }
      
      // Cerca anche in goals.sp.goals_over_under (percorso principale)
      const goalsOU = quote.goals?.sp?.goals_over_under || 
                     quote.main?.sp?.goals_over_under || {};
      
      if (Array.isArray(goalsOU)) {
        const item = goalsOU.find(o => {
          const oName = String(o.name || '').trim();
          const oHeader = (o.header || '').toLowerCase().trim();
          return oName === value && oHeader === type;
        });
        if (item && item.odds) return item.odds;
      }
      
      if (Array.isArray(goalsOU.odds)) {
        const item = goalsOU.odds.find(o => {
          const oName = String(o.name || '').trim();
          const oHeader = (o.header || '').toLowerCase().trim();
          return oName === value && oHeader === type;
        });
        if (item && item.odds) return item.odds;
      }
      
      // Cerca in asian_lines.sp.goal_line (percorso alternativo)
      const asianGoalLine = quote.asian_lines?.sp?.goal_line || {};
      if (Array.isArray(asianGoalLine)) {
        const item = asianGoalLine.find(o => {
          const oName = String(o.name || '').trim();
          const oHeader = (o.header || '').toLowerCase().trim();
          return oName === value && oHeader === type;
        });
        if (item && item.odds) return item.odds;
      }
      
      // Cerca in goals.sp.alternative_total_goals (per valori alternativi)
      const altGoals = quote.goals?.sp?.alternative_total_goals || 
                      quote.main?.sp?.alternative_total_goals || 
                      quote.alternative_total_goals || {};
      
      if (Array.isArray(altGoals)) {
        const item = altGoals.find(o => {
          const oName = String(o.name || '').trim();
          const oHeader = (o.header || '').toLowerCase().trim();
          return oName === value && oHeader === type;
        });
        if (item && item.odds) return item.odds;
      }
      
      if (Array.isArray(altGoals.odds)) {
        const item = altGoals.odds.find(o => {
          const oName = String(o.name || '').trim();
          const oHeader = (o.header || '').toLowerCase().trim();
          return oName === value && oHeader === type;
        });
        if (item && item.odds) return item.odds;
      }
      
      // Cerca in half.sp per Over/Under 1T
      const halfGoalLine = quote.half?.sp?.['1st_half_goal_line'] || 
                          quote.half?.sp?.goal_line || {};
      if (Array.isArray(halfGoalLine)) {
        const item = halfGoalLine.find(o => {
          const oName = String(o.name || '').trim();
          const oHeader = (o.header || '').toLowerCase().trim();
          return oName === value && oHeader === type;
        });
        if (item && item.odds) return item.odds;
      }
      
      // Fallback: cerca in match_goals
      const matchGoals = quote.match_goals || {};
      if (matchGoals[col]) {
        return matchGoals[col];
      }
      
      return null;
    }

    // Helper per estrarre quote Handicap
    function getHandicapQuota(quote, col) {
      if (!quote) return null;
      
      // Estrai il valore handicap dalla colonna (es. "H1 (-0.5)" -> header: "1", handicap: "-0.5")
      const match = col.match(/H([12X])\s*\(([+-]?\d+\.?\d*)\)/);
      if (!match) return null;
      
      const header = match[1]; // "1", "2", o "X"
      const handicapValue = match[2]; // "-0.5", "+1.0", etc.
      
      // Cerca in asian_lines.sp.asian_handicap
      const asianHandicap = quote.asian_lines?.sp?.asian_handicap || quote.asian_handicap || {};
      
      if (Array.isArray(asianHandicap)) {
        const item = asianHandicap.find(o => {
          const oHeader = String(o.header || '').trim();
          const oHandicap = String(o.handicap || '').trim();
          return oHeader === header && (oHandicap === handicapValue || oHandicap.includes(handicapValue));
        });
        if (item && item.odds) return item.odds;
      }
      
      // Cerca in main.sp.asian_handicap
      const mainHandicap = quote.main?.sp?.asian_handicap || {};
      if (Array.isArray(mainHandicap)) {
        const item = mainHandicap.find(o => {
          const oHeader = String(o.header || '').trim();
          const oHandicap = String(o.handicap || '').trim();
          return oHeader === header && (oHandicap === handicapValue || oHandicap.includes(handicapValue));
        });
        if (item && item.odds) return item.odds;
      }
      
      return null;
    }

    // Helper per estrarre quote GG/NG
    function getGGNGQuota(quote, col, isFirstHalf = false, isSecondHalf = false) {
      if (!quote) return null;
      
      const isGG = col.includes('GG');
      const searchName = isGG ? 'Yes' : 'No';
      
      if (isFirstHalf) {
        const btts1T = quote.goals?.sp?.both_teams_to_score_in_1st_half || 
                      quote.half?.sp?.both_teams_to_score_in_1st_half || {};
        if (Array.isArray(btts1T)) {
          const item = btts1T.find(o => (o.name || '').toLowerCase() === searchName.toLowerCase());
          if (item && item.odds) return item.odds;
        }
      } else if (isSecondHalf) {
        const btts2T = quote.goals?.sp?.both_teams_to_score_in_2nd_half || 
                      quote.half?.sp?.both_teams_to_score_in_2nd_half || {};
        if (Array.isArray(btts2T)) {
          const item = btts2T.find(o => (o.name || '').toLowerCase() === searchName.toLowerCase());
          if (item && item.odds) return item.odds;
        }
      } else {
        const btts = quote.goals?.sp?.both_teams_to_score || 
                    quote.main?.sp?.both_teams_to_score || 
                    quote.both_teams_to_score || {};
        if (Array.isArray(btts)) {
          const item = btts.find(o => (o.name || '').toLowerCase() === searchName.toLowerCase());
          if (item && item.odds) return item.odds;
        }
      }
      
      return null;
    }

    // Helper per estrarre quote Risultato Esatto
    function getRisEsattoQuota(quote, col, isFirstHalf = false) {
      if (!quote) return null;
      
      const correctScore = isFirstHalf 
        ? quote.half?.sp?.half_time_correct_score || quote.half_time_correct_score || {}
        : quote.main?.sp?.correct_score || quote.correct_score || {};
      
      if (Array.isArray(correctScore)) {
        const item = correctScore.find(o => {
          const oName = String(o.name || '').trim();
          const oHeader = String(o.header || '').trim();
          return oName === col || oHeader === col || oName.replace('-', '') === col.replace('-', '');
        });
        if (item && item.odds) return item.odds;
      }
      
      return null;
    }

    // Helper per estrarre quote Multi Goal
    function getMultiGoalQuota(quote, col, isFirstHalf = false, isSecondHalf = false) {
      if (!quote) return null;
      
      let goalsRange;
      if (isFirstHalf) {
        goalsRange = quote.goals?.sp?.['1st_half_goals_range'] || 
                    quote.half?.sp?.['1st_half_goals_range'] || {};
      } else if (isSecondHalf) {
        goalsRange = quote.goals?.sp?.['2nd_half_goals_range'] || 
                    quote.half?.sp?.['2nd_half_goals_range'] || {};
      } else {
        goalsRange = quote.goals?.sp?.match_goals_range || 
                    quote.match_goals_range || {};
      }
      
      if (Array.isArray(goalsRange)) {
        const item = goalsRange.find(o => {
          const oName = String(o.name || '').trim();
          return oName === col || oName.includes(col.replace(' Goals', ''));
        });
        if (item && item.odds) return item.odds;
      }
      
      return null;
    }

    // Helper per estrarre quote Combo
    function getComboQuota(quote, col) {
      if (!quote) return null;
      
      // Estrai tipo combo (es. "1 + Over 2.5" -> result: "1", type: "Over", value: "2.5")
      const match = col.match(/([12X])\s*\+\s*(Over|Under|GG|NG)\s*(\d+\.?\d*)?/);
      if (!match) return null;
      
      const result = match[1]; // "1", "2", o "X"
      const comboType = match[2]; // "Over", "Under", "GG", "NG"
      const value = match[3]; // "2.5" o undefined
      
      // Cerca in goals.sp.result_total_goals per combo 1X2 + Over/Under
      if (comboType === 'Over' || comboType === 'Under') {
        const resultTotalGoals = quote.goals?.sp?.result_total_goals || {};
        if (Array.isArray(resultTotalGoals)) {
          const item = resultTotalGoals.find(o => {
            const oName = String(o.name || '').trim();
            const oHeader = String(o.header || '').trim();
            const oHandicap = String(o.handicap || '').trim();
            return oName === result && 
                   oHeader.toLowerCase() === comboType.toLowerCase() && 
                   (value ? oHandicap === value : true);
          });
          if (item && item.odds) return item.odds;
        }
      }
      
      // Cerca in goals.sp.total_goals_both_teams_to_score per combo GG/NG + Over/Under
      if (comboType === 'GG' || comboType === 'NG') {
        const totalGoalsBtts = quote.goals?.sp?.total_goals_both_teams_to_score || {};
        if (Array.isArray(totalGoalsBtts)) {
          const item = totalGoalsBtts.find(o => {
            const oName = String(o.name || '').trim();
            return (comboType === 'GG' && (oName.includes('Yes') || oName.includes('Over'))) ||
                   (comboType === 'NG' && (oName.includes('No') || oName.includes('Under')));
          });
          if (item && item.odds) return item.odds;
        }
      }
      
      return null;
    }

    // Helper per estrarre quote Primo/Ultimo Gol
    function getFirstLastGoalQuota(quote, col, isFirst = true) {
      if (!quote) return null;
      
      const searchPath = isFirst 
        ? quote.main?.sp?.first_team_to_score || quote.first_team_to_score || {}
        : quote.main?.sp?.last_team_to_score || quote.last_team_to_score || {};
      
      if (Array.isArray(searchPath)) {
        const item = searchPath.find(o => {
          const oName = String(o.name || '').toLowerCase();
          const oHeader = String(o.header || '').toLowerCase();
          const colLower = col.toLowerCase();
          return (colLower === 'casa' && (oName.includes('home') || oHeader === '1')) ||
                 (colLower === 'ospiti' && (oName.includes('away') || oHeader === '2')) ||
                 (colLower === 'nessuno' && (oName.includes('no') || oName.includes('none')));
        });
        if (item && item.odds) return item.odds;
      }
      
      return null;
    }

    // Helper per estrarre quote Pari/Dispari
    function getPariDispariQuota(quote, col, isFirstHalf = false, isSecondHalf = false) {
      if (!quote) return null;
      
      const isPari = col.toLowerCase().includes('pari');
      
      let oddEven;
      if (isFirstHalf) {
        oddEven = quote.goals?.sp?.['1st_half_goals_odd_even'] || 
                 quote.half?.sp?.['1st_half_goals_odd_even'] || {};
      } else if (isSecondHalf) {
        oddEven = quote.goals?.sp?.['2nd_half_goals_odd_even'] || 
                 quote.half?.sp?.['2nd_half_goals_odd_even'] || {};
      } else {
        oddEven = quote.goals?.sp?.match_goals_odd_even || 
                 quote.main?.sp?.match_goals_odd_even || {};
      }
      
      if (Array.isArray(oddEven)) {
        const item = oddEven.find(o => {
          const oName = String(o.name || '').toLowerCase();
          const oHeader = String(o.header || '').toLowerCase();
          return (isPari && (oName.includes('even') || oHeader === 'even')) ||
                 (!isPari && (oName.includes('odd') || oHeader === 'odd'));
        });
        if (item && item.odds) return item.odds;
      }
      
      return null;
    }

    // Helper per estrarre quote Gol Totali (esatti)
    function getGolTotaliQuota(quote, col, isFirstHalf = false, isSecondHalf = false, isHome = false, isAway = false) {
      if (!quote) return null;
      
      let exactGoals;
      if (isFirstHalf) {
        exactGoals = quote.goals?.sp?.['1st_half_exact_goals'] || 
                    quote.half?.sp?.['1st_half_exact_goals'] || {};
      } else if (isSecondHalf) {
        exactGoals = quote.goals?.sp?.['2nd_half_exact_goals'] || {};
      } else if (isHome) {
        exactGoals = quote.goals?.sp?.home_team_exact_goals || {};
      } else if (isAway) {
        exactGoals = quote.goals?.sp?.away_team_exact_goals || {};
      } else {
        exactGoals = quote.goals?.sp?.exact_total_goals || 
                    quote.main?.sp?.exact_total_goals || {};
      }
      
      if (Array.isArray(exactGoals)) {
        const item = exactGoals.find(o => {
          const oName = String(o.name || '').trim();
          return oName === col || oName === col + '+' || oName === col.replace('+', '');
        });
        if (item && item.odds) return item.odds;
      }
      
      return null;
    }

    // Helper per estrarre quote Parziale/Finale
    function getParzialeFinaleQuota(quote, col) {
      if (!quote) return null;
      
      const htft = quote.main?.sp?.half_time_full_time || 
                  quote.half_time_full_time || {};
      
      if (Array.isArray(htft)) {
        const item = htft.find(o => {
          const oName = String(o.name || '').trim();
          const oHeader = String(o.header || '').trim();
          const colFormatted = col.replace('/', '/');
          return oName === colFormatted || oHeader === colFormatted || 
                 oName.replace('/', '/') === colFormatted;
        });
        if (item && item.odds) return item.odds;
      }
      
      return null;
    }

    // Helper per estrarre quote DNB
    function getDNBQuota(quote, col, isFirstHalf = false, isSecondHalf = false) {
      if (!quote) return null;
      
      let dnb;
      if (isFirstHalf) {
        dnb = quote.half?.sp?.['1st_half_draw_no_bet'] || {};
      } else if (isSecondHalf) {
        dnb = quote.half?.sp?.['2nd_half_draw_no_bet'] || {};
      } else {
        dnb = quote.main?.sp?.draw_no_bet || 
              quote.draw_no_bet || {};
      }
      
      if (Array.isArray(dnb)) {
        const item = dnb.find(o => {
          const oHeader = String(o.header || '').trim();
          return oHeader === col;
        });
        if (item && item.odds) return item.odds;
      }
      
      return null;
    }

    // Helper per estrarre quote Corner
    function getCornerQuota(quote, col) {
      if (!quote) return null;
      
      // Estrai valore da "Over 9.5" o "Under 9.5"
      const match = col.match(/(Over|Under)\s*(\d+\.?\d*)/i);
      if (!match) return null;
      
      const type = match[1].toLowerCase();
      const value = match[2];
      
      const corners = quote.corners?.sp?.corners || 
                     quote.main?.sp?.corners || 
                     quote.corners || {};
      
      if (Array.isArray(corners)) {
        const item = corners.find(o => {
          const oName = String(o.name || '').trim();
          const oHeader = (o.header || '').toLowerCase().trim();
          return oName === value && oHeader === type;
        });
        if (item && item.odds) return item.odds;
      }
      
      return null;
    }

    // Helper per estrarre quote Cartellini/Cards
    function getCardsQuota(quote, col) {
      if (!quote) return null;
      
      const match = col.match(/(Over|Under)\s*(\d+\.?\d*)/i);
      if (!match) return null;
      
      const type = match[1].toLowerCase();
      const value = match[2];
      
      const cards = quote.cards?.sp?.cards || 
                   quote.main?.sp?.cards || 
                   quote.cards || {};
      
      if (Array.isArray(cards)) {
        const item = cards.find(o => {
          const oName = String(o.name || '').trim();
          const oHeader = (o.header || '').toLowerCase().trim();
          return oName === value && oHeader === type;
        });
        if (item && item.odds) return item.odds;
      }
      
      return null;
    }

    // Helper per estrarre quote Rigori
    function getPenaltyQuota(quote, col) {
      if (!quote) return null;
      
      const isYes = col.toLowerCase().includes('s√¨') || col.toLowerCase().includes('si') || col.toLowerCase() === 'yes';
      
      const penalties = quote.main?.sp?.penalties || 
                       quote.others?.find(o => o.sp?.penalties)?.sp?.penalties || {};
      
      if (Array.isArray(penalties)) {
        const item = penalties.find(o => {
          const oName = (o.name || '').toLowerCase();
          return (isYes && (oName.includes('yes') || oName.includes('s√¨'))) ||
                 (!isYes && (oName.includes('no')));
        });
        if (item && item.odds) return item.odds;
      }
      
      return null;
    }

    // Helper per estrarre quote VAR (valori fissi)
    function getVARQuota(quote, col) {
      if (!quote) return null;
      
      const isYes = col.toLowerCase().includes('s√¨') || col.toLowerCase().includes('si') || col.toLowerCase() === 'yes';
      
      // Valori fissi per VAR
      if (isYes) {
        return '3.00';
      } else {
        return '1.25';
      }
    }

    // Helper per estrarre quote Metodo 1¬∞ gol (valori fissi)
    function getFirstGoalMethodQuota(quote, col) {
      if (!quote) return null;
      
      const colLower = col.toLowerCase();
      
      // Valori fissi per Metodo 1¬∞ gol
      const methodQuotes = {
        'piede': '1.4',
        'tiro': '1.4',
        'testa': '6',
        'rigore': '10',
        'punizione': '13',
        'autogol': '25'
      };
      
      // Cerca corrispondenza (anche parziale)
      for (const [key, value] of Object.entries(methodQuotes)) {
        if (colLower.includes(key) || key.includes(colLower)) {
          return value;
        }
      }
      
      return null;
    }

    // Helper per estrarre quote Segna (Goalscorers)
    function getGoalscorersQuota(quote, col, headerType = 'Anytime') {
      if (!quote) return null;
      
      const goalscorers = quote.main?.sp?.goalscorers || 
                         quote.player?.sp?.goalscorers || {};
      
      if (Array.isArray(goalscorers)) {
        const item = goalscorers.find(o => {
          const oName = String(o.name || '').trim();
          const oHeader = String(o.header || '').trim();
          return oName === col && oHeader === headerType;
        });
        if (item && item.odds) return item.odds;
      }
      
      return null;
    }

    // Helper per estrarre quote Goalscorer (da players collection)
    function getGoalscorerQuota(ev, col) {
      if (!ev || !ev.players) return null;
      
      // Cerca nel formato players.odds.gls (goalscorers)
      const gls = ev.players.odds?.gls;
      if (Array.isArray(gls)) {
        const item = gls.find(o => {
          const oName = String(o.name || '').trim();
          const colStr = String(col || '').trim();
          return oName === colStr || oName.toLowerCase() === colStr.toLowerCase();
        });
        if (item && item.odds) return item.odds;
      }
      
      // Cerca anche in quote.goalscorers se presente
      if (ev.quote && ev.quote.goalscorers) {
        const goalscorers = ev.quote.goalscorers;
        if (Array.isArray(goalscorers)) {
          const item = goalscorers.find(o => {
            const oName = String(o.name || '').trim();
            const colStr = String(col || '').trim();
            return oName === colStr || oName.toLowerCase() === colStr.toLowerCase();
          });
          if (item && item.odds) return item.odds;
        }
      }
      
      return null;
    }

    // Helper per estrarre quote Vince a 0 (Winning Margin)
    function getWinningMarginQuota(quote, col) {
      if (!quote) return null;
      
      const winningMargin = quote.others?.find(o => o.sp?.winning_margin)?.sp?.winning_margin || {};
      
      if (Array.isArray(winningMargin)) {
        const item = winningMargin.find(o => {
          const oName = String(o.name || '').trim();
          const oHeader = String(o.header || '').trim();
          return (oName === col || oName === col + '+') && oHeader === '1';
        });
        if (item && item.odds) return item.odds;
      }
      
      return null;
    }

    // Helper per estrarre quote Vince 1T e 2T / Vince 1T o 2T
    function getHalfWithMostGoalsQuota(quote, col) {
      if (!quote) return null;
      
      const isBoth = col.includes('e');
      const isEither = col.includes('o');
      
      const halfGoals = quote.main?.sp?.half_with_most_goals || 
                       quote.others?.find(o => o.sp?.half_with_most_goals)?.sp?.half_with_most_goals || {};
      
      if (Array.isArray(halfGoals)) {
        let item;
        if (isBoth) {
          item = halfGoals.find(o => {
            const oName = (o.name || '').toLowerCase();
            return oName.includes('both') || oName.includes('1st and 2nd');
          });
        } else if (isEither) {
          item = halfGoals.find(o => {
            const oName = (o.name || '').toLowerCase();
            return oName.includes('either') || oName.includes('1st or 2nd');
          });
        } else {
          item = halfGoals.find(o => {
            const oName = (o.name || '').trim();
            return oName === col;
          });
        }
        if (item && item.odds) return item.odds;
      }
      
      return null;
    }

    // Helper per estrarre quote Vincono Ribaltamento
    function getComebackQuota(quote, col) {
      if (!quote) return null;
      
      const comeback = quote.main?.sp?.comeback || 
                     quote.others?.find(o => o.sp?.comeback)?.sp?.comeback || {};
      
      if (Array.isArray(comeback)) {
        const item = comeback.find(o => {
          const oName = (o.name || '').toLowerCase();
          return oName.includes('comeback') || oName.includes('ribaltamento');
        });
        if (item && item.odds) return item.odds;
      }
      
      return null;
    }

    // Helper per estrarre quote HNB, ANB, Gol No Bet
    function getNoBetQuota(quote, col, betType = 'draw_no_bet') {
      if (!quote) return null;
      
      let noBet;
      if (betType === 'handicap_no_bet') {
        noBet = quote.main?.sp?.handicap_no_bet || {};
      } else if (betType === 'asian_no_bet') {
        noBet = quote.asian_lines?.sp?.asian_no_bet || {};
      } else if (betType === 'goal_no_bet') {
        noBet = quote.goals?.sp?.goal_no_bet || {};
      } else {
        noBet = quote.main?.sp?.draw_no_bet || {};
      }
      
      if (Array.isArray(noBet)) {
        const item = noBet.find(o => {
          const oHeader = String(o.header || '').trim();
          return oHeader === col;
        });
        if (item && item.odds) return item.odds;
      }
      
      return null;
    }

    // Helper per estrarre quote Tempo+Gol
    function getTimeAndGoalQuota(quote, col) {
      if (!quote) return null;
      
      const timeGoal = quote.main?.sp?.time_and_goal || 
                      quote.others?.find(o => o.sp?.time_and_goal)?.sp?.time_and_goal || {};
      
      if (Array.isArray(timeGoal)) {
        const item = timeGoal.find(o => {
          const oName = String(o.name || '').trim();
          return oName.includes(col) || oName === col;
        });
        if (item && item.odds) return item.odds;
      }
      
      return null;
    }

    // Helper per estrarre quote Tempo 1¬∞sub (valori fissi)
    function getTempoPrimoSubQuota(quote, col) {
      if (!quote) return null;
      
      const colLower = col.toLowerCase();
      
      // Valori fissi per Tempo 1¬∞sub
      const tempoSubQuotes = {
        '1¬∞ tempo': '3.5',
        '1 tempo': '3.5',
        '2¬∞ tempo': '1.9',
        '2 tempo': '1.9',
        'break': '2.2',
        'no sub': '100'
      };
      
      // Cerca corrispondenza (anche parziale)
      for (const [key, value] of Object.entries(tempoSubQuotes)) {
        if (colLower.includes(key) || key.includes(colLower)) {
          return value;
        }
      }
      
      return null;
    }

    // Helper per estrarre quote Team 1¬∞ sub (valori fissi)
    function getTeamPrimoSubQuota(quote, col) {
      if (!quote) return null;
      
      const colLower = col.toLowerCase();
      
      // Valori fissi per Team 1¬∞ sub
      const teamSubQuotes = {
        'casa': '1.8',
        'ospite': '1.8',
        'altro': '3'
      };
      
      // Cerca corrispondenza (anche parziale)
      for (const [key, value] of Object.entries(teamSubQuotes)) {
        if (colLower.includes(key) || key.includes(colLower)) {
          return value;
        }
      }
      
      return null;
    }

    // Helper per estrarre quote 1X2 1T (primo tempo)
    function get1X2FirstHalfQuota(quote, col) {
      if (!quote) return null;
      
      // Mappa colonna a valori possibili
      const colMap = {
        '1': ['1', 'Home'],
        'X': ['X', 'Draw', 'Tie'],
        '2': ['2', 'Away']
      };
      
      const searchValues = colMap[col] || [col];
      
      // Cerca in half_time_result (percorso diretto MongoDB)
      if (quote.half_time_result && Array.isArray(quote.half_time_result)) {
        for (const val of searchValues) {
          const item = quote.half_time_result.find(o => {
            const oName = String(o.name || '').trim();
            const oHeader = String(o.header || '').trim();
            return oName === val || oHeader === val || 
                   (col === '1' && (oName === '1' || oHeader === '1')) ||
                   (col === 'X' && (oName.toLowerCase() === 'draw' || oName.toLowerCase() === 'tie' || oHeader.toLowerCase() === 'draw' || oHeader.toLowerCase() === 'tie')) ||
                   (col === '2' && (oName === '2' || oHeader === '2'));
          });
          if (item && item.odds) return item.odds;
        }
      }
      
      // Cerca in half.sp.half_time_result
      if (quote.half?.sp?.half_time_result) {
        const halfTimeResult = quote.half.sp.half_time_result;
        if (Array.isArray(halfTimeResult)) {
          for (const val of searchValues) {
            const item = halfTimeResult.find(o => {
              const oName = String(o.name || '').trim();
              const oHeader = String(o.header || '').trim();
              return oName === val || oHeader === val || 
                     (col === '1' && (oName === '1' || oHeader === '1')) ||
                     (col === 'X' && (oName.toLowerCase() === 'draw' || oName.toLowerCase() === 'tie' || oHeader.toLowerCase() === 'draw' || oHeader.toLowerCase() === 'tie')) ||
                     (col === '2' && (oName === '2' || oHeader === '2'));
            });
            if (item && item.odds) return item.odds;
          }
        } else if (halfTimeResult.odds && Array.isArray(halfTimeResult.odds)) {
          for (const val of searchValues) {
            const item = halfTimeResult.odds.find(o => {
              const oName = String(o.name || '').trim();
              const oHeader = String(o.header || '').trim();
              return oName === val || oHeader === val || 
                     (col === '1' && (oName === '1' || oHeader === '1')) ||
                     (col === 'X' && (oName.toLowerCase() === 'draw' || oName.toLowerCase() === 'tie' || oHeader.toLowerCase() === 'draw' || oHeader.toLowerCase() === 'tie')) ||
                     (col === '2' && (oName === '2' || oHeader === '2'));
            });
            if (item && item.odds) return item.odds;
          }
        }
      }
      
      // Cerca in main.sp.half_time_result
      if (quote.main?.sp?.half_time_result) {
        const mainHalfTime = quote.main.sp.half_time_result;
        if (Array.isArray(mainHalfTime)) {
          for (const val of searchValues) {
            const item = mainHalfTime.find(o => {
              const oName = String(o.name || '').trim();
              const oHeader = String(o.header || '').trim();
              return oName === val || oHeader === val || 
                     (col === '1' && (oName === '1' || oHeader === '1')) ||
                     (col === 'X' && (oName.toLowerCase() === 'draw' || oName.toLowerCase() === 'tie' || oHeader.toLowerCase() === 'draw' || oHeader.toLowerCase() === 'tie')) ||
                     (col === '2' && (oName === '2' || oHeader === '2'));
            });
            if (item && item.odds) return item.odds;
          }
        } else if (mainHalfTime.odds && Array.isArray(mainHalfTime.odds)) {
          for (const val of searchValues) {
            const item = mainHalfTime.odds.find(o => {
              const oName = String(o.name || '').trim();
              const oHeader = String(o.header || '').trim();
              return oName === val || oHeader === val || 
                     (col === '1' && (oName === '1' || oHeader === '1')) ||
                     (col === 'X' && (oName.toLowerCase() === 'draw' || oName.toLowerCase() === 'tie' || oHeader.toLowerCase() === 'draw' || oHeader.toLowerCase() === 'tie')) ||
                     (col === '2' && (oName === '2' || oHeader === '2'));
            });
            if (item && item.odds) return item.odds;
          }
        }
      }
      
      // Cerca in others[x].sp.half_time_result
      if (quote.others && Array.isArray(quote.others)) {
        for (const other of quote.others) {
          if (other.sp && other.sp.half_time_result) {
            const otherHalfTime = other.sp.half_time_result;
            if (Array.isArray(otherHalfTime)) {
              for (const val of searchValues) {
                const item = otherHalfTime.find(o => {
                  const oName = String(o.name || '').trim();
                  const oHeader = String(o.header || '').trim();
                  return oName === val || oHeader === val || 
                         (col === '1' && (oName === '1' || oHeader === '1')) ||
                         (col === 'X' && (oName.toLowerCase() === 'draw' || oName.toLowerCase() === 'tie' || oHeader.toLowerCase() === 'draw' || oHeader.toLowerCase() === 'tie')) ||
                         (col === '2' && (oName === '2' || oHeader === '2'));
                });
                if (item && item.odds) return item.odds;
              }
            } else if (otherHalfTime.odds && Array.isArray(otherHalfTime.odds)) {
              for (const val of searchValues) {
                const item = otherHalfTime.odds.find(o => {
                  const oName = String(o.name || '').trim();
                  const oHeader = String(o.header || '').trim();
                  return oName === val || oHeader === val || 
                         (col === '1' && (oName === '1' || oHeader === '1')) ||
                         (col === 'X' && (oName.toLowerCase() === 'draw' || oName.toLowerCase() === 'tie' || oHeader.toLowerCase() === 'draw' || oHeader.toLowerCase() === 'tie')) ||
                         (col === '2' && (oName === '2' || oHeader === '2'));
                });
                if (item && item.odds) return item.odds;
              }
            }
          }
        }
      }
      
      return null;
    }

    // Helper per estrarre quote 1X2 2T (secondo tempo)
    function get1X2SecondHalfQuota(quote, col) {
      if (!quote) return null;
      
      // Mappa colonna a valori possibili
      const colMap = {
        '1': ['1', 'Home'],
        'X': ['X', 'Draw', 'Tie'],
        '2': ['2', 'Away']
      };
      
      const searchValues = colMap[col] || [col];
      
      // Cerca in 2nd_half_result (percorso diretto MongoDB)
      if (quote['2nd_half_result'] && Array.isArray(quote['2nd_half_result'])) {
        for (const val of searchValues) {
          const item = quote['2nd_half_result'].find(o => {
            const oName = String(o.name || '').trim();
            const oHeader = String(o.header || '').trim();
            return oName === val || oHeader === val || 
                   (col === '1' && (oName === '1' || oHeader === '1')) ||
                   (col === 'X' && (oName.toLowerCase() === 'draw' || oName.toLowerCase() === 'tie' || oHeader.toLowerCase() === 'draw' || oHeader.toLowerCase() === 'tie')) ||
                   (col === '2' && (oName === '2' || oHeader === '2'));
          });
          if (item && item.odds) return item.odds;
        }
      }
      
      // Cerca in half.sp.2nd_half_result
      if (quote.half?.sp?.['2nd_half_result']) {
        const secondHalfResult = quote.half.sp['2nd_half_result'];
        if (Array.isArray(secondHalfResult)) {
          for (const val of searchValues) {
            const item = secondHalfResult.find(o => {
              const oName = String(o.name || '').trim();
              const oHeader = String(o.header || '').trim();
              return oName === val || oHeader === val || 
                     (col === '1' && (oName === '1' || oHeader === '1')) ||
                     (col === 'X' && (oName.toLowerCase() === 'draw' || oName.toLowerCase() === 'tie' || oHeader.toLowerCase() === 'draw' || oHeader.toLowerCase() === 'tie')) ||
                     (col === '2' && (oName === '2' || oHeader === '2'));
            });
            if (item && item.odds) return item.odds;
          }
        } else if (secondHalfResult.odds && Array.isArray(secondHalfResult.odds)) {
          for (const val of searchValues) {
            const item = secondHalfResult.odds.find(o => {
              const oName = String(o.name || '').trim();
              const oHeader = String(o.header || '').trim();
              return oName === val || oHeader === val || 
                     (col === '1' && (oName === '1' || oHeader === '1')) ||
                     (col === 'X' && (oName.toLowerCase() === 'draw' || oName.toLowerCase() === 'tie' || oHeader.toLowerCase() === 'draw' || oHeader.toLowerCase() === 'tie')) ||
                     (col === '2' && (oName === '2' || oHeader === '2'));
            });
            if (item && item.odds) return item.odds;
          }
        }
      }
      
      // Cerca in goals.sp.2nd_half_result
      if (quote.goals?.sp?.['2nd_half_result']) {
        const goalsSecondHalf = quote.goals.sp['2nd_half_result'];
        if (Array.isArray(goalsSecondHalf)) {
          for (const val of searchValues) {
            const item = goalsSecondHalf.find(o => {
              const oName = String(o.name || '').trim();
              const oHeader = String(o.header || '').trim();
              return oName === val || oHeader === val || 
                     (col === '1' && (oName === '1' || oHeader === '1')) ||
                     (col === 'X' && (oName.toLowerCase() === 'draw' || oName.toLowerCase() === 'tie' || oHeader.toLowerCase() === 'draw' || oHeader.toLowerCase() === 'tie')) ||
                     (col === '2' && (oName === '2' || oHeader === '2'));
            });
            if (item && item.odds) return item.odds;
          }
        } else if (goalsSecondHalf.odds && Array.isArray(goalsSecondHalf.odds)) {
          for (const val of searchValues) {
            const item = goalsSecondHalf.odds.find(o => {
              const oName = String(o.name || '').trim();
              const oHeader = String(o.header || '').trim();
              return oName === val || oHeader === val || 
                     (col === '1' && (oName === '1' || oHeader === '1')) ||
                     (col === 'X' && (oName.toLowerCase() === 'draw' || oName.toLowerCase() === 'tie' || oHeader.toLowerCase() === 'draw' || oHeader.toLowerCase() === 'tie')) ||
                     (col === '2' && (oName === '2' || oHeader === '2'));
            });
            if (item && item.odds) return item.odds;
          }
        }
      }
      
      // Cerca in others[x].sp.2nd_half_result
      if (quote.others && Array.isArray(quote.others)) {
        for (const other of quote.others) {
          if (other.sp && other.sp['2nd_half_result']) {
            const otherSecondHalf = other.sp['2nd_half_result'];
            if (Array.isArray(otherSecondHalf)) {
              for (const val of searchValues) {
                const item = otherSecondHalf.find(o => {
                  const oName = String(o.name || '').trim();
                  const oHeader = String(o.header || '').trim();
                  return oName === val || oHeader === val || 
                         (col === '1' && (oName === '1' || oHeader === '1')) ||
                         (col === 'X' && (oName.toLowerCase() === 'draw' || oName.toLowerCase() === 'tie' || oHeader.toLowerCase() === 'draw' || oHeader.toLowerCase() === 'tie')) ||
                         (col === '2' && (oName === '2' || oHeader === '2'));
                });
                if (item && item.odds) return item.odds;
              }
            } else if (otherSecondHalf.odds && Array.isArray(otherSecondHalf.odds)) {
              for (const val of searchValues) {
                const item = otherSecondHalf.odds.find(o => {
                  const oName = String(o.name || '').trim();
                  const oHeader = String(o.header || '').trim();
                  return oName === val || oHeader === val || 
                         (col === '1' && (oName === '1' || oHeader === '1')) ||
                         (col === 'X' && (oName.toLowerCase() === 'draw' || oName.toLowerCase() === 'tie' || oHeader.toLowerCase() === 'draw' || oHeader.toLowerCase() === 'tie')) ||
                         (col === '2' && (oName === '2' || oHeader === '2'));
                });
                if (item && item.odds) return item.odds;
              }
            }
          }
        }
      }
      
      return null;
    }

    // Helper per estrarre quote Speciali Gol (valori fissi)
    function getSpecialGoalsQuota(quote, col) {
      if (!quote) return null;
      
      const colLower = col.toLowerCase();
      
      // Valori fissi per Speciali Gol
      const specialQuotes = {
        'autorete': '9',
        'sub segna': '2.5',
        'gol da corner': '30',
        'gol di testa': '3',
        'pali': '1.8',
        'gol oltre il 90¬∞': '4',
        'gol oltre il 90': '4'
      };
      
      // Cerca corrispondenza (anche parziale)
      for (const [key, value] of Object.entries(specialQuotes)) {
        if (colLower.includes(key) || key.includes(colLower)) {
          return value;
        }
      }
      
      return null;
    }

    function getColonnePerMercato(mercato) {
      // Per il basket, mostra 1X2 (1, X, 2) da game_lines_3_way
      if (sportSelezionato === 'basket') {
        if (mercato === 'Principali' || mercato === '1X2') {
          return ['1', 'X', '2'];
        }
      }
      
      // Per il tennis, mostra solo Money Line (1 e 2, senza X)
      if (sportSelezionato === 'tennis') {
        if (mercato === 'Principali' || mercato === '1X2') {
          return ['1', '2'];
        }
      }
      
      // Per l'e-sport, mostra solo To Win (1 e 2, senza X)
      if (sportSelezionato === 'e-sport' || sportSelezionato === 'esport') {
        if (mercato === 'Principali' || mercato === '1X2') {
          return ['1', '2'];
        }
      }
      // Per le freccette, mostra solo To Win (1 e 2, senza X)
      if (sportSelezionato === 'freccette') {
        if (mercato === 'Principali' || mercato === '1X2') {
          return ['1', '2'];
        }
      }
      
      // Per il boxing, mostra solo To Win Fight (1 e 2, senza X)
      if (sportSelezionato === 'boxing') {
        if (mercato === 'Principali' || mercato === '1X2') {
          return ['1', '2'];
        }
      }
      
      // Per il badminton, mostra solo To Win (1 e 2, senza X)
      if (sportSelezionato === 'badminton') {
        if (mercato === 'Principali' || mercato === '1X2') {
          return ['1', '2'];
        }
      }
      
      // Per il cricket, mostra solo To Win the Match (1 e 2, senza X)
      if (sportSelezionato === 'cricket') {
        if (mercato === 'Principali' || mercato === '1X2') {
          return ['1', '2'];
        }
      }
      
      // Per lo squash, mostra solo 1 e 2 (senza X)
      if (sportSelezionato === 'squash') {
        if (mercato === 'Principali' || mercato === '1X2') {
          return ['1', '2'];
        }
      }
      
      // Per Horse Racing, mostra tutti i cavalli con i loro nomi
      if (sportSelezionato === 'horse racing' || sportSelezionato === 'horseracing') {
        if (mercato === 'Principali' || mercato === '1X2') {
          // Raccogli tutti i nomi dei cavalli unici da matchesData
          const nomiCavalli = new Set();
          matchesData.forEach(ev => {
            const quote = ev.quote || {};
            const winEachWay = quote.win_each_way || [];
            if (Array.isArray(winEachWay)) {
              winEachWay.forEach(cavallo => {
                const nome = cavallo.name || cavallo.header || '';
                if (nome) nomiCavalli.add(nome);
              });
            }
          });
          // Ordina per nome
          return Array.from(nomiCavalli).sort();
        }
      }
      
      // Per il ping pong, mostra solo Money Line (1 e 2, senza X)
      if (sportSelezionato === 'pingpong' || sportSelezionato === 'ping_pong') {
        if (mercato === 'Principali' || mercato === '1X2') {
          return ['1', '2'];
        }
      }
      
      // Per il volley, mostra solo Winner (1 e 2, senza X)
      if (sportSelezionato === 'volleyball' || sportSelezionato === 'volley') {
        if (mercato === 'Principali' || mercato === '1X2') {
          return ['1', '2'];
        }
      }
      
      // Per il waterpolo, mostra solo 1 e 2 (senza X)
      if (sportSelezionato === 'water polo' || sportSelezionato === 'waterpolo') {
        if (mercato === 'Principali' || mercato === '1X2') {
          return ['1', '2'];
        }
      }
      
      // Per la pallamano, mostra solo 1 e 2 (senza X)
      if (sportSelezionato === 'pallamano') {
        if (mercato === 'Principali' || mercato === '1X2') {
          return ['1', '2'];
        }
      }
      
      // Per il futsal, mostra solo 1X2 (come gli altri sport non-calcio)
      if (sportSelezionato === 'futsal') {
        if (mercato === 'Principali' || mercato === '1X2') {
          return ['1', 'X', '2'];
        }
      }
      
      // Per gli altri sport (non calcio), mostra solo 1X2
      if (sportSelezionato !== 'calcio' && mercato === 'Principali') {
        return ['1', 'X', '2'];
      }
      
      switch(mercato) {
        case 'Principali':
          // Solo per calcio: 1X2 (3) + DC (3) + GG/NG (2) + Over/Under 1.5 e 2.5 (4) = 12 colonne
          return [
            // 1X2
            { type: '1X2', label: '1' },
            { type: '1X2', label: 'X' },
            { type: '1X2', label: '2' },
            // Doppia Chance
            { type: 'Doppia Chance', label: '1X' },
            { type: 'Doppia Chance', label: '12' },
            { type: 'Doppia Chance', label: 'X2' },
            // Gol Totali
            { type: 'Gol Totali', label: 'GG' },
            { type: 'Gol Totali', label: 'NG' },
            // Over/Under
            { type: 'Over/Under', label: 'Over 1.5' },
            { type: 'Over/Under', label: 'Under 1.5' },
            { type: 'Over/Under', label: 'Over 2.5' },
            { type: 'Over/Under', label: 'Under 2.5' }
          ];
        case '1X2':
          // Per il basket, restituisce gi√† ['1', 'X', '2'] sopra
          if (sportSelezionato === 'basket') {
            return ['1', 'X', '2'];
          }
          // Per il tennis, solo Money Line (1 e 2, senza X)
          if (sportSelezionato === 'tennis') {
            return ['1', '2'];
          }
          // Per il ping pong, solo Money Line (1 e 2, senza X)
          if (sportSelezionato === 'pingpong' || sportSelezionato === 'ping_pong') {
            return ['1', '2'];
          }
          return ['1', 'X', '2'];
        case 'Doppia Chance':
          return ['1X', '12', 'X2'];
        case 'Over/Under':
          return ['Over 0.5', 'Under 0.5', 'Over 1.5', 'Under 1.5', 'Over 2.5', 'Under 2.5', 'Over 3.5', 'Under 3.5', 'Over 4.5', 'Under 4.5', 'Over 5.5', 'Under 5.5', 'Over 6.5', 'Under 6.5'];
        case 'O/U 1T':
          return ['Over 0.5', 'Under 0.5', 'Over 1.5', 'Under 1.5', 'Over 2.5', 'Under 2.5','Over 3.5','Under 3.5'];
        case 'O/U 2T':
          return ['Over 0.5', 'Under 0.5', 'Over 1.5', 'Under 1.5', 'Over 2.5', 'Under 2.5','Over 3.5','Under 3.5'];
        case 'O/U C/O':
          return ['Casa Over 0.5', 'Casa Under 0.5', 'Casa Over 1.5', 'Casa Under 1.5', 'Casa Over 2.5', 'Casa Under 2.5', 'Casa Over 3.5', 'Casa Under 3.5', 
                  'Ospite Over 0.5', 'Ospite Under 0.5', 'Ospite Over 1.5', 'Ospite Under 1.5', 'Ospite Over 2.5', 'Ospite Under 2.5', 'Ospite Over 3.5', 'Ospite Under 3.5'];
        case 'O/U 1T C/O':
          return ['Casa Over 0.5', 'Casa Under 0.5', 'Casa Over 1.5', 'Casa Under 1.5', 'Casa Over 2.5', 'Casa Under 2.5', 'Casa Over 3.5', 'Casa Under 3.5',
                  'Ospite Over 0.5', 'Ospite Under 0.5', 'Ospite Over 1.5', 'Ospite Under 1.5', 'Ospite Over 2.5', 'Ospite Under 2.5', 'Ospite Over 3.5', 'Ospite Under 3.5'];
        case 'Gol Totali':
          return ['GG', 'NG'];
        case 'GG/NG 1T':
          return ['GG 1T', 'NG 1T'];
        case 'GG/NG 2T':
          return ['GG 2T', 'NG 2T'];
        case 'GG Special':
          return ['GG + Over 2.5', 'NG + Over 2.5', 'GG + Under 2.5', 'NG + Under 2.5'];
        case 'Handicap':
          return ['H1 (-0.5)', 'H2 (+0.5)', 'H1 (-1.0)', 'H2 (+1.0)', 'H1 (-1.5)', 'H2 (+1.5)', 'H1 (-2.0)', 'H2 (+2.0)', 'H1 (-2.5)', 'H2 (+2.5)'];
        case 'Handicap 1T':
          return ['H1 (-0.5)', 'H2 (+0.5)', 'H1 (-1.0)', 'H2 (+1.0)', 'H1 (-1.5)', 'H2 (+1.5)'];
        case 'Handicap 2T':
          return ['H1 (-0.5)', 'H2 (+0.5)', 'H1 (-1.0)', 'H2 (+1.0)'];
        case 'Ris. Esatto':
          return ['0-0', '1-0', '0-1', '1-1', '2-0', '0-2', '2-1', '1-2', '2-2', '3-0', '0-3', '3-1', '1-3', '3-2', '2-3', '4-0', '0-4', '4-1', '1-4', 'Altro'];
        case 'Ris. Es. 1T':
          return ['0-0', '1-0', '0-1', '1-1', '2-0', '0-2', '2-1', '1-2', 'Altro'];
        case 'Ris. Es. 2T':
          return ['0-0', '1-0', '0-1', '1-1', '2-0', '0-2', 'Altro'];
        case 'Ris. Es. P/F':
          return ['1/1', '1/X', '1/2', 'X/1', 'X/X', 'X/2', '2/1', '2/X', '2/2'];
        case 'Gol Esatti':
          return ['0', '1', '2', '3', '4', '5+'];
        case 'GolTot 1T':
          return ['0', '1', '2', '3+'];
        case 'GolTot 2T':
          return ['0', '1', '2', '3+'];
        case 'GolTot Casa':
          return ['0', '1', '2', '3', '4+'];
        case 'GolTot Ospite':
          return ['0', '1', '2', '3', '4+'];
        case 'Multi Gol':
          return ['1-2 Goals', '1-3 Goals', '1-4 Goals', '2-3 Goals', '2-4 Goals', '3-4 Goals', '3-5 Goals', '4-5 Goals'];
        case 'Multi Gol 1T':
          return ['1-2 Goals', '1-3 Goals', '2-3 Goals', '3-4 Goals'];
        case 'Multi Gol 2T':
          return ['1-2 Goals', '1-3 Goals', '2-3 Goals', '3-4 Goals'];
        case 'Multi Gol C/O':
          return ['1-2 Goals', '1-3 Goals', '2-3 Goals'];
        case 'Multigoal 1T/2':
          return ['1T/2T'];
        case 'Multigol Comb':
          return ['Combo'];
        case 'Combo':
          return ['1 + Over 2.5', '1 + Under 2.5', '2 + Over 2.5', '2 + Under 2.5', 'X + Over 2.5', 'X + Under 2.5', '1 + GG', '1 + NG', '2 + GG', '2 + NG', 'X + GG', 'X + NG'];
        case 'Combo 1T':
          return ['1 + Over 1.5', '1 + Under 1.5', '2 + Over 1.5', '2 + Under 1.5', 'X + Over 1.5', 'X + Under 1.5'];
        case 'Combo 2T':
          return ['1 + Over 1.5', '1 + Under 1.5', '2 + Over 1.5', '2 + Under 1.5', 'X + Over 1.5', 'X + Under 1.5'];
        case 'Combo DC':
          return ['1X + Over 2.5', '1X + Under 2.5', '12 + Over 2.5', '12 + Under 2.5', 'X2 + Over 2.5', 'X2 + Under 2.5'];
        case 'Combo DC 1T':
          return ['1X + Over 1.5', '1X + Under 1.5', '12 + Over 1.5', '12 + Under 1.5', 'X2 + Over 1.5', 'X2 + Under 1.5'];
        case 'Combo DC 2T':
          return ['1X + Over 1.5', '1X + Under 1.5', '12 + Over 1.5', '12 + Under 1.5', 'X2 + Over 1.5', 'X2 + Under 1.5'];
        case 'C. DC Multi':
          return ['1X', '12', 'X2'];
        case 'Combo 3':
          return ['Combo 3'];
        case 'Combo3 HT/FT':
          return ['HT/FT'];
        case 'Combo+Multi':
          return ['Combo+Multi'];
        case 'Combo C/O':
          return ['Combo C/O'];
        case 'Chance 3 Mix':
          return ['1X2 Mix'];
        case 'Chance Mix':
          return ['Chance Mix'];
        case 'HT Ch. Mix':
          return ['HT Mix'];
        case 'Ris. Esatto Mix':
          return ['Ris. Esatto Mix'];
        case 'Segna 1T 2T':
          return ['1T/2T'];
        case 'Vince a 0':
          return ['Vince a 0'];
        case 'Vince 1T e 2T':
          return ['1T e 2T'];
        case 'Vince 1T o 2T':
          return ['1T o 2T'];
        case 'Vincono Rib.':
          return ['Ribaltamento'];
        case 'Cart. Allen.':
          return ['Cart. Allen.'];
        case 'Primo Gol':
          return ['Casa', 'Ospiti', 'Nessuno'];
        case 'Primo Gol Min':
          return ['0-15', '16-30', '31-45', '46-60', '61-75', '76-90'];
        case 'Primo Gol Min.':
          return ['0-15', '16-30', '31-45', '46-60', '61-75', '76-90'];
        case '1X2+Primo Go':
          return ['1 + Primo', 'X + Primo', '2 + Primo'];
        case 'DNB Primo Go':
          return ['DNB Primo'];
        case 'Ultimo Gol':
          return ['Casa', 'Ospiti', 'Nessuno'];
        case 'Rigori':
          return ['S√¨', 'No'];
        case 'Speciali Gol':
          return ['Autorete', 'Sub segna', 'Gol da corner', 'Gol di testa', 'Pali', 'Gol oltre il 90¬∞'];
        case 'Metodo 1¬∞ gol':
          return ['Tiro', 'Testa', 'Rigore', 'Punizione', 'Autogol'];
        case 'Tempo 1¬∞sub':
          return ['1¬∞ tempo', '2¬∞ tempo', 'Break', 'No sub'];
        case 'Team 1¬∞ sub':
          return ['Casa', 'Ospite', 'Altro'];
        case 'VAR Si/No':
          return ['S√¨', 'No'];
        case 'Corner':
          return ['Over 9.5', 'Under 9.5', 'Over 10.5', 'Under 10.5', 'Over 11.5', 'Under 11.5'];
        case 'Pari/Dispari':
          return ['Pari', 'Dispari'];
        case 'Pari/Dis. 1T':
          return ['Pari 1T', 'Dispari 1T'];
        case 'Pari/Dis. 2T':
          return ['Pari 2T', 'Dispari 2T'];
        case 'P./D. Squadre':
          return ['Casa Pari', 'Casa Dispari', 'Ospite Pari', 'Ospite Dispari'];
        case 'Parz./Fin.':
          return ['1/1', '1/X', '1/2', 'X/1', 'X/X', 'X/2', '2/1', '2/X', '2/2'];
        case 'DC 1T':
          return ['1X 1T', '12 1T', 'X2 1T'];
        case 'DC 2T':
          return ['1X 2T', '12 2T', 'X2 2T'];
        case '1X2 5 min':
          return ['1', 'X', '2'];
        case '1X2 10 min':
          return ['1', 'X', '2'];
        case '1X2 15 min':
          return ['1', 'X', '2'];
        case '1X2 25 min':
          return ['1', 'X', '2'];
        case '1X2 30 min':
          return ['1', 'X', '2'];
        case 'Goal (0 - 15)':
          return ['S√¨', 'No'];
        case 'Goal (0 - 30)':
          return ['S√¨', 'No'];
        case 'DNB':
          return ['1', '2'];
        case 'DNB 1T':
          return ['1', '2'];
        case 'DNB 2T':
          return ['1', '2'];
        case 'HNB':
          return ['HNB'];
        case 'ANB':
          return ['ANB'];
        case 'Gol No Bet':
          return ['Gol No Bet'];
        case 'Tempo+Gol':
          return ['Tempo+Gol'];
        case 'T+G (C/O)':
          return ['T+G C/O'];
        case '1T':
          return ['1', 'X', '2'];
        case '2T':
          return ['1', 'X', '2'];
        case 'Goalscorer':
          // Le colonne per Goalscorer sono dinamiche (lista giocatori)
          // Verranno popolate dinamicamente dai dati dell'evento
          return []; // Array vuoto, verr√† popolato dinamicamente
        default:
          return ['1', 'X', '2'];
      }
    }

    // Carica i dati delle partite
    async function loadMatches() {
      try {
        const matchesBody = document.getElementById('matches-body');
        if (!matchesBody) {
          console.error('Elemento matches-body non trovato');
          return;
        }
        
        const colonne = getColonnePerMercato(mercatoSelezionato);
        // Per Goalscorer, usa 5 colonne (Id, Data, Evento, Messaggio, Mercati)
        let numCols;
        if (mercatoSelezionato === 'Goalscorer') {
          numCols = 5;
        } else {
          numCols = 4 + (Array.isArray(colonne) && colonne[0]?.type ? colonne.length : colonne.length);
        }
        matchesBody.innerHTML = `
          <tr>
            <td colspan="${numCols}" class="text-center py-20">
              <div class="flex flex-col items-center justify-center">
                <svg class="w-32 h-32 mb-4 text-yellow-500 animate-spin" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                  <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                  <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <div class="text-yellow-500 text-xl font-bold">BETBET</div>
                <div class="text-gray-400 text-sm mt-2">Caricamento in corso...</div>
              </div>
            </td>
          </tr>
        `;
        
        // Usa URL assoluto per evitare problemi su Render
        // Ridotto limite a 200 per performance
        // Usa endpoint betbet che legge da database 'sports'
        const sportForMongo = getSportForMongo(sportSelezionato);
        let url = `${window.location.origin}/api/events-betbet?sport=${sportForMongo}&limit=200`;
        if (campionatoSelezionato) {
          url += `&league=${encodeURIComponent(campionatoSelezionato)}`;
          // Aggiungi anche la nazione se disponibile per evitare ambiguit√† (es. Serie A italiana vs brasiliana)
          if (nazioneSelezionata) {
            url += `&nation=${encodeURIComponent(nazioneSelezionata)}`;
          }
        }
        
        const response = await fetch(url);
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        
        if (data.success && data.results) {
          matchesData = data.results;
          
          // Per Horse Racing, renderizza campi e corse
          if (sportSelezionato === 'horse racing' || sportSelezionato === 'horseracing') {
            renderCampiHorseRacing();
            renderCorseHorseRacing();
          } else if (mercatoSelezionato === 'Goalscorer' && sportSelezionato === 'calcio') {
            // Per Goalscorer, renderizza squadre e marcatori
            renderSquadreGoalscorer();
            renderMarcatoriGoalscorer();
          } else {
            renderMatches();
          }
          
          // Mostra tabelle mercati per categoria solo per calcio
          if (sportSelezionato === 'calcio') {
            renderMercatiPerCategoria();
          } else {
            document.getElementById('mercati-categorie-container').classList.add('hidden');
          }
        } else {
          const colonne = getColonnePerMercato(mercatoSelezionato);
          // Per Goalscorer, usa 5 colonne (Id, Data, Evento, Messaggio, Mercati)
          let numCols;
          if (mercatoSelezionato === 'Goalscorer') {
            numCols = 5;
          } else {
            numCols = 4 + (Array.isArray(colonne) && colonne[0]?.type ? colonne.length : colonne.length);
          }
          matchesBody.innerHTML = `<tr><td colspan="${numCols}" class="text-center py-4 text-red-400">Nessun dato disponibile</td></tr>`;
        }
      } catch (error) {
        console.error('Errore caricamento dati:', error);
        const matchesBody = document.getElementById('matches-body');
        if (matchesBody) {
          const colonne = getColonnePerMercato(mercatoSelezionato);
          // Per Goalscorer, usa 5 colonne (Id, Data, Evento, Messaggio, Mercati)
          let numCols;
          if (mercatoSelezionato === 'Goalscorer') {
            numCols = 5;
          } else {
            numCols = 4 + (Array.isArray(colonne) && colonne[0]?.type ? colonne.length : colonne.length);
          }
          matchesBody.innerHTML = `<tr><td colspan="${numCols}" class="text-center py-4 text-red-400">Errore nel caricamento dei dati: ${error.message}</td></tr>`;
        }
      }
    }

    // Renderizza le partite
    function renderMatches() {
      try {
        const tbody = document.getElementById('matches-body');
        const thead = document.getElementById('table-header');
        
        if (!tbody || !thead) {
          console.error('Elementi tabella non trovati');
          return;
        }
        
        if (matchesData.length === 0) {
          const colonne = getColonnePerMercato(mercatoSelezionato);
          // Per Horse Racing, usa solo 1 colonna (colspan)
          // Per Goalscorer, usa 5 colonne (Id, Data, Evento, Messaggio, Mercati)
          let numCols;
          if (sportSelezionato === 'horse racing' || sportSelezionato === 'horseracing') {
            numCols = 1;
          } else if (mercatoSelezionato === 'Goalscorer') {
            numCols = 5;
          } else {
            numCols = 4 + (Array.isArray(colonne) && colonne[0]?.type ? colonne.length : colonne.length);
          }
          tbody.innerHTML = `<tr><td colspan="${numCols}" class="text-center py-4 text-gray-400">Nessuna partita disponibile</td></tr>`;
          return;
        }

        // Aggiorna header in base al mercato
        let colonne = getColonnePerMercato(mercatoSelezionato);
        // Assicurati che colonne sia sempre un array valido
        if (!Array.isArray(colonne)) {
          colonne = [];
        }
        
        // Per Goalscorer, non serve popolare colonne (i marcatori vengono mostrati in modo espandibile)
        const isPrincipali = Array.isArray(colonne) && colonne.length > 0 && colonne[0]?.type;
        
        // Aggiorna header tabella
        let headerHtml = '';
        
        // Per Horse Racing, header semplificato
        if (sportSelezionato === 'horse racing' || sportSelezionato === 'horseracing') {
          headerHtml = `<th class="px-2 py-1 border-b border-gray-600 text-center">Corse di Cavalli</th>`;
        } else {
          headerHtml = `
            <th class="px-2 py-1 border-b border-gray-600 text-center">Id</th>
            <th class="px-2 py-1 border-b border-gray-600 text-center">Data</th>
            <th class="px-2 py-1 border-b border-gray-600 text-center">Evento</th>
          `;
          
          // Se colonne √® un array di oggetti (Principali), usa label, altrimenti usa direttamente la stringa
          if (isPrincipali) {
            colonne.forEach(col => {
              headerHtml += `<th class="px-1 py-1 border-b border-gray-600">${col.label}</th>`;
            });
          } else {
            colonne.forEach(col => {
              headerHtml += `<th class="px-1 py-1 border-b border-gray-600">${col}</th>`;
            });
          }
          headerHtml += `<th class="px-2 py-1 border-b border-gray-600 text-center">Mercati</th>`;
        }
        thead.innerHTML = `<tr>${headerHtml}</tr>`;

        let html = '';
        const grouped = {};
        
        // Raggruppa per data e poi per campionato
        matchesData.forEach(ev => {
          const date = new Date(ev.start_time_date || ev.start_time);
          const dateStr = date.toLocaleDateString('it-IT');
          const league = ev.league || 'Altri Campionati';
          
          if (!grouped[dateStr]) {
            grouped[dateStr] = {};
          }
          if (!grouped[dateStr][league]) {
            grouped[dateStr][league] = [];
          }
          grouped[dateStr][league].push(ev);
        });

        Object.keys(grouped).sort().forEach(date => {
          // Per Horse Racing, usa solo 1 colonna (colspan)
          // Per Goalscorer, usa 5 colonne (Id, Data, Evento, Messaggio, Mercati)
          let numCols;
          if (sportSelezionato === 'horse racing' || sportSelezionato === 'horseracing') {
            numCols = 1;
          } else if (mercatoSelezionato === 'Goalscorer') {
            numCols = 5;
          } else {
            numCols = 4 + colonne.length;
          }
          html += `<tr><td colspan="${numCols}" class="bg-gray-900 text-yellow-400 font-bold px-2 py-1 border-b border-gray-700">${date}</td></tr>`;
          
          // Per ogni data, mostra i campionati
          Object.keys(grouped[date]).sort().forEach(league => {
            // Per Horse Racing, visualizzazione speciale verticale
            if (sportSelezionato === 'horse racing' || sportSelezionato === 'horseracing') {
              // Raggruppa le corse per campo (league)
              const corsePerCampo = {};
              grouped[date][league].forEach(ev => {
                const campo = ev.league || ev.home_name || 'Unknown';
                if (!corsePerCampo[campo]) {
                  corsePerCampo[campo] = [];
                }
                corsePerCampo[campo].push(ev);
              });
              
              // Per ogni campo
              Object.keys(corsePerCampo).sort().forEach(campo => {
                // Header del campo
                html += `<tr><td colspan="${numCols}" class="bg-gray-800 text-blue-400 font-semibold px-4 py-2 border-b border-gray-600 text-sm">üèá ${campo}</td></tr>`;
                
                // Per ogni corsa nel campo
                corsePerCampo[campo].forEach(ev => {
                  const numeroCorsa = ev.numero_corsa || ev.quote?.numero_corsa || 'N/A';
                  const quote = ev.quote || {};
                  const winEachWay = quote.win_each_way || [];
                  
                  // Riga con numero corsa
                  html += `<tr class="bg-gray-750">
                    <td colspan="${numCols}" class="px-4 py-1 border-b border-gray-600">
                      <span class="text-yellow-400 font-bold text-sm">üê¥ Corsa ${numeroCorsa}</span>
                    </td>
                  </tr>`;
                  
                  // Riga con lista cavalli
                  if (winEachWay && Array.isArray(winEachWay) && winEachWay.length > 0) {
                    // Ordina i cavalli per posizione (header)
                    const cavalliOrdinati = [...winEachWay].sort((a, b) => {
                      const posA = parseInt(a.header || '99');
                      const posB = parseInt(b.header || '99');
                      return posA - posB;
                    });
                    
                    cavalliOrdinati.forEach((cavallo) => {
                      const nomeCavallo = cavallo.name || '';
                      const quota = cavallo.odds || '-';
                      const posizione = cavallo.header || '';
                      
                      html += `<tr class="bg-gray-800 hover:bg-gray-700">
                        <td colspan="${numCols}" class="px-6 py-1 border-b border-gray-700">
                          <div class="flex items-center justify-between">
                            <span class="text-white text-sm">Cavallo ${posizione}: ${nomeCavallo}</span>
                            <button class="quota-btn bg-green-600 hover:bg-green-700 text-white px-3 py-1 rounded text-sm font-bold" 
                                    data-match-id="${ev.match_id || ev._id}" 
                                    data-quota="${quota}" 
                                    data-categoria="win_each_way" 
                                    data-segno="${nomeCavallo}"
                                    data-evento="Corsa ${numeroCorsa} - ${nomeCavallo}">
                              ${quota}
                            </button>
                          </div>
                        </td>
                      </tr>`;
                    });
                  } else {
                    html += `<tr class="bg-gray-800">
                      <td colspan="${numCols}" class="px-6 py-1 border-b border-gray-700 text-gray-400 text-sm">Nessun cavallo disponibile</td>
                    </tr>`;
                  }
                });
              });
            } else {
              // Visualizzazione normale per gli altri sport
              html += `<tr><td colspan="${numCols}" class="bg-gray-800 text-blue-400 font-semibold px-4 py-1 border-b border-gray-600 text-xs">üèÜ ${league}</td></tr>`;
              
              grouped[date][league].forEach(ev => {
                const time = new Date(ev.start_time_date || ev.start_time).toLocaleTimeString('it-IT', { hour: '2-digit', minute: '2-digit' });
                const quote_1x2 = ev.quote_1x2 || {};
                const matchId = ev.match_id || ev._id;
                const teams = `${ev.home_name || ''} - ${ev.away_name || ''}`;
                
                // Per Goalscorer, mostra solo riga base (senza colonne quote)
                if (mercatoSelezionato === 'Goalscorer') {
                  html += `<tr class="bg-gray-800 hover:bg-gray-700 cursor-pointer goalscorer-match-row" data-match-id="${matchId}" data-expanded="false">
                    <td class="px-2 py-1 border-b border-gray-700 text-center">${matchId}</td>
                    <td class="px-2 py-1 border-b border-gray-700 text-center">${time}</td>
                    <td class="px-2 py-1 border-b border-gray-700 text-center">${teams}</td>
                    <td class="px-2 py-1 border-b border-gray-700 text-center">
                      <span class="text-xs text-gray-400">üëÜ Clicca per vedere i marcatori</span>
                    </td>
                    <td class="px-2 py-1 border-b border-gray-700 text-center">
                      <button class="mercati-btn px-2 py-1 bg-blue-600 hover:bg-blue-700 text-white text-xs rounded"
                              data-match-id="${matchId}">
                        üìä
                      </button>
                    </td>
                  </tr>`;
                  
                  // Riga espansa per i marcatori (nascosta di default)
                  const goalscorers = [];
                  if (ev.players && ev.players.odds && ev.players.odds.gls) {
                    goalscorers.push(...ev.players.odds.gls);
                  }
                  if (ev.quote && ev.quote.goalscorers) {
                    goalscorers.push(...ev.quote.goalscorers);
                  }
                  
                  if (goalscorers.length > 0) {
                    // Per Goalscorer, la riga base ha 5 colonne (Id, Data, Evento, Messaggio, Mercati)
                    const goalscorerColspan = 5;
                    html += `<tr class="goalscorer-expanded-row hidden bg-gray-900" data-match-id="${matchId}">
                      <td colspan="${goalscorerColspan}" class="px-4 py-2 border-b border-gray-700">
                        <div class="space-y-2">`;
                    
                    goalscorers.forEach(player => {
                      const playerName = player.name || '';
                      // Estrai odds: pu√≤ essere stringa, numero, o oggetto con odds
                      let playerOdds = '-';
                      if (typeof player.odds === 'string' || typeof player.odds === 'number') {
                        playerOdds = String(player.odds);
                      } else if (player.odds && typeof player.odds === 'object' && player.odds.odds) {
                        playerOdds = String(player.odds.odds);
                      }
                      const quotaNum = parseFloat(playerOdds);
                      const isSelected = selections.some(s => s.id == matchId && s.categoria === 'Goalscorer' && s.segno === playerName);
                      const quotaFormattata = quotaNum > 1 ? formattaQuota(playerOdds) : '-';
                      
                      html += `
                        <div class="flex items-center justify-between bg-gray-800 px-3 py-2 rounded hover:bg-gray-700">
                          <span class="text-white text-sm">${playerName}</span>
                          <button class="quote-btn bg-gray-900 hover:bg-yellow-500 hover:text-black text-white px-3 py-1 rounded text-sm font-bold ${isSelected ? 'bg-yellow-500 text-black' : ''} ${quotaNum <= 1 ? 'opacity-60 cursor-not-allowed' : 'cursor-pointer'}"
                                  data-match-id="${matchId}"
                                  data-categoria="Goalscorer"
                                  data-segno="${playerName}"
                                  data-quota="${playerOdds}"
                                  data-evento="${(teams || '').replace(/"/g, '&quot;').replace(/'/g, '&#39;')}"
                                  ${quotaNum <= 1 ? 'disabled' : ''}>
                            ${quotaFormattata}
                          </button>
                        </div>`;
                    });
                    
                    html += `
                        </div>
                      </td>
                    </tr>`;
                  } else {
                    // Per Goalscorer, la riga base ha 5 colonne
                    const goalscorerColspan = 5;
                    html += `<tr class="goalscorer-expanded-row hidden bg-gray-900" data-match-id="${matchId}">
                      <td colspan="${goalscorerColspan}" class="px-4 py-2 border-b border-gray-700 text-center text-gray-400">
                        Nessun marcatore disponibile
                      </td>
                    </tr>`;
                  }
                } else {
                  // Rendering normale per gli altri mercati
                  html += `<tr class="bg-gray-800 hover:bg-gray-700" data-match-id="${matchId}">
                    <td class="px-2 py-1 border-b border-gray-700 text-center">${matchId}</td>
                    <td class="px-2 py-1 border-b border-gray-700 text-center">${time}</td>
                    <td class="px-2 py-1 border-b border-gray-700 text-center">${teams}</td>`;
                  
                  // Aggiungi colonne in base al mercato
                  colonne.forEach(col => {
                let quota = '-';
                const quote = ev.quote || {};
                const colLabel = isPrincipali ? col.label : col;
                const colType = isPrincipali ? col.type : mercatoSelezionato;
                
                // Per il basket, estrai le quote 1X2 da game_lines con Money Line
                if (sportSelezionato === 'basket') {
                  quota = get1X2Quota(quote, colLabel || col, 'basket') || quote_1x2[colLabel || col] || '-';
                } else if (sportSelezionato === 'tennis') {
                  // Per il tennis, estrai le quote Money Line (solo 1 e 2, senza X)
                  quota = get1X2Quota(quote, colLabel || col, 'tennis') || quote_1x2[colLabel || col] || '-';
                } else if (sportSelezionato === 'hockey' || sportSelezionato === 'ice_hockey') {
                  // Per l'hockey, estrai le quote 1X2 da 3_way
                  quota = get1X2Quota(quote, colLabel || col, 'hockey') || quote_1x2[colLabel || col] || '-';
                } else if (sportSelezionato === 'volleyball' || sportSelezionato === 'volley') {
                  // Per il volley, estrai le quote da game_line con Winner (solo 1 e 2, senza X)
                  quota = get1X2Quota(quote, colLabel || col, 'volleyball') || quote_1x2[colLabel || col] || '-';
                } else if (sportSelezionato === 'water polo' || sportSelezionato === 'waterpolo') {
                  // Per il waterpolo, estrai le quote da game_lines con To Win (solo 1 e 2, senza X)
                  quota = get1X2Quota(quote, colLabel || col, 'waterpolo') || quote_1x2[colLabel || col] || '-';
                } else if (sportSelezionato === 'pallamano') {
                  // Per la pallamano, estrai le quote da game_lines con To Win (solo 1 e 2, senza X)
                  quota = get1X2Quota(quote, colLabel || col, 'pallamano') || quote_1x2[colLabel || col] || '-';
                } else if (sportSelezionato === 'football' || sportSelezionato === 'american football') {
                  // Per il football (american football), estrai le quote da game_lines con Money Line (solo 1 e 2, senza X)
                  quota = get1X2Quota(quote, colLabel || col, 'football') || quote_1x2[colLabel || col] || '-';
                } else if (sportSelezionato === 'rugby') {
                  // Per il rugby, estrai le quote 1X2 da game_betting_3_way con Result
                  quota = get1X2Quota(quote, colLabel || col, 'rugby') || quote_1x2[colLabel || col] || '-';
                } else if (sportSelezionato === 'e-sport' || sportSelezionato === 'esport') {
                  // Per l'e-sport, estrai le quote da match_lines con To Win (solo 1 e 2, senza X)
                  quota = get1X2Quota(quote, colLabel || col, 'e-sport') || quote_1x2[colLabel || col] || '-';
                } else if (sportSelezionato === 'boxing') {
                  // Per il boxing, estrai le quote da to_win_fight (solo 1 e 2, senza X)
                  quota = get1X2Quota(quote, colLabel || col, 'boxing') || quote_1x2[colLabel || col] || '-';
                } else if (sportSelezionato === 'badminton') {
                  // Per il badminton, estrai le quote da match_lines con To Win (solo 1 e 2, senza X)
                  quota = get1X2Quota(quote, colLabel || col, 'badminton') || quote_1x2[colLabel || col] || '-';
                } else if (sportSelezionato === 'cricket') {
                  // Per il cricket, estrai le quote da to_win_the_match (solo 1 e 2, senza X)
                  quota = get1X2Quota(quote, colLabel || col, 'cricket') || quote_1x2[colLabel || col] || '-';
                } else if (sportSelezionato === 'squash') {
                  // Per lo squash, estrai le quote da schedule.sp.main (solo 1 e 2, senza X)
                  // schedule potrebbe essere a livello root dell'evento, non dentro quote
                  let squashQuote = get1X2Quota(quote, colLabel || col, 'squash');
                  if (!squashQuote && ev.schedule?.sp?.main) {
                    const scheduleMain = ev.schedule.sp.main;
                    if (Array.isArray(scheduleMain)) {
                      for (const odd of scheduleMain) {
                        const name = (odd.name || '').trim();
                        if ((colLabel || col) === '1' && name === '1') {
                          squashQuote = odd.odds;
                          break;
                        } else if ((colLabel || col) === '2' && name === '2') {
                          squashQuote = odd.odds;
                          break;
                        }
                      }
                    }
                  }
                  quota = squashQuote || quote_1x2[colLabel || col] || '-';
                } else if (sportSelezionato === 'horse racing' || sportSelezionato === 'horseracing') {
                  // Per Horse Racing, estrai le quote da win_each_way usando il nome del cavallo
                  quota = get1X2Quota(quote, colLabel || col, 'horse racing') || '-';
                } else if (sportSelezionato === 'futsal') {
                  // Per il futsal, estrai le quote 1X2 da money_line con Result
                  quota = get1X2Quota(quote, colLabel || col, 'futsal') || quote_1x2[colLabel || col] || '-';
                } else if (sportSelezionato === 'pingpong' || sportSelezionato === 'ping_pong') {
                  // Per il ping pong, estrai le quote da match_lines con To Win (solo 1 e 2, senza X)
                  quota = get1X2Quota(quote, colLabel || col, 'pingpong') || quote_1x2[colLabel || col] || '-';
                } else if (isPrincipali) {
                  // Gestione Principali: usa colType per determinare il mercato
                  if (colType === '1X2') {
                    quota = quote_1x2[colLabel] || '-';
                  } else if (colType === 'Doppia Chance') {
                    const homeName = ev.home_name || '';
                    const awayName = ev.away_name || '';
                    quota = getDoubleChanceQuota(quote, colLabel, homeName, awayName) || '-';
                  } else if (colType === 'Over/Under') {
                    quota = getOverUnderQuota(quote, colLabel) || '-';
                  } else if (colType === 'Gol Totali') {
                    const btts = quote['both_teams_to_score'] || {};
                    if (Array.isArray(btts)) {
                      const item = btts.find(o => (o.name || o.header) === colLabel || (colLabel === 'GG' && (o.name === 'Yes' || o.name === 'S√¨')) || (colLabel === 'NG' && (o.name === 'No' || o.name === 'No')));
                      quota = item?.odds || '-';
                    } else {
                      quota = btts[colLabel === 'GG' ? 'Yes' : 'No'] || '-';
                    }
                  }
                } else if (mercatoSelezionato === '1X2') {
                  quota = quote_1x2[col] || '-';
                } else if (mercatoSelezionato === 'Doppia Chance') {
                  // Usa la funzione helper per estrarre la quota Doppia Chance
                  const homeName = ev.home_name || '';
                  const awayName = ev.away_name || '';
                  quota = getDoubleChanceQuota(quote, col, homeName, awayName) || '-';
                } else if (mercatoSelezionato === 'Over/Under') {
                  // Usa la funzione helper per estrarre la quota Over/Under
                  quota = getOverUnderQuota(quote, col) || '-';
                } else if (mercatoSelezionato === 'Gol Totali') {
                  const btts = quote['both_teams_to_score'] || {};
                  if (Array.isArray(btts)) {
                    const item = btts.find(o => (o.name || o.header) === col || (col === 'GG' && (o.name === 'Yes' || o.name === 'S√¨')) || (col === 'NG' && (o.name === 'No' || o.name === 'No')));
                    quota = item?.odds || '-';
                  } else {
                    quota = btts[col === 'GG' ? 'Yes' : 'No'] || '-';
                  }
                } else if (mercatoSelezionato === 'Handicap' || mercatoSelezionato === 'Handicap 1T' || mercatoSelezionato === 'Handicap 2T') {
                  quota = getHandicapQuota(quote, col) || '-';
                } else if (mercatoSelezionato === 'Ris. Esatto') {
                  quota = getRisEsattoQuota(quote, col, false) || '-';
                } else if (mercatoSelezionato === 'Ris. Es. 1T') {
                  quota = getRisEsattoQuota(quote, col, true) || '-';
                } else if (mercatoSelezionato === 'Ris. Es. 2T') {
                  quota = getRisEsattoQuota(quote, col, false) || '-';
                } else if (mercatoSelezionato === 'Ris. Es. P/F') {
                  quota = getParzialeFinaleQuota(quote, col) || '-';
                } else if (mercatoSelezionato === 'Gol Esatti') {
                  quota = getGolTotaliQuota(quote, col, false, false, false, false) || '-';
                } else if (mercatoSelezionato === 'GolTot 1T') {
                  quota = getGolTotaliQuota(quote, col, true, false, false, false) || '-';
                } else if (mercatoSelezionato === 'GolTot 2T') {
                  quota = getGolTotaliQuota(quote, col, false, true, false, false) || '-';
                } else if (mercatoSelezionato === 'GolTot Casa') {
                  quota = getGolTotaliQuota(quote, col, false, false, true, false) || '-';
                } else if (mercatoSelezionato === 'GolTot Ospite') {
                  quota = getGolTotaliQuota(quote, col, false, false, false, true) || '-';
                } else if (mercatoSelezionato === 'GG/NG 1T') {
                  quota = getGGNGQuota(quote, col, true, false) || '-';
                } else if (mercatoSelezionato === 'GG/NG 2T') {
                  quota = getGGNGQuota(quote, col, false, true) || '-';
                } else if (mercatoSelezionato === 'GG Special') {
                  quota = getComboQuota(quote, col) || '-';
                } else if (mercatoSelezionato === 'Multi Gol') {
                  quota = getMultiGoalQuota(quote, col, false, false) || '-';
                } else if (mercatoSelezionato === 'Multi Gol 1T') {
                  quota = getMultiGoalQuota(quote, col, true, false) || '-';
                } else if (mercatoSelezionato === 'Multi Gol 2T') {
                  quota = getMultiGoalQuota(quote, col, false, true) || '-';
                } else if (mercatoSelezionato === 'Multi Gol C/O' || mercatoSelezionato === 'Multigoal 1T/2' || mercatoSelezionato === 'Multigol Comb') {
                  quota = getMultiGoalQuota(quote, col, false, false) || '-';
                } else if (mercatoSelezionato === 'Combo' || mercatoSelezionato === 'Combo 1T' || mercatoSelezionato === 'Combo 2T' || 
                          mercatoSelezionato === 'Combo DC' || mercatoSelezionato === 'Combo DC 1T' || mercatoSelezionato === 'Combo DC 2T' ||
                          mercatoSelezionato === 'C. DC Multi' || mercatoSelezionato === 'Combo 3' || mercatoSelezionato === 'Combo3 HT/FT' ||
                          mercatoSelezionato === 'Combo+Multi' || mercatoSelezionato === 'Combo C/O' || mercatoSelezionato === 'Chance 3 Mix' ||
                          mercatoSelezionato === 'Chance Mix' || mercatoSelezionato === 'HT Ch. Mix' || mercatoSelezionato === 'Ris. Esatto Mix') {
                  quota = getComboQuota(quote, col) || '-';
                } else if (mercatoSelezionato === 'Primo Gol') {
                  quota = getFirstLastGoalQuota(quote, col, true) || '-';
                } else if (mercatoSelezionato === 'Ultimo Gol') {
                  quota = getFirstLastGoalQuota(quote, col, false) || '-';
                } else if (mercatoSelezionato === 'Primo Gol Min' || mercatoSelezionato === 'Primo Gol Min.' || mercatoSelezionato === '1X2+Primo Go' || mercatoSelezionato === 'DNB Primo Go') {
                  quota = getFirstLastGoalQuota(quote, col, true) || '-';
                } else if (mercatoSelezionato === 'Pari/Dispari') {
                  quota = getPariDispariQuota(quote, col, false, false) || '-';
                } else if (mercatoSelezionato === 'Pari/Dis. 1T') {
                  quota = getPariDispariQuota(quote, col, true, false) || '-';
                } else if (mercatoSelezionato === 'Pari/Dis. 2T') {
                  quota = getPariDispariQuota(quote, col, false, true) || '-';
                } else if (mercatoSelezionato === 'P./D. Squadre') {
                  quota = getPariDispariQuota(quote, col, false, false) || '-';
                } else if (mercatoSelezionato === 'Parz./Fin.') {
                  quota = getParzialeFinaleQuota(quote, col) || '-';
                } else if (mercatoSelezionato === 'DC 1T') {
                  const homeName = ev.home_name || '';
                  const awayName = ev.away_name || '';
                  quota = getDoubleChanceQuota(quote, col, homeName, awayName, true, false) || '-';
                } else if (mercatoSelezionato === 'DC 2T') {
                  const homeName = ev.home_name || '';
                  const awayName = ev.away_name || '';
                  quota = getDoubleChanceQuota(quote, col, homeName, awayName, false, true) || '-';
                } else if (mercatoSelezionato === '1X2 5 min' || mercatoSelezionato === '1X2 10 min' || mercatoSelezionato === '1X2 15 min' || 
                          mercatoSelezionato === '1X2 25 min' || mercatoSelezionato === '1X2 30 min') {
                  quota = quote_1x2[col] || '-';
                } else if (mercatoSelezionato === 'Goal (0 - 15)' || mercatoSelezionato === 'Goal (0 - 30)') {
                  // Cerca in early_goal o late_goal
                  const goalType = mercatoSelezionato.includes('15') ? 'early_goal' : 'late_goal';
                  const goalData = quote.goals?.sp?.[goalType] || {};
                  if (Array.isArray(goalData)) {
                    const item = goalData.find(o => (o.name || '').toLowerCase() === col.toLowerCase());
                    quota = item?.odds || '-';
                  }
                } else if (mercatoSelezionato === 'DNB' || mercatoSelezionato === 'DNB 1T' || mercatoSelezionato === 'DNB 2T') {
                  const is1T = mercatoSelezionato === 'DNB 1T';
                  const is2T = mercatoSelezionato === 'DNB 2T';
                  quota = getDNBQuota(quote, col, is1T, is2T) || '-';
                } else if (mercatoSelezionato === 'HNB') {
                  quota = getNoBetQuota(quote, col, 'handicap_no_bet') || '-';
                } else if (mercatoSelezionato === 'ANB') {
                  quota = getNoBetQuota(quote, col, 'asian_no_bet') || '-';
                } else if (mercatoSelezionato === 'Gol No Bet') {
                  quota = getNoBetQuota(quote, col, 'goal_no_bet') || '-';
                } else if (mercatoSelezionato === 'Tempo+Gol' || mercatoSelezionato === 'T+G (C/O)') {
                  quota = getTimeAndGoalQuota(quote, col) || '-';
                } else if (mercatoSelezionato === '1T') {
                  quota = get1X2FirstHalfQuota(quote, col) || '-';
                } else if (mercatoSelezionato === '2T') {
                  quota = get1X2SecondHalfQuota(quote, col) || '-';
                } else if (mercatoSelezionato === 'O/U 1T') {
                  quota = getOverUnderQuota(quote, col, true, false) || '-';
                } else if (mercatoSelezionato === 'O/U 2T') {
                  quota = getOverUnderQuota(quote, col, false, true) || '-';
                } else if (mercatoSelezionato === 'O/U C/O') {
                  quota = getTeamOverUnderQuota(quote, col, false) || '-';
                } else if (mercatoSelezionato === 'O/U 1T C/O') {
                  quota = getTeamOverUnderQuota(quote, col, true) || '-';
                } else if (mercatoSelezionato === 'Corner') {
                  quota = getCornerQuota(quote, col) || '-';
                } else if (mercatoSelezionato === 'Cart. Allen.') {
                  quota = getCardsQuota(quote, col) || '-';
                } else if (mercatoSelezionato === 'Tempo 1¬∞sub') {
                  quota = getTempoPrimoSubQuota(quote, col) || '-';
                } else if (mercatoSelezionato === 'Team 1¬∞ sub') {
                  quota = getTeamPrimoSubQuota(quote, col) || '-';
                } else if (mercatoSelezionato === 'VAR Si/No') {
                  quota = getVARQuota(quote, col) || '-';
                } else if (mercatoSelezionato === 'Rigori') {
                  quota = getPenaltyQuota(quote, col) || '-';
                } else if (mercatoSelezionato === 'Speciali Gol') {
                  quota = getSpecialGoalsQuota(quote, col) || '-';
                } else if (mercatoSelezionato === 'Metodo 1¬∞ gol') {
                  quota = getFirstGoalMethodQuota(quote, col) || '-';
                } else if (mercatoSelezionato === 'Segna 1T 2T') {
                  // Per Segna 1T 2T, cerca goalscorers con header appropriato
                  quota = getGoalscorersQuota(quote, col, 'Anytime') || '-';
                } else if (mercatoSelezionato === 'Goalscorer') {
                  // Per Goalscorer, cerca nelle quote dei giocatori
                  quota = getGoalscorerQuota(ev, col) || '-';
                } else if (mercatoSelezionato === 'Vince a 0') {
                  quota = getWinningMarginQuota(quote, col) || '-';
                } else if (mercatoSelezionato === 'Vince 1T e 2T' || mercatoSelezionato === 'Vince 1T o 2T') {
                  quota = getHalfWithMostGoalsQuota(quote, col) || '-';
                } else if (mercatoSelezionato === 'Vincono Rib.') {
                  quota = getComebackQuota(quote, col) || '-';
                } else {
                  // üîπ Fallback: cerca direttamente nel quote object usando il nome del mercato
                  // Converte il nome del mercato da italiano a chiave database (snake_case)
                  const mercatoKey = convertiMercatoToKey(mercatoSelezionato);
                  
                  if (mercatoKey && quote[mercatoKey]) {
                    if (Array.isArray(quote[mercatoKey])) {
                      // Cerca la quota nell'array usando name, header o col (priorit√† a header per formato calculated)
                      const item = quote[mercatoKey].find(o => {
                        if (!o || typeof o !== 'object') return false;
                        const oName = String(o.name || '').trim();
                        const oHeader = String(o.header || '').trim();
                        const colStr = String(col || '').trim();
                        // Priorit√† a header (formato calculated: header="1X", "X2", "12")
                        if (oHeader && oHeader.toUpperCase() === colStr.toUpperCase()) {
                          return true;
                        }
                        // Fallback a name
                        return oName === colStr || oHeader === colStr || 
                               oName.toLowerCase() === colStr.toLowerCase() || 
                               oHeader.toLowerCase() === colStr.toLowerCase();
                      });
                      if (item && item.odds) {
                        quota = item.odds;
                      }
                    } else if (quote[mercatoKey].odds && Array.isArray(quote[mercatoKey].odds)) {
                      const item = quote[mercatoKey].odds.find(o => {
                        if (!o || typeof o !== 'object') return false;
                        const oName = String(o.name || '').trim();
                        const oHeader = String(o.header || '').trim();
                        const colStr = String(col || '').trim();
                        if (oHeader && oHeader.toUpperCase() === colStr.toUpperCase()) {
                          return true;
                        }
                        return oName === colStr || oHeader === colStr || 
                               oName.toLowerCase() === colStr.toLowerCase() || 
                               oHeader.toLowerCase() === colStr.toLowerCase();
                      });
                      if (item && item.odds) {
                        quota = item.odds;
                      }
                    }
                  }
                  
                  // Se ancora non trovato, cerca anche in goals.sp, main.sp, half.sp, others
                  if (quota === '-') {
                    // Cerca in goals.sp
                    if (quote.goals?.sp?.[mercatoKey]) {
                      const goalsData = quote.goals.sp[mercatoKey];
                      if (Array.isArray(goalsData)) {
                        const item = goalsData.find(o => {
                          if (!o || typeof o !== 'object') return false;
                          const oName = String(o.name || '').trim();
                          const oHeader = String(o.header || '').trim();
                          const colStr = String(col || '').trim();
                          // Priorit√† a header (formato calculated)
                          if (oHeader && oHeader.toUpperCase() === colStr.toUpperCase()) {
                            return true;
                          }
                          return oName === colStr || oHeader === colStr || 
                                 oName.toLowerCase() === colStr.toLowerCase() || 
                                 oHeader.toLowerCase() === colStr.toLowerCase();
                        });
                        if (item && item.odds) {
                          quota = item.odds;
                        }
                      } else if (goalsData.odds && Array.isArray(goalsData.odds)) {
                        const item = goalsData.odds.find(o => {
                          if (!o || typeof o !== 'object') return false;
                          const oName = String(o.name || '').trim();
                          const oHeader = String(o.header || '').trim();
                          const colStr = String(col || '').trim();
                          if (oHeader && oHeader.toUpperCase() === colStr.toUpperCase()) {
                            return true;
                          }
                          return oName === colStr || oHeader === colStr || 
                                 oName.toLowerCase() === colStr.toLowerCase() || 
                                 oHeader.toLowerCase() === colStr.toLowerCase();
                        });
                        if (item && item.odds) {
                          quota = item.odds;
                        }
                      }
                    }
                    
                    // Cerca in main.sp
                    if (quota === '-' && quote.main?.sp?.[mercatoKey]) {
                      const mainData = quote.main.sp[mercatoKey];
                      if (Array.isArray(mainData)) {
                        const item = mainData.find(o => {
                          if (!o || typeof o !== 'object') return false;
                          const oName = String(o.name || '').trim();
                          const oHeader = String(o.header || '').trim();
                          const colStr = String(col || '').trim();
                          // Priorit√† a header (formato calculated)
                          if (oHeader && oHeader.toUpperCase() === colStr.toUpperCase()) {
                            return true;
                          }
                          return oName === colStr || oHeader === colStr || 
                                 oName.toLowerCase() === colStr.toLowerCase() || 
                                 oHeader.toLowerCase() === colStr.toLowerCase();
                        });
                        if (item && item.odds) {
                          quota = item.odds;
                        }
                      } else if (mainData.odds && Array.isArray(mainData.odds)) {
                        const item = mainData.odds.find(o => {
                          if (!o || typeof o !== 'object') return false;
                          const oName = String(o.name || '').trim();
                          const oHeader = String(o.header || '').trim();
                          const colStr = String(col || '').trim();
                          if (oHeader && oHeader.toUpperCase() === colStr.toUpperCase()) {
                            return true;
                          }
                          return oName === colStr || oHeader === colStr || 
                                 oName.toLowerCase() === colStr.toLowerCase() || 
                                 oHeader.toLowerCase() === colStr.toLowerCase();
                        });
                        if (item && item.odds) {
                          quota = item.odds;
                        }
                      }
                    }
                    
                    // Cerca in half.sp
                    if (quota === '-' && quote.half?.sp?.[mercatoKey]) {
                      const halfData = quote.half.sp[mercatoKey];
                      if (Array.isArray(halfData)) {
                        const item = halfData.find(o => {
                          if (!o || typeof o !== 'object') return false;
                          const oName = String(o.name || '').trim();
                          const oHeader = String(o.header || '').trim();
                          const colStr = String(col || '').trim();
                          // Priorit√† a header (formato calculated)
                          if (oHeader && oHeader.toUpperCase() === colStr.toUpperCase()) {
                            return true;
                          }
                          return oName === colStr || oHeader === colStr || 
                                 oName.toLowerCase() === colStr.toLowerCase() || 
                                 oHeader.toLowerCase() === colStr.toLowerCase();
                        });
                        if (item && item.odds) {
                          quota = item.odds;
                        }
                      } else if (halfData.odds && Array.isArray(halfData.odds)) {
                        const item = halfData.odds.find(o => {
                          if (!o || typeof o !== 'object') return false;
                          const oName = String(o.name || '').trim();
                          const oHeader = String(o.header || '').trim();
                          const colStr = String(col || '').trim();
                          if (oHeader && oHeader.toUpperCase() === colStr.toUpperCase()) {
                            return true;
                          }
                          return oName === colStr || oHeader === colStr || 
                                 oName.toLowerCase() === colStr.toLowerCase() || 
                                 oHeader.toLowerCase() === colStr.toLowerCase();
                        });
                        if (item && item.odds) {
                          quota = item.odds;
                        }
                      }
                    }
                    
                    // Cerca in others
                    if (quota === '-' && quote.others && Array.isArray(quote.others)) {
                      for (const other of quote.others) {
                        if (other.sp && other.sp[mercatoKey]) {
                          const otherData = other.sp[mercatoKey];
                          if (Array.isArray(otherData)) {
                            const item = otherData.find(o => {
                              if (!o || typeof o !== 'object') return false;
                              const oName = String(o.name || '').trim();
                              const oHeader = String(o.header || '').trim();
                              const colStr = String(col || '').trim();
                              // Priorit√† a header (formato calculated)
                              if (oHeader && oHeader.toUpperCase() === colStr.toUpperCase()) {
                                return true;
                              }
                              return oName === colStr || oHeader === colStr || 
                                     oName.toLowerCase() === colStr.toLowerCase() || 
                                     oHeader.toLowerCase() === colStr.toLowerCase();
                            });
                            if (item && item.odds) {
                              quota = item.odds;
                              break;
                            }
                          } else if (otherData.odds && Array.isArray(otherData.odds)) {
                            const item = otherData.odds.find(o => {
                              if (!o || typeof o !== 'object') return false;
                              const oName = String(o.name || '').trim();
                              const oHeader = String(o.header || '').trim();
                              const colStr = String(col || '').trim();
                              if (oHeader && oHeader.toUpperCase() === colStr.toUpperCase()) {
                                return true;
                              }
                              return oName === colStr || oHeader === colStr || 
                                     oName.toLowerCase() === colStr.toLowerCase() || 
                                     oHeader.toLowerCase() === colStr.toLowerCase();
                            });
                            if (item && item.odds) {
                              quota = item.odds;
                              break;
                            }
                          }
                        }
                      }
                    }
                    
                    // üîπ Ricerca generica: itera su tutte le chiavi del quote object
                    if (quota === '-') {
                      // Crea una lista di chiavi alternative da cercare
                      const alternativeKeys = [mercatoKey];
                      
                      // Aggiungi varianti comuni
                      if (mercatoKey.includes('_')) {
                        alternativeKeys.push(mercatoKey.replace(/_/g, ''));
                        alternativeKeys.push(mercatoKey.replace(/_/g, '-'));
                      }
                      if (mercatoKey.includes('1st_half')) {
                        alternativeKeys.push(mercatoKey.replace('1st_half', 'first_half'));
                        alternativeKeys.push(mercatoKey.replace('1st_half', '1t'));
                      }
                      if (mercatoKey.includes('2nd_half')) {
                        alternativeKeys.push(mercatoKey.replace('2nd_half', 'second_half'));
                        alternativeKeys.push(mercatoKey.replace('2nd_half', '2t'));
                      }
                      
                      // Cerca in tutte le chiavi del quote object
                      for (const key in quote) {
                        if (key === 'others' || key === 'goals' || key === 'main' || key === 'half' || 
                            key === 'asian_lines' || key === 'corners' || key === 'cards' || 
                            key === 'specials' || key === 'player') {
                          continue; // Gi√† cercato sopra
                        }
                        
                        // Verifica se la chiave corrisponde a una delle alternative
                        const keyLower = key.toLowerCase();
                        const matches = alternativeKeys.some(altKey => {
                          const altLower = altKey.toLowerCase();
                          return keyLower === altLower || 
                                 keyLower.includes(altLower) || 
                                 altLower.includes(keyLower) ||
                                 keyLower.replace(/_/g, '') === altLower.replace(/_/g, '');
                        });
                        
                        if (matches) {
                          const data = quote[key];
                          if (Array.isArray(data)) {
                            const item = data.find(o => {
                              if (!o || typeof o !== 'object') return false;
                              const oName = String(o.name || '').trim();
                              const oHeader = String(o.header || '').trim();
                              const colStr = String(col || '').trim();
                              // Priorit√† a header (formato calculated)
                              if (oHeader && oHeader.toUpperCase() === colStr.toUpperCase()) {
                                return true;
                              }
                              // Cerca anche corrispondenze parziali
                              if (oName && colStr && (
                                oName === colStr || 
                                oHeader === colStr || 
                                oName.toLowerCase() === colStr.toLowerCase() || 
                                oHeader.toLowerCase() === colStr.toLowerCase() ||
                                oName.toLowerCase().includes(colStr.toLowerCase()) ||
                                colStr.toLowerCase().includes(oName.toLowerCase())
                              )) {
                                return true;
                              }
                              return false;
                            });
                            if (item && item.odds) {
                              quota = item.odds;
                              break;
                            }
                          }
                        }
                      }
                    }
                  }
                }
                
                const quotaNum = parseFloat(quota);
                const categoria = isPrincipali ? colType : mercatoSelezionato;
                const segno = isPrincipali ? colLabel : col;
                const isSelected = selections.some(s => s.id == matchId && s.categoria === categoria && s.segno === segno);
                const quotaFormattata = quotaNum > 1 ? formattaQuota(quota) : '-';
                
                html += `
                  <td class="px-1 py-1 border-b border-gray-700">
                    <button class="quote-btn w-full border border-gray-600 rounded px-0.5 py-0.5 text-xs ${isSelected ? 'bg-yellow-500 text-black' : 'bg-gray-900 text-white hover:bg-yellow-500 hover:text-black'} ${quotaNum <= 1 ? 'opacity-60 cursor-not-allowed' : 'cursor-pointer'}"
                            data-match-id="${matchId}"
                            data-categoria="${categoria}"
                            data-segno="${segno}"
                            data-quota="${quota}"
                            data-evento="${(teams || '').replace(/"/g, '&quot;').replace(/'/g, '&#39;')}"
                            ${quotaNum <= 1 ? 'disabled' : ''}>
                      ${quotaFormattata}
                    </button>
                  </td>`;
              });
              
              // Pulsante mercati dopo le quote
              html += `
                <td class="px-2 py-1 border-b border-gray-700 text-center">
                  <button class="mercati-btn px-2 py-1 bg-blue-600 hover:bg-blue-700 text-white text-xs rounded"
                          data-match-id="${matchId}">
                    üìä
                  </button>
                </td>
              `;
              
              html += `</tr>`;
                }
              });
            }
          });
        });

        tbody.innerHTML = html;
        
        // Aggiungi event listener per espandere/collassare marcatori (Goalscorer)
        tbody.querySelectorAll('.goalscorer-match-row').forEach(row => {
          row.addEventListener('click', function(e) {
            // Non espandere se si clicca sul pulsante mercati
            if (e.target.closest('.mercati-btn')) {
              return;
            }
            
            const matchId = this.getAttribute('data-match-id');
            const isExpanded = this.getAttribute('data-expanded') === 'true';
            const expandedRow = tbody.querySelector(`tr.goalscorer-expanded-row[data-match-id="${matchId}"]`);
            
            if (expandedRow) {
              if (isExpanded) {
                expandedRow.classList.add('hidden');
                this.setAttribute('data-expanded', 'false');
                const spanEl = this.querySelector('td:nth-child(4) span');
                if (spanEl) spanEl.textContent = 'üëÜ Clicca per vedere i marcatori';
              } else {
                expandedRow.classList.remove('hidden');
                this.setAttribute('data-expanded', 'true');
                const spanEl = this.querySelector('td:nth-child(4) span');
                if (spanEl) spanEl.textContent = 'üëá Clicca per nascondere i marcatori';
              }
            }
          });
        });
        
        // Aggiungi event listener ai pulsanti quote (sia quote-btn che quota-btn per Horse Racing)
        tbody.querySelectorAll('.quote-btn, .quota-btn').forEach(btn => {
          if (!btn.disabled) {
            btn.addEventListener('click', function() {
              const matchId = this.getAttribute('data-match-id');
              const categoria = this.getAttribute('data-categoria');
              const segno = this.getAttribute('data-segno');
              const quota = this.getAttribute('data-quota');
              const evento = this.getAttribute('data-evento');
              selectQuote(matchId, categoria, segno, quota, evento);
            });
          }
        });
        
        // Aggiungi event listener ai pulsanti mercati
        tbody.querySelectorAll('.mercati-btn').forEach(btn => {
          btn.addEventListener('click', function() {
            const matchId = this.getAttribute('data-match-id');
            apriMercati(matchId);
          });
        });
      } catch (error) {
        console.error('Errore renderMatches:', error);
        const tbody = document.getElementById('matches-body');
        if (tbody) {
          tbody.innerHTML = '<tr><td colspan="6" class="text-center py-4 text-red-400">Errore nel rendering delle partite</td></tr>';
        }
      }
    }

    // Renderizza i campi nella sidebar per Horse Racing
    function renderCampiHorseRacing() {
      const campiList = document.getElementById('campi-list');
      if (!campiList) return;
      
      // Raccogli tutti i campi unici
      const campi = new Set();
      matchesData.forEach(ev => {
        const campo = ev.league || ev.home_name || 'Unknown';
        if (campo && campo !== 'Unknown') {
          campi.add(campo);
        }
      });
      
      const campiArray = Array.from(campi).sort();
      
      if (campiArray.length === 0) {
        campiList.innerHTML = '<div class="text-gray-400 text-sm p-2">Nessun campo disponibile</div>';
        return;
      }
      
      let html = '';
      campiArray.forEach(campo => {
        const isSelected = campoSelezionato === campo;
        html += `
          <button class="campo-btn w-full md:w-full text-left px-2 md:px-3 py-1.5 md:py-2 mb-0 md:mb-1 rounded text-xs md:text-sm font-medium transition-colors whitespace-nowrap ${
            isSelected 
              ? 'bg-yellow-500 text-black' 
              : 'bg-gray-700 text-white hover:bg-gray-600'
          }" 
                  data-campo="${campo}">
            üèá ${campo}
          </button>
        `;
      });
      
      campiList.innerHTML = html;
      
      // Aggiungi event listener
      campiList.querySelectorAll('.campo-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          const campo = this.getAttribute('data-campo');
          campoSelezionato = campo;
          renderCampiHorseRacing(); // Aggiorna UI
          renderCorseHorseRacing(); // Renderizza le corse
        });
      });
    }

    // Renderizza le corse del campo selezionato per Horse Racing
    function renderCorseHorseRacing() {
      const corseContainer = document.getElementById('corse-container');
      const campoTitle = document.getElementById('campo-selezionato-title');
      
      if (!corseContainer) return;
      
      if (!campoSelezionato) {
        campoTitle.textContent = 'Seleziona un campo';
        corseContainer.innerHTML = '<div class="text-gray-400 text-center py-8">Seleziona un campo dalla lista a destra</div>';
        return;
      }
      
      campoTitle.textContent = `üèá ${campoSelezionato}`;
      
      // Filtra le corse del campo selezionato
      const corse = matchesData.filter(ev => {
        const campo = ev.league || ev.home_name || 'Unknown';
        return campo === campoSelezionato;
      });
      
      if (corse.length === 0) {
        corseContainer.innerHTML = '<div class="text-gray-400 text-center py-8">Nessuna corsa disponibile per questo campo</div>';
        return;
      }
      
      // Raggruppa per data
      const groupedByDate = {};
      corse.forEach(ev => {
        const date = new Date(ev.start_time_date || ev.start_time);
        const dateStr = date.toLocaleDateString('it-IT');
        if (!groupedByDate[dateStr]) {
          groupedByDate[dateStr] = [];
        }
        groupedByDate[dateStr].push(ev);
      });
      
      let html = '';
      Object.keys(groupedByDate).sort().forEach(date => {
        html += `<div class="mb-4">
          <div class="bg-gray-900 text-yellow-400 font-bold px-4 py-2 mb-2 rounded">${date}</div>`;
        
        groupedByDate[date].forEach(ev => {
          const time = new Date(ev.start_time_date || ev.start_time).toLocaleTimeString('it-IT', { hour: '2-digit', minute: '2-digit' });
          const numeroCorsa = ev.numero_corsa || ev.quote?.numero_corsa || 'N/A';
          const matchId = ev.match_id || ev._id;
          const quote = ev.quote || {};
          const winEachWay = quote.win_each_way || [];
          
          html += `
            <div class="bg-gray-800 rounded mb-3 p-2 md:p-3" data-corsa-id="${matchId}">
              <div class="flex flex-col md:flex-row md:items-center md:justify-between mb-2 pb-2 border-b border-gray-700 gap-1 md:gap-0">
                <div class="flex flex-wrap items-center gap-2 md:gap-3">
                  <span class="text-yellow-400 font-bold text-sm md:text-base">üê¥ Corsa ${numeroCorsa}</span>
                  <span class="text-gray-400 text-xs md:text-sm">${time}</span>
                  <span class="text-gray-500 text-xs">ID: ${matchId}</span>
                </div>
              </div>
              <div class="space-y-1">`;
          
          if (winEachWay && Array.isArray(winEachWay) && winEachWay.length > 0) {
            const cavalliOrdinati = [...winEachWay].sort((a, b) => {
              const posA = parseInt(a.header || '99');
              const posB = parseInt(b.header || '99');
              return posA - posB;
            });
            
            cavalliOrdinati.forEach(cavallo => {
              const nomeCavallo = cavallo.name || '';
              const quota = cavallo.odds || '-';
              const posizione = cavallo.header || '';
              
              html += `
                <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between py-1 px-2 hover:bg-gray-700 rounded gap-1 sm:gap-0">
                  <span class="text-white text-xs sm:text-sm truncate">Cavallo ${posizione}: ${nomeCavallo}</span>
                  <button class="quota-btn bg-green-600 hover:bg-green-700 text-white px-3 sm:px-4 py-1 rounded text-xs sm:text-sm font-bold min-w-[60px] w-full sm:w-auto text-center" 
                          data-match-id="${matchId}" 
                          data-quota="${quota}" 
                          data-categoria="win_each_way" 
                          data-segno="${nomeCavallo}"
                          data-evento="Corsa ${numeroCorsa} - ${nomeCavallo}">
                    ${quota}
                  </button>
                </div>`;
            });
          } else {
            html += '<div class="text-gray-400 text-sm py-2">Nessun cavallo disponibile</div>';
          }
          
          html += `</div></div>`;
        });
        
        html += `</div>`;
      });
      
      corseContainer.innerHTML = html;
      
      // Aggiungi event listener ai pulsanti quote
      corseContainer.querySelectorAll('.quota-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          const matchId = this.getAttribute('data-match-id');
          const categoria = this.getAttribute('data-categoria');
          const segno = this.getAttribute('data-segno');
          const quota = this.getAttribute('data-quota');
          const evento = this.getAttribute('data-evento');
          selectQuote(matchId, categoria, segno, quota, evento);
        });
      });
    }

    // Renderizza le partite nella sidebar per Goalscorer
    function renderSquadreGoalscorer() {
      const partiteList = document.getElementById('partite-list');
      if (!partiteList) return;
      
      if (matchesData.length === 0) {
        partiteList.innerHTML = '<div class="text-gray-400 text-sm p-2">Nessuna partita disponibile</div>';
        return;
      }
      
      // Raggruppa per data
      const groupedByDate = {};
      matchesData.forEach(ev => {
        const date = new Date(ev.start_time_date || ev.start_time);
        const dateStr = date.toLocaleDateString('it-IT', { day: '2-digit', month: '2-digit' });
        if (!groupedByDate[dateStr]) {
          groupedByDate[dateStr] = [];
        }
        groupedByDate[dateStr].push(ev);
      });
      
      let html = '';
      Object.keys(groupedByDate).sort().forEach(date => {
        html += `<div class="text-gray-400 text-xs font-semibold px-2 py-1 mb-1">${date}</div>`;
        
        groupedByDate[date].forEach(ev => {
          const matchId = ev.match_id || ev.id || ev._id;
          const homeName = (ev.home_name || '').trim();
          const awayName = (ev.away_name || '').trim();
          const time = new Date(ev.start_time_date || ev.start_time).toLocaleTimeString('it-IT', { hour: '2-digit', minute: '2-digit' });
          const isSelected = partitaSelezionata === matchId;
          
          html += `
            <button class="partita-btn w-full md:w-full text-left px-2 md:px-3 py-1.5 md:py-2 mb-0 md:mb-1 rounded text-xs md:text-sm font-medium transition-colors ${
              isSelected 
                ? 'bg-yellow-500 text-black' 
                : 'bg-gray-700 text-white hover:bg-gray-600'
            }" 
                    data-match-id="${matchId}">
              <div class="font-bold">${homeName}</div>
              <div class="text-xs opacity-75">vs ${awayName}</div>
              <div class="text-xs opacity-60">${time}</div>
            </button>
          `;
        });
      });
      
      partiteList.innerHTML = html;
      
      // Aggiungi event listener
      partiteList.querySelectorAll('.partita-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          const matchId = this.getAttribute('data-match-id');
          partitaSelezionata = matchId;
          // Reset tab selezionata quando si cambia partita
          const marcatoriContainer = document.getElementById('marcatori-container');
          if (marcatoriContainer) {
            marcatoriContainer.setAttribute('data-tab-selezionata', 'casa');
          }
          renderSquadreGoalscorer(); // Aggiorna UI
          renderMarcatoriGoalscorer(); // Renderizza i marcatori
        });
      });
    }

    // Renderizza i marcatori della partita selezionata per Goalscorer
    function renderMarcatoriGoalscorer() {
      const marcatoriContainer = document.getElementById('marcatori-container');
      const partitaTitle = document.getElementById('partita-selezionata-title');
      
      if (!marcatoriContainer) return;
      
      if (!partitaSelezionata) {
        partitaTitle.textContent = 'Seleziona una partita';
        marcatoriContainer.innerHTML = '<div class="text-gray-400 text-center py-8">Seleziona una partita dalla lista a sinistra</div>';
        return;
      }
      
      // Trova la partita selezionata
      const partita = matchesData.find(ev => {
        const matchId = ev.match_id || ev.id || ev._id;
        return String(matchId) === String(partitaSelezionata);
      });
      
      if (!partita) {
        partitaTitle.textContent = 'Partita non trovata';
        marcatoriContainer.innerHTML = '<div class="text-gray-400 text-center py-8">Partita non trovata</div>';
        return;
      }
      
      const homeName = (partita.home_name || '').trim();
      const awayName = (partita.away_name || '').trim();
      const matchId = partita.match_id || partita.id || partita._id;
      const time = new Date(partita.start_time_date || partita.start_time).toLocaleTimeString('it-IT', { hour: '2-digit', minute: '2-digit' });
      const league = partita.league || 'N/A';
      
      partitaTitle.textContent = `${homeName} - ${awayName} (${time})`;
      
      // Estrai tutti i dati dei players
      const playersData = partita.players && partita.players.odds ? partita.players.odds : {};
      
      // Se soa non √® in players.odds, cerca anche direttamente in partita.players.odds (potrebbe essere annidato diversamente)
      if (!playersData.soa && partita.players && partita.players.odds && partita.players.odds.soa) {
        playersData.soa = partita.players.odds.soa;
      }
      
      // Se mgs non √® in players.odds, cerca anche in quote (dalla partita direttamente)
      if (!playersData.mgs && partita.quote) {
        // Cerca multi_scorers o mgs nella struttura quote
        if (partita.quote.multi_scorers && Array.isArray(partita.quote.multi_scorers)) {
          playersData.mgs = partita.quote.multi_scorers;
        } else if (partita.quote.mgs && Array.isArray(partita.quote.mgs)) {
          playersData.mgs = partita.quote.mgs;
        }
      }
      
      // Se gls non √® in players.odds, cerca anche in quote (dalla partita direttamente)
      if (!playersData.gls && partita.quote) {
        // Cerca goalscorers o gls nella struttura quote
        if (partita.quote.goalscorers && Array.isArray(partita.quote.goalscorers)) {
          playersData.gls = partita.quote.goalscorers;
        } else if (partita.quote.gls && Array.isArray(partita.quote.gls)) {
          playersData.gls = partita.quote.gls;
        }
      }
      
      
      // Mercati disponibili
      const mercati = {
        'score': 'Segna',
        'gls': 'Goalscorer (Anytime/First/Last)',
        'tgs': 'Team Goalscorer',
        'mgs': 'Multiple Goalscorer',
        'gls_method': 'Goalscorer Method',
        'anytime_1x2': 'Anytime 1X2',
        'first_1x2': 'First 1X2',
        'anytime_cs': 'Anytime Correct Score',
        'first_cs_mix': 'First Correct Score Mix',
        'soa': 'Score or Assist'
      };
      
      // Funzione helper per estrarre odds
      function getOddsValue(odd) {
        if (typeof odd === 'string' || typeof odd === 'number') {
          return String(odd);
        } else if (odd && typeof odd === 'object' && odd.odds) {
          return String(odd.odds);
        } else if (odd && typeof odd === 'object' && '$numberDouble' in odd) {
          return String(odd.$numberDouble);
        }
        return '-';
      }
      
      // Funzione helper per renderizzare i players di un mercato
      function renderMercatoPlayers(mercatoKey, mercatoNome, teamNumber) {
        let mercatoData = playersData[mercatoKey];
        
        // Se il mercato √® "score", estrai solo i players con header "Score" da soa
        if (mercatoKey === 'score') {
          // Cerca prima in playersData.soa
          const soaData = playersData.soa;
          if (soaData && Array.isArray(soaData)) {
            mercatoData = soaData.filter(player => {
              const header = (player.header || '').trim();
              return header === 'Score';
            });
          }
          
          // Se non trovato in playersData, cerca anche in quote
          if ((!mercatoData || !Array.isArray(mercatoData) || mercatoData.length === 0) && partita.quote) {
            let soaDataFromQuote = null;
            if (partita.quote.soa && Array.isArray(partita.quote.soa)) {
              soaDataFromQuote = partita.quote.soa;
            } else if (partita.quote.others && Array.isArray(partita.quote.others)) {
              for (let other of partita.quote.others) {
                if (other && other.sp && other.sp.soa && Array.isArray(other.sp.soa)) {
                  soaDataFromQuote = other.sp.soa;
                  break;
                }
              }
            }
            if (soaDataFromQuote) {
              mercatoData = soaDataFromQuote.filter(player => {
                const header = (player.header || '').trim();
                return header === 'Score';
              });
            }
          }
          
          // Se ancora non trovato, cerca anche direttamente in partita.players.odds.soa (potrebbe essere annidato diversamente)
          if ((!mercatoData || !Array.isArray(mercatoData) || mercatoData.length === 0) && partita.players && partita.players.odds && partita.players.odds.soa && Array.isArray(partita.players.odds.soa)) {
            mercatoData = partita.players.odds.soa.filter(player => {
              const header = (player.header || '').trim();
              return header === 'Score';
            });
          }
        }
        
        // Se il mercato non √® in playersData, cerca anche in quote (per mgs e gls potrebbe essere in quote)
        if ((!mercatoData || !Array.isArray(mercatoData) || mercatoData.length === 0) && partita.quote) {
          // Cerca direttamente in quote
          if (mercatoKey === 'mgs' && partita.quote.multi_scorers && Array.isArray(partita.quote.multi_scorers)) {
            mercatoData = partita.quote.multi_scorers;
          } else if (mercatoKey === 'gls' && partita.quote.goalscorers && Array.isArray(partita.quote.goalscorers)) {
            mercatoData = partita.quote.goalscorers;
          } else if (partita.quote[mercatoKey] && Array.isArray(partita.quote[mercatoKey])) {
            mercatoData = partita.quote[mercatoKey];
          }
          
          // Se ancora non trovato, cerca in quote.others (struttura annidata)
          if ((!mercatoData || !Array.isArray(mercatoData) || mercatoData.length === 0) && partita.quote.others && Array.isArray(partita.quote.others)) {
            for (let other of partita.quote.others) {
              if (other && other.sp) {
                if (mercatoKey === 'mgs' && other.sp.multi_scorers && Array.isArray(other.sp.multi_scorers)) {
                  mercatoData = other.sp.multi_scorers;
                  break;
                } else if (mercatoKey === 'gls' && other.sp.goalscorers && Array.isArray(other.sp.goalscorers)) {
                  mercatoData = other.sp.goalscorers;
                  break;
                } else if (other.sp[mercatoKey] && Array.isArray(other.sp[mercatoKey])) {
                  mercatoData = other.sp[mercatoKey];
                  break;
                }
              }
            }
          }
          
          // Se √® "score" e non trovato, cerca anche in soa da quote
          if (mercatoKey === 'score' && (!mercatoData || !Array.isArray(mercatoData) || mercatoData.length === 0)) {
            let soaData = null;
            if (partita.quote && partita.quote.soa && Array.isArray(partita.quote.soa)) {
              soaData = partita.quote.soa;
            } else if (partita.quote && partita.quote.others && Array.isArray(partita.quote.others)) {
              for (let other of partita.quote.others) {
                if (other && other.sp && other.sp.soa && Array.isArray(other.sp.soa)) {
                  soaData = other.sp.soa;
                  break;
                }
              }
            }
            if (soaData) {
              mercatoData = soaData.filter(player => {
                const header = (player.header || '').trim();
                return header === 'Score';
              });
            }
          }
        }
        
        // Per "score", mostra sempre il mercato anche se vuoto
        if (mercatoKey === 'score') {
          // Se non ci sono dati, crea un array vuoto per permettere il rendering
          if (!mercatoData || !Array.isArray(mercatoData)) {
            mercatoData = [];
          }
        } else if (!mercatoData || !Array.isArray(mercatoData) || mercatoData.length === 0) {
          return '';
        }
        
        // Filtra solo i players della squadra selezionata
        // Per mgs, potrebbe non esserci il campo team/name2, quindi mostra tutti i players
        let teamPlayers;
        if (mercatoKey === 'mgs') {
          // Per mgs, mostra tutti i players (il filtro per squadra verr√† fatto dopo se necessario)
          teamPlayers = mercatoData;
        } else {
          // Per gls, score e altri mercati, filtra per squadra
          // Per "score" da soa, usa name2 (che √® "1" o "2") invece di team (che pu√≤ essere "Player/Last 5")
          teamPlayers = mercatoData.filter(player => {
            // Per "score", priorit√† a name2 perch√© team pu√≤ essere "Player/Last 5"
            const playerTeam = (mercatoKey === 'score' && player.name2) ? player.name2 : (player.team || player.name2);
            // Se non c'√® team/name2, mostra il player (potrebbe essere da quote)
            if (!playerTeam) {
              return true;
            }
            // Confronta come stringa per gestire sia "1"/"2" che numeri
            return String(playerTeam) === String(teamNumber);
          });
        }
        
        // Per "score", mostra sempre anche se vuoto
        if (mercatoKey !== 'score' && teamPlayers.length === 0) {
          return '';
        }
        
        // ID univoco per questo mercato
        const mercatoId = `mercato-${mercatoKey}-team-${teamNumber}`;
        
        // Gestione speciale per mercati 1X2
        if (mercatoKey === 'anytime_1x2' || mercatoKey === 'first_1x2') {
          // Raggruppa per giocatore
          const playersByName = {};
          teamPlayers.forEach(player => {
            const playerName = (player.name || '').trim();
            if (!playerName || playerName.toLowerCase().includes('no goalscorer')) {
              return;
            }
            if (!playersByName[playerName]) {
              playersByName[playerName] = { '1': null, 'X': null, '2': null };
            }
            // Il header √® formato come "anytime_1", "anytime_X", "anytime_2", "first_1", "first_X", "first_2"
            const header = (player.header || '').trim().toLowerCase();
            // Estrai il risultato dal header (ultimo carattere dopo l'underscore o ultimo carattere)
            let result = null;
            if (header.includes('_')) {
              const parts = header.split('_');
              result = parts[parts.length - 1]; // Prendi l'ultima parte dopo l'underscore
            } else if (header.length > 0) {
              result = header[header.length - 1]; // Prendi l'ultimo carattere
            }
            
            // Normalizza il risultato (pu√≤ essere "1", "x", "2")
            if (result === '1' || result === 'x' || result === '2') {
              const normalizedResult = result.toUpperCase() === 'X' ? 'X' : result;
              playersByName[playerName][normalizedResult] = player;
            }
          });
          
          let html = `
            <div class="mb-2 border border-gray-600 rounded">
              <button class="mercato-toggle-btn w-full flex items-center justify-between px-3 py-2 bg-gray-700 hover:bg-gray-600 text-white font-bold text-sm transition-colors" data-mercato-id="${mercatoId}">
                <span>${mercatoNome}</span>
                <span class="toggle-icon">‚ñ∂</span>
              </button>
              <div id="${mercatoId}" class="hidden p-2 bg-gray-800">
                <div class="overflow-x-auto">
                  <table class="w-full border-collapse">
                    <thead>
                      <tr class="bg-gray-900">
                        <th class="text-left text-white text-xs font-bold px-2 py-2 border-b border-gray-600">Giocatore</th>
                        <th class="text-center text-white text-xs font-bold px-2 py-2 border-b border-gray-600 w-20">1</th>
                        <th class="text-center text-white text-xs font-bold px-2 py-2 border-b border-gray-600 w-20">X</th>
                        <th class="text-center text-white text-xs font-bold px-2 py-2 border-b border-gray-600 w-20">2</th>
                      </tr>
                    </thead>
                    <tbody>`;
          
          Object.keys(playersByName).sort().forEach(playerName => {
            const playerData = playersByName[playerName];
            html += `<tr class="hover:bg-gray-700">`;
            
            // Nome giocatore
            html += `<td class="text-white text-xs sm:text-sm px-2 py-2 border-b border-gray-700 truncate">${playerName}</td>`;
            
            // Quote 1, X, 2 in colonne
            ['1', 'X', '2'].forEach(result => {
              const player = playerData[result];
              html += `<td class="text-center px-2 py-2 border-b border-gray-700">`;
              
              if (player) {
                const playerOdds = getOddsValue(player.odds);
                const quotaNum = parseFloat(playerOdds);
                const quotaFormattata = quotaNum > 1 && !isNaN(quotaNum) ? formattaQuota(playerOdds) : '-';
                const isSelected = selections.some(s => s.id == matchId && s.categoria === 'Goalscorer' && s.segno === `${playerName} ${result}`);
                const evento = `${homeName} - ${awayName}`;
                
                html += `
                  <button class="quote-btn w-full bg-gray-900 hover:bg-yellow-500 hover:text-black text-white px-2 py-1 rounded text-xs font-bold ${isSelected ? 'bg-yellow-500 text-black' : ''} ${quotaNum <= 1 || isNaN(quotaNum) ? 'opacity-60 cursor-not-allowed' : 'cursor-pointer'}" 
                          data-match-id="${matchId}" 
                          data-categoria="Goalscorer" 
                          data-segno="${playerName.replace(/"/g, '&quot;')} ${result}" 
                          data-quota="${playerOdds}" 
                          data-evento="${evento.replace(/"/g, '&quot;')}"
                          ${quotaNum <= 1 || isNaN(quotaNum) ? 'disabled' : ''}>
                    ${quotaFormattata}
                  </button>`;
              } else {
                html += `<button class="w-full bg-gray-900 text-gray-500 px-2 py-1 rounded text-xs font-bold cursor-not-allowed" disabled>-</button>`;
              }
              
              html += `</td>`;
            });
            
            html += `</tr>`;
          });
          
          html += `
                    </tbody>
                  </table>
                </div>
              </div>
            </div>`;
          return html;
        }
        
        // Gestione speciale per mercato score (Segna) - mostra sempre, anche se vuoto
        if (mercatoKey === 'score') {
          let html = `
            <div class="mb-2 border border-gray-600 rounded">
              <button class="mercato-toggle-btn w-full flex items-center justify-between px-3 py-2 bg-gray-700 hover:bg-gray-600 text-white font-bold text-sm transition-colors" data-mercato-id="${mercatoId}">
                <span>${mercatoNome}</span>
                <span class="toggle-icon">‚ñ∂</span>
              </button>
              <div id="${mercatoId}" class="hidden p-2 bg-gray-800">`;
          
          if (teamPlayers.length === 0) {
            html += `<div class="text-gray-400 text-center py-4 text-sm">Nessun dato disponibile</div>`;
          } else {
            html += `
                <div class="overflow-x-auto">
                  <table class="w-full border-collapse">
                    <thead>
                      <tr class="bg-gray-900">
                        <th class="text-left text-white text-xs font-bold px-2 py-2 border-b border-gray-600">Giocatore</th>
                        <th class="text-center text-white text-xs font-bold px-2 py-2 border-b border-gray-600 w-24">Quota</th>
                      </tr>
                    </thead>
                    <tbody>`;
            
            // Ordina i players per quota
            const sortedPlayers = [...teamPlayers].sort((a, b) => {
              const oddsA = parseFloat(getOddsValue(a.odds) || '999');
              const oddsB = parseFloat(getOddsValue(b.odds) || '999');
              return oddsA - oddsB;
            });
            
            sortedPlayers.forEach(player => {
              const playerName = (player.name || '').trim();
              if (!playerName || playerName.toLowerCase().includes('no goalscorer')) {
                return;
              }
              
              const playerOdds = getOddsValue(player.odds);
              const quotaNum = parseFloat(playerOdds);
              const quotaFormattata = quotaNum > 1 && !isNaN(quotaNum) ? formattaQuota(playerOdds) : '-';
              const isSelected = selections.some(s => s.id == matchId && s.categoria === 'Goalscorer' && s.segno === `${playerName} ${mercatoNome}`);
              const evento = `${homeName} - ${awayName}`;
              
              html += `
                <tr class="hover:bg-gray-700">
                  <td class="text-white text-xs sm:text-sm px-2 py-2 border-b border-gray-700 truncate">${playerName}</td>
                  <td class="text-center px-2 py-2 border-b border-gray-700">
                    <button class="quote-btn w-full bg-gray-900 hover:bg-yellow-500 hover:text-black text-white px-2 py-1 rounded text-xs font-bold ${isSelected ? 'bg-yellow-500 text-black' : ''} ${quotaNum <= 1 || isNaN(quotaNum) ? 'opacity-60 cursor-not-allowed' : 'cursor-pointer'}" 
                            data-match-id="${matchId}" 
                            data-categoria="Goalscorer" 
                            data-segno="${playerName.replace(/"/g, '&quot;')} ${mercatoNome}" 
                            data-quota="${playerOdds}" 
                            data-evento="${evento.replace(/"/g, '&quot;')}"
                            ${quotaNum <= 1 || isNaN(quotaNum) ? 'disabled' : ''}>
                      ${quotaFormattata}
                    </button>
                  </td>
                </tr>`;
            });
            
            html += `
                      </tbody>
                    </table>
                  </div>`;
          }
          
          html += `
              </div>
            </div>`;
          
          return html;
        }
        
        // Gestione speciale per mercato soa (Score or Assist) - senza "Score"
        if (mercatoKey === 'soa') {
          // Raggruppa per header speciali (escludendo "Score")
          const specialHeaders = {
            'Assist': 'Assist',
            'To Score or Assist': 'Segna o Assist',
            'AssistDuo': 'Assist Duo',
            'ToScoreandAssist': 'Segna e Assist'
          };
          
          const specialPlayers = {};
          const normalPlayers = [];
          
          teamPlayers.forEach(player => {
            const header = (player.header || '').trim();
            // Escludi "Score" da soa
            if (header === 'Score') {
              return; // Salta i players con header "Score"
            }
            
            // Cerca match esatto o parziale negli header speciali
            let matchedHeader = null;
            if (specialHeaders[header]) {
              matchedHeader = header;
            } else {
              // Cerca match parziale, dando priorit√† ai match pi√π specifici (pi√π lunghi)
              const headerLower = header.toLowerCase();
              const sortedKeys = Object.keys(specialHeaders).sort((a, b) => b.length - a.length);
              for (let key of sortedKeys) {
                const keyLower = key.toLowerCase();
                if (headerLower === keyLower || headerLower.includes(keyLower) || keyLower.includes(headerLower)) {
                  matchedHeader = key;
                  break;
                }
              }
            }
            
            if (matchedHeader) {
              if (!specialPlayers[matchedHeader]) {
                specialPlayers[matchedHeader] = [];
              }
              specialPlayers[matchedHeader].push(player);
            } else {
              normalPlayers.push(player);
            }
          });
          
          let html = '';
          
          // Crea tabelle separate per tutti gli header speciali (senza "Score")
          const headerOrder = ['Assist', 'To Score or Assist', 'AssistDuo', 'ToScoreandAssist'];
          headerOrder.forEach(headerKey => {
            if (specialPlayers[headerKey] && specialPlayers[headerKey].length > 0) {
              const subMercatoId = `${mercatoId}-${headerKey.replace(/\s+/g, '-')}`;
              const subMercatoNome = specialHeaders[headerKey];
              
              html += `
                <div class="mb-2 border border-gray-600 rounded">
                  <button class="mercato-toggle-btn w-full flex items-center justify-between px-3 py-2 bg-gray-700 hover:bg-gray-600 text-white font-bold text-sm transition-colors" data-mercato-id="${subMercatoId}">
                    <span>${subMercatoNome}</span>
                    <span class="toggle-icon">‚ñ∂</span>
                  </button>
                  <div id="${subMercatoId}" class="hidden p-2 bg-gray-800">
                    <div class="overflow-x-auto">
                      <table class="w-full border-collapse">
                        <thead>
                          <tr class="bg-gray-900">
                            <th class="text-left text-white text-xs font-bold px-2 py-2 border-b border-gray-600">Giocatore</th>
                            <th class="text-center text-white text-xs font-bold px-2 py-2 border-b border-gray-600 w-24">Quota</th>
                          </tr>
                        </thead>
                        <tbody>`;
              
              // Ordina i players per quota
              const sortedPlayers = [...specialPlayers[headerKey]].sort((a, b) => {
                const oddsA = parseFloat(getOddsValue(a.odds) || '999');
                const oddsB = parseFloat(getOddsValue(b.odds) || '999');
                return oddsA - oddsB;
              });
              
              sortedPlayers.forEach(player => {
                const playerName = (player.name || '').trim();
                if (!playerName || playerName.toLowerCase().includes('no goalscorer')) {
                  return;
                }
                
                const playerOdds = getOddsValue(player.odds);
                const quotaNum = parseFloat(playerOdds);
                const quotaFormattata = quotaNum > 1 && !isNaN(quotaNum) ? formattaQuota(playerOdds) : '-';
                const isSelected = selections.some(s => s.id == matchId && s.categoria === 'Goalscorer' && s.segno === `${playerName} ${subMercatoNome}`);
                const evento = `${homeName} - ${awayName}`;
                
                html += `
                  <tr class="hover:bg-gray-700">
                    <td class="text-white text-xs sm:text-sm px-2 py-2 border-b border-gray-700 truncate">${playerName}</td>
                    <td class="text-center px-2 py-2 border-b border-gray-700">
                      <button class="quote-btn w-full bg-gray-900 hover:bg-yellow-500 hover:text-black text-white px-2 py-1 rounded text-xs font-bold ${isSelected ? 'bg-yellow-500 text-black' : ''} ${quotaNum <= 1 || isNaN(quotaNum) ? 'opacity-60 cursor-not-allowed' : 'cursor-pointer'}" 
                              data-match-id="${matchId}" 
                              data-categoria="Goalscorer" 
                              data-segno="${playerName.replace(/"/g, '&quot;')} ${subMercatoNome}" 
                              data-quota="${playerOdds}" 
                              data-evento="${evento.replace(/"/g, '&quot;')}"
                              ${quotaNum <= 1 || isNaN(quotaNum) ? 'disabled' : ''}>
                        ${quotaFormattata}
                      </button>
                    </td>
                  </tr>`;
              });
              
              html += `
                        </tbody>
                      </table>
                    </div>
                  </div>
                </div>`;
            }
          });
          
          // Gestione standard per gli altri header (se presenti)
          if (normalPlayers.length > 0) {
            const playersByHeader = {};
            normalPlayers.forEach(player => {
              const header = (player.header || 'Other').trim();
              if (!playersByHeader[header]) {
                playersByHeader[header] = [];
              }
              playersByHeader[header].push(player);
            });
            
            Object.keys(playersByHeader).forEach(header => {
              html += `<div class="text-gray-300 text-xs font-semibold px-2 py-1 mt-1 mb-1">${header}</div>`;
              
              const sortedPlayers = [...playersByHeader[header]].sort((a, b) => {
                const oddsA = parseFloat(getOddsValue(a.odds) || '999');
                const oddsB = parseFloat(getOddsValue(b.odds) || '999');
                return oddsA - oddsB;
              });
              
              sortedPlayers.forEach(player => {
                const playerName = (player.name || '').trim();
                if (!playerName || playerName.toLowerCase().includes('no goalscorer')) {
                  return;
                }
                
                const playerOdds = getOddsValue(player.odds);
                const quotaNum = parseFloat(playerOdds);
                const quotaFormattata = quotaNum > 1 && !isNaN(quotaNum) ? formattaQuota(playerOdds) : '-';
                const isSelected = selections.some(s => s.id == matchId && s.categoria === 'Goalscorer' && s.segno === `${playerName} ${header}`);
                const evento = `${homeName} - ${awayName}`;
                
                html += `
                  <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between py-1 px-2 hover:bg-gray-700 rounded gap-1 sm:gap-0">
                    <span class="text-white text-xs sm:text-sm truncate">${playerName}</span>
                    <button class="quote-btn bg-gray-900 hover:bg-yellow-500 hover:text-black text-white px-3 sm:px-4 py-1 rounded text-xs sm:text-sm font-bold min-w-[60px] w-full sm:w-auto text-center ${isSelected ? 'bg-yellow-500 text-black' : ''} ${quotaNum <= 1 || isNaN(quotaNum) ? 'opacity-60 cursor-not-allowed' : 'cursor-pointer'}" 
                            data-match-id="${matchId}" 
                            data-categoria="Goalscorer" 
                            data-segno="${playerName.replace(/"/g, '&quot;')} ${header}" 
                            data-quota="${playerOdds}" 
                            data-evento="${evento.replace(/"/g, '&quot;')}"
                            ${quotaNum <= 1 || isNaN(quotaNum) ? 'disabled' : ''}>
                      ${quotaFormattata}
                    </button>
                  </div>`;
              });
            });
          }
          
          return html;
        }
        
        // Gestione speciale per mercati risultati esatti
        if (mercatoKey === 'anytime_cs' || mercatoKey === 'first_cs_mix') {
          // Raggruppa per giocatore
          const playersByName = {};
          teamPlayers.forEach(player => {
            const playerName = (player.name || '').trim();
            if (!playerName || playerName.toLowerCase().includes('no goalscorer')) {
              return;
            }
            if (!playersByName[playerName]) {
              playersByName[playerName] = [];
            }
            playersByName[playerName].push(player);
          });
          
          let html = `
            <div class="mb-2 border border-gray-600 rounded">
              <button class="mercato-toggle-btn w-full flex items-center justify-between px-3 py-2 bg-gray-700 hover:bg-gray-600 text-white font-bold text-sm transition-colors" data-mercato-id="${mercatoId}">
                <span>${mercatoNome}</span>
                <span class="toggle-icon">‚ñ∂</span>
              </button>
              <div id="${mercatoId}" class="hidden p-2 bg-gray-800">
                <div class="space-y-1">`;
          
          Object.keys(playersByName).sort().forEach(playerName => {
            const playerOptions = playersByName[playerName];
            // Estrai i risultati esatti (dal header o name)
            const risultati = [];
            playerOptions.forEach(player => {
              const risultato = (player.header || player.name || '').trim();
              if (risultato && risultato !== playerName && !risultati.includes(risultato)) {
                risultati.push(risultato);
              }
            });
            
            if (risultati.length === 0) {
              return;
            }
            
            html += `
              <div class="flex items-center gap-2 py-1 px-2 hover:bg-gray-700 rounded">
                <span class="text-white text-xs sm:text-sm flex-1 truncate">${playerName}</span>
                <select class="quote-select bg-gray-900 text-white px-2 py-1 rounded text-xs font-bold border border-gray-600 hover:bg-gray-700" 
                        data-match-id="${matchId}" 
                        data-categoria="Goalscorer" 
                        data-player-name="${playerName.replace(/"/g, '&quot;')}"
                        data-evento="${(homeName + ' - ' + awayName).replace(/"/g, '&quot;')}">
                  <option value="">Seleziona risultato</option>`;
            
            risultati.forEach(risultato => {
              // Trova la quota per questo risultato
              const playerWithResult = playerOptions.find(p => (p.header || p.name || '').trim() === risultato);
              if (playerWithResult) {
                const playerOdds = getOddsValue(playerWithResult.odds);
                const quotaNum = parseFloat(playerOdds);
                const quotaFormattata = quotaNum > 1 && !isNaN(quotaNum) ? formattaQuota(playerOdds) : '-';
                const isSelected = selections.some(s => s.id == matchId && s.categoria === 'Goalscorer' && s.segno === `${playerName} ${risultato}`);
                
                html += `<option value="${risultato.replace(/"/g, '&quot;')}" data-quota="${playerOdds}" ${isSelected ? 'selected' : ''}>${risultato} (${quotaFormattata})</option>`;
              }
            });
            
            html += `
                </select>
              </div>`;
          });
          
          html += `
                </div>
              </div>
            </div>`;
          return html;
        }
        
        // Gestione speciale per mercato mgs (Multiple Goalscorer) con 2 or More, 3 or More
        if (mercatoKey === 'mgs') {
          const specialPlayers = {};
          const normalPlayers = [];
          
          teamPlayers.forEach(player => {
            const header = (player.header || '').trim();
            // Normalizza l'header per il matching (rimuovi spazi extra, normalizza case)
            const headerLower = header.toLowerCase();
            
            // Cerca match per "2 or More" o "3 or More" (pi√π flessibile)
            let normalizedKey = null;
            if (headerLower.includes('2') && (headerLower.includes('more') || headerLower.includes('or'))) {
              normalizedKey = '2 or More';
            } else if (headerLower.includes('3') && (headerLower.includes('more') || headerLower.includes('or'))) {
              normalizedKey = '3 or More';
            }
            
            if (normalizedKey) {
              if (!specialPlayers[normalizedKey]) {
                specialPlayers[normalizedKey] = [];
              }
              specialPlayers[normalizedKey].push(player);
            } else {
              normalPlayers.push(player);
            }
          });
          
          let html = '';
          
          // Crea tabelle separate per Doppietta e Tripletta
          const headerMapping = {
            '2 or More': 'Doppietta',
            '3 or More': 'Tripletta'
          };
          
          Object.keys(headerMapping).forEach(headerKey => {
            if (specialPlayers[headerKey] && specialPlayers[headerKey].length > 0) {
              const subMercatoId = `${mercatoId}-${headerKey.replace(/\s+/g, '-')}`;
              const subMercatoNome = headerMapping[headerKey];
              
              html += `
                <div class="mb-2 border border-gray-600 rounded">
                  <button class="mercato-toggle-btn w-full flex items-center justify-between px-3 py-2 bg-gray-700 hover:bg-gray-600 text-white font-bold text-sm transition-colors" data-mercato-id="${subMercatoId}">
                    <span>${subMercatoNome}</span>
                    <span class="toggle-icon">‚ñ∂</span>
                  </button>
                  <div id="${subMercatoId}" class="hidden p-2 bg-gray-800">
                    <div class="overflow-x-auto">
                      <table class="w-full border-collapse">
                        <thead>
                          <tr class="bg-gray-900">
                            <th class="text-left text-white text-xs font-bold px-2 py-2 border-b border-gray-600">Giocatore</th>
                            <th class="text-center text-white text-xs font-bold px-2 py-2 border-b border-gray-600 w-24">Quota</th>
                          </tr>
                        </thead>
                        <tbody>`;
              
              // Ordina i players per quota
              const sortedPlayers = [...specialPlayers[headerKey]].sort((a, b) => {
                const oddsA = parseFloat(getOddsValue(a.odds) || '999');
                const oddsB = parseFloat(getOddsValue(b.odds) || '999');
                return oddsA - oddsB;
              });
              
              sortedPlayers.forEach(player => {
                const playerName = (player.name || '').trim();
                if (!playerName || playerName.toLowerCase().includes('no goalscorer')) {
                  return;
                }
                
                const playerOdds = getOddsValue(player.odds);
                const quotaNum = parseFloat(playerOdds);
                const quotaFormattata = quotaNum > 1 && !isNaN(quotaNum) ? formattaQuota(playerOdds) : '-';
                const isSelected = selections.some(s => s.id == matchId && s.categoria === 'Goalscorer' && s.segno === `${playerName} ${subMercatoNome}`);
                const evento = `${homeName} - ${awayName}`;
                
                html += `
                  <tr class="hover:bg-gray-700">
                    <td class="text-white text-xs sm:text-sm px-2 py-2 border-b border-gray-700 truncate">${playerName}</td>
                    <td class="text-center px-2 py-2 border-b border-gray-700">
                      <button class="quote-btn w-full bg-gray-900 hover:bg-yellow-500 hover:text-black text-white px-2 py-1 rounded text-xs font-bold ${isSelected ? 'bg-yellow-500 text-black' : ''} ${quotaNum <= 1 || isNaN(quotaNum) ? 'opacity-60 cursor-not-allowed' : 'cursor-pointer'}" 
                              data-match-id="${matchId}" 
                              data-categoria="Goalscorer" 
                              data-segno="${playerName.replace(/"/g, '&quot;')} ${subMercatoNome}" 
                              data-quota="${playerOdds}" 
                              data-evento="${evento.replace(/"/g, '&quot;')}"
                              ${quotaNum <= 1 || isNaN(quotaNum) ? 'disabled' : ''}>
                        ${quotaFormattata}
                      </button>
                    </td>
                  </tr>`;
              });
              
              html += `
                        </tbody>
                      </table>
                    </div>
                  </div>
                </div>`;
            }
          });
          
          // Se non ci sono dati speciali ma ci sono dati nel mercato mgs, mostra comunque il mercato con tutti i dati
          // Questo serve per mostrare "2 or More" e "3 or More" anche se non vengono riconosciuti correttamente
          if (Object.keys(specialPlayers).length === 0 && teamPlayers.length > 0) {
            // Mostra tutti i dati come tabelle separate per ogni header
            const playersByHeader = {};
            teamPlayers.forEach(player => {
              const header = (player.header || 'Other').trim();
              if (!playersByHeader[header]) {
                playersByHeader[header] = [];
              }
              playersByHeader[header].push(player);
            });
            
            // Per mgs, mostra ogni header come tabella separata
            Object.keys(playersByHeader).forEach(header => {
              const headerId = `${mercatoId}-${header.replace(/\s+/g, '-')}`;
              const headerNome = header === '2 or More' ? 'Doppietta' : (header === '3 or More' ? 'Tripletta' : header);
              
              html += `
                <div class="mb-2 border border-gray-600 rounded">
                  <button class="mercato-toggle-btn w-full flex items-center justify-between px-3 py-2 bg-gray-700 hover:bg-gray-600 text-white font-bold text-sm transition-colors" data-mercato-id="${headerId}">
                    <span>${headerNome}</span>
                    <span class="toggle-icon">‚ñ∂</span>
                  </button>
                  <div id="${headerId}" class="hidden p-2 bg-gray-800">
                    <div class="overflow-x-auto">
                      <table class="w-full border-collapse">
                        <thead>
                          <tr class="bg-gray-900">
                            <th class="text-left text-white text-xs font-bold px-2 py-2 border-b border-gray-600">Giocatore</th>
                            <th class="text-center text-white text-xs font-bold px-2 py-2 border-b border-gray-600 w-24">Quota</th>
                          </tr>
                        </thead>
                        <tbody>`;
              
              const sortedPlayers = [...playersByHeader[header]].sort((a, b) => {
                const oddsA = parseFloat(getOddsValue(a.odds) || '999');
                const oddsB = parseFloat(getOddsValue(b.odds) || '999');
                return oddsA - oddsB;
              });
              
              sortedPlayers.forEach(player => {
                const playerName = (player.name || '').trim();
                if (!playerName || playerName.toLowerCase().includes('no goalscorer')) {
                  return;
                }
                
                const playerOdds = getOddsValue(player.odds);
                const quotaNum = parseFloat(playerOdds);
                const quotaFormattata = quotaNum > 1 && !isNaN(quotaNum) ? formattaQuota(playerOdds) : '-';
                const isSelected = selections.some(s => s.id == matchId && s.categoria === 'Goalscorer' && s.segno === `${playerName} ${headerNome}`);
                const evento = `${homeName} - ${awayName}`;
                
                html += `
                  <tr class="hover:bg-gray-700">
                    <td class="text-white text-xs sm:text-sm px-2 py-2 border-b border-gray-700 truncate">${playerName}</td>
                    <td class="text-center px-2 py-2 border-b border-gray-700">
                      <button class="quote-btn w-full bg-gray-900 hover:bg-yellow-500 hover:text-black text-white px-2 py-1 rounded text-xs font-bold ${isSelected ? 'bg-yellow-500 text-black' : ''} ${quotaNum <= 1 || isNaN(quotaNum) ? 'opacity-60 cursor-not-allowed' : 'cursor-pointer'}" 
                              data-match-id="${matchId}" 
                              data-categoria="Goalscorer" 
                              data-segno="${playerName.replace(/"/g, '&quot;')} ${headerNome}" 
                              data-quota="${playerOdds}" 
                              data-evento="${evento.replace(/"/g, '&quot;')}"
                              ${quotaNum <= 1 || isNaN(quotaNum) ? 'disabled' : ''}>
                        ${quotaFormattata}
                      </button>
                    </td>
                  </tr>`;
              });
              
              html += `
                        </tbody>
                      </table>
                    </div>
                  </div>
                </div>`;
            });
          }
          
          // Gestione standard per gli altri header (se presenti)
          if (normalPlayers.length > 0) {
            const playersByHeader = {};
            normalPlayers.forEach(player => {
              const header = (player.header || 'Other').trim();
              if (!playersByHeader[header]) {
                playersByHeader[header] = [];
              }
              playersByHeader[header].push(player);
            });
            
            html += `
              <div class="mb-2 border border-gray-600 rounded">
                <button class="mercato-toggle-btn w-full flex items-center justify-between px-3 py-2 bg-gray-700 hover:bg-gray-600 text-white font-bold text-sm transition-colors" data-mercato-id="${mercatoId}">
                  <span>${mercatoNome}</span>
                  <span class="toggle-icon">‚ñ∂</span>
                </button>
                <div id="${mercatoId}" class="hidden p-2 bg-gray-800">`;
            
            Object.keys(playersByHeader).forEach(header => {
              html += `<div class="text-gray-300 text-xs font-semibold px-2 py-1 mt-1 mb-1">${header}</div>`;
              
              const sortedPlayers = [...playersByHeader[header]].sort((a, b) => {
                const oddsA = parseFloat(getOddsValue(a.odds) || '999');
                const oddsB = parseFloat(getOddsValue(b.odds) || '999');
                return oddsA - oddsB;
              });
              
              sortedPlayers.forEach(player => {
                const playerName = (player.name || '').trim();
                if (!playerName || playerName.toLowerCase().includes('no goalscorer')) {
                  return;
                }
                
                const playerOdds = getOddsValue(player.odds);
                const quotaNum = parseFloat(playerOdds);
                const quotaFormattata = quotaNum > 1 && !isNaN(quotaNum) ? formattaQuota(playerOdds) : '-';
                const isSelected = selections.some(s => s.id == matchId && s.categoria === 'Goalscorer' && s.segno === playerName);
                const evento = `${homeName} - ${awayName}`;
                
                html += `
                  <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between py-1 px-2 hover:bg-gray-700 rounded gap-1 sm:gap-0">
                    <span class="text-white text-xs sm:text-sm truncate">${playerName}</span>
                    <button class="quote-btn bg-gray-900 hover:bg-yellow-500 hover:text-black text-white px-3 sm:px-4 py-1 rounded text-xs sm:text-sm font-bold min-w-[60px] w-full sm:w-auto text-center ${isSelected ? 'bg-yellow-500 text-black' : ''} ${quotaNum <= 1 || isNaN(quotaNum) ? 'opacity-60 cursor-not-allowed' : 'cursor-pointer'}" 
                            data-match-id="${matchId}" 
                            data-categoria="Goalscorer" 
                            data-segno="${playerName.replace(/"/g, '&quot;')}" 
                            data-quota="${playerOdds}" 
                            data-evento="${evento.replace(/"/g, '&quot;')}"
                            ${quotaNum <= 1 || isNaN(quotaNum) ? 'disabled' : ''}>
                      ${quotaFormattata}
                    </button>
                  </div>`;
              });
            });
            
            html += `
                </div>
              </div>`;
          }
          
          return html;
        }
        
        // Gestione speciale per mercato gls_method (Goalscorer Method)
        if (mercatoKey === 'gls_method') {
          // Raggruppa per header speciali
          const specialHeaders = {
            'Header': 'Di Testa',
            'Outside the Box': 'Fuori Area'
          };
          
          const specialPlayers = {};
          const normalPlayers = [];
          
          teamPlayers.forEach(player => {
            const header = (player.header || '').trim();
            // Cerca match esatto o parziale negli header speciali
            let matchedHeader = null;
            if (specialHeaders[header]) {
              matchedHeader = header;
            } else {
              // Cerca match parziale
              const headerLower = header.toLowerCase();
              const sortedKeys = Object.keys(specialHeaders).sort((a, b) => b.length - a.length);
              for (let key of sortedKeys) {
                const keyLower = key.toLowerCase();
                if (headerLower === keyLower || headerLower.includes(keyLower) || keyLower.includes(headerLower)) {
                  matchedHeader = key;
                  break;
                }
              }
            }
            
            if (matchedHeader) {
              if (!specialPlayers[matchedHeader]) {
                specialPlayers[matchedHeader] = [];
              }
              specialPlayers[matchedHeader].push(player);
            } else {
              normalPlayers.push(player);
            }
          });
          
          let html = '';
          
          // Crea tabelle separate per tutti gli header speciali
          Object.keys(specialHeaders).forEach(headerKey => {
            if (specialPlayers[headerKey] && specialPlayers[headerKey].length > 0) {
              const subMercatoId = `${mercatoId}-${headerKey.replace(/\s+/g, '-')}`;
              const subMercatoNome = specialHeaders[headerKey];
              
              html += `
                <div class="mb-2 border border-gray-600 rounded">
                  <button class="mercato-toggle-btn w-full flex items-center justify-between px-3 py-2 bg-gray-700 hover:bg-gray-600 text-white font-bold text-sm transition-colors" data-mercato-id="${subMercatoId}">
                    <span>${subMercatoNome}</span>
                    <span class="toggle-icon">‚ñ∂</span>
                  </button>
                  <div id="${subMercatoId}" class="hidden p-2 bg-gray-800">
                    <div class="overflow-x-auto">
                      <table class="w-full border-collapse">
                        <thead>
                          <tr class="bg-gray-900">
                            <th class="text-left text-white text-xs font-bold px-2 py-2 border-b border-gray-600">Giocatore</th>
                            <th class="text-center text-white text-xs font-bold px-2 py-2 border-b border-gray-600 w-24">Quota</th>
                          </tr>
                        </thead>
                        <tbody>`;
              
              // Ordina i players per quota
              const sortedPlayers = [...specialPlayers[headerKey]].sort((a, b) => {
                const oddsA = parseFloat(getOddsValue(a.odds) || '999');
                const oddsB = parseFloat(getOddsValue(b.odds) || '999');
                return oddsA - oddsB;
              });
              
              sortedPlayers.forEach(player => {
                const playerName = (player.name || '').trim();
                if (!playerName || playerName.toLowerCase().includes('no goalscorer')) {
                  return;
                }
                
                const playerOdds = getOddsValue(player.odds);
                const quotaNum = parseFloat(playerOdds);
                const quotaFormattata = quotaNum > 1 && !isNaN(quotaNum) ? formattaQuota(playerOdds) : '-';
                const isSelected = selections.some(s => s.id == matchId && s.categoria === 'Goalscorer' && s.segno === `${playerName} ${subMercatoNome}`);
                const evento = `${homeName} - ${awayName}`;
                
                html += `
                  <tr class="hover:bg-gray-700">
                    <td class="text-white text-xs sm:text-sm px-2 py-2 border-b border-gray-700 truncate">${playerName}</td>
                    <td class="text-center px-2 py-2 border-b border-gray-700">
                      <button class="quote-btn w-full bg-gray-900 hover:bg-yellow-500 hover:text-black text-white px-2 py-1 rounded text-xs font-bold ${isSelected ? 'bg-yellow-500 text-black' : ''} ${quotaNum <= 1 || isNaN(quotaNum) ? 'opacity-60 cursor-not-allowed' : 'cursor-pointer'}" 
                              data-match-id="${matchId}" 
                              data-categoria="Goalscorer" 
                              data-segno="${playerName.replace(/"/g, '&quot;')} ${subMercatoNome}" 
                              data-quota="${playerOdds}" 
                              data-evento="${evento.replace(/"/g, '&quot;')}"
                              ${quotaNum <= 1 || isNaN(quotaNum) ? 'disabled' : ''}>
                        ${quotaFormattata}
                      </button>
                    </td>
                  </tr>`;
              });
              
              html += `
                        </tbody>
                      </table>
                    </div>
                  </div>
                </div>`;
            }
          });
          
          // Gestione standard per gli altri header (se presenti)
          if (normalPlayers.length > 0) {
            const playersByHeader = {};
            normalPlayers.forEach(player => {
              const header = (player.header || 'Other').trim();
              if (!playersByHeader[header]) {
                playersByHeader[header] = [];
              }
              playersByHeader[header].push(player);
            });
            
            Object.keys(playersByHeader).forEach(header => {
              html += `<div class="text-gray-300 text-xs font-semibold px-2 py-1 mt-1 mb-1">${header}</div>`;
              
              const sortedPlayers = [...playersByHeader[header]].sort((a, b) => {
                const oddsA = parseFloat(getOddsValue(a.odds) || '999');
                const oddsB = parseFloat(getOddsValue(b.odds) || '999');
                return oddsA - oddsB;
              });
              
              sortedPlayers.forEach(player => {
                const playerName = (player.name || '').trim();
                if (!playerName || playerName.toLowerCase().includes('no goalscorer')) {
                  return;
                }
                
                const playerOdds = getOddsValue(player.odds);
                const quotaNum = parseFloat(playerOdds);
                const quotaFormattata = quotaNum > 1 && !isNaN(quotaNum) ? formattaQuota(playerOdds) : '-';
                const isSelected = selections.some(s => s.id == matchId && s.categoria === 'Goalscorer' && s.segno === `${playerName} ${header}`);
                const evento = `${homeName} - ${awayName}`;
                
                html += `
                  <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between py-1 px-2 hover:bg-gray-700 rounded gap-1 sm:gap-0">
                    <span class="text-white text-xs sm:text-sm truncate">${playerName}</span>
                    <button class="quote-btn bg-gray-900 hover:bg-yellow-500 hover:text-black text-white px-3 sm:px-4 py-1 rounded text-xs sm:text-sm font-bold min-w-[60px] w-full sm:w-auto text-center ${isSelected ? 'bg-yellow-500 text-black' : ''} ${quotaNum <= 1 || isNaN(quotaNum) ? 'opacity-60 cursor-not-allowed' : 'cursor-pointer'}" 
                            data-match-id="${matchId}" 
                            data-categoria="Goalscorer" 
                            data-segno="${playerName.replace(/"/g, '&quot;')} ${header}" 
                            data-quota="${playerOdds}" 
                            data-evento="${evento.replace(/"/g, '&quot;')}"
                            ${quotaNum <= 1 || isNaN(quotaNum) ? 'disabled' : ''}>
                      ${quotaFormattata}
                    </button>
                  </div>`;
              });
            });
          }
          
          return html;
        }
        
        // Gestione speciale per mercato gls con Anytime, Anytime1T, AnytimeDuo, AnytimePlus, First, Last
        if (mercatoKey === 'gls') {
          // Raggruppa per header speciali (senza "Score" che √® un mercato separato)
          const specialHeaders = {
            'Anytime': 'Anytime',
            'Anytime1T': 'Anytime 1T',
            'AnytimeDuo': 'Anytime Duo',
            'AnytimePlus': 'Anytime Plus',
            'First': 'Primo Marcatore',
            'Last': 'Ultimo Marcatore'
          };
          
          const specialPlayers = {};
          const normalPlayers = [];
          
          teamPlayers.forEach(player => {
            const header = (player.header || '').trim();
            // Cerca match esatto o parziale negli header speciali
            let matchedHeader = null;
            if (specialHeaders[header]) {
              matchedHeader = header;
            } else {
              // Cerca match parziale, dando priorit√† ai match pi√π specifici (pi√π lunghi)
              const headerLower = header.toLowerCase();
              const sortedKeys = Object.keys(specialHeaders).sort((a, b) => b.length - a.length);
              for (let key of sortedKeys) {
                const keyLower = key.toLowerCase();
                // Match esatto (case-insensitive) o match parziale
                if (headerLower === keyLower || headerLower.includes(keyLower) || keyLower.includes(headerLower)) {
                  matchedHeader = key;
                  break;
                }
              }
            }
            
            if (matchedHeader) {
              if (!specialPlayers[matchedHeader]) {
                specialPlayers[matchedHeader] = [];
              }
              specialPlayers[matchedHeader].push(player);
            } else {
              normalPlayers.push(player);
            }
          });
          
          let html = '';
          
          // Crea tabelle separate per tutti gli header speciali
          const headerOrder = ['Anytime', 'Anytime1T', 'AnytimeDuo', 'AnytimePlus', 'First', 'Last'];
          headerOrder.forEach(headerKey => {
            if (!specialHeaders[headerKey]) return; // Skip se l'header non esiste
            if (specialPlayers[headerKey] && specialPlayers[headerKey].length > 0) {
              const subMercatoId = `${mercatoId}-${headerKey}`;
              const subMercatoNome = specialHeaders[headerKey];
              
              html += `
                <div class="mb-2 border border-gray-600 rounded">
                  <button class="mercato-toggle-btn w-full flex items-center justify-between px-3 py-2 bg-gray-700 hover:bg-gray-600 text-white font-bold text-sm transition-colors" data-mercato-id="${subMercatoId}">
                    <span>${subMercatoNome}</span>
                    <span class="toggle-icon">‚ñ∂</span>
                  </button>
                  <div id="${subMercatoId}" class="hidden p-2 bg-gray-800">
                    <div class="overflow-x-auto">
                      <table class="w-full border-collapse">
                        <thead>
                          <tr class="bg-gray-900">
                            <th class="text-left text-white text-xs font-bold px-2 py-2 border-b border-gray-600">Giocatore</th>
                            <th class="text-center text-white text-xs font-bold px-2 py-2 border-b border-gray-600 w-24">Quota</th>
                          </tr>
                        </thead>
                        <tbody>`;
              
              // Ordina i players per quota
              const sortedPlayers = [...specialPlayers[headerKey]].sort((a, b) => {
                const oddsA = parseFloat(getOddsValue(a.odds) || '999');
                const oddsB = parseFloat(getOddsValue(b.odds) || '999');
                return oddsA - oddsB;
              });
              
              sortedPlayers.forEach(player => {
                const playerName = (player.name || '').trim();
                if (!playerName || playerName.toLowerCase().includes('no goalscorer')) {
                  return;
                }
                
                const playerOdds = getOddsValue(player.odds);
                const quotaNum = parseFloat(playerOdds);
                const quotaFormattata = quotaNum > 1 && !isNaN(quotaNum) ? formattaQuota(playerOdds) : '-';
                const isSelected = selections.some(s => s.id == matchId && s.categoria === 'Goalscorer' && s.segno === `${playerName} ${subMercatoNome}`);
                const evento = `${homeName} - ${awayName}`;
                
                html += `
                  <tr class="hover:bg-gray-700">
                    <td class="text-white text-xs sm:text-sm px-2 py-2 border-b border-gray-700 truncate">${playerName}</td>
                    <td class="text-center px-2 py-2 border-b border-gray-700">
                      <button class="quote-btn w-full bg-gray-900 hover:bg-yellow-500 hover:text-black text-white px-2 py-1 rounded text-xs font-bold ${isSelected ? 'bg-yellow-500 text-black' : ''} ${quotaNum <= 1 || isNaN(quotaNum) ? 'opacity-60 cursor-not-allowed' : 'cursor-pointer'}" 
                              data-match-id="${matchId}" 
                              data-categoria="Goalscorer" 
                              data-segno="${playerName.replace(/"/g, '&quot;')} ${subMercatoNome}" 
                              data-quota="${playerOdds}" 
                              data-evento="${evento.replace(/"/g, '&quot;')}"
                              ${quotaNum <= 1 || isNaN(quotaNum) ? 'disabled' : ''}>
                        ${quotaFormattata}
                      </button>
                    </td>
                  </tr>`;
              });
              
              html += `
                        </tbody>
                      </table>
                    </div>
                  </div>
                </div>`;
            }
          });
          
          // Gestione standard per gli altri header (Anytime, First, Last, etc.)
          if (normalPlayers.length > 0) {
            const playersByHeader = {};
            normalPlayers.forEach(player => {
              const header = (player.header || 'Anytime').trim();
              if (!playersByHeader[header]) {
                playersByHeader[header] = [];
              }
              playersByHeader[header].push(player);
            });
            
            html += `
              <div class="mb-2 border border-gray-600 rounded">
                <button class="mercato-toggle-btn w-full flex items-center justify-between px-3 py-2 bg-gray-700 hover:bg-gray-600 text-white font-bold text-sm transition-colors" data-mercato-id="${mercatoId}">
                  <span>${mercatoNome}</span>
                  <span class="toggle-icon">‚ñ∂</span>
                </button>
                <div id="${mercatoId}" class="hidden p-2 bg-gray-800">`;
            
            // Ordina gli header (solo quelli non speciali, escludendo anche 2 or More e 3 or More che sono in mgs)
            const headerOrder = ['Anytime'];
            const sortedHeaders = Object.keys(playersByHeader).sort((a, b) => {
              const indexA = headerOrder.indexOf(a);
              const indexB = headerOrder.indexOf(b);
              if (indexA === -1 && indexB === -1) return a.localeCompare(b);
              if (indexA === -1) return 1;
              if (indexB === -1) return -1;
              return indexA - indexB;
            });
            
            sortedHeaders.forEach(header => {
              html += `<div class="text-gray-300 text-xs font-semibold px-2 py-1 mt-1 mb-1">${header}</div>`;
              
              // Ordina i players per quota
              const sortedPlayers = [...playersByHeader[header]].sort((a, b) => {
                const oddsA = parseFloat(getOddsValue(a.odds) || '999');
                const oddsB = parseFloat(getOddsValue(b.odds) || '999');
                return oddsA - oddsB;
              });
              
              sortedPlayers.forEach(player => {
                const playerName = (player.name || '').trim();
                if (!playerName || playerName.toLowerCase().includes('no goalscorer')) {
                  return;
                }
                
                const playerOdds = getOddsValue(player.odds);
                const quotaNum = parseFloat(playerOdds);
                const quotaFormattata = quotaNum > 1 && !isNaN(quotaNum) ? formattaQuota(playerOdds) : '-';
                const isSelected = selections.some(s => s.id == matchId && s.categoria === 'Goalscorer' && s.segno === playerName);
                const evento = `${homeName} - ${awayName}`;
                
                html += `
                  <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between py-1 px-2 hover:bg-gray-700 rounded gap-1 sm:gap-0">
                    <span class="text-white text-xs sm:text-sm truncate">${playerName}</span>
                    <button class="quote-btn bg-gray-900 hover:bg-yellow-500 hover:text-black text-white px-3 sm:px-4 py-1 rounded text-xs sm:text-sm font-bold min-w-[60px] w-full sm:w-auto text-center ${isSelected ? 'bg-yellow-500 text-black' : ''} ${quotaNum <= 1 || isNaN(quotaNum) ? 'opacity-60 cursor-not-allowed' : 'cursor-pointer'}" 
                            data-match-id="${matchId}" 
                            data-categoria="Goalscorer" 
                            data-segno="${playerName.replace(/"/g, '&quot;')}" 
                            data-quota="${playerOdds}" 
                            data-evento="${evento.replace(/"/g, '&quot;')}"
                            ${quotaNum <= 1 || isNaN(quotaNum) ? 'disabled' : ''}>
                      ${quotaFormattata}
                    </button>
                  </div>`;
              });
            });
            
            html += `
                </div>
              </div>`;
          }
          
          return html;
        }
        
        // Gestione standard per altri mercati
        // Raggruppa per header
        const playersByHeader = {};
        teamPlayers.forEach(player => {
          const header = (player.header || 'Anytime').trim();
          if (!playersByHeader[header]) {
            playersByHeader[header] = [];
          }
          playersByHeader[header].push(player);
        });
        
        let html = `
          <div class="mb-2 border border-gray-600 rounded">
            <button class="mercato-toggle-btn w-full flex items-center justify-between px-3 py-2 bg-gray-700 hover:bg-gray-600 text-white font-bold text-sm transition-colors" data-mercato-id="${mercatoId}">
              <span>${mercatoNome}</span>
              <span class="toggle-icon">‚ñ∂</span>
            </button>
            <div id="${mercatoId}" class="hidden p-2 bg-gray-800">`;
        
        // Ordina gli header
        const headerOrder = ['Anytime', 'First', 'Last', '2 or More', '3 or More'];
        const sortedHeaders = Object.keys(playersByHeader).sort((a, b) => {
          const indexA = headerOrder.indexOf(a);
          const indexB = headerOrder.indexOf(b);
          if (indexA === -1 && indexB === -1) return a.localeCompare(b);
          if (indexA === -1) return 1;
          if (indexB === -1) return -1;
          return indexA - indexB;
        });
        
        sortedHeaders.forEach(header => {
          html += `<div class="text-gray-300 text-xs font-semibold px-2 py-1 mt-1 mb-1">${header}</div>`;
          
          // Ordina i players per quota
          const sortedPlayers = [...playersByHeader[header]].sort((a, b) => {
            const oddsA = parseFloat(getOddsValue(a.odds) || '999');
            const oddsB = parseFloat(getOddsValue(b.odds) || '999');
            return oddsA - oddsB;
          });
          
          sortedPlayers.forEach(player => {
            const playerName = (player.name || '').trim();
            if (!playerName || playerName.toLowerCase().includes('no goalscorer')) {
              return;
            }
            
            const playerOdds = getOddsValue(player.odds);
            const quotaNum = parseFloat(playerOdds);
            const quotaFormattata = quotaNum > 1 && !isNaN(quotaNum) ? formattaQuota(playerOdds) : '-';
            const isSelected = selections.some(s => s.id == matchId && s.categoria === 'Goalscorer' && s.segno === playerName);
            const evento = `${homeName} - ${awayName}`;
            
            html += `
              <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between py-1 px-2 hover:bg-gray-700 rounded gap-1 sm:gap-0">
                <span class="text-white text-xs sm:text-sm truncate">${playerName}</span>
                <button class="quote-btn bg-gray-900 hover:bg-yellow-500 hover:text-black text-white px-3 sm:px-4 py-1 rounded text-xs sm:text-sm font-bold min-w-[60px] w-full sm:w-auto text-center ${isSelected ? 'bg-yellow-500 text-black' : ''} ${quotaNum <= 1 || isNaN(quotaNum) ? 'opacity-60 cursor-not-allowed' : 'cursor-pointer'}" 
                        data-match-id="${matchId}" 
                        data-categoria="Goalscorer" 
                        data-segno="${playerName.replace(/"/g, '&quot;')}" 
                        data-quota="${playerOdds}" 
                        data-evento="${evento.replace(/"/g, '&quot;')}"
                        ${quotaNum <= 1 || isNaN(quotaNum) ? 'disabled' : ''}>
                  ${quotaFormattata}
                </button>
              </div>`;
          });
        });
        
        html += `
            </div>
          </div>`;
        return html;
      }
      
      // Variabile per tab selezionata (Casa o Ospite)
      let tabSelezionata = marcatoriContainer.getAttribute('data-tab-selezionata') || 'casa';
      
      let html = `
        <div class="mb-4">
          <div class="flex gap-2 mb-4">
            <button class="tab-team-btn flex-1 px-4 py-2 rounded font-bold transition-colors ${
              tabSelezionata === 'casa' 
                ? 'bg-yellow-500 text-black' 
                : 'bg-gray-700 text-white hover:bg-gray-600'
            }" data-team="casa" data-team-number="1">
              ${homeName}
            </button>
            <button class="tab-team-btn flex-1 px-4 py-2 rounded font-bold transition-colors ${
              tabSelezionata === 'ospite' 
                ? 'bg-yellow-500 text-black' 
                : 'bg-gray-700 text-white hover:bg-gray-600'
            }" data-team="ospite" data-team-number="2">
              ${awayName}
            </button>
          </div>
          
          <div id="team-casa-content" class="${tabSelezionata === 'casa' ? '' : 'hidden'}">`;
      
      // Renderizza mercati per Casa (team 1) - mantieni l'ordine con "Segna" per primo
      const mercatiOrder = ['score', 'gls', 'tgs', 'mgs', 'gls_method', 'anytime_1x2', 'first_1x2', 'anytime_cs', 'first_cs_mix', 'soa'];
      mercatiOrder.forEach(mercatoKey => {
        if (mercati[mercatoKey]) {
          html += renderMercatoPlayers(mercatoKey, mercati[mercatoKey], '1');
        }
      });
      
      html += `</div>
          
          <div id="team-ospite-content" class="${tabSelezionata === 'ospite' ? '' : 'hidden'}">`;
      
      // Renderizza mercati per Ospite (team 2) - mantieni l'ordine con "Segna" per primo
      mercatiOrder.forEach(mercatoKey => {
        if (mercati[mercatoKey]) {
          html += renderMercatoPlayers(mercatoKey, mercati[mercatoKey], '2');
        }
      });
      
      html += `</div>
        </div>`;
      
      marcatoriContainer.innerHTML = html;
      
      // Aggiungi event listener per i tab
      marcatoriContainer.querySelectorAll('.tab-team-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          const team = this.getAttribute('data-team');
          tabSelezionata = team;
          marcatoriContainer.setAttribute('data-tab-selezionata', team);
          
          // Aggiorna UI tab
          marcatoriContainer.querySelectorAll('.tab-team-btn').forEach(t => {
            t.classList.remove('bg-yellow-500', 'text-black');
            t.classList.add('bg-gray-700', 'text-white');
          });
          this.classList.remove('bg-gray-700', 'text-white');
          this.classList.add('bg-yellow-500', 'text-black');
          
          // Mostra/nascondi contenuti
          document.getElementById('team-casa-content').classList.toggle('hidden', team !== 'casa');
          document.getElementById('team-ospite-content').classList.toggle('hidden', team !== 'ospite');
        });
      });
      
      // Aggiungi event listener ai pulsanti toggle mercati
      marcatoriContainer.querySelectorAll('.mercato-toggle-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          const mercatoId = this.getAttribute('data-mercato-id');
          const mercatoContent = document.getElementById(mercatoId);
          const toggleIcon = this.querySelector('.toggle-icon');
          
          if (mercatoContent) {
            mercatoContent.classList.toggle('hidden');
            // Cambia icona
            if (mercatoContent.classList.contains('hidden')) {
              toggleIcon.textContent = '‚ñ∂';
            } else {
              toggleIcon.textContent = '‚ñº';
            }
          }
        });
      });
      
      // Aggiungi event listener ai pulsanti quote
      marcatoriContainer.querySelectorAll('.quote-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          if (this.disabled) return;
          const matchId = this.getAttribute('data-match-id');
          const categoria = this.getAttribute('data-categoria');
          const segno = this.getAttribute('data-segno').replace(/&quot;/g, '"');
          const quota = this.getAttribute('data-quota');
          const evento = this.getAttribute('data-evento').replace(/&quot;/g, '"');
          selectQuote(matchId, categoria, segno, quota, evento);
        });
      });
      
      // Aggiungi event listener alle select risultati esatti
      marcatoriContainer.querySelectorAll('.quote-select').forEach(select => {
        select.addEventListener('change', function() {
          const selectedOption = this.options[this.selectedIndex];
          if (!selectedOption || !selectedOption.value) {
            return; // Nessuna selezione
          }
          
          const matchId = this.getAttribute('data-match-id');
          const categoria = this.getAttribute('data-categoria');
          const playerName = this.getAttribute('data-player-name').replace(/&quot;/g, '"');
          const risultato = selectedOption.value.replace(/&quot;/g, '"');
          const quota = selectedOption.getAttribute('data-quota');
          const evento = this.getAttribute('data-evento').replace(/&quot;/g, '"');
          
          if (quota && quota !== '-') {
            selectQuote(matchId, categoria, `${playerName} ${risultato}`, quota, evento);
          }
        });
      });
    }

    // Mappatura nomi categorie da chiave database a nome italiano (come nell'immagine)
    const categoriaNames = {
      'goals_over_under': 'O/U',
      '1st_half_goals_over_under': 'O/U 1T',
      '2nd_half_goals_over_under': 'O/U 2T',
      'goals_over_under_corners': 'O/U C/O',
      '1st_half_goals_over_under_corners': 'O/U 1T C/O',
      '2nd_half_goals_over_under_corners': 'O/U 2T C/O',
      '1st_half_2nd_half_goals': 'O/U 1T/2T',
      'half_time_result': '1T',
      '2nd_half_result': '2T',
      'half_time_double_chance': 'DC 1T',
      '2nd_half_double_chance': 'DC 2T',
      'half_time_full_time': 'Parz./Fin.',
      'result_total_goals': 'P/F + GG/NG',
      'alternative_total_goals': 'Gol Totali',
      '1st_half_alternative_total_goals': 'GolTot 1T',
      '2nd_half_alternative_total_goals': 'GolTot 2T',
      'home_team_total_goals': 'GolTot Casa',
      'away_team_total_goals': 'GolTot Ospite',
      'both_teams_to_score': 'GG/NG',
      'both_teams_to_score_1st_half': 'GG/NG 1T',
      'both_teams_to_score_2nd_half': 'GG/NG 2T',
      'both_teams_to_score_special': 'GG Special',
      'handicap_result': 'Handicap',
      '1st_half_handicap_result': 'Handicap 1T',
      '2nd_half_handicap_result': 'Handicap 2T',
      'asian_handicap': 'Asian Handicap',
      'goals_odd_even': 'Pari/Dispari',
      '1st_half_goals_odd_even': 'Pari/Dis. 1T',
      '2nd_half_goals_odd_even': 'Pari/Dis. 2T',
      'team_goals_odd_even': 'P/D. Squadre',
      'correct_score': 'Ris. Esatto',
      '1st_half_correct_score': 'Ris. Es. 1T',
      '2nd_half_correct_score': 'Ris. Es. 2T',
      'half_time_full_time_correct_score': 'Ris. Es. P/F',
      'draw_no_bet': 'DNB',
      '1st_half_draw_no_bet': 'DNB 1T',
      '2nd_half_draw_no_bet': 'DNB 2T',
      'home_no_bet': 'HNB',
      'away_no_bet': 'ANB',
      'goals_no_bet': 'Gol No Bet',
      'time_goals': 'Tempo+Gol',
      'time_goals_corners': 'T+G (C/O)',
      'result_total_goals_combo': 'Combo',
      '1st_half_result_total_goals_combo': 'Combo 1T',
      '2nd_half_result_total_goals_combo': 'Combo 2T',
      'double_chance_total_goals': 'Combo DC',
      '1st_half_double_chance_total_goals': 'Combo DC 1T',
      '2nd_half_double_chance_total_goals': 'Combo DC 2T',
      'double_chance_multi': 'C. DC Multi',
      'combo_3': 'Combo 3',
      'combo_3_ht_ft': 'Combo3 HT/FT',
      'combo_multi': 'Combo+Multi',
      'combo_3_multi_corners': 'Combo3 Multi C/C',
      'chance_3_mix': 'Chance 3 Mix',
      'ht_chance_mix': 'HT Ch. Mix',
      'correct_score_mix': 'Ris. Esatto Mix',
      'first_team_to_score': 'Primo Gol',
      'last_team_to_score': 'Ultimo Gol',
      'match_goals_range': 'Multi Gol',
      '1st_half_match_goals_range': 'Multi Gol 1T',
      '2nd_half_match_goals_range': 'Multi Gol 2T',
      'home_team_match_goals_range': 'Multi Gol Casa',
      'away_team_match_goals_range': 'Multi Gol Ospite',
      'match_goals_range_corners': 'Multi Gol C/O',
      '1st_half_2nd_half_match_goals_range': 'Multigoal 1T/2T',
      'special_goals': 'Speciali Gol',
      'full_time_result': '1X2',
      'double_chance': 'DC',
      'goal_line': 'Goal Line',
      'first_team_to_score': 'Segna',
      'win_to_nil': 'Vince a 0',
      'win_both_halves': 'Vince 1T e 2T',
      'win_either_half': 'Vince 1T o 2T',
      'win_from_behind': 'Vincono Rib.',
      'winning_margin': 'Margine Vitt.',
      'corners': 'Corner',
      'cards': 'Cartellini'
    };
    
    // Organizzazione delle categorie in righe (come nell'immagine)
    const categoriePerRiga = [
      ['goals_over_under', '1st_half_goals_over_under', '2nd_half_goals_over_under', 'goals_over_under_corners', '1st_half_goals_over_under_corners', '2nd_half_goals_over_under_corners', '1st_half_2nd_half_goals', 'half_time_result', '2nd_half_result', 'half_time_double_chance', '2nd_half_double_chance', 'half_time_full_time'],
      ['result_total_goals', 'alternative_total_goals', '1st_half_alternative_total_goals', '2nd_half_alternative_total_goals', 'home_team_total_goals', 'away_team_total_goals', 'both_teams_to_score', 'both_teams_to_score_1st_half', 'both_teams_to_score_2nd_half', 'both_teams_to_score_special', 'handicap_result', '1st_half_handicap_result'],
      ['2nd_half_handicap_result', 'asian_handicap', 'goals_odd_even', '1st_half_goals_odd_even', '2nd_half_goals_odd_even', 'team_goals_odd_even', 'correct_score', '1st_half_correct_score', '2nd_half_correct_score', 'half_time_full_time_correct_score', 'draw_no_bet', '1st_half_draw_no_bet'],
      ['2nd_half_draw_no_bet', 'home_no_bet', 'away_no_bet', 'goals_no_bet', 'time_goals', 'time_goals_corners', 'result_total_goals_combo', '1st_half_result_total_goals_combo', '2nd_half_result_total_goals_combo', 'double_chance_total_goals', '1st_half_double_chance_total_goals', '2nd_half_double_chance_total_goals'],
      ['double_chance_multi', 'combo_3', 'combo_3_ht_ft', 'combo_multi', 'combo_3_multi_corners', 'chance_3_mix', 'ht_chance_mix', 'correct_score_mix', 'first_team_to_score', 'win_to_nil', 'win_both_halves', 'win_either_half'],
      ['win_from_behind', 'winning_margin', 'last_team_to_score', 'match_goals_range', '1st_half_match_goals_range', '2nd_half_match_goals_range', 'home_team_match_goals_range', 'away_team_match_goals_range', 'match_goals_range_corners', '1st_half_2nd_half_match_goals_range', 'special_goals', 'full_time_result']
    ];
    
    // Funzione per convertire chiave categoria a nome formattato
    function getCategoriaNome(categoriaKey) {
      // Se c'√® una mappatura, usala
      if (categoriaNames[categoriaKey]) {
        return categoriaNames[categoriaKey];
      }
      // Altrimenti converte snake_case a Title Case
      return categoriaKey
        .split('_')
        .map(word => {
          // Gestisci casi speciali come "1st", "2nd", etc.
          if (word.match(/^\d+[a-z]+$/)) {
            return word.charAt(0).toUpperCase() + word.slice(1).toLowerCase();
          }
          return word.charAt(0).toUpperCase() + word.slice(1).toLowerCase();
        })
        .join(' ');
    }
    
    // Funzione per convertire nome mercato italiano a chiave database (snake_case)
    function convertiMercatoToKey(mercatoNome) {
      // Mappatura diretta completa per tutti i mercati
      const directMap = {
        'Doppia Chance': 'double_chance',
        'DC': 'double_chance',
        'O/U': 'goals_over_under',
        'Over/Under': 'goals_over_under',
        'Gol Totali': 'both_teams_to_score',
        'GG/NG': 'both_teams_to_score',
        'GG/NG 1T': 'both_teams_to_score_1st_half',
        'GG/NG 2T': 'both_teams_to_score_2nd_half',
        'GG Special': 'both_teams_to_score_special',
        '1T': 'half_time_result',
        '2T': '2nd_half_result',
        'DC 1T': 'half_time_double_chance',
        'DC 2T': '2nd_half_double_chance',
        'O/U 1T': '1st_half_goals_over_under',
        'O/U 2T': '2nd_half_goals_over_under',
        'O/U C/O': 'goals_over_under_corners',
        'O/U 1T C/O': '1st_half_goals_over_under_corners',
        'O/U 2T C/O': '2nd_half_goals_over_under_corners',
        'Parz./Fin.': 'half_time_full_time',
        'Gol Esatti': 'total_goals',
        'GolTot 1T': '1st_half_total_goals',
        'GolTot 2T': '2nd_half_total_goals',
        'GolTot Casa': 'home_team_total_goals',
        'GolTot Ospite': 'away_team_total_goals',
        'Handicap': 'handicap_result',
        'Handicap 1T': '1st_half_handicap_result',
        'Handicap 2T': '2nd_half_handicap_result',
        'Pari/Dispari': 'goals_odd_even',
        'Pari/Dis. 1T': '1st_half_goals_odd_even',
        'Pari/Dis. 2T': '2nd_half_goals_odd_even',
        'P./D. Squadre': 'team_goals_odd_even',
        'Ris. Esatto': 'correct_score',
        'Ris. Es. 1T': '1st_half_correct_score',
        'Ris. Es. 2T': '2nd_half_correct_score',
        'Ris. Es. P/F': 'half_time_full_time_correct_score',
        'DNB': 'draw_no_bet',
        'DNB 1T': '1st_half_draw_no_bet',
        'DNB 2T': '2nd_half_draw_no_bet',
        'HNB': 'handicap_no_bet',
        'ANB': 'asian_no_bet',
        'Gol No Bet': 'goal_no_bet',
        'Corner': 'corners',
        'Cart. Allen.': 'cards',
        'Primo Gol': 'first_team_to_score',
        'Ultimo Gol': 'last_team_to_score',
        'Tempo+Gol': 'time_goals',
        'T+G (C/O)': 'time_goals_corners',
        'Combo': 'result_total_goals_combo',
        'Combo 1T': '1st_half_result_total_goals_combo',
        'Combo 2T': '2nd_half_result_total_goals_combo',
        'Combo DC': 'double_chance_total_goals',
        'Combo DC 1T': '1st_half_double_chance_total_goals',
        'Combo DC 2T': '2nd_half_double_chance_total_goals',
        'C. DC Multi': 'double_chance_multi',
        'Multi Gol': 'match_goals_range',
        'Multi Gol 1T': '1st_half_match_goals_range',
        'Multi Gol 2T': '2nd_half_match_goals_range',
        'Multi Gol C/O': 'match_goals_range_corners',
        'Multigoal 1T/2': '1st_half_2nd_half_match_goals_range',
        'Vince a 0': 'win_to_nil',
        'Vince 1T e 2T': 'win_both_halves',
        'Vince 1T o 2T': 'win_either_half',
        'Vincono Rib.': 'wins_from_behind',
        'Goal (0 - 15)': 'early_goal',
        'Goal (0 - 30)': 'late_goal',
        '1X2 5 min': '1x2_5min',
        '1X2 10 min': '1x2_10min',
        '1X2 15 min': '1x2_15min',
        '1X2 25 min': '1x2_25min',
        '1X2 30 min': '1x2_30min'
      };
      
      // Se c'√® una mappatura diretta, usala
      if (directMap[mercatoNome]) {
        return directMap[mercatoNome];
      }
      
      // Crea una mappatura inversa da nome italiano a chiave database
      const reverseMap = {};
      for (const [key, value] of Object.entries(categoriaNames)) {
        reverseMap[value] = key;
      }
      
      // Se c'√® una mappatura nella categoriaNames, usala
      if (reverseMap[mercatoNome]) {
        return reverseMap[mercatoNome];
      }
      
      // Altrimenti prova a convertire il nome italiano a snake_case
      // Rimuovi spazi, caratteri speciali e converti a lowercase con underscore
      let key = mercatoNome
        .toLowerCase()
        .replace(/\s+/g, '_')
        .replace(/[¬∞'"]/g, '')
        .replace(/[√†√°√¢√£√§√•]/g, 'a')
        .replace(/[√®√©√™√´]/g, 'e')
        .replace(/[√¨√≠√Æ√Ø]/g, 'i')
        .replace(/[√≤√≥√¥√µ√∂]/g, 'o')
        .replace(/[√π√∫√ª√º]/g, 'u')
        .replace(/[√ß]/g, 'c')
        .replace(/[^a-z0-9_]/g, '');
      
      // Gestisci casi speciali
      key = key.replace(/1t/g, '1st_half');
      key = key.replace(/2t/g, '2nd_half');
      key = key.replace(/o\/u/g, 'goals_over_under');
      key = key.replace(/dc/g, 'double_chance');
      key = key.replace(/doppia_chance/g, 'double_chance');
      key = key.replace(/gg\/ng/g, 'both_teams_to_score');
      key = key.replace(/gg/g, 'both_teams_to_score');
      key = key.replace(/ng/g, 'both_teams_to_score');
      key = key.replace(/parz\.\/fin\./g, 'half_time_full_time');
      key = key.replace(/parz_fin/g, 'half_time_full_time');
      key = key.replace(/gol_esatti/g, 'total_goals');
      key = key.replace(/goltot/g, 'total_goals');
      key = key.replace(/ris_esatto/g, 'correct_score');
      key = key.replace(/ris_es/g, 'correct_score');
      key = key.replace(/pari\/dispari/g, 'goals_odd_even');
      key = key.replace(/pari_dis/g, 'goals_odd_even');
      key = key.replace(/handicap/g, 'handicap_result');
      key = key.replace(/corner/g, 'corners');
      key = key.replace(/cart/g, 'cards');
      
      return key;
    }

    // Variabile globale per salvare i mercati per categoria
    let mercatiPerCategoriaGlobal = {};
    let categoriaSelezionataMercati = null;

    // Renderizza mercati organizzati per categoria con tab (solo calcio)
    function renderMercatiPerCategoria() {
      const container = document.getElementById('mercati-categorie-container');
      const tabsDiv = document.getElementById('categorie-tabs');
      const contentDiv = document.getElementById('mercati-categorie-content');
      
      if (!container || !tabsDiv || !contentDiv || !matchesData || matchesData.length === 0) {
        if (container) container.classList.add('hidden');
        return;
      }
      
      
      // Raccogli tutti i mercati da tutte le partite, organizzati per categoria
      mercatiPerCategoriaGlobal = {};
      
      matchesData.forEach((ev, idx) => {
        const quote = ev.quote || {};
        
        // La struttura √®: ev.quote = { "categoria": [array di quote], ... }
        // Ogni categoria √® una chiave del dizionario
        Object.keys(quote).forEach(categoriaKey => {
          const quoteArray = quote[categoriaKey];
          
          // Verifica che sia un array
          if (!Array.isArray(quoteArray) || quoteArray.length === 0) {
            return;
          }
          
          // Usa la funzione per ottenere il nome formattato della categoria
          const categoriaNome = getCategoriaNome(categoriaKey);
          
          if (!mercatiPerCategoriaGlobal[categoriaNome]) {
            mercatiPerCategoriaGlobal[categoriaNome] = [];
          }
          
          // Aggiungi le quote di questa categoria
          quoteArray.forEach(odd => {
            if (odd && odd.odds) {
              // Crea un ID univoco basato su categoria + nome + header + handicap
              const uniqueId = `${categoriaKey}_${odd.name || ''}_${odd.header || ''}_${odd.handicap || ''}`;
              
              mercatiPerCategoriaGlobal[categoriaNome].push({
                id: uniqueId,
                name: odd.name || '',
                header: odd.header || '',
                odds: odd.odds,
                handicap: odd.handicap || '',
                categoria: categoriaNome
              });
            }
          });
        });
      });
      
      
      // Rimuovi duplicati (stesso ID o stessa combinazione)
      Object.keys(mercatiPerCategoriaGlobal).forEach(categoria => {
        const seen = new Set();
        mercatiPerCategoriaGlobal[categoria] = mercatiPerCategoriaGlobal[categoria].filter(item => {
          if (seen.has(item.id)) return false;
          seen.add(item.id);
          return true;
        });
      });
      
      if (Object.keys(mercatiPerCategoriaGlobal).length === 0) {
        container.classList.add('hidden');
        return;
      }
      
      // Mostra il contenitore
      container.classList.remove('hidden');
      
      // Genera le tab organizzate per righe (come nell'immagine)
      let tabsHtml = '';
      let primaCategoriaTrovata = null;
      
      // Crea una mappa inversa: nome categoria -> chiave database
      const categoriaToKey = {};
      Object.keys(mercatiPerCategoriaGlobal).forEach(catNome => {
        // Trova la chiave corrispondente
        Object.keys(categoriaNames).forEach(key => {
          if (categoriaNames[key] === catNome) {
            categoriaToKey[catNome] = key;
          }
        });
      });
      
      // Genera le righe di tab
      categoriePerRiga.forEach((riga, rigaIdx) => {
        riga.forEach((categoriaKey, idx) => {
          const categoriaNome = categoriaNames[categoriaKey] || getCategoriaNome(categoriaKey);
          
          // Verifica se questa categoria ha quote disponibili
          if (!mercatiPerCategoriaGlobal[categoriaNome]) {
            return; // Salta se non ci sono quote
          }
          
          // Seleziona la prima categoria trovata come attiva
          if (!primaCategoriaTrovata) {
            primaCategoriaTrovata = categoriaNome;
            categoriaSelezionataMercati = categoriaNome;
          }
          
          const isActive = categoriaNome === primaCategoriaTrovata;
          
          tabsHtml += `<button 
            class="categoria-tab-btn px-2 py-1 rounded text-xs font-bold whitespace-nowrap ${
              isActive ? 'bg-yellow-500 text-black border-2 border-yellow-400' : 'bg-gray-700 text-white hover:bg-gray-600'
            }" 
            data-categoria="${categoriaNome}">
            ${categoriaNome}
          </button>`;
        });
      });
      
      // Aggiungi anche le categorie non mappate (se ce ne sono)
      Object.keys(mercatiPerCategoriaGlobal).forEach(catNome => {
        let found = false;
        categoriePerRiga.forEach(riga => {
          riga.forEach(key => {
            if (categoriaNames[key] === catNome) found = true;
          });
        });
        if (!found) {
          const isActive = catNome === primaCategoriaTrovata;
          if (!primaCategoriaTrovata) {
            primaCategoriaTrovata = catNome;
            categoriaSelezionataMercati = catNome;
          }
          tabsHtml += `<button 
            class="categoria-tab-btn px-2 py-1 rounded text-xs font-bold whitespace-nowrap ${
              isActive ? 'bg-yellow-500 text-black border-2 border-yellow-400' : 'bg-gray-700 text-white hover:bg-gray-600'
            }" 
            data-categoria="${catNome}">
            ${catNome}
          </button>`;
        }
      });
      
      tabsDiv.innerHTML = tabsHtml;
      
      // Aggiungi event listener alle tab
      document.querySelectorAll('.categoria-tab-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          const categoria = this.getAttribute('data-categoria');
          mostraCategoriaMercati(categoria);
        });
      });
      
      // Mostra la prima categoria trovata
      if (primaCategoriaTrovata) {
        mostraCategoriaMercati(primaCategoriaTrovata);
      }
    }
    
    // Mostra le quote di una categoria specifica
    function mostraCategoriaMercati(categoria) {
      categoriaSelezionataMercati = categoria;
      const contentDiv = document.getElementById('mercati-categorie-content');
      const mercati = mercatiPerCategoriaGlobal[categoria] || [];
      
      // Aggiorna le tab attive
      document.querySelectorAll('.categoria-tab-btn').forEach(btn => {
        if (btn.getAttribute('data-categoria') === categoria) {
          btn.classList.remove('bg-gray-700', 'text-white', 'hover:bg-gray-600');
          btn.classList.add('bg-yellow-500', 'text-black', 'border-2', 'border-yellow-400');
        } else {
          btn.classList.remove('bg-yellow-500', 'text-black', 'border-2', 'border-yellow-400');
          btn.classList.add('bg-gray-700', 'text-white', 'hover:bg-gray-600');
        }
      });
      
      if (mercati.length === 0) {
        contentDiv.innerHTML = '<div class="text-gray-400 text-center py-4">Nessuna quota disponibile per questa categoria</div>';
        return;
      }
      
      // Genera la tabella
      let html = `<table class="min-w-full text-xs text-white">`;
      html += `<thead class="bg-gray-600">`;
      html += `<tr>`;
      html += `<th class="px-2 py-1 border-b border-gray-500 text-left">Nome/Header</th>`;
      html += `<th class="px-2 py-1 border-b border-gray-500 text-left">Handicap</th>`;
      html += `<th class="px-2 py-1 border-b border-gray-500 text-center">Quota</th>`;
      html += `</tr>`;
      html += `</thead>`;
      html += `<tbody>`;
      
      mercati.forEach(mercato => {
        const nomeDisplay = mercato.name || mercato.header || '-';
        const handicapDisplay = mercato.handicap || '-';
        const quotaNum = parseFloat(mercato.odds);
        const quotaDisplay = quotaNum > 1 ? parseFloat(mercato.odds).toFixed(2) : '-';
        
        html += `<tr class="bg-gray-800 hover:bg-gray-700">`;
        html += `<td class="px-2 py-1 border-b border-gray-600">${nomeDisplay}</td>`;
        html += `<td class="px-2 py-1 border-b border-gray-600">${handicapDisplay}</td>`;
        html += `<td class="px-2 py-1 border-b border-gray-600 text-center font-bold ${quotaNum > 1 ? 'text-yellow-400' : 'text-gray-500'}">${quotaDisplay}</td>`;
        html += `</tr>`;
      });
      
      html += `</tbody>`;
      html += `</table>`;
      
      contentDiv.innerHTML = html;
    }

    // Seleziona una quota
    function selectQuote(id, categoria, segno, quota, evento) {
      if (parseFloat(quota) <= 1 || quota === '-') return;
      
      const key = `${id}-${categoria}-${segno}`;
      const existing = selections.findIndex(s => s.key === key);
      
      if (existing !== -1) {
        selections.splice(existing, 1);
      } else {
        // Rimuovi altre selezioni per la stessa partita e mercato
        selections = selections.filter(s => !(s.id === id && s.categoria === categoria));
        selections.push({ id, categoria, segno, quota, evento, key });
      }
      
      updateSchedina();
      renderMatches(); // Rerenderizza per aggiornare lo stato visivo
    }

    // Aggiorna la schedina
    function updateSchedina() {
      const content = document.getElementById('schedina-content');
      const importoInput = document.getElementById('importo-input');
      
      if (selections.length === 0) {
        content.innerHTML = '<div class="text-xs text-gray-400">Nessuna selezione</div>';
        document.getElementById('vincita-pot').textContent = '0.00 ‚Ç¨';
        return;
      }

      let html = '<div class="flex flex-col space-y-1">';
      let totaleQuota = 1;
      
      selections.forEach(sel => {
        totaleQuota *= parseFloat(sel.quota);
        html += `
          <div class="flex items-center justify-between bg-gray-900 rounded px-2 py-1 mb-1">
            <div>
              <div class="font-bold text-yellow-400 text-xs">${sel.id} - ${sel.evento}</div>
              <div class="text-xs">${sel.categoria}: <span class="font-bold">${sel.segno}</span> @ <span class="font-bold">${formattaQuota(sel.quota)}</span></div>
            </div>
            <button class="remove-selection-btn ml-2 text-red-400 hover:text-red-600 font-bold" data-key="${sel.key}">&times;</button>
          </div>
        `;
      });
      
      html += `<div class="mt-2 text-xs">Totale quota: <span class="font-bold">${totaleQuota.toFixed(2)}</span></div>`;
      html += '</div>';
      
      content.innerHTML = html;
      
      // Aggiungi event listener ai pulsanti rimuovi
      content.querySelectorAll('.remove-selection-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          const key = this.getAttribute('data-key');
          removeSelection(key);
        });
      });
      
      updateVincita();
    }

    // Rimuovi selezione
    function removeSelection(key) {
      selections = selections.filter(s => s.key !== key);
      updateSchedina();
    }

    // Aggiorna vincita potenziale
    function updateVincita() {
      const importo = parseFloat(document.getElementById('importo-input').value) || 0;
      if (selections.length === 0 || importo <= 0) {
        document.getElementById('vincita-pot').textContent = '0.00 ‚Ç¨';
        return;
      }
      
      const totaleQuota = selections.reduce((acc, s) => acc * parseFloat(s.quota), 1);
      const vincita = (importo * totaleQuota).toFixed(2);
      document.getElementById('vincita-pot').textContent = vincita + ' ‚Ç¨';
    }

    // Pulisci schedina
    function clearSchedina() {
      selections = [];
      document.getElementById('importo-input').value = '';
      updateSchedina();
    }

    // Ottieni credito corrente
    async function getCredito() {
      try {
        const res = await fetch('/api/credito');
        const data = await res.json();
        return data.credito || 0;
      } catch (err) {
        console.error('Errore recupero credito:', err);
        return 0;
      }
    }

    // Gioca schedina
    async function giocaSchedina() {
      if (selections.length === 0) {
        alert('Nessuna selezione nella schedina!');
        return;
      }
      
      const importo = parseFloat(document.getElementById('importo-input').value);
      if (isNaN(importo) || importo <= 0) {
        alert('Inserisci un importo valido!');
        return;
      }
      
      // Verifica credito disponibile
      const credito = await getCredito();
      if (credito < importo) {
        alert(`Credito insufficiente! Credito disponibile: ${credito.toFixed(2)} ‚Ç¨`);
        return;
      }
      
      const totaleQuota = selections.reduce((acc, s) => acc * parseFloat(s.quota), 1);
      const vincita = importo * totaleQuota;
      
      try {
        const res = await fetch('/api/salva-schedina', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            scommesse: selections,
            importo: importo,
            vincita: vincita,
            data: new Date().toISOString()
          })
        });
        
        const result = await res.json();
        if (res.ok) {
          alert('Schedina giocata con successo! Credito rimanente: ' + result.credito_rimanente.toFixed(2) + ' ‚Ç¨');
          // Aggiorna il credito visualizzato
          if (result.credito_rimanente !== undefined) {
            document.getElementById('credito-display').textContent = result.credito_rimanente.toFixed(2) + ' ‚Ç¨';
          }
          clearSchedina();
        } else {
          alert(result.error || 'Errore durante il salvataggio!');
        }
      } catch (err) {
        alert('Errore di rete: ' + err.message);
      }
    }

    // Event listener per l'importo
    document.getElementById('importo-input').addEventListener('input', updateVincita);

    let categoriaSelezionata = 'Principali';
    let eventoCorrente = null;

    // Mappa categorie database -> categorie UI
    const mappaCategorie = {
      'full_time_result': 'Principali',
      'match_goals': 'O/U',
      'both_teams_to_score': 'Gol Totali',
      'asian_lines': 'Handicap',
      'correct_score': 'Ris. Esatto',
      'corners': 'Corner',
      'cards': 'Cartellini',
      'first_goal': 'Primo Gol',
      'half_time': '1T',
      'second_half': '2T',
      'double_chance': 'Doppia Chance',
      'draw_no_bet': 'DNB',
      'handicap': 'Handicap',
      'over_under': 'O/U',
      'match_goals_range': 'Gol Totali'
    };

    // Apri modal mercati
    function apriMercati(matchId) {
      const modal = document.getElementById('modal-mercati');
      const titolo = document.getElementById('modal-titolo');
      const tabContainer = document.getElementById('tab-categorie');
      
      // Trova l'evento nei dati caricati
      const evento = matchesData.find(m => (m.match_id || m._id) == matchId || String(m.match_id || m._id) === String(matchId) || String(m.match_id || m._id) === String(matchId));
      if (!evento) {
        alert('Evento non trovato');
        return;
      }
      
      eventoCorrente = evento;
      categoriaSelezionata = 'Principali';
      
      const teams = `${evento.home_name || ''} - ${evento.away_name || ''}`;
      titolo.textContent = teams;
      
      // Crea tab categorie
      const quote = evento.quote || {};
      const categorieDisponibili = ['Principali'];
      
      // Aggiungi categorie disponibili
      Object.keys(quote).forEach(cat => {
        const catUI = mappaCategorie[cat] || cat;
        if (!categorieDisponibili.includes(catUI) && quote[cat] && quote[cat].length > 0) {
          categorieDisponibili.push(catUI);
        }
      });
      
      // Aggiungi categorie standard
      ['O/U', 'Gol Totali', 'Handicap', 'Ris. Esatto', 'Corner', 'Cartellini', 'Primo Gol', '1T', '2T', 'Doppia Chance', 'DNB'].forEach(cat => {
        if (!categorieDisponibili.includes(cat)) {
          categorieDisponibili.push(cat);
        }
      });
      
      let tabHtml = '';
      categorieDisponibili.forEach(cat => {
        const isActive = cat === categoriaSelezionata;
        tabHtml += `
          <button class="categoria-tab px-3 py-1 rounded text-xs font-bold whitespace-nowrap ${isActive ? 'bg-yellow-500 text-black' : 'bg-gray-600 text-white hover:bg-gray-500'}"
                  data-categoria="${cat}">
            ${cat}
          </button>
        `;
      });
      tabContainer.innerHTML = tabHtml;
      
      // Aggiungi event listener alle tab categorie
      tabContainer.querySelectorAll('.categoria-tab').forEach(btn => {
        btn.addEventListener('click', function() {
          const categoria = this.getAttribute('data-categoria');
          selezionaCategoria(categoria);
        });
      });
      
      // Renderizza contenuto
      renderizzaMercati();
      modal.classList.remove('hidden');
    }

    // Seleziona categoria
    function selezionaCategoria(categoria) {
      categoriaSelezionata = categoria;
      
      // Aggiorna tab
      document.querySelectorAll('#tab-categorie button').forEach(btn => {
        if (btn.textContent.trim() === categoria) {
          btn.classList.remove('bg-gray-600', 'text-white');
          btn.classList.add('bg-yellow-500', 'text-black');
        } else {
          btn.classList.remove('bg-yellow-500', 'text-black');
          btn.classList.add('bg-gray-600', 'text-white');
        }
      });
      
      renderizzaMercati();
    }

    // Renderizza mercati in base alla categoria
    function renderizzaMercati() {
      if (!eventoCorrente) return;
      
      const contenuto = document.getElementById('modal-contenuto');
      const quote_1x2 = eventoCorrente.quote_1x2 || {};
      const quote = eventoCorrente.quote || {};
      const matchId = eventoCorrente.match_id || eventoCorrente._id;
      const teams = `${eventoCorrente.home_name || ''} - ${eventoCorrente.away_name || ''}`;
      
      let html = '';
      
      if (categoriaSelezionata === 'Principali') {
        // 1X2
        html += '<div class="mb-6">';
        html += '<h3 class="text-lg font-bold text-yellow-400 mb-3">1X2</h3>';
        html += '<div class="grid grid-cols-3 gap-3">';
        ['1', 'X', '2'].forEach(segno => {
          const quota = quote_1x2[segno] || '-';
          const quotaNum = parseFloat(quota);
          const isSelected = selections.some(s => s.id == matchId && s.categoria === '1X2' && s.segno === segno);
          html += `
            <button class="modal-quote-btn px-4 py-3 rounded text-sm font-bold ${isSelected ? 'bg-yellow-500 text-black' : 'bg-gray-700 text-white hover:bg-yellow-500 hover:text-black'} ${quotaNum <= 1 ? 'opacity-60 cursor-not-allowed' : 'cursor-pointer'}"
                    data-match-id="${matchId}"
                    data-categoria="1X2"
                    data-segno="${segno}"
                    data-quota="${quota}"
                    data-evento="${(teams || '').replace(/"/g, '&quot;').replace(/'/g, '&#39;')}"
                    ${quotaNum <= 1 ? 'disabled' : ''}>
              <div class="text-xs mb-1">${segno === '1' ? 'Casa' : segno === 'X' ? 'Pareggio' : 'Ospiti'}</div>
              <div class="text-lg">${quotaNum > 1 ? formattaQuota(quota) : '-'}</div>
            </button>
          `;
        });
        html += '</div></div>';
        
        // Doppia Chance
        html += '<div class="mb-6">';
        html += '<h3 class="text-lg font-bold text-yellow-400 mb-3">Doppia Chance</h3>';
        html += '<div class="grid grid-cols-3 gap-3">';
        ['1X', '12', 'X2'].forEach(segno => {
          const quota = quote_1x2[segno] || '-';
          const quotaNum = parseFloat(quota);
          const isSelected = selections.some(s => s.id == matchId && s.categoria === 'Doppia Chance' && s.segno === segno);
          html += `
            <button class="modal-quote-btn px-4 py-3 rounded text-sm font-bold ${isSelected ? 'bg-yellow-500 text-black' : 'bg-gray-700 text-white hover:bg-yellow-500 hover:text-black'} ${quotaNum <= 1 ? 'opacity-60 cursor-not-allowed' : 'cursor-pointer'}"
                    data-match-id="${matchId}"
                    data-categoria="Doppia Chance"
                    data-segno="${segno}"
                    data-quota="${quota}"
                    data-evento="${(teams || '').replace(/"/g, '&quot;').replace(/'/g, '&#39;')}"
                    ${quotaNum <= 1 ? 'disabled' : ''}>
              <div class="text-xs mb-1">${segno}</div>
              <div class="text-lg">${quotaNum > 1 ? formattaQuota(quota) : '-'}</div>
            </button>
          `;
        });
        html += '</div></div>';
      } else if (categoriaSelezionata === 'O/U' || categoriaSelezionata === 'Over/Under') {
        // Over/Under
        const overUnder = quote['match_goals'] || {};
        if (overUnder && Array.isArray(overUnder)) {
          html += '<div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3">';
          overUnder.forEach(item => {
            const nome = item.name || item.header || '-';
            const quota = item.odds || '-';
            const quotaNum = parseFloat(quota);
            const isSelected = selections.some(s => s.id == matchId && s.categoria === 'O/U' && s.segno === nome);
            html += `
              <button class="modal-quote-btn px-4 py-3 rounded text-sm font-bold ${isSelected ? 'bg-yellow-500 text-black' : 'bg-gray-700 text-white hover:bg-yellow-500 hover:text-black'} ${quotaNum <= 1 ? 'opacity-60 cursor-not-allowed' : 'cursor-pointer'}"
                      data-match-id="${matchId}"
                      data-categoria="O/U"
                      data-segno="${(nome || '').replace(/"/g, '&quot;').replace(/'/g, '&#39;')}"
                      data-quota="${quota}"
                      data-evento="${(teams || '').replace(/"/g, '&quot;').replace(/'/g, '&#39;')}"
                      ${quotaNum <= 1 ? 'disabled' : ''}>
                <div class="text-xs mb-1">${nome}</div>
                <div class="text-lg">${quotaNum > 1 ? formattaQuota(quota) : '-'}</div>
              </button>
            `;
          });
          html += '</div>';
        } else {
          // Fallback per struttura diversa
          Object.keys(overUnder).forEach(key => {
            const quota = overUnder[key];
            const quotaNum = parseFloat(quota);
            const isSelected = selections.some(s => s.id == matchId && s.categoria === 'O/U' && s.segno === key);
            html += `
              <button class="modal-quote-btn px-4 py-3 rounded text-sm font-bold ${isSelected ? 'bg-yellow-500 text-black' : 'bg-gray-700 text-white hover:bg-yellow-500 hover:text-black'} ${quotaNum <= 1 ? 'opacity-60 cursor-not-allowed' : 'cursor-pointer'}"
                      data-match-id="${matchId}"
                      data-categoria="O/U"
                      data-segno="${(key || '').replace(/"/g, '&quot;').replace(/'/g, '&#39;')}"
                      data-quota="${quota}"
                      data-evento="${(teams || '').replace(/"/g, '&quot;').replace(/'/g, '&#39;')}"
                      ${quotaNum <= 1 ? 'disabled' : ''}>
                <div class="text-xs mb-1">${key}</div>
                <div class="text-lg">${quotaNum > 1 ? formattaQuota(quota) : '-'}</div>
              </button>
            `;
          });
        }
      } else {
        // Mostra tutti i mercati della categoria selezionata
        const categoriaKey = Object.keys(mappaCategorie).find(k => mappaCategorie[k] === categoriaSelezionata) || categoriaSelezionata.toLowerCase();
        const mercati = quote[categoriaKey] || [];
        
        if (Array.isArray(mercati) && mercati.length > 0) {
          html += '<div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3">';
          mercati.forEach(item => {
            const nome = item.name || item.header || '-';
            const quota = item.odds || '-';
            const handicap = item.handicap ? ` (${item.handicap})` : '';
            const quotaNum = parseFloat(quota);
            const isSelected = selections.some(s => s.id == matchId && s.categoria === categoriaSelezionata && s.segno === nome);
            html += `
              <button class="modal-quote-btn px-4 py-3 rounded text-sm font-bold ${isSelected ? 'bg-yellow-500 text-black' : 'bg-gray-700 text-white hover:bg-yellow-500 hover:text-black'} ${quotaNum <= 1 ? 'opacity-60 cursor-not-allowed' : 'cursor-pointer'}"
                      data-match-id="${matchId}"
                      data-categoria="${(categoriaSelezionata || '').replace(/"/g, '&quot;').replace(/'/g, '&#39;')}"
                      data-segno="${(nome || '').replace(/"/g, '&quot;').replace(/'/g, '&#39;')}"
                      data-quota="${quota}"
                      data-evento="${(teams || '').replace(/"/g, '&quot;').replace(/'/g, '&#39;')}"
                      ${quotaNum <= 1 ? 'disabled' : ''}>
                <div class="text-xs mb-1">${nome}${handicap}</div>
                <div class="text-lg">${quotaNum > 1 ? formattaQuota(quota) : '-'}</div>
              </button>
            `;
          });
          html += '</div>';
        } else {
          html += '<p class="text-gray-400">Nessun mercato disponibile per questa categoria</p>';
        }
      }
      
      contenuto.innerHTML = html || '<p class="text-gray-400">Nessun mercato disponibile</p>';
      
      // Aggiungi event listener ai pulsanti quote nel modal
      contenuto.querySelectorAll('.modal-quote-btn').forEach(btn => {
        if (!btn.disabled) {
          btn.addEventListener('click', function() {
            const matchId = this.getAttribute('data-match-id');
            const categoria = this.getAttribute('data-categoria');
            const segno = this.getAttribute('data-segno');
            const quota = this.getAttribute('data-quota');
            const evento = this.getAttribute('data-evento');
            selectQuoteFromModal(matchId, categoria, segno, quota, evento);
          });
        }
      });
    }

    // Refresh mercati
    function refreshMercati() {
      if (eventoCorrente) {
        const matchId = eventoCorrente.match_id || eventoCorrente._id;
        apriMercati(matchId);
      }
    }

    // Chiudi modal mercati
    function chiudiMercati() {
      document.getElementById('modal-mercati').classList.add('hidden');
    }


    // Funzione di ricerca - cerca sempre direttamente nel database tramite API
    async function cercaEvento(query) {
      if (!query || query.trim() === '') {
        return [];
      }
      
      const risultati = [];
      
      try {
        // Cerca sempre direttamente nel database tramite API
        const sportForMongo = getSportForMongo(sportSelezionato);
        const url = `${window.location.origin}/api/search-betbet?sport=${sportForMongo}&q=${encodeURIComponent(query)}&limit=50`;
        
        const response = await fetch(url);
        if (response.ok) {
          const data = await response.json();
          if (data.success && data.results && data.results.length > 0) {
            // Converti i risultati in formato compatibile
            const searchTerm = query.trim().toLowerCase();
            data.results.forEach(ev => {
              const matchId = String(ev.match_id || ev._id || '').toLowerCase();
              const homeName = (ev.home_name || '').toLowerCase();
              const awayName = (ev.away_name || '').toLowerCase();
              const league = (ev.league || '').toLowerCase();
              const numeroCorsa = String(ev.numero_corsa || ev.quote?.numero_corsa || '').toLowerCase().trim();
              
              let tipo = 'ID Evento';
              if (homeName.includes(searchTerm) || awayName.includes(searchTerm)) {
                tipo = 'Squadra';
              } else if (league.includes(searchTerm)) {
                tipo = 'Campo';
              } else if (numeroCorsa && numeroCorsa.includes(searchTerm)) {
                tipo = 'Corsa';
              }
              
              risultati.push({
                tipo: tipo,
                evento: ev,
                match: matchId || homeName || awayName || league || numeroCorsa
              });
            });
          }
        }
      } catch (error) {
        console.error('Errore durante la ricerca API:', error);
      }
      
      return risultati;
    }

    // Mostra risultati ricerca e scrolla al primo risultato
    async function eseguiRicerca() {
      const searchInput = document.getElementById('search-input');
      const searchResults = document.getElementById('search-results');
      
      if (!searchInput || !searchResults) return;
      
      const query = searchInput.value.trim();
      
      if (query === '') {
        searchResults.classList.add('hidden');
        return;
      }
      
      // Mostra messaggio di caricamento
      if (searchResults) {
        searchResults.innerHTML = '<div class="p-3 text-yellow-400 text-sm">üîç Ricerca in corso...</div>';
        searchResults.classList.remove('hidden');
      }
      
      // Cerca sempre direttamente nel database tramite API
      const risultati = await cercaEvento(query);
      
      if (risultati.length === 0) {
        searchResults.innerHTML = '<div class="p-3 text-gray-400 text-sm">Nessun risultato trovato</div>';
        searchResults.classList.remove('hidden');
        return;
      }
      
      // Mostra max 5 risultati nel dropdown
      const risultatiLimitati = risultati.slice(0, 5);
      let html = '';
      risultatiLimitati.forEach((risultato, idx) => {
        const ev = risultato.evento;
        const matchId = ev.match_id || ev._id;
        const homeName = ev.home_name || '';
        const awayName = ev.away_name || '';
        const league = ev.league || '';
        const displayText = sportSelezionato === 'horse racing' || sportSelezionato === 'horseracing'
          ? `${league} - Corsa ${ev.numero_corsa || ev.quote?.numero_corsa || 'N/A'}`
          : `${homeName} vs ${awayName} (${league})`;
        
        html += `
          <div class="search-result-item p-2 hover:bg-gray-700 cursor-pointer border-b border-gray-700 last:border-b-0" 
               data-match-id="${matchId}" 
               data-index="${idx}">
            <div class="text-white text-sm font-medium">${displayText}</div>
            <div class="text-gray-400 text-xs">ID: ${matchId} - ${risultato.tipo}</div>
          </div>
        `;
      });
      
      if (risultati.length > 5) {
        html += `<div class="p-2 text-gray-400 text-xs text-center">... e altri ${risultati.length - 5} risultati</div>`;
      }
      
      searchResults.innerHTML = html;
      searchResults.classList.remove('hidden');
      
      // Aggiungi event listener ai risultati
      searchResults.querySelectorAll('.search-result-item').forEach((item, idx) => {
        item.addEventListener('click', function() {
          const matchId = this.getAttribute('data-match-id');
          const risultato = risultati[idx];
          const ev = risultato.evento;
          const league = ev.league;
          
          // Seleziona il campionato dell'evento selezionato
          if (league && league !== campionatoSelezionato) {
            // Estrai la nazione dall'evento se disponibile e convertila in italiano
            const eventNation = convertNationToItalian(ev.nation);
            // Aspetta che il campionato sia selezionato prima di caricare i match
            selezionaCampionato(league, eventNation).then(() => {
              // Ricarica i dati con il filtro del campionato
              loadMatches().then(() => {
                setTimeout(() => {
                  scrollaAEvento(matchId);
                }, 300);
              });
            });
          } else {
            scrollaAEvento(matchId);
          }
          
          searchResults.classList.add('hidden');
          searchInput.value = '';
        });
      });
      
      // Se c'√® almeno un risultato, seleziona il campionato e scrolla al primo
      if (risultati.length > 0) {
        const primoRisultato = risultati[0].evento;
        const league = primoRisultato.league;
        
        // Se c'√® un campionato, selezionalo automaticamente
        if (league && league !== campionatoSelezionato) {
          // Estrai la nazione dall'evento se disponibile e convertila in italiano
          const eventNation = convertNationToItalian(primoRisultato.nation);
          // Aspetta che il campionato sia selezionato prima di caricare i match
          selezionaCampionato(league, eventNation).then(() => {
            // Ricarica i dati con il filtro del campionato
            loadMatches().then(() => {
              setTimeout(() => {
                scrollaAEvento(primoRisultato.match_id || primoRisultato._id);
              }, 300);
            });
          });
        } else {
          // Se non c'√® campionato o √® gi√† selezionato, scrolla direttamente
          setTimeout(() => {
            scrollaAEvento(primoRisultato.match_id || primoRisultato._id);
          }, 100);
        }
      }
    }

    // Scrolla all'evento trovato e lo evidenzia
    function scrollaAEvento(matchId) {
      // Trova l'evento nei dati caricati
      let ev = matchesData.find(e => String(e.match_id || e._id) === String(matchId));
      
      // Se l'evento non √® nei dati caricati, potrebbe essere perch√© c'√® un filtro attivo
      // In questo caso, seleziona il campionato dell'evento e ricarica
      if (!ev) {
        // Prova a trovare l'evento nei risultati della ricerca API (se disponibili)
        // Altrimenti, carica l'evento specifico tramite API
        
        // Carica l'evento specifico per ottenere il campionato
        const sportForMongo = getSportForMongo(sportSelezionato);
        fetch(`${window.location.origin}/api/search-betbet?sport=${sportForMongo}&q=${matchId}&limit=1`)
          .then(response => response.json())
          .then(data => {
            if (data.success && data.results && data.results.length > 0) {
              const evento = data.results[0];
              const league = evento.league;
              
              // Seleziona il campionato dell'evento
              if (league) {
                // Estrai la nazione dall'evento se disponibile e convertila in italiano
                const eventNation = convertNationToItalian(evento.nation);
                // Aspetta che il campionato sia selezionato prima di caricare i match
                selezionaCampionato(league, eventNation).then(() => {
                  // Ricarica i dati con il filtro del campionato
                  loadMatches().then(() => {
                    setTimeout(() => {
                      scrollaAEventoDopoRicerca(matchId);
                    }, 300);
                  });
                });
              } else {
                // Se non c'√® campionato, carica senza filtro ma solo 200 eventi
                campionatoSelezionato = null;
                nazioneSelezionata = null;
                renderLeaguesMenu();
                loadMatches().then(() => {
                  setTimeout(() => {
                    scrollaAEventoDopoRicerca(matchId);
                  }, 300);
                });
              }
            }
          })
          .catch(error => {
            console.error('Errore caricamento evento:', error);
          });
        return;
      }
      
      // Se ancora non lo trova, potrebbe non essere stato caricato
      if (!ev) {
        console.warn('Evento non trovato nei dati caricati:', matchId);
        return;
      }
      
      // Per Horse Racing, seleziona il campo e scrolla alla corsa
      if (sportSelezionato === 'horse racing' || sportSelezionato === 'horseracing') {
        const campo = ev.league || ev.home_name || 'Unknown';
        campoSelezionato = campo;
        renderCampiHorseRacing();
        renderCorseHorseRacing();
        
        // Scrolla alla corsa
        setTimeout(() => {
          const corseContainer = document.getElementById('corse-container');
          if (corseContainer) {
            const corsaElement = corseContainer.querySelector(`[data-corsa-id="${matchId}"]`);
            if (corsaElement) {
              corsaElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
              corsaElement.classList.add('ring-8', 'ring-red-500', 'bg-red-500', 'bg-opacity-40', 'shadow-2xl', 'shadow-red-500/80', 'border-4', 'border-red-400', 'animate-pulse');
              
              // Rimuovi evidenziazione quando l'utente clicca su qualcosa
              const rimuoviEvidenziazione = () => {
                corsaElement.classList.remove('ring-8', 'ring-red-500', 'bg-red-500', 'bg-opacity-40', 'shadow-2xl', 'shadow-red-500/80', 'border-4', 'border-red-400', 'animate-pulse');
                document.removeEventListener('click', rimuoviEvidenziazione);
              };
              // Usa setTimeout per evitare che il click sul risultato della ricerca rimuova subito l'evidenziazione
              setTimeout(() => {
                document.addEventListener('click', rimuoviEvidenziazione, { once: true });
              }, 100);
            }
          }
        }, 300);
        return;
      }
      
      // Per gli altri sport, seleziona il campionato dell'evento se diverso da quello attuale
      const league = ev.league || '';
      if (league && campionatoSelezionato !== league) {
        // Estrai la nazione dall'evento se disponibile e convertila in italiano
        const eventNation = convertNationToItalian(ev.nation);
        // Aspetta che il campionato sia selezionato prima di caricare i match
        selezionaCampionato(league, eventNation).then(() => {
          // Ricarica i dati con il filtro del campionato (solo 200 eventi)
          loadMatches().then(() => {
            // Dopo aver ricaricato, scrolla all'evento
            setTimeout(() => {
              scrollaAEventoDopoRicerca(matchId);
            }, 300);
          });
        });
        return;
      }
      
      // Se il campionato √® gi√† selezionato o non c'√® campionato, scrolla direttamente
      scrollaAEventoDopoRicerca(matchId);
    }

    // Funzione helper per scrollare dopo aver verificato/ricaricato i dati
    function scrollaAEventoDopoRicerca(matchId) {
      // Aspetta che il rendering sia completato, poi scrolla
      setTimeout(() => {
        const tbody = document.getElementById('matches-body');
        if (!tbody) return;
        
        // Cerca la riga con il match_id (prima per data-match-id sulla riga, poi sui pulsanti)
        const foundRow = tbody.querySelector(`tr[data-match-id="${matchId}"]`) || 
                        Array.from(tbody.querySelectorAll('tr')).find(row => {
                          const quoteBtns = row.querySelectorAll('[data-match-id]');
                          return Array.from(quoteBtns).some(btn => 
                            String(btn.getAttribute('data-match-id')) === String(matchId)
                          );
                        });
        
        if (foundRow) {
          foundRow.scrollIntoView({ behavior: 'smooth', block: 'center' });
          foundRow.classList.add('ring-8', 'ring-red-500', 'bg-red-500', 'bg-opacity-40', 'shadow-2xl', 'shadow-red-500/80', 'border-4', 'border-red-400', 'animate-pulse');
          
          // Rimuovi evidenziazione quando l'utente clicca su qualcosa
          const rimuoviEvidenziazione = () => {
            foundRow.classList.remove('ring-8', 'ring-red-500', 'bg-red-500', 'bg-opacity-40', 'shadow-2xl', 'shadow-red-500/80', 'border-4', 'border-red-400', 'animate-pulse');
            document.removeEventListener('click', rimuoviEvidenziazione);
          };
          // Usa setTimeout per evitare che il click sul risultato della ricerca rimuova subito l'evidenziazione
          setTimeout(() => {
            document.addEventListener('click', rimuoviEvidenziazione, { once: true });
          }, 100);
        } else {
          // Se non trova la riga, potrebbe essere in una sezione di data/campionato collassata
          // Prova a cercare in tutte le righe, incluse quelle nascoste
          const allRows = tbody.querySelectorAll('tr');
          let targetRow = null;
          
          allRows.forEach(row => {
            if (row.getAttribute('data-match-id') === String(matchId)) {
              targetRow = row;
            } else {
              const quoteBtns = row.querySelectorAll('[data-match-id]');
              Array.from(quoteBtns).forEach(btn => {
                if (String(btn.getAttribute('data-match-id')) === String(matchId)) {
                  targetRow = row;
                }
              });
            }
          });
          
          if (targetRow) {
            // Assicurati che la riga sia visibile (espandi eventuali sezioni collassate)
            targetRow.closest('tbody')?.querySelectorAll('tr').forEach(tr => {
              if (tr.contains(targetRow) || tr === targetRow) {
                tr.style.display = '';
              }
            });
            
            targetRow.scrollIntoView({ behavior: 'smooth', block: 'center' });
            targetRow.classList.add('ring-8', 'ring-red-500', 'bg-red-500', 'bg-opacity-40', 'shadow-2xl', 'shadow-red-500/80', 'border-4', 'border-red-400', 'animate-pulse');
            
            // Rimuovi evidenziazione quando l'utente clicca su qualcosa
            const rimuoviEvidenziazione = () => {
              targetRow.classList.remove('ring-8', 'ring-red-500', 'bg-red-500', 'bg-opacity-40', 'shadow-2xl', 'shadow-red-500/80', 'border-4', 'border-red-400', 'animate-pulse');
              document.removeEventListener('click', rimuoviEvidenziazione);
            };
            // Usa setTimeout per evitare che il click sul risultato della ricerca rimuova subito l'evidenziazione
            setTimeout(() => {
              document.addEventListener('click', rimuoviEvidenziazione, { once: true });
            }, 100);
          }
        }
      }, 100);
    }

    // Seleziona quota dal modal
    function selectQuoteFromModal(id, categoria, segno, quota, evento) {
      selectQuote(id, categoria, segno, quota, evento);
      // Aggiorna il modal per mostrare la selezione
      apriMercati(id);
    }

        // Chiudi modal cliccando fuori
    document.getElementById('modal-mercati').addEventListener('click', (e) => {
      if (e.target.id === 'modal-mercati') {
        chiudiMercati();
      }
    });


    // Gestione menu mobile
    function toggleSidebar(sidebarId, overlayId) {
      const sidebar = document.getElementById(sidebarId);
      const overlay = document.getElementById(overlayId);
      
      if (!sidebar || !overlay) return;
      
      if (sidebar.classList.contains('-translate-x-full') || sidebar.classList.contains('translate-x-full')) {
        // Apri sidebar
        sidebar.classList.remove('-translate-x-full', 'translate-x-full');
        overlay.classList.remove('hidden');
        document.body.style.overflow = 'hidden';
      } else {
        // Chiudi sidebar
        if (sidebarId === 'sidebar-left') {
          sidebar.classList.add('-translate-x-full');
        } else {
          sidebar.classList.add('translate-x-full');
        }
        overlay.classList.add('hidden');
        document.body.style.overflow = '';
      }
    }
    
    function closeSidebar(sidebarId, overlayId) {
      const sidebar = document.getElementById(sidebarId);
      const overlay = document.getElementById(overlayId);
      
      if (!sidebar || !overlay) return;
      
      if (sidebarId === 'sidebar-left') {
        sidebar.classList.add('-translate-x-full');
      } else {
        sidebar.classList.add('translate-x-full');
      }
      overlay.classList.add('hidden');
      document.body.style.overflow = '';
    }

    // Inizializza sport selezionato e UI
    window.addEventListener('DOMContentLoaded', () => {
      // Event listeners per menu mobile
      const mobileMenuLeft = document.getElementById('mobile-menu-left');
      const mobileMenuRight = document.getElementById('mobile-menu-right');
      const closeSidebarLeft = document.getElementById('close-sidebar-left');
      const closeSidebarRight = document.getElementById('close-sidebar-right');
      const overlay = document.getElementById('mobile-overlay');
      
      if (mobileMenuLeft) {
        mobileMenuLeft.addEventListener('click', () => toggleSidebar('sidebar-left', 'mobile-overlay'));
      }
      
      if (mobileMenuRight) {
        mobileMenuRight.addEventListener('click', () => toggleSidebar('sidebar-right', 'mobile-overlay'));
      }
      
      if (closeSidebarLeft) {
        closeSidebarLeft.addEventListener('click', () => closeSidebar('sidebar-left', 'mobile-overlay'));
      }
      
      if (closeSidebarRight) {
        closeSidebarRight.addEventListener('click', () => closeSidebar('sidebar-right', 'mobile-overlay'));
      }
      
      if (overlay) {
        overlay.addEventListener('click', () => {
          closeSidebar('sidebar-left', 'mobile-overlay');
          closeSidebar('sidebar-right', 'mobile-overlay');
        });
      }
      
      try {
        // Imposta UI per calcio
        const calcioItem = document.querySelector('[data-sport="calcio"]');
        if (calcioItem) {
          calcioItem.classList.add('bg-yellow-500', 'bg-opacity-20');
          // Cerca l'indicatore dentro calcio-toggle
          const calcioToggle = document.getElementById('calcio-toggle');
          if (calcioToggle) {
            const indicator = calcioToggle.querySelector('.sport-indicator');
            if (indicator) {
              indicator.classList.remove('hidden');
            }
          }
        }
        
        const sportTitle = document.getElementById('sport-title');
        if (sportTitle) {
          sportTitle.textContent = 'CALCIO';
        }
        
        // Apri automaticamente il submenu calcio e mostra la freccia
        const submenu = document.getElementById('calcio-submenu');
        const arrow = document.getElementById('calcio-arrow');
        if (submenu && arrow) {
          submenu.classList.remove('hidden');
          arrow.style.transform = 'rotate(180deg)';
        }
        
        // Mappa sport -> toggle ID, icon, nome
        const sportToggleMap = {
          'calcio': { toggle: 'calcio-toggle', icon: '‚öΩ', nome: 'CALCIO' },
          'tennis': { toggle: 'tennis-toggle', icon: 'üéæ', nome: 'Tennis' },
          'basket': { toggle: 'basket-toggle', icon: 'üèÄ', nome: 'Basket' },
          'hockey': { toggle: 'hockey-toggle', icon: 'üèí', nome: 'Hockey' },
          'rugby': { toggle: 'rugby-toggle', icon: 'üèâ', nome: 'Rugby' },
          'american football': { toggle: 'american-football-toggle', icon: 'üèà', nome: 'American Football' },
          'volleyball': { toggle: 'volleyball-toggle', icon: 'üèê', nome: 'Volleyball' },
          'water polo': { toggle: 'water-polo-toggle', icon: 'üèì', nome: 'Water Polo' },
          'pingpong': { toggle: 'pingpong-toggle', icon: 'üéæ', nome: 'Pingpong' },
          'futsal': { toggle: 'futsal-toggle', icon: '‚öΩ', nome: 'Futsal' },
          'pallamano': { toggle: 'pallamano-toggle', icon: 'üéæ', nome: 'Pallamano' },
          'freccette': { toggle: 'freccette-toggle', icon: 'üéæ', nome: 'Freccette' },
          'boxing': { toggle: 'boxing-toggle', icon: 'ü•ä', nome: 'Boxing' },
          'e-sport': { toggle: 'e-sport-toggle', icon: 'üéÆ', nome: 'E-Sport' },
          'badminton': { toggle: 'badminton-toggle', icon: 'üè∏', nome: 'Badminton' },
          'cricket': { toggle: 'cricket-toggle', icon: 'üèè', nome: 'Cricket' },
          'squash': { toggle: 'squash-toggle', icon: 'üéæ', nome: 'Squash' }
        };
        
        // Aggiungi event listener per horse racing
        const horseRacingItem = document.querySelector('[data-sport="horse racing"]');
        if (horseRacingItem) {
          horseRacingItem.addEventListener('click', function() {
            selezionaSport('horse racing', 'üê¥', 'Horse Racing');
          });
        }
        
        // Aggiungi event listener per tutti i toggle sport
        Object.entries(sportToggleMap).forEach(([sport, info]) => {
          const toggle = document.getElementById(info.toggle);
          if (toggle) {
            toggle.addEventListener('click', function(e) {
              // Trova l'arrow ID dalla mappa toggleSportMenu
              const sportMap = {
                'calcio': { arrow: 'calcio-arrow' },
                'tennis': { arrow: 'tennis-arrow' },
                'basket': { arrow: 'basket-arrow' },
                'hockey': { arrow: 'hockey-arrow' },
                'rugby': { arrow: 'rugby-arrow' },
                'american football': { arrow: 'american-football-arrow' },
                'volleyball': { arrow: 'volleyball-arrow' },
                'water polo': { arrow: 'water-polo-arrow' },
                'pingpong': { arrow: 'pingpong-arrow' },
                'futsal': { arrow: 'futsal-arrow' },
                'pallamano': { arrow: 'pallamano-arrow' },
                'freccette': { arrow: 'freccette-arrow' },
                'boxing': { arrow: 'boxing-arrow' },
                'e-sport': { arrow: 'e-sport-arrow' },
                'badminton': { arrow: 'badminton-arrow' },
                'cricket': { arrow: 'cricket-arrow' },
                'squash': { arrow: 'squash-arrow' },
                'horse racing': { arrow: 'horse-racing-arrow' }
              };
              
              const arrowId = sportMap[sport]?.arrow;
              
              // Se si clicca sulla freccia o sull'indicatore, solo toggle menu
              if (arrowId && (e.target.closest(`#${arrowId}`) || e.target.closest('.sport-indicator'))) {
                toggleSportMenu(sport);
              } else {
                // Altrimenti seleziona sport e apri menu
                selezionaSport(sport, info.icon, info.nome);
                toggleSportMenu(sport); // Apri anche il menu
              }
            });
          }
        });
        
        // Aggiungi event listener ai tab mercati
        document.querySelectorAll('.mercato-tab-btn').forEach(btn => {
          btn.addEventListener('click', function() {
            const mercato = this.getAttribute('data-mercato');
            if (mercato) {
              selezionaMercato(mercato);
            }
          });
        });
        
        // Aggiungi event listener al pulsante toggle mercati
        const toggleMercatiBtn = document.getElementById('toggle-mercati-btn');
        const mercatiRigheExtra = document.getElementById('mercati-righe-extra');
        const toggleMercatiText = document.getElementById('toggle-mercati-text');
        
        if (toggleMercatiBtn && mercatiRigheExtra && toggleMercatiText) {
          toggleMercatiBtn.addEventListener('click', function() {
            const isHidden = mercatiRigheExtra.classList.contains('hidden');
            if (isHidden) {
              mercatiRigheExtra.classList.remove('hidden');
              toggleMercatiText.textContent = '‚ñ≤ Nascondi';
            } else {
              mercatiRigheExtra.classList.add('hidden');
              toggleMercatiText.textContent = '‚ñº Mostra tutti';
            }
          });
        }
        
        // Mostra/nascondi tab mercati in base allo sport iniziale
        const mercatiTabsContainer = document.getElementById('mercati-tabs-container');
        if (mercatiTabsContainer) {
          if (sportSelezionato === 'calcio') {
            mercatiTabsContainer.classList.remove('hidden');
          } else {
            mercatiTabsContainer.classList.add('hidden');
          }
        }
        
        // Imposta mercato Principali per calcio, 1X2 per altri sport
        if (sportSelezionato === 'calcio') {
          selezionaMercato('Principali');
        } else {
        selezionaMercato('1X2');
        }
        
        // Event listener per la ricerca
        const searchInput = document.getElementById('search-input');
        const searchBtn = document.getElementById('search-btn');
        const searchResults = document.getElementById('search-results');
        
        if (searchInput && searchBtn) {
          // Ricerca al click del pulsante
          searchBtn.addEventListener('click', eseguiRicerca);
          
          // Ricerca al premere Enter
          searchInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
              eseguiRicerca();
            }
          });
          
          // Mostra risultati mentre si digita (con debounce)
          let searchTimeout;
          let isSearching = false; // Flag per evitare ricerche multiple simultanee
          searchInput.addEventListener('input', async function() {
            clearTimeout(searchTimeout);
            const query = this.value.trim();
            
            if (query === '') {
              if (searchResults) searchResults.classList.add('hidden');
              return;
            }
            
            searchTimeout = setTimeout(async () => {
              if (isSearching) return; // Evita ricerche multiple simultanee
              isSearching = true;
              
              // Mostra messaggio di caricamento
              if (searchResults) {
                searchResults.innerHTML = '<div class="p-3 text-yellow-400 text-sm">üîç Ricerca in corso...</div>';
                searchResults.classList.remove('hidden');
              }
              
              // Cerca sempre direttamente nel database tramite API
              const risultati = await cercaEvento(query);
              
              isSearching = false;
              
              if (!searchResults) return;
              
              if (risultati.length === 0) {
                searchResults.innerHTML = '<div class="p-3 text-gray-400 text-sm">Nessun risultato trovato</div>';
                searchResults.classList.remove('hidden');
                return;
              }
              
              const risultatiLimitati = risultati.slice(0, 5);
              let html = '';
              risultatiLimitati.forEach((risultato) => {
                const ev = risultato.evento;
                const matchId = ev.match_id || ev._id;
                const homeName = ev.home_name || '';
                const awayName = ev.away_name || '';
                const league = ev.league || '';
                const displayText = sportSelezionato === 'horse racing' || sportSelezionato === 'horseracing'
                  ? `${league} - Corsa ${ev.numero_corsa || ev.quote?.numero_corsa || 'N/A'}`
                  : `${homeName} vs ${awayName} (${league})`;
                
                html += `
                  <div class="search-result-item p-2 hover:bg-gray-700 cursor-pointer border-b border-gray-700 last:border-b-0" 
                       data-match-id="${matchId}">
                    <div class="text-white text-sm font-medium">${displayText}</div>
                    <div class="text-gray-400 text-xs">ID: ${matchId} - ${risultato.tipo}</div>
                  </div>
                `;
              });
              
              if (risultati.length > 5) {
                html += `<div class="p-2 text-gray-400 text-xs text-center">... e altri ${risultati.length - 5} risultati</div>`;
              }
              
              searchResults.innerHTML = html;
              searchResults.classList.remove('hidden');
              
              // Aggiungi event listener ai risultati
              searchResults.querySelectorAll('.search-result-item').forEach((item, idx) => {
                item.addEventListener('click', function() {
                  const matchId = this.getAttribute('data-match-id');
                  const risultato = risultati[idx];
                  const ev = risultato.evento;
                  const league = ev.league;
                  
                  // Seleziona il campionato dell'evento selezionato
                  if (league && league !== campionatoSelezionato) {
                    // Estrai la nazione dall'evento se disponibile e convertila in italiano
                    const eventNation = convertNationToItalian(ev.nation);
                    selezionaCampionato(league, eventNation);
                    // Ricarica i dati con il filtro del campionato
                    loadMatches().then(() => {
                      setTimeout(() => {
                        scrollaAEvento(matchId);
                      }, 300);
                    });
                  } else {
                    scrollaAEvento(matchId);
                  }
                  
                  searchResults.classList.add('hidden');
                  searchInput.value = '';
                });
              });
            }, 300);
          });
          
          // Nascondi risultati quando si clicca fuori
          document.addEventListener('click', function(e) {
            if (searchResults && !searchInput.contains(e.target) && !searchResults.contains(e.target) && !searchBtn.contains(e.target)) {
              searchResults.classList.add('hidden');
            }
          });
        }
        
        // Seleziona calcio di default all'apertura
        if (!sportSelezionato) {
          sportSelezionato = 'calcio';
          const calcioItem = document.querySelector('[data-sport="calcio"]');
          if (calcioItem) {
            calcioItem.classList.add('bg-yellow-500', 'bg-opacity-20');
            const indicator = calcioItem.querySelector('.sport-indicator');
            if (indicator) indicator.classList.remove('hidden');
          }
          document.getElementById('sport-title').textContent = 'CALCIO';
        }
        
        // Carica i campionati all'apertura (le partite verranno caricate automaticamente quando viene selezionato il campionato)
        loadLeagues().then(() => {
        }).catch(error => {
          console.error('DOMContentLoaded: errore caricamento campionati', error);
        });
      } catch (error) {
        console.error('Errore inizializzazione:', error);
        const matchesBody = document.getElementById('matches-body');
        if (matchesBody) {
          matchesBody.innerHTML = '<tr><td colspan="6" class="text-center py-4 text-red-400">Errore di inizializzazione. Controlla la console.</td></tr>';
        }
      }
    });
  </script>
</body>
</html>